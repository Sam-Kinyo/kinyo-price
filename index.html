<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>KINYO æŸ¥åƒ¹ç³»çµ± v4.7.3</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
:root{
  --bg:#f5f6f8;
  --card:#ffffff;
  --primary:#111827;
  --border:#e5e7eb;
  --text:#1f2937;
  --muted:#6b7280;
  --radius:12px;
  --shadow:0 4px 12px rgba(0,0,0,0.06);
}

body{
  margin:0;
  padding:24px;
  background:var(--bg);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--text);
  max-width:980px;
  margin:0 auto;
}

h1{margin:0 0 4px;}
.subtitle{
  color:var(--muted);
  margin-bottom:18px;
  font-size:14px;
}

/* Top-right user bar */
.top-bar{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:12px;
  margin-bottom:14px;
  font-size:13px;
}
.user-badge{
  background:#eef0f4;
  padding:6px 14px;
  border-radius:999px;
}
.logout-btn{
  padding:6px 14px;
  border-radius:999px;
  border:1px solid var(--border);
  cursor:pointer;
  background:white;
  font-size:12px;
}

/* Search Box */
.search-box{
  background:var(--card);
  padding:18px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  margin-bottom:12px;
}
.search-row{margin-bottom:14px;}
label{
  font-weight:600;
  margin-bottom:6px;
  display:block;
  font-size:14px;
}

input,select{
  width:100%;
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:15px;
  box-sizing:border-box;
}

/* Buttons */
.btn-primary{
  background:var(--primary);
  color:white;
  border:none;
  border-radius:999px;
  padding:12px 20px;
  font-weight:600;
  cursor:pointer;
  width:100%;
}
.btn-secondary{
  background:white;
  border:1px solid var(--border);
  padding:10px 16px;
  border-radius:999px;
  cursor:pointer;
  font-size:14px;
}
.btn-outline-add{
  padding:6px 12px;
  border-radius:6px;
  border:1px solid #2563eb;
  background:#eff6ff;
  color:#2563eb;
  font-size:12px;
  cursor:pointer;
  font-weight:600;
}
.btn-outline-add:hover{background:#dbeafe;}

/* Toolbar */
.toolbar{
  display:flex;
  gap:10px;
  align-items:center;
  margin:10px 0 6px;
}
.toolbar select{flex:1;}

/* Table */
table{
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:var(--shadow);
}
th,td{
  padding:12px 10px;
  border-bottom:1px solid var(--border);
  font-size:14px;
  vertical-align:top;
}
th{background:#fafafa;text-align:left;}

/* Detail card â€” desktop */
#detailCard{
  position:fixed;
  right:20px;
  top:120px;
  width:340px;
  max-height:78vh;
  overflow-y:auto;
  background:white;
  padding:18px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  display:none;
  z-index:999;
}

/* Mobile sheets */
.sheet-backdrop{
  position:fixed; inset:0;
  background:rgba(0,0,0,0.45);
  z-index:1000;
  display:none;
}
.sheet{
  position:fixed; left:0; right:0; bottom:0;
  height:80vh; background:#fff;
  border-radius:16px 16px 0 0;
  transform:translateY(100%);
  transition:transform .25s ease;
  display:flex; flex-direction:column;
  z-index:1001;
}
.sheet.open{transform:translateY(0);}

/* Quote item */
.quote-item{
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:12px 0;
  border-bottom:1px solid #eee;
}

.quote-info{font-size:14px;}
.quote-del{
  color:#999;
  cursor:pointer;
  padding:6px;
  font-size:16px;
}
.quote-del:hover{color:#ef4444;}

/* Price tags */
.price-tag{
  padding:3px 8px;
  font-size:12px;
  border-radius:6px;
  display:inline-block;
  margin-right:6px;
  margin-bottom:4px;
  font-weight:600;
  white-space:nowrap;
}
.tag50{background:#dbeafe;color:#1e40af;}
.tag100{background:#e0f2fe;color:#0369a1;}
.tag300{background:#dcfce7;color:#15803d;}
.tag500{background:#ffedd5;color:#ea580c;}
.tag1000{background:#fee2e2;color:#b91c1c;}

/* TOP LOADING BAR v4.7.3 */
#topLoadingBar{
  position:fixed;
  top:0; left:0;
  width:100%;
  height:3px;
  background:transparent;
  z-index:2000;
  overflow:hidden;
  display:none;
}
#topLoadingBar .bar{
  position:absolute;
  height:100%;
  width:30%;
  left:-30%;
  background:#2563eb;
  animation:topLoadingMove 0.9s ease-in-out infinite;
}
@keyframes topLoadingMove{
  0%{left:-30%;width:30%;}
  50%{left:35%;width:40%;}
  100%{left:100%;width:30%;}
}

@media(max-width:900px){
  #detailCard{display:none!important;}
}
@media(max-width:600px){
  body{padding:14px;}
  .search-box{padding:14px;}
  th,td{padding:8px;font-size:13px;}
}
</style>
</head>

<body>

<!-- v4.7.3 Loading Bar -->
<div id="topLoadingBar"><div class="bar"></div></div>

<div class="top-bar">
  <span id="userInfo" class="user-badge">æœªç™»å…¥</span>
  <button id="logoutBtn" class="logout-btn" style="display:none;">ç™»å‡º</button>
</div>

<h1>KINYO æŸ¥åƒ¹ç³»çµ±</h1>
<div class="subtitle">
  éƒ­åº­è±ªå˜”å¿ƒç€è¡€ä¹‹ä½œï¼ˆv4.7.3ï¼‰ ä»»ä½•å»ºè­°ğŸ“±ï¼š0976-966-333
</div>
<div class="search-box">
  <div class="search-row">
    <label>é—œéµå­—æœå°‹ï¼ˆå‹è™Ÿ / åç¨±ï¼‰</label>
    <input id="keyword" placeholder="å¦‚ï¼šCL528 / æ•èšŠç‡ˆ / é™¤æ¯›çƒæ©Ÿ" />
  </div>

  <div class="search-row">
    <label>èµ·è¨‚é‡ï¼ˆå¯ä¸é¸ï¼‰</label>
    <select id="qtySelect"></select>
  </div>

  <div class="search-row">
    <label>é ç®—å€é–“ï¼ˆèµ·è¨‚é‡å·²é¸æ™‚æ‰ç”Ÿæ•ˆï¼›å¯åªå¡«ä¸€é‚Šï¼‰</label>
    <div style="display:flex; gap:10px;">
      <input id="minPrice" type="number" placeholder="æœ€ä½ (å¯ç©º)">
      <input id="maxPrice" type="number" placeholder="æœ€é«˜ (å¯ç©º)">
    </div>
  </div>

  <button id="searchBtn" class="btn-primary">æŸ¥è©¢</button>
  <button id="clearBtn" class="btn-secondary" style="margin-top:10px;width:100%;">æ¸…é™¤æœå°‹æ¢ä»¶</button>
</div>

<!-- Toolbarï¼ˆv4.7.2 ä¿ç•™ + å ±åƒ¹å–®æŒ‰éˆ• v4.7.2/7.3ï¼‰ -->
<div class="toolbar">
  <select id="sortSelect" class="btn-secondary">
    <option value="">ä¸æ’åº</option>
    <option value="minPriceAsc">æœ«å”®ï¼šä½ â†’ é«˜</option>
    <option value="minPriceDesc">æœ«å”®ï¼šé«˜ â†’ ä½</option>
    <option value="marketAsc">è³£å ´ï¼šä½ â†’ é«˜</option>
    <option value="marketDesc">è³£å ´ï¼šé«˜ â†’ ä½</option>
    <option value="alphaAsc">ä¸»å‹è™Ÿï¼šA â†’ Z</option>
    <option value="alphaDesc">ä¸»å‹è™Ÿï¼šZ â†’ A</option>
  </select>

  <button id="exportBtn" class="btn-secondary" disabled>åŒ¯å‡º Excel</button>
  <button id="quoteToolbarBtn" class="btn-secondary">å ±åƒ¹å–®</button>
</div>

<table id="resultTable" style="display:none;">
  <thead>
    <tr>
      <th style="width:32px;"><input type="checkbox" id="checkAll" /></th>
      <th style="width:120px;">åœ–ç‰‡</th>
      <th style="width:110px;">ä¸»å‹è™Ÿ</th>
      <th>å•†å“è³‡è¨Š</th>
      <th style="width:80px;">æœ«å”®</th>
      <th style="width:80px;">è³£å ´</th>
    </tr>
  </thead>
  <tbody id="resultBody"></tbody>
</table>

<!-- Desktop detail card -->
<div id="detailCard"></div>

<!-- Backdropï¼ˆæ‰‹æ©Ÿ detail / å ±åƒ¹å–® å…±ç”¨ï¼‰ -->
<div id="sheetBackdrop" class="sheet-backdrop hidden"></div>

<!-- Mobile detail -->
<div id="mobileDetailSheet" class="sheet hidden">
  <div class="sheet-header">
    <span>å•†å“è³‡è¨Š</span>
    <button id="sheetCloseBtn" class="sheet-close">Ã—</button>
  </div>
  <div class="sheet-content" id="sheetContent"></div>
</div>

<!-- Quote bottom-sheet -->
<div id="quoteSheet" class="sheet hidden">
  <div class="sheet-header">
    <span>å ±åƒ¹å–®é è¦½</span>
    <button id="quoteCloseBtn" class="sheet-close">Ã—</button>
  </div>
  <div class="sheet-content" id="quoteListBody"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  /* Firebase Config */
  const firebaseConfig = {
    apiKey: "AIzaSyDtp6rwV7KmIOedLQ9793BnXbBquopP9kM",
    authDomain: "kinyo-price.firebaseapp.com",
    projectId: "kinyo-price",
    storageBucket: "kinyo-price.firebasestorage.app",
    messagingSenderId: "122464645678",
    appId: "1:122464645678:web:c0febbc6297a8ada5ea5bf"
  };

  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  /* å…¨åŸŸè®Šæ•¸ */
  let productCache = [];
  let currentResultList = [];
  let userLevel = 1;
  let currentUserEmail = "";
  let quoteList = [];

  /* DOM æŒ‡å‘ */
  const keywordInput   = document.getElementById("keyword");
  const qtySelect      = document.getElementById("qtySelect");
  const minPriceInput  = document.getElementById("minPrice");
  const maxPriceInput  = document.getElementById("maxPrice");
  const searchBtn      = document.getElementById("searchBtn");
  const clearBtn       = document.getElementById("clearBtn");
  const sortSelect     = document.getElementById("sortSelect");
  const exportBtn      = document.getElementById("exportBtn");
  const quoteToolbarBtn = document.getElementById("quoteToolbarBtn");

  const resultTable    = document.getElementById("resultTable");
  const resultBody     = document.getElementById("resultBody");
  const checkAllBox    = document.getElementById("checkAll");
  const detailCard     = document.getElementById("detailCard");

  const sheetBackdrop  = document.getElementById("sheetBackdrop");
  const mobileSheet    = document.getElementById("mobileDetailSheet");
  const sheetContent   = document.getElementById("sheetContent");
  const sheetCloseBtn  = document.getElementById("sheetCloseBtn");

  const quoteSheet     = document.getElementById("quoteSheet");
  const quoteCloseBtn  = document.getElementById("quoteCloseBtn");
  const quoteListBody  = document.getElementById("quoteListBody");

  const topLoadingBar  = document.getElementById("topLoadingBar");

  const userInfoSpan   = document.getElementById("userInfo");
  const logoutBtn      = document.getElementById("logoutBtn");

  /* Loading Bar v4.7.3 */
  function showLoadingBar(){
    if (!topLoadingBar) return;
    topLoadingBar.style.display = "block";
  }
  function hideLoadingBar(){
    if (!topLoadingBar) return;
    topLoadingBar.style.display = "none";
  }

  /* ä¸»å‹è™Ÿåˆ¤å®šè¦å‰‡ï¼ˆv4.5.3 â†’ v4.7.3 å»¶ç”¨ï¼‰
     è¦å‰‡ï¼š
     - è‹±æ–‡ + æ•¸å­— + è‹±æ–‡(1~3ç¢¼) â†’ è‰²ç¢¼
     - è‹¥çµå°¾æ˜¯è‹±æ–‡ â†’ è¦–ç‚ºé¡è‰²ç¢¼
     - WV-KHP1230W é€™é¡ä¹Ÿåƒå¾—åˆ°
  */
  function getMainModel(model){
    if (!model) return "";
    const m = model.toUpperCase().trim();

    const match = m.match(/^([A-Z0-9\-]+?)([A-Z]{1,3})$/);
    if (match){
      const prefix = match[1];
      const suffix = match[2];
      if (/^[A-Z]{1,3}$/.test(suffix)) return prefix.replace(/[\-]$/,"");
    }
    return m;
  }

  /* é è¼‰å•†å“ */
  async function preloadProducts(){
    showLoadingBar();
    try{
      const snap = await getDocs(collection(db, "Products"));
      productCache = [];

      snap.forEach(docSnap => {
        const d = docSnap.data() || {};
        const model = (d.model || "").trim();
        const mainModel = getMainModel(model);

        const searchKey = (d.searchKey || `${model} ${d.name || ""}`).toLowerCase();
        const up = model.toUpperCase();

        let colorList = d.colorList || "";
        if (!colorList){
          const m2 = up.match(/([A-Z]{1,3})$/);
          if (m2) colorList = m2[1];
        }

        productCache.push({
          ...d,
          model,
          mainModel,
          colorList,
          searchKey
        });
      });

      console.log("å•†å“é è¼‰å®Œæˆï¼š", productCache.length);
    }catch(e){
      console.error("é è¼‰å¤±æ•—ï¼š", e);
    }finally{
      hideLoadingBar();
    }
  }

  /* åƒ¹æ ¼ç­‰ç´š */
  function setupQtySelectByLevel(){
    qtySelect.innerHTML = "";
    const opt0 = new Option("ä¸ä½¿ç”¨èµ·è¨‚é‡", "");
    qtySelect.appendChild(opt0);

    if (userLevel >= 1){
      qtySelect.appendChild(new Option("50 å€‹", "50"));
    }
    if (userLevel >= 2){
      qtySelect.appendChild(new Option("100 å€‹", "100"));
      qtySelect.appendChild(new Option("300 å€‹", "300"));
    }
    if (userLevel >= 3){
      qtySelect.appendChild(new Option("500 å€‹", "500"));
      qtySelect.appendChild(new Option("1000 å€‹", "1000"));
    }
  }

  /* åˆä½µä¸»å‹è™Ÿ */
  function mergeByMainModel(list){
    const map = {};

    list.forEach(item => {
      const main = item.mainModel || getMainModel(item.model);
      if (!map[main]){
        map[main] = {
          ...item,
          models: [item.model],
          colorList: item.colorList || ""
        };
      }else{
        map[main].models.push(item.model);

        const exist = map[main].colorList.split(" / ").filter(Boolean);
        const newc  = (item.colorList || "").split(" / ").filter(Boolean);
        map[main].colorList = [...new Set([...exist, ...newc])].join(" / ");
      }
    });

    return Object.values(map);
  }

  /* æ’åº */
  function applySorting(list){
    const opt = sortSelect.value;

    if (opt === "minPriceAsc")  return list.sort((a,b)=>a.minPrice - b.minPrice);
    if (opt === "minPriceDesc") return list.sort((a,b)=>b.minPrice - a.minPrice);
    if (opt === "marketAsc")    return list.sort((a,b)=>a.marketPrice - b.marketPrice);
    if (opt === "marketDesc")   return list.sort((a,b)=>b.marketPrice - a.marketPrice);
    if (opt === "alphaAsc")     return list.sort((a,b)=>a.mainModel.localeCompare(b.mainModel));
    if (opt === "alphaDesc")    return list.sort((a,b)=>b.mainModel.localeCompare(a.mainModel));

    return list;
  }

  /* æ¯›åˆ©è©¦ç®—ï¼ˆv4.7.3 B + Cï¼‰ */
  function calcMarginPctByQty(item){
    const qty = qtySelect.value;
    if (!qty) return null;

    const key = `quote${qty}`;
    const cost = Number(item[key] ?? item.quote50 ?? 0);
    const market = Number(item.marketPrice ?? 0);

    if (market <= 0 || cost <= 0) return null;
    const pct = ((market - cost) / market) * 100;
    return Math.round(pct * 10) / 10;
  }

  /* æœå°‹é‚è¼¯ï¼ˆå« loading barï¼‰ */
  function searchProducts(){
    showLoadingBar();

    try{
      const key = keywordInput.value.trim().toLowerCase();
      const qty = qtySelect.value;
      const minPraw = minPriceInput.value.trim();
      const maxPraw = maxPriceInput.value.trim();

      /* Case 1ï¼šé—œéµå­— + èµ·è¨‚é‡ + é ç®—ï¼ˆæœ€å¼·çµ„åˆï¼‰ */
      if (key && qty){
        const costKey = `quote${qty}`;
        const minP = minPraw ? Number(minPraw) : 0;
        const maxP = maxPraw ? Number(maxPraw) : Number.MAX_SAFE_INTEGER;

        const r = productCache.filter(p=>{
          const hit = p.searchKey.includes(key);
          if (!hit) return false;
          const price = Number(p[costKey] || 0);
          return price >= minP && price <= maxP;
        });

        currentResultList = applySorting(mergeByMainModel(r));
        renderResults(currentResultList);
        return;
      }

      /* Case 2ï¼šåªæ‰“é—œéµå­— */
      if (key && !qty){
        const r = productCache.filter(p => p.searchKey.includes(key));
        currentResultList = applySorting(mergeByMainModel(r));
        renderResults(currentResultList);
        return;
      }

      /* Case 3ï¼šåªæœ‰èµ·è¨‚é‡ + é ç®— */
      if (qty){
        const costKey = `quote${qty}`;
        const minP = minPraw ? Number(minPraw) : 0;
        const maxP = maxPraw ? Number(maxPraw) : Number.MAX_SAFE_INTEGER;

        const r = productCache.filter(p=>{
          const price = Number(p[costKey] || 0);
          return price >= minP && price <= maxP;
        });

        currentResultList = applySorting(mergeByMainModel(r));
        renderResults(currentResultList);
        return;
      }

      alert("è«‹è¼¸å…¥é—œéµå­—ï¼Œæˆ–é¸æ“‡èµ·è¨‚é‡ + é ç®—å€é–“ã€‚");

    }finally{
      hideLoadingBar();
    }
  }
/* æ¸²æŸ“çµæœ */
  function renderResults(list){
    resultBody.innerHTML = "";
    detailCard.style.display = "none";
    closeSheet();
    checkAllBox.checked = false;

    if (list.length === 0){
      resultTable.style.display = "none";
      exportBtn.disabled = true;
      return;
    }

    resultTable.style.display = "table";
    exportBtn.disabled = false;

    list.forEach(item=>{
      const img = item.imageUrl || "https://placehold.co/120x120?text=No+Image";

      let priceHtml = "";
      if (userLevel >= 1) priceHtml += `<span class="price-tag tag50">50å€‹ï¼š${item.quote50}</span>`;
      if (userLevel >= 2){
        priceHtml += `<span class="price-tag tag100">100å€‹ï¼š${item.quote100}</span>`;
        priceHtml += `<span class="price-tag tag300">300å€‹ï¼š${item.quote300}</span>`;
      }
      if (userLevel >= 3){
        priceHtml += `<span class="price-tag tag500">500å€‹ï¼š${item.quote500}</span>`;
        priceHtml += `<span class="price-tag tag1000">1000å€‹ï¼š${item.quote1000}</span>`;
      }

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="row-check" data-model="${item.model}"></td>
        <td><img src="${img}" style="width:110px;height:110px;border-radius:8px;border:1px solid #eee;"></td>
        <td>${item.mainModel}</td>
        <td>
          <div style="font-weight:700;margin-bottom:4px;">${item.name}</div>
          <div style="font-size:13px;color:#555;margin-bottom:4px;">é¡è‰²ï¼š${item.colorList || "-"}</div>
          <div style="margin-bottom:6px;">${priceHtml}</div>

          <div style="display:flex; gap:6px;">
            <button class="line-btn" data-model="${item.model}"
              style="padding:6px 10px;background:#06C755;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:12px;">
              LINE
            </button>
            <button class="btn-outline-add add-quote-btn" data-model="${item.model}">
              â• å ±åƒ¹å–®
            </button>
          </div>
        </td>
        <td style="text-align:right;">${item.minPrice}</td>
        <td style="text-align:right;">${item.marketPrice}</td>
      `;

      /* äº‹ä»¶ï¼šæ¡Œæ©Ÿ hover é¡¯ç¤ºå³å´ detail */
      if (window.innerWidth > 900){
        tr.addEventListener("mouseenter", ()=>showDetailDesktop(item));
        tr.addEventListener("click", e=>{
          if (e.target.tagName === "BUTTON" || e.target.tagName === "INPUT") return;
          showDetailDesktop(item);
        });
      }else{
        /* æ‰‹æ©Ÿï¼šé»æ“Šé–‹ bottom sheet */
        tr.addEventListener("click", e=>{
          if (e.target.tagName === "BUTTON" || e.target.tagName === "INPUT") return;
          showDetailMobile(item);
        });
      }

      resultBody.appendChild(tr);
    });

    bindCheckAll();
  }

  /* æ¡Œæ©Ÿè©³ç´°è³‡è¨Š */
  function showDetailDesktop(item){
    const img = item.imageUrl || "https://placehold.co/300x300?text=No+Image";

    let priceBlock = "";
    if (userLevel >= 1) priceBlock += `<div>50å€‹ï¼š${item.quote50}</div>`;
    if (userLevel >= 2) priceBlock += `<div>100å€‹ï¼š${item.quote100}</div><div>300å€‹ï¼š${item.quote300}</div>`;
    if (userLevel >= 3) priceBlock += `<div>500å€‹ï¼š${item.quote500}</div><div>1000å€‹ï¼š${item.quote1000}</div>`;

    const margin = calcMarginPctByQty(item);
    const marginHtml = margin === null
      ? `<div style="color:#aaa;font-size:13px;">æ¯›åˆ©è©¦ç®—ï¼šè«‹å…ˆé¸èµ·è¨‚é‡</div>`
      : `<div style="font-weight:700;color:#16a34a;">æ¯›åˆ©è©¦ç®—ï¼ˆ${qtySelect.value}å€‹ï¼‰ï¼š${margin}%</div>`;

    detailCard.style.display = "block";
    detailCard.innerHTML = `
      <img src="${img}" style="width:100%;border-radius:10px;border:1px solid #eee;margin-bottom:10px;">
      <div style="font-weight:700;font-size:16px;margin-bottom:6px;">${item.name}</div>

      <div style="font-size:14px;line-height:1.6;margin-bottom:10px;">
        <strong>ä¸»å‹è™Ÿï¼š</strong>${item.mainModel}<br>
        <strong>é¡è‰²ï¼š</strong>${item.colorList || "-"}<br>
        <strong>è³£å ´ï¼š</strong>${item.marketPrice}<br>
        <strong>æœ«å”®ï¼š</strong>${item.minPrice}<br>
        <strong>ç¶²å€ï¼š</strong>${item.productUrl ? `<a href="${item.productUrl}" target="_blank">å‰å¾€</a>` : "-"}
      </div>

      <div style="font-weight:700;margin-bottom:6px;">æ¡è³¼åƒ¹æ ¼</div>
      <div style="line-height:1.6;">${priceBlock}</div>

      <div style="margin-top:8px;">${marginHtml}</div>

      <div style="display:flex; gap:8px; margin-top:12px;">
        <button class="btn-primary line-btn" data-model="${item.model}" style="flex:1;">LINE åˆ†äº«</button>
        <button class="btn-outline-add add-quote-btn" data-model="${item.model}" style="flex:1;">åŠ å…¥å ±åƒ¹å–®</button>
      </div>
    `;
  }

  /* æ‰‹æ©Ÿè©³ç´°è³‡è¨Š */
  function showDetailMobile(item){
    const img = item.imageUrl || "https://placehold.co/300x300?text=No+Image";

    let priceBlock = "";
    if (userLevel >= 1) priceBlock += `<div>50å€‹ï¼š${item.quote50}</div>`;
    if (userLevel >= 2) priceBlock += `<div>100å€‹ï¼š${item.quote100}</div><div>300å€‹ï¼š${item.quote300}</div>`;
    if (userLevel >= 3) priceBlock += `<div>500å€‹ï¼š${item.quote500}</div><div>1000å€‹ï¼š${item.quote1000}</div>`;

    const margin = calcMarginPctByQty(item);
    const marginHtml = margin === null
      ? `<div style="color:#aaa;font-size:13px;">æ¯›åˆ©è©¦ç®—ï¼šè«‹å…ˆé¸èµ·è¨‚é‡</div>`
      : `<div style="font-weight:700;color:#16a34a;">æ¯›åˆ©è©¦ç®—ï¼ˆ${qtySelect.value}å€‹ï¼‰ï¼š${margin}%</div>`;

    sheetContent.innerHTML = `
      <img src="${img}" style="width:100%;border-radius:10px;border:1px solid #eee;margin-bottom:10px;">
      <div style="font-weight:700;font-size:16px;margin-bottom:6px;">${item.name}</div>

      <div style="font-size:14px;line-height:1.6;margin-bottom:10px;">
        <strong>ä¸»å‹è™Ÿï¼š</strong>${item.mainModel}<br>
        <strong>é¡è‰²ï¼š</strong>${item.colorList || "-"}<br>
        <strong>è³£å ´ï¼š</strong>${item.marketPrice}<br>
        <strong>æœ«å”®ï¼š</strong>${item.minPrice}<br>
      </div>

      <div style="font-weight:700;margin-bottom:6px;">æ¡è³¼åƒ¹æ ¼</div>
      <div style="line-height:1.6;">${priceBlock}</div>

      <div style="margin-top:8px;">${marginHtml}</div>
    `;
    openSheet();
  }

  function openSheet(){
    sheetBackdrop.classList.remove("hidden");
    mobileSheet.classList.remove("hidden");
    requestAnimationFrame(()=>mobileSheet.classList.add("open"));
  }

  function closeSheet(){
    mobileSheet.classList.remove("open");
    setTimeout(()=>{
      mobileSheet.classList.add("hidden");
      if (quoteSheet.classList.contains("hidden"))
        sheetBackdrop.classList.add("hidden");
    },220);
  }

  /* å‹¾é¸å…¨éƒ¨ */
  function bindCheckAll(){
    const checks = document.querySelectorAll(".row-check");

    checkAllBox.onchange = ()=>{
      checks.forEach(c=>c.checked = checkAllBox.checked);
    };

    checks.forEach(c=>{
      c.onchange = ()=>{
        const all = document.querySelectorAll(".row-check");
        const ok = document.querySelectorAll(".row-check:checked");
        checkAllBox.checked = (all.length === ok.length);
      };
    });
  }

  /* åŠ å…¥å ±åƒ¹å–® */
  document.addEventListener("click", e=>{
    /* å ±åƒ¹å–®æŒ‰éˆ• */
    if (e.target.classList.contains("add-quote-btn")){
      const model = e.target.dataset.model;
      const item = currentResultList.find(p=>p.model === model);
      if (!item) return;

      const qty = qtySelect.value || "50";
      const key = `quote${qty}`;
      const cost = Number(item[key] ?? item.quote50);

      quoteList.push({
        model: item.model,
        name: item.name,
        price: cost,
        qtyLabel: `${qty}å€‹`,
        marketPrice: item.marketPrice
      });

      alert(`å·²åŠ å…¥å ±åƒ¹å–®ï¼ˆ${qty}å€‹ï¼š$${cost}ï¼‰`);
    }

    /* LINE åˆ†äº« */
    if (e.target.classList.contains("line-btn")){
      const model = e.target.dataset.model;
      const item = currentResultList.find(p=>p.model === model);

      let costText = "";
      if (userLevel >= 1) costText += `50å€‹ï¼š${item.quote50}\n`;
      if (userLevel >= 2) costText += `100å€‹ï¼š${item.quote100}\n300å€‹ï¼š${item.quote300}\n`;
      if (userLevel >= 3) costText += `500å€‹ï¼š${item.quote500}\n1000å€‹ï¼š${item.quote1000}\n`;

      const text =
`ğŸ”¥ã€${item.model}ã€‘${item.name}
è³£å ´å”®åƒ¹ï¼š${item.marketPrice}
--------------------
æ¡è³¼åƒ¹æ ¼ï¼š
${costText}
å•†å“é€£çµï¼š${item.productUrl || "ç„¡"}`;

      navigator.clipboard.writeText(text)
        .then(()=>alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿"))
        .catch(()=>alert("è¤‡è£½å¤±æ•—"));
    }
  });

  /* å ±åƒ¹å–®å€ï¼šæ¸²æŸ“ */
  function renderQuoteSheet(){
    quoteListBody.innerHTML = "";

    if (quoteList.length === 0){
      quoteListBody.innerHTML =
        `<div style="text-align:center;padding:40px;color:#999;">å ±åƒ¹å–®æ˜¯ç©ºçš„</div>`;
      return;
    }

    quoteList.forEach((q, idx)=>{
      const mkt = Number(q.marketPrice || 0);
      const cost = Number(q.price || 0);
      let marginText = "æ¯›åˆ©ï¼š-";

      if (cost > 0 && mkt > 0){
        const pct = ((mkt - cost) / mkt) * 100;
        marginText = `æ¯›åˆ©ï¼š${Math.round(pct * 10) / 10}%`;
      }

      const div = document.createElement("div");
      div.className = "quote-item";

      div.innerHTML = `
        <div style="flex:1;">
          <div style="font-weight:700;">${q.name}</div>
          <div class="quote-info" style="color:#666;">
            ${q.model}ï½œ${q.qtyLabel}ï½œå–®åƒ¹ï¼š$${q.price}ï½œ
            <span style="font-weight:700;color:#16a34a;">${marginText}</span>
          </div>
        </div>
        <div class="quote-del" data-idx="${idx}">ğŸ—‘ï¸</div>
      `;

      div.querySelector(".quote-del").onclick = ()=>{
        quoteList.splice(idx,1);
        renderQuoteSheet();
      };

      quoteListBody.appendChild(div);
    });
  }

  /* é–‹å•Ÿå ±åƒ¹å–® */
  quoteToolbarBtn.onclick = ()=>{
    sheetBackdrop.classList.remove("hidden");
    quoteSheet.classList.remove("hidden");
    requestAnimationFrame(()=>quoteSheet.classList.add("open"));
    renderQuoteSheet();
  };

  /* é—œé–‰å ±åƒ¹å–® */
  quoteCloseBtn.onclick = ()=>{
    quoteSheet.classList.remove("open");
    setTimeout(()=>{
      quoteSheet.classList.add("hidden");
      if (mobileSheet.classList.contains("hidden"))
        sheetBackdrop.classList.add("hidden");
    },220);
  };

  /* é» backdrop é—œé–‰ sheet */
  sheetBackdrop.onclick = ()=>{
    closeSheet();
    quoteSheet.classList.remove("open");
    setTimeout(()=>{
      quoteSheet.classList.add("hidden");
      sheetBackdrop.classList.add("hidden");
    },220);
  };

  /* Excel åŒ¯å‡ºï¼ˆä¿æŒ v4.6 åŠŸèƒ½ï¼‰ */
  function exportSelectedExcel(){
    const rows = [];
    const header = ["å‹è™Ÿ","ä¸»å‹è™Ÿ","åç¨±","é¡è‰²åˆ—è¡¨","ç®±å…¥æ•¸","å•†å“é€£çµ"];
    rows.push(header);

    const checked = document.querySelectorAll(".row-check:checked");
    if (checked.length === 0){
      alert("è«‹å…ˆå‹¾é¸è¦åŒ¯å‡ºçš„å•†å“");
      return;
    }

    checked.forEach(c=>{
      const model = c.dataset.model;
      const item = currentResultList.find(p=>p.model === model);
      if (!item) return;

      rows.push([
        item.model,
        item.mainModel,
        item.name,
        item.colorList || "",
        item.cartonQty || "",
        item.productUrl || ""
      ]);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹");
    XLSX.writeFile(wb, "KINYO_å•†å“å ±åƒ¹.xlsx");
  }

  exportBtn.onclick = exportSelectedExcel;

  /* Enter å°±æœå°‹ */
  keywordInput.addEventListener("keypress", e=>{
    if (e.key === "Enter") searchProducts();
  });

  searchBtn.onclick = searchProducts;

  clearBtn.onclick = ()=>{
    keywordInput.value = "";
    qtySelect.value = "";
    minPriceInput.value = "";
    maxPriceInput.value = "";
    resultTable.style.display = "none";
    resultBody.innerHTML = "";
    detailCard.style.display = "none";
  };

  /* æ’åº */
  sortSelect.onchange = ()=>{
    if (currentResultList.length > 0){
      currentResultList = applySorting([...currentResultList]);
      renderResults(currentResultList);
    }
  };

  /* Auth */
  onAuthStateChanged(auth, async user=>{
    if (!user){
      window.location.href = "login.html";
      return;
    }

    currentUserEmail = user.email || "";
    const userDoc = await getDoc(doc(db, "Users", currentUserEmail.toLowerCase()));
    if (userDoc.exists()) userLevel = userDoc.data().level || 1;

    userInfoSpan.textContent = `ç™»å…¥å¸³è™Ÿï¼š${currentUserEmail.replace(/@.*/, "")}`;
    logoutBtn.style.display = "inline-block";

    setupQtySelectByLevel();
    preloadProducts();
  });

  logoutBtn.onclick = ()=>signOut(auth);

</script>
</body>
</html>