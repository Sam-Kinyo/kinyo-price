<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>KINYO æŸ¥åƒ¹ç³»çµ±ï¼ˆv5.2.7ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- PptxGenJS for PPT export & XLSX for Excel -->
<script src="https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
/* =========================================
   Root è®Šæ•¸
========================================= */
:root{
  --bg:#f5f6f8;
  --card:#ffffff;
  --primary:#111827;
  --primary-blue:#2563eb;
  --border:#e5e7eb;
  --text:#1f2937;
  --muted:#6b7280;
  --radius:12px;
  --shadow:0 4px 12px rgba(0,0,0,0.06);

  --loading-bg:#e5e7eb;
  --loading-fill:#3b82f6;
}

/* =========================================
   Body
========================================= */
body{
  margin:0;
  padding:24px;
  background:var(--bg);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--text);
  max-width:980px;
  margin:0 auto;
}

h1{margin:0 0 4px;}
.subtitle{
  color:var(--muted);
  margin-bottom:18px;
  font-size:14px;
}

/* =========================================
   Top Bar
========================================= */
.top-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:14px;
}
.user-badge{
  background:#eef0f4;
  padding:6px 14px;
  border-radius:999px;
  font-size:13px;
  transition: all 0.3s ease;
}
.logout-btn{
  padding:6px 14px;
  border-radius:999px;
  border:1px solid var(--border);
  cursor:pointer;
  background:white;
  font-size:12px;
}

/* =========================================
   Toolbar
========================================= */
.toolbar{
  display:flex;
  gap:10px;
  align-items:center;
  margin:10px 0 6px;
  flex-wrap: wrap;
  transition: all 0.3s ease;
}
.toolbar select{ flex:1; min-width: 120px; }

/* ğŸš€ æ–°å¢ï¼šå·¥å…·åˆ—æ‡¸æµ®æ¨£å¼ (ç•¶æœ‰å‹¾é¸æ™‚è§¸ç™¼) */
.toolbar.fixed-active {
  position: fixed;
  bottom: 30px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 2000;
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(10px);
  padding: 12px 20px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.25);
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: 24px;
  width: auto;
  max-width: 92%;
  justify-content: center;
  animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes popUp {
  from { transform: translate(-50%, 100%); opacity: 0; }
  to { transform: translate(-50%, 0); opacity: 1; }
}

/* ä½”ä½å€å¡Šï¼Œé˜²æ­¢æ‡¸æµ®æ™‚ç‰ˆé¢è·³å‹• */
#toolbarSpacer {
  height: 70px;
  display: none;
}

.quote-toolbar-btn{
  padding:10px 16px;
  border-radius:999px;
  border:1px solid var(--border);
  background:white;
  cursor:pointer;
  font-size:14px;
  white-space:nowrap;
  display:none;
}

/* =========================================
   æœå°‹å€å¡Š
========================================= */
.search-box{
  background:var(--card);
  padding:18px;
  border-radius:var(--radius);
  box-shadow:0 8px 28px rgba(0,0,0,0.15);
  margin-bottom:12px;
}
.search-row{margin-bottom:14px;}
label{
  font-weight:600;
  margin-bottom:6px;
  display:block;
  font-size:14px;
}
input,select{
  width:100%;
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:15px;
  box-sizing:border-box;
}

/* =========================================
   Buttons
========================================= */
.btn-primary{
  background:var(--primary);
  color:white;
  border:none;
  border-radius:999px;
  padding:12px 20px;
  font-weight:600;
  cursor:pointer;
  width:100%;
}
.btn-secondary{
  background:white;
  border:1px solid var(--border);
  padding:10px 16px;
  border-radius:999px;
  cursor:pointer;
  font-size:14px;
  white-space:nowrap;
}
.btn-secondary:disabled {
  color: #ccc;
  cursor: not-allowed;
}
.btn-outline-add{
  padding:6px 12px;
  border-radius:6px;
  border:1px solid #2563eb;
  background:#eff6ff;
  color:#2563eb;
  font-size:12px;
  cursor:pointer;
  font-weight:600;
}
.btn-outline-add:hover{background:#dbeafe;}

/* =========================================
   è¡¨æ ¼
========================================= */
table{
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:var(--radius);
  box-shadow:0 8px 28px rgba(0,0,0,0.15);
}
th,td{
  padding:12px 10px;
  border-bottom:1px solid var(--border);
  font-size:14px;
  vertical-align:top;
}
th{background:#fafafa;text-align:left;}

.product-img{
  width:110px;height:110px;
  object-fit:cover;
  border-radius:14px;
  border:1px solid #e5e7eb;
  cursor: pointer;
}
.model-cell {
  cursor: pointer;
}
.model-cell:hover {
  color: var(--primary-blue);
  text-decoration: underline;
}

/* åƒ¹æ ¼æ¨™ç±¤ */
.price-tag{
  padding:3px 8px;
  font-size:12px;
  border-radius:6px;
  display:inline-block;
  margin-right:6px;
  margin-bottom:4px;
  font-weight:600;
  white-space:nowrap;
}
.tag50{background:#dbeafe;color:#1e40af;}
.tag100{background:#e0f2fe;color:#0369a1;}
.tag300{background:#dcfce7;color:#15803d;}
.tag500{background:#ffedd5;color:#ea580c;}
.tag1000{background:#fee2e2;color:#b91c1c;}

/* =========================================
   Loading
========================================= */
#centerLoadingBox{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.35);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
#centerLoadingCard{
  background:rgba(255,255,255,0.65);backdrop-filter:blur(14px);
  width:280px;
  padding:20px;
  border-radius:12px;
  box-shadow:0 8px 28px rgba(0,0,0,0.15);
}
.loading-title{
  font-size:15px;
  font-weight:700;
  margin-bottom:12px;
}
.loading-bar .fill{
  height:100%;
  width:0%;
  background:var(--loading-fill);
  transition:width .15s linear;
}

/* =========================================
   Detail Card
========================================= */
#detailCard{
  position:fixed;
  right:20px;
  top:120px;
  width:360px;
  max-height:78vh;
  overflow-y:auto;
  background:white;
  padding:18px;
  border-radius:var(--radius);
  box-shadow:0 8px 28px rgba(0,0,0,0.15);
  display:none;
  z-index:999;
}

/* å³ä¸Šè§’é—œé–‰æŒ‰éˆ•æ¨£å¼ */
.card-close-btn {
  position: absolute; 
  top: 12px; 
  right: 12px; 
  width: 32px; 
  height: 32px; 
  border-radius: 50%; 
  background: #f3f4f6; 
  border: 1px solid #e5e7eb;
  color: #6b7280; 
  font-size: 20px; 
  cursor: pointer; 
  display: flex; 
  align-items: center; 
  justify-content: center;
  z-index: 20;
  transition: all 0.2s;
}
.card-close-btn:hover {
  background: #e5e7eb;
  color: #ef4444; /* Hoveræ™‚è®Šç´…è‰² */
  transform: scale(1.1);
}

/* =========================================
   ç¶²è·¯åœ– grid
========================================= */
.net-gallery{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:6px;
  margin-top:10px;
}
.net-gallery img{
  width:100%;
  border-radius:6px;
  border:1px solid #e5e7eb;
  object-fit:cover;
  cursor: pointer;
  transition: transform 0.2s;
}
.net-gallery img:hover {
  transform: scale(1.05);
}

.btn-blue{
  display:inline-block;
  background:#2563eb;
  color:white;
  padding:10px 18px;
  border-radius:999px;
  font-size:14px;
  font-weight:600;
  text-decoration:none;
  margin:6px 0;
}

/* =========================================
   Mobile Sheet
========================================= */
.sheet-backdrop{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.45);
  z-index:1000;
}
.sheet{
  position:fixed;left:0;right:0;bottom:0;
  height:80vh;background:#fff;
  border-radius:16px 16px 0 0;
  transform:translateY(100%);
  transition:transform .25s ease;
  display:flex;flex-direction:column;
  z-index:1001;
}
.sheet.open{transform:translateY(0);}
.sheet-header{
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  font-weight:700;
  display:flex;justify-content:space-between;align-items:center;
}
.sheet-close{
  background:none;border:none;
  font-size:26px;cursor:pointer;line-height:1;
}
.sheet-content{
  padding:16px;overflow-y:auto;font-size:15px;flex:1;
}
.hidden{display:none!important;}

.quote-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 0;border-bottom:1px solid #eee;
}
.quote-info{font-size:14px;color:#666;}
.quote-price{font-weight:700;color:#2563eb;}
.quote-del{color:#999;cursor:pointer;padding:6px;font-size:16px;}
.quote-del:hover{color:#ef4444;}

/* =========================================
   Login Overlay
========================================= */
#loginOverlay {
  position: fixed;
  inset: 0;
  background: #f5f6f8;
  z-index: 3000;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}
.login-card {
  background: white;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  width: 90%;
  max-width: 400px;
  text-align: center;
}
.login-card h2 {
  margin-top: 0;
  color: var(--primary);
}
.login-input {
  width: 100%;
  margin-bottom: 12px;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-sizing: border-box;
}
.login-btn {
  width: 100%;
  padding: 12px;
  background: var(--primary-blue);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  margin-top: 10px;
}
.login-btn:hover {
  background: #1d4ed8;
}
.login-error {
  color: #ef4444;
  margin-top: 10px;
  font-size: 14px;
  display: none;
}

/* =========================================
   RWD
========================================= */
@media (max-width:900px){
  #detailCard{display:none!important;}
}
@media (max-width:600px){
  body{padding:14px;}
  .search-box{padding:14px;}
  input,select{font-size:14px;}
  
  /* RWD Card View Styles */
  thead { display: none; }
  table, tbody, tr, td { display: block; width: 100%; }
  
  tr {
    margin-bottom: 16px;
    border: 1px solid #e5e7eb;
    border-radius: 16px;
    background: #fff;
    padding: 16px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    position: relative;
    box-sizing: border-box; 
  }

  /* 1. å‹¾é¸æ¡† (çµ•å°å®šä½å·¦ä¸Š) */
  td:nth-of-type(1) {
    position: absolute;
    top: 12px;
    left: 12px;
    width: auto;
    padding: 0;
    border: none;
    z-index: 10;
  }

  /* 2. åœ–ç‰‡ (ç½®ä¸­) */
  td:nth-of-type(2) {
    text-align: center;
    border: none;
    padding-bottom: 10px;
  }
  .product-img {
    width: 140px; height: 140px; 
  }

  /* 3. ä¸»å‹è™Ÿ (ç½®ä¸­ç°å­—) */
  td:nth-of-type(3) {
    text-align: center;
    color: #888;
    font-size: 13px;
    border: none;
    padding: 0 0 8px 0;
  }

  /* 4. å•†å“è³‡è¨Š (åç¨±, é¡è‰², åƒ¹æ ¼æ¨™ç±¤) */
  td:nth-of-type(4) {
    border: none;
    padding: 0 0 12px 0;
  }

  /* 5. åƒ¹æ ¼å€å¡Š (æœ«å”® & è³£å ´) - ä¸¦æ’é¡¯ç¤º */
  td:nth-of-type(5), td:nth-of-type(6) {
    border: none;
    padding: 8px 12px;
    background: #f9fafb;
    margin-bottom: 4px;
    border-radius: 8px;
    display: flex; 
    justify-content: space-between; 
    align-items: center;
    font-size: 14px;
    font-weight: bold;
  }

  /* åŠ ä¸Šæ¨™é¡Œ (å½å…ƒç´ ) */
  td:nth-of-type(5)::before {
    content: "æœ«å”®åƒ¹æ ¼";
    font-weight: normal;
    color: #6b7280;
  }
  td:nth-of-type(6)::before {
    content: "è³£å ´åƒ¹æ ¼";
    font-weight: normal;
    color: #6b7280;
  }
  
  /* éš±è—åŸæœ¬çš„ç©ºç™½ TD é‚Šæ¡† */
  td { border-bottom: none !important; }
}
</style>
</head>
<body>

<!-- Login Overlay -->
<div id="loginOverlay">
  <div class="login-card">
    <h2>KINYO æŸ¥åƒ¹ç³»çµ±</h2>
    <p style="color:#666;margin-bottom:20px;">è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ç™»å…¥</p>
    <input type="email" id="loginEmail" class="login-input" placeholder="é›»å­ä¿¡ç®±">
    <input type="password" id="loginPassword" class="login-input" placeholder="å¯†ç¢¼">
    <button id="doLoginBtn" class="login-btn">ç™»å…¥</button>
    <div id="loginError" class="login-error"></div>
  </div>
</div>

<!-- Loading -->
<div id="centerLoadingBox">
  <div id="centerLoadingCard">
    <div class="loading-title">å•†å“è¼‰å…¥ä¸­...</div>
    <div id="centerLoadingBar" class="loading-bar">
      <div class="fill"></div>
    </div>
  </div>
</div>

<div class="top-bar">
  <span id="userInfo" class="user-badge">æœªç™»å…¥</span>
  <button id="logoutBtn" class="logout-btn" style="display:none;">ç™»å‡º</button>
</div>

<h1>KINYO æŸ¥åƒ¹ç³»çµ±</h1>
<div class="subtitle">
  éƒ­åº­è±ªå˜”å¿ƒç€è¡€ä¹‹ä½œï¼ˆv5.2.7ï¼‰ã€€ä»»ä½•å»ºè­°ï¼š0976-966-333
</div>

<form id="searchForm" class="search-box">
  <div class="search-row">
    <label>é—œéµå­—æœå°‹ï¼ˆå‹è™Ÿ / åç¨±ï¼‰</label>
    <input id="keyword" placeholder="å¦‚ï¼šCL528 / æ•èšŠç‡ˆ / é™¤æ¯›çƒæ©Ÿ" autocomplete="off" />
  </div>

  <div class="search-row">
    <label>èµ·è¨‚é‡ï¼ˆå¯ä¸é¸ï¼‰</label>
    <select id="qtySelect"></select>
  </div>

  <div class="search-row">
    <label>é ç®—å€é–“ï¼ˆèµ·è¨‚é‡å·²é¸æ™‚æ‰ç”Ÿæ•ˆï¼›å¯åªå¡«ä¸€é‚Šï¼‰</label>
    <div style="display:flex; gap:10px;">
      <input id="minPrice" type="number" placeholder="æœ€ä½ (å¯ç©º)">
      <input id="maxPrice" type="number" placeholder="æœ€é«˜ (å¯ç©º)">
    </div>
  </div>

  <button id="searchBtn" type="submit" class="btn-primary">æŸ¥è©¢</button>
  <button id="clearBtn" type="button" class="btn-secondary" style="margin-top:10px;width:100%;">æ¸…é™¤æœå°‹æ¢ä»¶</button>
</form>

<div class="toolbar">
  <select id="sortSelect" class="btn-secondary">
    <option value="">ä¸æ’åº (éš¨æ©Ÿ)</option>
    <option value="minPriceAsc">æœ«å”®ï¼šä½ â†’ é«˜</option>
    <option value="minPriceDesc">æœ«å”®ï¼šé«˜ â†’ ä½</option>
    <option value="marketAsc">è³£å ´ï¼šä½ â†’ é«˜</option>
    <option value="marketDesc">è³£å ´ï¼šé«˜ â†’ ä½</option>
    <option value="alphaAsc">ä¸»å‹è™Ÿï¼šA â†’ Z</option>
    <option value="alphaDesc">ä¸»å‹è™Ÿï¼šZ â†’ A</option>
  </select>
  <button id="multiLineBtn" class="btn-secondary" disabled>å¤šé¸ LINE åˆ†äº«</button>
  <button id="exportBtn" class="btn-secondary" disabled>åŒ¯å‡º Excel</button>
  <button id="quoteToolbarBtn" class="quote-toolbar-btn">å ±åƒ¹å–®</button>
  <button id="pptToolbarBtn" class="btn-secondary" disabled>ç”Ÿæˆ PPTï¼ˆ1â€“20ï¼‰</button>
</div>
<div id="toolbarSpacer"></div>

<table id="resultTable" style="display:none;">
  <thead>
    <tr>
      <th style="width:32px;"><input type="checkbox" id="checkAll" /></th>
      <th style="width:120px;">åœ–ç‰‡</th>
      <th style="width:100px;">ä¸»å‹è™Ÿ</th>
      <th>å•†å“è³‡è¨Š</th>
      <th style="width:80px;">æœ«å”®</th>
      <th style="width:80px;">è³£å ´</th>
    </tr>
  </thead>
  <tbody id="resultBody"></tbody>
</table>

<div id="detailCard"></div>

<div id="sheetBackdrop" class="sheet-backdrop hidden"></div>
<div id="mobileDetailSheet" class="sheet hidden">
  <div class="sheet-header">
    <span>å•†å“è³‡è¨Š</span>
    <button id="sheetCloseBtn" class="sheet-close">Ã—</button>
  </div>
  <div class="sheet-content" id="sheetContent"></div>
</div>

<div id="quoteSheet" class="sheet hidden">
  <div class="sheet-header">
    <span>å ±åƒ¹å–®é è¦½</span>
    <button id="quoteCloseBtn" class="quote-close">Ã—</button>
  </div>

  <div class="sheet-content" style="display:flex;flex-direction:column;">
    <div id="quoteListBody" style="flex:1;overflow-y:auto;"></div>

    <div style="border-top:1px solid #eee; padding-top:12px; margin-top:10px;">
      <button id="copyQuoteBtn" class="btn-primary" style="width:100%;">è¤‡è£½æ•´å¼µå ±åƒ¹å–® (LINE)</button>
      <button id="downloadQuoteExcelBtn" class="btn-secondary" style="width:100%;margin-top:8px;">ä¸‹è¼‰ Excel å ±åƒ¹å–®</button>
      <button id="clearQuoteBtn" class="btn-secondary" style="width:100%;margin-top:8px;color:#ef4444;border-color:#ef4444;">æ¸…ç©ºå ±åƒ¹å–®</button>
    </div>
  </div>
</div>


<script type="module">
/* =======================================================
   1. è¨­å®šæ‚¨çš„ LOGO ç¶²å€
======================================================= */
const COMPANY_LOGO_URL = "https://drive.google.com/file/d/1JxoU3A5qAYsE39pc2z7IMVwVS8-uTOIn/view?usp=drive_link"; 

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, initializeFirestore } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtp6rwV7KmIOedLQ9793BnXbBquopP9kM",
  authDomain: "kinyo-price.firebaseapp.com",
  projectId: "kinyo-price",
  storageBucket: "kinyo-price.firebasestorage.app",
  messagingSenderId: "122464645678",
  appId: "1:122464645678:web:c0febbc6297a8ada5ea5bf",
  measurementId: "G-R0PWMZNSJH"
};

const app  = initializeApp(firebaseConfig);
const db = initializeFirestore(app, { experimentalForceLongPolling: true });
const auth = getAuth(app);

const searchForm      = document.getElementById("searchForm");
const keywordInput    = document.getElementById("keyword");
const qtySelect       = document.getElementById("qtySelect");
const minPriceInput   = document.getElementById("minPrice");
const maxPriceInput   = document.getElementById("maxPrice");
const sortSelect      = document.getElementById("sortSelect");
const exportBtn       = document.getElementById("exportBtn");
const pptToolbarBtn   = document.getElementById("pptToolbarBtn");
const multiLineBtn    = document.getElementById("multiLineBtn");
const clearBtn        = document.getElementById("clearBtn");

const resultTable     = document.getElementById("resultTable");
const resultBody      = document.getElementById("resultBody");
const checkAllBox     = document.getElementById("checkAll");
const detailCard      = document.getElementById("detailCard");

const userInfoSpan    = document.getElementById("userInfo");
const logoutBtn       = document.getElementById("logoutBtn");

const sheetBackdrop   = document.getElementById("sheetBackdrop");
const mobileSheet     = document.getElementById("mobileDetailSheet");
const sheetContent    = document.getElementById("sheetContent");
const sheetCloseBtn   = document.getElementById("sheetCloseBtn");

const quoteSheet      = document.getElementById("quoteSheet");
const quoteCloseBtn   = document.getElementById("quoteCloseBtn");
const quoteListBody   = document.getElementById("quoteListBody");
const copyQuoteBtn    = document.getElementById("copyQuoteBtn");
const clearQuoteBtn   = document.getElementById("clearQuoteBtn");
const downloadQuoteExcelBtn = document.getElementById("downloadQuoteExcelBtn");
const quoteToolbarBtn = document.getElementById("quoteToolbarBtn");

const centerLoadingBox = document.getElementById("centerLoadingBox");
const centerLoadingBar = document.getElementById("centerLoadingBar");

// Login Elements
const loginOverlay = document.getElementById("loginOverlay");
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const doLoginBtn = document.getElementById("doLoginBtn");
const loginError = document.getElementById("loginError");

let productCache = [];
let currentResultList = [];
let userLevel = 1;
let currentUserEmail = "";
let quoteList = [];
let isProductsLoaded = false;
let isQuotesLoaded = false;

const CACHE_TTL = 1000 * 60 * 60 * 6; 

function getCacheKey() {
  const mail = (currentUserEmail || "guest").toLowerCase();
  return `KINYO_SAFE_CACHE_V1_${mail}`;
}

function loadCache() {
  try {
    const raw = localStorage.getItem(getCacheKey());
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj || !obj.time || !Array.isArray(obj.data)) return null;
    if (Date.now() - obj.time > CACHE_TTL) return null;
    return obj.data;
  } catch { return null; }
}

function saveCache(data) {
  try {
    localStorage.setItem(getCacheKey(), JSON.stringify({ time: Date.now(), data }));
  } catch {}
}

let driveMap = new Map();
let mainFolderMap = new Map();
let netMap    = new Map();
let netImagesMap = new Map();
let isDriveLoaded = false;

function showLoading() {
  centerLoadingBox.style.display = "flex";
  centerLoadingBar.querySelector(".fill").style.width = "0%";
  setTimeout(() => { centerLoadingBar.querySelector(".fill").style.width = "55%"; }, 120);
}
function hideLoading() {
  centerLoadingBar.querySelector(".fill").style.width = "100%";
  setTimeout(() => { centerLoadingBox.style.display = "none"; }, 0);
}

// ğŸš€ æ›´æ–°ä½¿ç”¨è€…ç‹€æ…‹é¡¯ç¤º (ç”¨æ–¼æœå°‹ä¸­æç¤º)
function updateUserDisplay(status) {
  if (!userInfoSpan) return;
  if (status === 'searching') {
    userInfoSpan.textContent = "ğŸ” æœå°‹é‹ç®—ä¸­...";
    userInfoSpan.style.background = "#fef9c3"; // Yellow
    userInfoSpan.style.color = "#854d0e";
  } else {
    userInfoSpan.textContent = `ç™»å…¥å¸³è™Ÿï¼š${currentUserEmail.replace(/@.*/, "")}`;
    userInfoSpan.style.background = "#eef0f4";
    userInfoSpan.style.color = "inherit";
  }
}

// ğŸš€ Firestore Retry Helper
async function getDocsWithRetry(queryRef, retries = 3, delay = 1000) {
    for (let i = 0; i < retries; i++) {
        try {
            return await getDocs(queryRef);
        } catch (err) {
            console.warn(`Attempt ${i + 1} failed. Retrying in ${delay}ms...`, err);
            if (i === retries - 1) throw err;
            await new Promise(res => setTimeout(res, delay));
        }
    }
}

// ğŸš€ æ™ºæ…§å‹è™Ÿæ­£è¦åŒ– (èˆ‡ Python åŒæ­¥)
function normalizeKey(key) {
    if (!key) return "";
    // 1. Force Upper Case FIRST
    let base = key.split('.')[0].split('_')[0].toUpperCase();
    // 2. Remove hyphens
    base = base.replace(/-/g, '');
    // 3. Match Letters + Digits pattern
    let m = base.match(/^([a-zA-Z]+)(\d+)([a-zA-Z]*)$/);
    if (m) {
        // Return Letters + Digits only (ignore color suffix in key)
        return (m[1] + m[2]);
    }
    return base;
}

// ğŸš€ éš¨æ©Ÿæ´—ç‰Œå‡½å¼
function shuffleArray(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

async function preloadDriveModelData() {
  try {
    const res = await fetch(`./modelData.json?v=${Date.now()}`, { cache: "no-store" });
    if (!res.ok) throw new Error("modelData.json è®€å–å¤±æ•—");
    const data = await res.json();

    driveMap.clear(); netMap.clear(); netImagesMap.clear(); mainFolderMap.clear();

    (data.models || []).forEach(m => {
      // ğŸš€ ä½¿ç”¨æ­£è¦åŒ–å¾Œçš„ Key å­˜å…¥ Map
      const rawKey = String(m.mainModel || m.model || "").trim();
      if (!rawKey) return;
      const key = normalizeKey(rawKey);

      if (m.mainImage) driveMap.set(key, m.mainImage);
      if (m.folderUrl) mainFolderMap.set(key, m.folderUrl);
      
      const folderUrl = m.netGalleryUrl || m.netFolderUrl || m.folderUrl || m.folderLink || "";
      if (folderUrl) netMap.set(key, folderUrl);

      let finalImages = [];
      if (Array.isArray(m.netImages) && m.netImages.length > 0) {
          finalImages = m.netImages.filter(Boolean);
      }
      else if (Array.isArray(m.images) && m.images.length > 0) {
          finalImages = m.images.map(x => x.url).filter(Boolean);
      }
      
      if (finalImages.length > 0) {
         netImagesMap.set(key, finalImages);
      }
    });
    isDriveLoaded = true;
  } catch (e) {
    console.warn("Drive è¼‰å…¥å¤±æ•—", e);
    isDriveLoaded = false;
  }
}

// ğŸš€ Lookup Functions now use normalizeKey
function getDriveMainImage(model, mainModel) {
  const k1 = normalizeKey(model);
  const k2 = normalizeKey(mainModel);
  return driveMap.get(k1) || driveMap.get(k2) || "";
}
function getDriveMainFolder(model, mainModel){
  const k1 = normalizeKey(model);
  const k2 = normalizeKey(mainModel);
  return mainFolderMap.get(k1)||mainFolderMap.get(k2)||"";
}
function getDriveNetGallery(model, mainModel) {
  const k1 = normalizeKey(model);
  const k2 = normalizeKey(mainModel);
  return netMap.get(k1) || netMap.get(k2) || "";
}
function getDriveNetImages(model, mainModel){
  const k1 = normalizeKey(model);
  const k2 = normalizeKey(mainModel);
  return netImagesMap.get(k1) || netImagesMap.get(k2) || [];
}

function getMainModel(model) {
  if (!model) return "";
  const raw = String(model).trim().toUpperCase();
  if (!raw) return "";
  const m = raw.match(/^([A-Z]+[0-9]+)([A-Z]{1,3})$/);
  if (m) return m[1];
  if (raw.includes("-")) {
    const parts = raw.split("-");
    const last = parts[parts.length - 1];
    if (/^[A-Z]{1,3}$/.test(last)) return raw.replace(/-[A-Z]{1,3}$/, "");
  }
  return raw;
}

async function preloadProducts() {
  const cached = loadCache();
  if (cached && cached.length) {
    productCache = cached.map(p => ({
      ...p,
      model: (p.model || "").trim(),
      mainModel: p.mainModel || getMainModel(p.model || ""),
      searchKey: (p.searchKey || `${p.model||""} ${p.mainModel||""} ${p.name||""}`.toLowerCase())
    }));
    isProductsLoaded = true;
    isQuotesLoaded = false;
    refreshProductsFromFirestore();
    return;
  }
  showLoading();
  isProductsLoaded = false;
  isQuotesLoaded = false;
  try {
    const snap = await getDocsWithRetry(collection(db, "Products"));
    const fullList = [];
    snap.forEach(docSnap => {
      const d = docSnap.data() || {};
      const model = (d.model || "").trim();
      const mainModel = getMainModel(model);
      let colorList = (d.colorList || "").trim();
      if (!colorList) {
        const suffix = model.toUpperCase().replace(mainModel, "");
        if (suffix && /^[A-Z]{1,3}$/.test(suffix)) colorList = suffix;
      }
      const searchKey = `${model} ${mainModel} ${d.name || ""}`.toLowerCase();
      fullList.push({ ...d, model, mainModel, colorList, searchKey });
    });
    productCache = fullList;
    isProductsLoaded = true;
    isQuotesLoaded = true;
    const safeList = fullList.map(p => {
      const c = { ...p };
      delete c.quote50; delete c.quote100; delete c.quote300; delete c.quote500; delete c.quote1000;
      return c;
    });
    saveCache(safeList);
  } catch (e) {
    console.error(e);
  }
  hideLoading();
}

async function refreshProductsFromFirestore() {
  try {
    const snap = await getDocsWithRetry(collection(db, "Products"));
    const fullList = [];
    snap.forEach(docSnap => {
      const d = docSnap.data() || {};
      const model = (d.model || "").trim();
      const mainModel = getMainModel(model);
      let colorList = (d.colorList || "").trim();
      if (!colorList) {
        const suffix = model.toUpperCase().replace(mainModel, "");
        if (suffix && /^[A-Z]{1,3}$/.test(suffix)) colorList = suffix;
      }
      const searchKey = `${model} ${mainModel} ${d.name || ""}`.toLowerCase();
      fullList.push({ ...d, model, mainModel, colorList, searchKey });
    });
    productCache = fullList;
    isQuotesLoaded = true;
    const safeList = fullList.map(p => {
      const c = { ...p };
      delete c.quote50; delete c.quote100; delete c.quote300; delete c.quote500; delete c.quote1000;
      return c;
    });
    saveCache(safeList);
  } catch(e) { console.warn(e); }
}

function setupQtySelectByLevel() {
  qtySelect.innerHTML = "";
  const emptyOpt = document.createElement("option");
  emptyOpt.value = ""; emptyOpt.textContent = "ä¸ä½¿ç”¨èµ·è¨‚é‡";
  qtySelect.appendChild(emptyOpt);
  const add = (v,t)=>{
    const o = document.createElement("option"); o.value = v; o.textContent = t; qtySelect.appendChild(o);
  };
  if (userLevel >= 1) add("50", "50 å€‹");
  if (userLevel >= 2) { add("100", "100 å€‹"); add("300", "300 å€‹"); }
  if (userLevel >= 3) { add("500", "500 å€‹"); add("1000", "1000 å€‹"); }
}

function mergeByMainModel(list) {
  const map = {};
  list.forEach(item => {
    const main = item.mainModel || getMainModel(item.model);
    if (!map[main]) {
      map[main] = { ...item, models: [item.model], colorList: item.colorList || "-" };
    } else {
      map[main].models.push(item.model);
      const exist = map[main].colorList.split(" / ").filter(Boolean);
      const incoming = (item.colorList || "").split(" / ").filter(Boolean);
      map[main].colorList = [...new Set([...exist, ...incoming])].join(" / ");
    }
  });
  return Object.values(map);
}

function applySorting(list) {
  const o = sortSelect.value;
  if (o === "minPriceAsc")  return list.sort((a,b)=> (a.minPrice||0) - (b.minPrice||0));
  if (o === "minPriceDesc") return list.sort((a,b)=> (b.minPrice||0) - (a.minPrice||0));
  if (o === "marketAsc")    return list.sort((a,b)=> (a.marketPrice||0) - (b.marketPrice||0));
  if (o === "marketDesc")   return list.sort((a,b)=> (b.marketPrice||0) - (a.marketPrice||0));
  if (o === "alphaAsc")     return list.sort((a,b)=> (a.mainModel||"").localeCompare(b.mainModel||""));
  if (o === "alphaDesc")    return list.sort((a,b)=> (b.mainModel||"").localeCompare(a.mainModel||""));
  return list;
}

function searchProducts() {
  if (!isProductsLoaded) { alert("å•†å“è³‡æ–™è¼‰å…¥ä¸­"); return; }
  
  const key = keywordInput.value.trim().toLowerCase();
  const qty = qtySelect.value;
  const minPraw = minPriceInput.value.trim();
  const maxPraw = maxPriceInput.value.trim();
  
  const hasKey = !!key;
  const hasQty = !!qty;
  const hasBudget = !!minPraw || !!maxPraw;

  if (hasBudget && !hasQty) {
    alert("æœå°‹é ç®—å€é–“æ™‚ï¼Œå¿…é ˆé¸æ“‡ã€Œèµ·è¨‚é‡ã€ï¼");
    return;
  }
  
  if (hasQty && !hasKey && !hasBudget) {
    alert("é¸æ“‡èµ·è¨‚é‡å¾Œï¼Œè«‹è¼¸å…¥ã€Œé—œéµå­—ã€æˆ–ã€Œé ç®—å€é–“ã€ï¼");
    return;
  }
  
  if (!hasKey && !hasQty && !hasBudget) {
    alert("è«‹è¼¸å…¥æœå°‹æ¢ä»¶ï¼ˆé—œéµå­—ã€èµ·è¨‚é‡ã€é ç®—ï¼‰");
    return;
  }

  const _needsQuote = hasQty && hasBudget;
  if (_needsQuote && !isQuotesLoaded) { alert("å ±åƒ¹è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™"); return; }

  showLoading();
  updateUserDisplay('searching');

  setTimeout(() => {
    let r = productCache;

    if (hasKey) {
      r = r.filter(p => (p.searchKey || "").includes(key));
    }

    if (hasBudget) {
      const min = minPraw ? Number(minPraw) : 0;
      const max = maxPraw ? Number(maxPraw) : Number.MAX_SAFE_INTEGER;
      const k = `quote${qty}`;
      r = r.filter(p => {
        const price = Number(p[k]) || 0;
        return price >= min && price <= max;
      });
    }

    // ğŸš€ éš¨æ©Ÿæ’åºé‚è¼¯ï¼šå¦‚æœæ²’æœ‰æŒ‡å®šæ’åºï¼Œå°±éš¨æ©Ÿæ´—ç‰Œ
    currentResultList = mergeByMainModel(r);
    if (!sortSelect.value) {
        currentResultList = shuffleArray(currentResultList);
    } else {
        currentResultList = applySorting(currentResultList);
    }
    
    renderResults(currentResultList);
    hideLoading();
    updateUserDisplay('normal');
  }, 0);
}

function renderResults(list) {
  resultBody.innerHTML = ""; detailCard.style.display = "none"; checkAllBox.checked = false; updateMultiLineBtnState();
  if (list.length === 0) {
    resultTable.style.display = "none"; exportBtn.disabled = true; pptToolbarBtn.disabled = true; return;
  }
  resultTable.style.display = "table"; exportBtn.disabled = false; pptToolbarBtn.disabled = false;

  list.forEach(item => {
    let img = item.imageUrl;
    if (!img || !img.startsWith("http")) {
      const driveImg = getDriveMainImage(item.model, item.mainModel);
      if (driveImg) img = driveImg;
      else img = "https://placehold.co/110x110?text=No+Image";
    }
  
    const tr = document.createElement("tr");
    let priceHtml = "";

    // ğŸš€ éš±è—å ±åƒ¹é‚è¼¯ï¼šuserLevel < 1 (å³ 0) æ™‚ï¼Œåƒ¹æ ¼éƒ½é¡¯ç¤º ---
    const showPrice = userLevel >= 1;
    const getPrice = (p) => showPrice ? (item[p] ?? "-") : "---";

    if (userLevel >= 1) priceHtml += `<span class="price-tag tag50">50å€‹ï¼š${getPrice('quote50')}</span>`;
    if (userLevel >= 2) {
      priceHtml += `<span class="price-tag tag100">100å€‹ï¼š${getPrice('quote100')}</span>`;
      priceHtml += `<span class="price-tag tag300">300å€‹ï¼š${getPrice('quote300')}</span>`;
    }
    if (userLevel >= 3) {
      priceHtml += `<span class="price-tag tag500">500å€‹ï¼š${getPrice('quote500')}</span>`;
      priceHtml += `<span class="price-tag tag1000">1000å€‹ï¼š${getPrice('quote1000')}</span>`;
    }
    tr.innerHTML = `
      <td><input type="checkbox" class="row-check" data-model="${item.model}"></td>
      <td>
        <img src="${img}" class="product-img" onerror="this.onerror=null;this.src='https://placehold.co/110x110?text=No+Image';">
      </td>
      <td class="model-cell">${item.mainModel || "-"}</td>
      <td>
        <div style="font-weight:700;margin-bottom:4px;">${item.name || "-"}</div>
        <div style="font-size:13px;color:#555;margin-bottom:4px;">é¡è‰²ï¼š${item.colorList || "-"}</div>
        <div class="price-tag-container" style="font-size:13px;margin-bottom:4px;">${priceHtml}</div>
        <div style="display:flex; gap:6px;">
          <button class="line-share-btn" data-model="${item.model}" style="margin-top:6px;padding:6px 10px;font-size:12px;background:#06C755;color:#fff;border:none;border-radius:6px;cursor:pointer;">LINE</button>
          <button class="btn-outline-add add-quote-btn" data-model="${item.model}">â• å ±åƒ¹å–®</button>
        </div>
      </td>
      <td style="text-align:right;">${showPrice ? (item.minPrice ?? "-") : "---"}</td>
      <td style="text-align:right;">${showPrice ? (item.marketPrice ?? "-") : "---"}</td>
    `;

    const imgEl = tr.querySelector('.product-img');
    const modelEl = tr.querySelector('.model-cell');

    const openDetail = () => {
      if (window.innerWidth > 900) {
        if (window.hideDetailTimer) clearTimeout(window.hideDetailTimer);
        showDetailDesktop(item);
      } else {
        showDetailMobile(item);
      }
    };

    if (imgEl) {
      imgEl.addEventListener('click', openDetail);
      if (window.innerWidth > 900) {
          imgEl.addEventListener('mouseenter', openDetail);
          imgEl.addEventListener('mouseleave', () => {
             window.hideDetailTimer = setTimeout(() => {
               detailCard.style.display = "none";
             }, 200); 
          });
      }
    }
    if (modelEl) {
      modelEl.addEventListener('click', openDetail);
       if (window.innerWidth > 900) {
          modelEl.addEventListener('mouseenter', openDetail);
          modelEl.addEventListener('mouseleave', () => {
             window.hideDetailTimer = setTimeout(() => {
               detailCard.style.display = "none";
             }, 200); 
          });
      }
    }

    resultBody.appendChild(tr);
  });
  bindCheckAll();
}

function showDetailDesktop(item) {
  if (window.hideDetailTimer) clearTimeout(window.hideDetailTimer);

  let img = item.imageUrl;
  if (!img || !img.startsWith("http")) {
    const driveImg = getDriveMainImage(item.model, item.mainModel);
    if (driveImg) img = driveImg;
    else img = "https://placehold.co/300x300?text=No+Image";
  }

  const driveMainFolder = getDriveMainFolder(item.model, item.mainModel);
  const netImages = getDriveNetImages(item.model, item.mainModel);
  const netFolderUrl = getDriveNetGallery(item.model, item.mainModel);
  const actMainLink = driveMainFolder || getDriveMainImage(item.model, item.mainModel);
  const actNetLink = netFolderUrl || (netImages && netImages.length > 0 ? netImages[0] : "");

  let netThumbHtml = "";
  if (netImages && netImages.length > 0) {
      const imgsHtml = netImages.slice(0, 6).map(url => { 
          const displayUrl = "https://images.weserv.nl/?url=" + encodeURIComponent(url);
          return `<img src="${displayUrl}" loading="lazy" style="cursor:pointer; width:100%; height:60px; object-fit:cover; border-radius:4px;" onclick="window.open('${url}', '_blank')">`;
      }).join("");
      netThumbHtml = `<div class="net-gallery" style="grid-template-columns:repeat(6, 1fr); gap:4px; margin-top:8px;">${imgsHtml}</div>`;
  }

  const showPrice = userLevel >= 1;
  const getPrice = (p) => showPrice ? (item[p] ?? "-") : "---";

  // Construct Price Block
  let quoteHtml = "";
  const tiers = [50, 100, 300, 500, 1000];
  tiers.forEach(t => {
      if (userLevel >= (t >= 500 ? 3 : (t >= 100 ? 2 : 1))) {
          quoteHtml += `<div style="display:flex; justify-content:space-between; padding:2px 0; border-bottom:1px dashed #eee;">
              <span style="color:#666;">${t}å€‹</span>
              <span style="font-weight:bold; color:#2563eb;">${getPrice('quote' + t)}</span>
          </div>`;
      }
  });

  detailCard.style.display = "block";
  detailCard.innerHTML = `
    <button class="card-close-btn" onclick="document.getElementById('detailCard').style.display='none'">Ã—</button>
    
    <!-- Main Image -->
    <img src="${img}" style="width:100%; border-radius:10px; border:1px solid #eee; margin-bottom:12px;" onerror="this.onerror=null;this.src='https://placehold.co/300x300?text=No+Image';">

    <!-- 1. Download Buttons -->
    <div style="margin-bottom:16px;">
      <div style="display:flex; gap:8px; flex-wrap:wrap;">
        ${actMainLink ? `<a href="${actMainLink}" target="_blank" class="btn-secondary" style="flex:1; text-align:center; font-size:13px; padding:8px;">ä¸‹è¼‰å¤§åœ–</a>` : `<button disabled class="btn-secondary" style="flex:1; color:#ccc;">ç„¡å¤§åœ–</button>`}
        ${actNetLink ? `<a href="${actNetLink}" target="_blank" class="btn-secondary" style="flex:1; text-align:center; font-size:13px; padding:8px;">ä¸‹è¼‰ç¶²è·¯åœ–</a>` : `<button disabled class="btn-secondary" style="flex:1; color:#ccc;">ç„¡ç¶²è·¯åœ–</button>`}
      </div>
      ${netThumbHtml}
    </div>

    <!-- 2. Basic Info -->
    <div style="margin-bottom:16px; background:#f9fafb; padding:12px; border-radius:8px;">
      <div style="font-weight:700; font-size:16px; margin-bottom:8px; color:#111;">${item.name || "-"}</div>
      <div style="font-size:14px; line-height:1.8; color:#444;">
        <div><span style="color:#888;">é¡è‰²ï¼š</span> ${item.colorList || "-"}</div>
        <div><span style="color:#888;">ç®±å…¥æ•¸ï¼š</span> ${item.cartonQty || "-"}</div>
        <div><span style="color:#888;">åœ‹éš›æ¢ç¢¼ï¼š</span> ${item.barcode || item.internationalBarcode || "-"}</div>
        <div><span style="color:#888;">é€£çµï¼š</span> ${item.productUrl ? `<a href="${item.productUrl}" target="_blank" style="color:#2563eb;text-decoration:underline;">é–‹å•Ÿç¶²é </a>` : "-"}</div>
      </div>
    </div>

    <!-- 3. Price Info -->
    <div style="margin-bottom:12px;">
      <div style="font-weight:700; margin-bottom:8px; border-left:4px solid #2563eb; padding-left:8px;">åƒ¹æ ¼è³‡è¨Š</div>
      <div style="background:#fff; border:1px solid #eee; border-radius:8px; padding:12px;">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
           <span>è³£å ´å”®åƒ¹</span>
           <span style="font-weight:bold;">${getPrice('marketPrice')}</span>
        </div>
        <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
           <span>æœ«å”®åƒ¹æ ¼</span>
           <span style="font-weight:bold; color:#dc2626;">${getPrice('minPrice')}</span>
        </div>
        <div style="background:#f0f9ff; padding:8px 12px; border-radius:6px;">
           <div style="font-size:12px; color:#666; margin-bottom:4px; font-weight:600;">æ¡è³¼å ±åƒ¹</div>
           ${quoteHtml || '<div style="color:#999; font-size:12px;">ç„¡æ¬Šé™æŸ¥çœ‹å ±åƒ¹</div>'}
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div style="display:flex; gap:8px; margin-top:16px;">
      <button class="btn-primary line-share-btn" data-model="${item.model}" style="flex:1;">LINE åˆ†äº«</button>
      <button class="btn-outline-add add-quote-btn" data-model="${item.model}" style="flex:1;">åŠ å…¥å ±åƒ¹å–®</button>
    </div>
  `;
}

function showDetailMobile(item) { showDetailDesktop(item); openSheet(); document.getElementById("sheetContent").innerHTML = detailCard.innerHTML; }

function openSheet() { sheetBackdrop.classList.remove("hidden"); mobileSheet.classList.remove("hidden"); requestAnimationFrame(() => mobileSheet.classList.add("open")); }
function closeSheet() { mobileSheet.classList.remove("open"); setTimeout(() => { mobileSheet.classList.add("hidden"); if (quoteSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden"); }, 220); }

/* Export Functions */
function exportSelectedExcel() {
  const checked = document.querySelectorAll(".row-check:checked");
  if (checked.length === 0) { alert("è«‹å…ˆå‹¾é¸è¦åŒ¯å‡ºçš„å•†å“"); return; }
  const selectedModels = Array.from(checked).map(c => c.getAttribute("data-model"));
  const baseHeader = ["å•†å“å‹è™Ÿ","ä¸»å‹è™Ÿ","å•†å“åç¨±","é¡è‰²åˆ—è¡¨","ç®±å…¥æ•¸","å•†å“é€£çµ","å•†å“å¤§åœ–","ç¶²è·¯åœ–"];
  const qty = qtySelect.value;
  let priceHeader = qty ? [`${qty}å€‹`, "æœ«å”®", "è³£å ´"] : ["æœ«å”®", "è³£å ´"];
  const rows = [[...baseHeader, ...priceHeader]];
  selectedModels.forEach(m => {
    const item = currentResultList.find(p => p.model === m);
    if (!item) return;
    const driveMain = getDriveMainImage(item.model, item.mainModel);
    const driveNetList = getDriveNetImages(item.model, item.mainModel);
    const baseRow = [item.model, item.mainModel, item.name, item.colorList || "", item.cartonQty || "", item.productUrl || "", driveMain || "", driveNetList.join(" | ")];
    let priceRow = [];
    // åƒ¹æ ¼éš±è—
    const showPrice = userLevel >= 1;
    if (qty) {
      const ck = `quote${qty}`;
      priceRow = [showPrice ? (item[ck] ?? item.quote50 ?? "-") : "---", showPrice ? (item.minPrice ?? "-") : "---", showPrice ? (item.marketPrice ?? "-") : "---"];
    } else {
      priceRow = [showPrice ? (item.minPrice ?? "-") : "---", showPrice ? (item.marketPrice ?? "-") : "---"];
    }
    rows.push([...baseRow, ...priceRow]);
  });
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹");
  XLSX.writeFile(wb, `KINYO_å•†å“å ±åƒ¹_${qty ? qty+'å€‹' : 'é—œéµå­—æœå°‹'}.xlsx`);
}
function downloadQuoteExcel() {
  if (quoteList.length === 0) { alert("å ±åƒ¹å–®æ˜¯ç©ºçš„"); return; }
  const header = ["å•†å“å‹è™Ÿ","å•†å“åç¨±","æ¡è³¼è¦æ ¼","å–®åƒ¹","æ•¸é‡"];
  const rows = [header];
  // åƒ¹æ ¼éš±è—
  const showPrice = userLevel >= 1;
  quoteList.forEach(q => rows.push([q.model, q.name, q.qtyLabel, showPrice ? q.price : "---", q.count]));
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®");
  XLSX.writeFile(wb, `KINYO_å ±åƒ¹å–®_${new Date().toISOString().slice(0,10)}.xlsx`);
}

// --- PPT Logic Updated (4:3 Style with Image Locking) ---
// Helper: Pick random N items, but ensure index 0 (Main Image) is kept first
function pickRandom(arr, n){ 
  if(!Array.isArray(arr) || arr.length === 0) return [];
  const first = arr[0]; // The Python script already ensures index 0 is _01
  const others = arr.slice(1);
  const shuffledOthers = shuffleArray(others);
  const pickedOthers = shuffledOthers.slice(0, n - 1); 
  return [first, ...pickedOthers];
}

async function fetchAsDataURL(url){
  if(!url) return null;
  let targetUrl = url;
  if (url.includes("drive.google.com") && url.includes("/file/d/")) {
    const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
    if (match && match[1]) targetUrl = `https://drive.google.com/uc?id=${match[1]}`;
  } else if (url.includes("drive.google.com") && url.includes("id=")) {
      const match = url.match(/id=([a-zA-Z0-9_-]+)/);
      if (match && match[1]) targetUrl = `https://drive.google.com/uc?id=${match[1]}`;
  }
  try{ 
    const proxyUrl = "https://images.weserv.nl/?url=" + encodeURIComponent(targetUrl); 
    const r = await fetch(proxyUrl); 
    if(!r.ok) return null; 
    const blob = await r.blob(); 
    return await new Promise((resolve)=>{ 
      const fr = new FileReader(); 
      fr.onload = ()=>resolve(fr.result); 
      fr.onerror = ()=>resolve(null); 
      fr.readAsDataURL(blob); 
    }); 
  } catch(e){ 
    return null; 
  }
}
function getQuoteByTier(item, tier){ 
  const key = "quote" + String(tier); 
  return (item && item[key] != null) ? item[key] : ""; 
}

async function buildProductSlide(pptx, item, tier){
  const slide = pptx.addSlide();
  
  // ğŸš€ éš±è—å ±åƒ¹é‚è¼¯ (PPT)
  const showPrice = userLevel >= 1;
  const getPrice = (p) => showPrice ? (item[p] ?? "-") : "N/A";
  
  // 1. Header Area (White Background)
  const logoData = await fetchAsDataURL(COMPANY_LOGO_URL);
  if(logoData){
    slide.addImage({ data: logoData, x:0.4, y:0.2, w:2.4, h:1.2, sizing: { type:'contain' } });
  } else {
    slide.addText("KINYO", { x:0.4, y:0.3, fontSize:24, bold:true, color:'000000' });
  }
  
  // Title (Middle-Left) - Black Text
  slide.addText(`${item.name || ""}`, { x:3.0, y:0.2, w:4.0, h:0.8, fontFace:"Microsoft JhengHei", fontSize:24, bold:true, color:'000000', valign:'middle' });

  // Quote Info (Right) - Stacked
  const quoteVal = getQuoteByTier(item, tier);
  // Market Price
  slide.addText(`è³£å ´åƒ¹: $${getPrice('marketPrice')}`, { x:7.2, y:0.2, w:2.5, h:0.4, fontSize:14, color:'6B7280', fontFace:"Microsoft JhengHei", align:'right' });
  // Quote (Blue Qty, Red Price)
  slide.addText(
    [
      { text: `å ±åƒ¹(${tier}pcs): `, options: { color:'1E3A8A', bold:true, fontSize:14 } },
      { text: `$${getPrice('quote' + tier)}`, options: { color:'DC2626', bold:true, fontSize:20 } }
    ],
    { x:7.2, y:0.6, w:2.5, h:0.4, align:'right', fontFace:"Microsoft JhengHei" }
  );

  // Divider Line
  slide.addShape(pptx.ShapeType.line, { x:0.4, y:1.2, w:9.2, h:0, line:{color:'E5E7EB', width:1} });

  // 3. Images Grid (2x3) - 4:3 Layout
  const netImgs = getDriveNetImages(item.model, item.mainModel) || [];
  const netImgsPicked = pickRandom(netImgs, 6);

  const startY = 1.5; 
  const w = 2.8; const h = 2.4; 
  
  const colX = [0.4, 3.6, 6.8];
  const rowY = [startY, startY + h + 0.3];

  let idx = 0;
  for(let r=0; r<2; r++){
    for(let c=0; c<3; c++){
      if(idx >= netImgsPicked.length) break;
      const url = netImgsPicked[idx];
      
      slide.addShape(pptx.ShapeType.rect, { 
        x:colX[c], y:rowY[r], w:w, h:h, 
        fill:{color:'FFFFFF'}, 
        line:{color:'E5E7EB', width:1},
        shadow: { type:'outer', angle:45, blur:8, offset:3, color:'000000', opacity:0.15 } 
      });

      const dataUrl = await fetchAsDataURL(url);
      if(dataUrl){
        slide.addImage({ 
          data:dataUrl, 
          x:colX[c]+0.1, y:rowY[r]+0.1, w:w-0.2, h:h-0.2,
          sizing: { type: 'contain', w:w-0.2, h:h-0.2 } 
        });
      } else {
        slide.addText("No Image", { x:colX[c], y:rowY[r]+1, w:w, align:'center', fontSize:12, color:'9CA3AF' });
      }
      idx++;
    }
  }

  // 4. Footer
  slide.addText(`KINYO | ç”Ÿæˆæ—¥æœŸ: ${new Date().toLocaleDateString()}`, { x:0.4, y:7.0, fontSize:10, color:'9CA3AF' });
}

async function exportSelectedPPT() {
  if (typeof PptxGenJS === "undefined") { alert("PPT æ¨¡çµ„æœªè¼‰å…¥"); return; }
  const checks = Array.from(document.querySelectorAll(".row-check:checked"));
  if (checks.length < 1) { alert("è«‹è‡³å°‘å‹¾é¸ 1 å€‹å•†å“æ‰èƒ½ç”Ÿæˆ PPTã€‚"); return; }
  if (checks.length > 20) { alert("æœ€å¤šåªèƒ½å‹¾é¸ 20 å€‹å•†å“ç”Ÿæˆ PPTã€‚"); return; }
  
  const tier = qtySelect.value || "50";
  const selectedItems = checks.map(cb => {
      const model = cb.dataset.model;
      let item = currentResultList.find(p => p.model === model);
      if(!item) item = currentResultList.find(p => p.mainModel === model);
      if(!item) item = currentResultList.find(p => Array.isArray(p.models) && p.models.includes(model));
      return item;
  }).filter(Boolean);

  if (selectedItems.length === 0) { alert("æ‰¾ä¸åˆ°å·²å‹¾é¸å•†å“çš„è³‡æ–™ï¼Œè«‹é‡æ–°æœå°‹å¾Œå†è©¦ã€‚"); return; }

  pptToolbarBtn.disabled = true; pptToolbarBtn.textContent = "PPT ç”Ÿæˆä¸­...";
  try {
    const pptx = new PptxGenJS();
    pptx.layout = "LAYOUT_4x3"; 
    pptx.author = "KINYO Price System";
    pptx.company = "KINYO";
    pptx.title = `KINYO Quote ${tier}pcs`;

    for (const item of selectedItems) {
      await buildProductSlide(pptx, item, tier);
    }
    
    const salesName = "éƒ­åº­è±ª";
    const salesPhone = "0976-966333";
    await pptx.writeFile({ fileName: `KINYO-å•†å“æ¨è–¦å ±åƒ¹-æ•¸é‡${tier}-@${salesName}-@${salesPhone}.pptx` });

  } catch (e) {
    console.error(e);
    alert("PPT ç”Ÿæˆå¤±æ•—ï¼Œè«‹æŸ¥çœ‹ Consoleã€‚");
  } finally {
    pptToolbarBtn.disabled = false;
    pptToolbarBtn.textContent = "ç”Ÿæˆ PPTï¼ˆ1â€“20ï¼‰";
  }
}

/* =======================================================
   Event Listeners (Bind within Module)
======================================================= */
searchForm.onsubmit = (e)=>{ e.preventDefault(); searchProducts(); };
exportBtn.onclick = exportSelectedExcel;
logoutBtn.onclick = () => signOut(auth);

if(pptToolbarBtn) {
  pptToolbarBtn.onclick = exportSelectedPPT;
}
if(downloadQuoteExcelBtn) {
  downloadQuoteExcelBtn.onclick = downloadQuoteExcel;
}
if(copyQuoteBtn) {
  copyQuoteBtn.onclick = () => {
    if (quoteList.length === 0) return alert("å ±åƒ¹å–®æ˜¯ç©ºçš„");
    let text = "KINYO å ±åƒ¹å–®\n--------------------\n";
    quoteList.forEach((q,i)=>{
      const showPrice = userLevel >= 1;
      const priceDisplay = showPrice ? q.price : "---";
      text += `${i+1}. ã€${q.model}ã€‘${q.name}\n   ${q.qtyLabel}ï¼š${priceDisplay} x ${q.count}\n`;
    });
    text += "--------------------\n";
    navigator.clipboard.writeText(text)
      .then(() => alert("å ±åƒ¹å–®å·²è¤‡è£½"))
      .catch(() => alert("è¤‡è£½å¤±æ•—"));
  };
}

// ğŸš€ ä¿®æ­£æ¸…ç©ºæŒ‰éˆ•é‚è¼¯ï¼šå°‡æ¸…é™¤æœå°‹æ¢ä»¶å’Œæ¸…é™¤å ±åƒ¹å–®åˆ†é–‹è™•ç†
if(clearBtn) {
  clearBtn.onclick = () => {
    keywordInput.value = "";
    qtySelect.value = "";
    minPriceInput.value = "";
    maxPriceInput.value = "";

    resultBody.innerHTML = "";
    resultTable.style.display = "none";
    exportBtn.disabled = true;
    if(pptToolbarBtn) pptToolbarBtn.disabled = true;
    if(multiLineBtn) multiLineBtn.disabled = true;
    checkAllBox.checked = false;
    detailCard.style.display = "none";
  };
}

if(clearQuoteBtn) {
  clearQuoteBtn.onclick = () => {
    if(quoteList.length === 0) {
        alert("å ±åƒ¹å–®å·²ç¶“æ˜¯ç©ºçš„");
        return;
    }
    if(confirm("ç¢ºå®šè¦æ¸…ç©ºå ±åƒ¹å–®å—ï¼Ÿé€™å°‡ç„¡æ³•å¾©åŸã€‚")) {
        quoteList = [];
        renderQuoteList();
        updateQuoteToolbarBtn();
    }
  };
}

// Login Button Click Logic
if(doLoginBtn) {
  doLoginBtn.onclick = async () => {
    const email = loginEmail.value.trim();
    const password = loginPassword.value.trim();
    
    if(!email || !password) {
      loginError.textContent = "è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼";
      loginError.style.display = "block";
      return;
    }

    loginError.style.display = "none";
    doLoginBtn.disabled = true;
    doLoginBtn.textContent = "ç™»å…¥ä¸­...";

    try {
      // ğŸš€ å¼·åˆ¶ä½¿ç”¨ LOCAL æŒä¹…æ€§ï¼Œè§£æ±ºåœ¨æŸäº›ç’°å¢ƒä¸‹ Session éºå¤±æˆ–è¢«é˜»æ“‹çš„å•é¡Œ
      await setPersistence(auth, browserLocalPersistence);
      await signInWithEmailAndPassword(auth, email, password);
      // Success: onAuthStateChanged will handle the UI update
    } catch (error) {
      // ğŸš€ å¿½ç•¥é€™å€‹ç‰¹å®šçš„éè‡´å‘½éŒ¯èª¤
      if (error.message && error.message.includes("message channel closed")) {
          console.warn("Ignored non-fatal auth error:", error);
          return;
      }
      
      console.error(error);
      loginError.textContent = "ç™»å…¥å¤±æ•—ï¼šè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼";
      loginError.style.display = "block";
      doLoginBtn.disabled = false;
      doLoginBtn.textContent = "ç™»å…¥";
    }
  };
}

/* =======================================================
   Firebase Authï¼šç™»å…¥å¾Œæµç¨‹
======================================================= */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    // Show Login Overlay instead of redirecting
    if(loginOverlay) loginOverlay.style.display = "flex";
    return;
  }
  
  // Hide Login Overlay if user is logged in
  if(loginOverlay) loginOverlay.style.display = "none";

  currentUserEmail = user.email || "";

  // ğŸš€ æ ¸å¿ƒé‚è¼¯ï¼šåˆ¤æ–·æ˜¯å¦ç‚ºå±•ç¤ºå¸³è™Ÿ
  if (currentUserEmail.toLowerCase() === 'show@kinyo.com') {
      userLevel = 0; // å¼·åˆ¶è¨­å®šç‚ºæœ€ä½ç­‰ç´š
  } else {
      // å¦å‰‡å¾ Firestore æŠ“å–è©²ç”¨æˆ¶çš„å¯¦éš›ç­‰ç´š
      try {
          const userDoc = await getDoc(doc(db, "Users", currentUserEmail.toLowerCase()));
          if (userDoc.exists()) userLevel = userDoc.data().level || 1;
      } catch {
          userLevel = 1;
      }
  }

  userInfoSpan.textContent = `ç™»å…¥å¸³è™Ÿï¼š${currentUserEmail.replace(/@.*/, "")}`;
  logoutBtn.style.display = "inline-block";

  setupQtySelectByLevel();

  await preloadDriveModelData();
  await preloadProducts();
});

/* =======================================================
   Quote Button Listeners inside Module
======================================================= */
document.addEventListener("click", (e) => {
  if (e.target.classList.contains("add-quote-btn")) {
    const model = e.target.getAttribute("data-model");
    const item  = currentResultList.find(p => p.model === model);
    if (!item) return;

    const qty = qtySelect.value || "50";
    const ck  = `quote${qty}`;
    const cost = item[ck] ?? item.quote50 ?? 0;

    quoteList.push({
      model: item.model,
      name: item.name,
      price: cost,
      qtyLabel: `${qty}å€‹`,
      count: 1
    });

    updateQuoteToolbarBtn();
    alert(`å·²åŠ å…¥å ±åƒ¹å–®ï¼ˆ${qty}å€‹ï¼š$${cost}ï¼‰`);
    return;
  }

  if (e.target.classList.contains("line-share-btn")) {
    const model = e.target.getAttribute("data-model");
    const item  = currentResultList.find(p => p.model === model);
    if (!item) return;

    const showPrice = userLevel >= 1;
    const getPrice = (p) => showPrice ? (item[p] ?? "-") : "---";

    let costText = "";
    if (userLevel >= 1) costText += `50å€‹ï¼š${getPrice('quote50')}\n`;
    if (userLevel >= 2) costText += `100å€‹ï¼š${getPrice('quote100')}\n300å€‹ï¼š${getPrice('quote300')}\n`;
    if (userLevel >= 3) costText += `500å€‹ï¼š${getPrice('quote500')}\n100å€‹ï¼š${getPrice('quote1000')}\n`;

    const text = `ã€${item.model}ã€‘${item.name}
è³£å ´å”®åƒ¹ï¼š${getPrice('marketPrice')}
æœ«å”®åƒ¹æ ¼ï¼š${getPrice('minPrice')}
--------------------
æ¡è³¼åƒ¹æ ¼ï¼š
${costText}
å•†å“é€£çµï¼š${item.productUrl || "ç„¡"}`;

    navigator.clipboard.writeText(text)
      .then(() => alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿"))
      .catch(() => alert("è¤‡è£½å¤±æ•—"));
  }

  const card = document.getElementById("detailCard");
  if (card && card.style.display !== "none") {
    if (!card.contains(e.target) && !e.target.closest("tr")) {
      card.style.display = "none";
    }
  }

  if(card && !card.hasAttribute("data-listeners-added")){
      card.setAttribute("data-listeners-added", "true");
      card.addEventListener("mouseenter", () => {
        if (window.hideDetailTimer) clearTimeout(window.hideDetailTimer);
      });
      card.addEventListener("mouseleave", () => {
        window.hideDetailTimer = setTimeout(() => {
          card.style.display = "none";
        }, 200);
      });
  }
});

if (multiLineBtn) {
    multiLineBtn.onclick = () => {
        const checked = document.querySelectorAll(".row-check:checked");
        if (checked.length === 0) {
            alert("è«‹å…ˆå‹¾é¸è¦åˆ†äº«çš„å•†å“");
            return;
        }

        const qty = qtySelect.value || "50";
        let text = `KINYO å¤šå“é …å ±åƒ¹ï¼ˆèµ·è¨‚é‡ï¼š${qty}å€‹ï¼‰\n--------------------\n`;

        Array.from(checked).forEach((c, i) => {
            const model = c.getAttribute("data-model");
            const item = currentResultList.find(p => p.model === model);
            if (!item) return;

            const showPrice = userLevel >= 1;
            const ck = `quote${qty}`;
            
            // Logic to get quote, market price, and link
            const cost = showPrice ? (item[ck] ?? item.quote50 ?? "-") : "---";
            const market = showPrice ? (item.marketPrice ?? "-") : "---";
            const link = item.productUrl || "ç„¡é€£çµ";

            text += `${i + 1}. ã€${item.model}ã€‘${item.name}\n`;
            text += `   ğŸ’° ${qty}å€‹å ±åƒ¹ï¼š$${cost}\n`;
            text += `   ğŸ›’ è³£å ´å”®åƒ¹ï¼š$${market}\n`;
            text += `   ğŸ”— å•†å“é€£çµï¼š${link}\n\n`;
        });

        text += "--------------------\n";
        text += "ä»¥ä¸Šå ±åƒ¹åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›ä»¥æœ€çµ‚ç¢ºèªç‚ºä¸»ã€‚";

        navigator.clipboard.writeText(text)
            .then(() => alert(`å·²è¤‡è£½ ${checked.length} é …å•†å“çš„å ±åƒ¹è³‡è¨Šï¼è«‹ç›´æ¥åœ¨ LINE è²¼ä¸Šã€‚`))
            .catch(() => alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚"));
    };
}

if(sortSelect) {
  sortSelect.onchange = () => {
    if (currentResultList.length > 0) {
      currentResultList = applySorting([...currentResultList]);
      renderResults(currentResultList);
    }
  };
}

if(sheetCloseBtn) sheetCloseBtn.onclick = closeSheet;
if(quoteCloseBtn) quoteCloseBtn.onclick = closeQuoteSheet;

if(sheetBackdrop) {
  sheetBackdrop.onclick = () => {
    if (!mobileSheet.classList.contains("hidden")) closeSheet();
    if (!quoteSheet.classList.contains("hidden")) closeQuoteSheet();
  };
}

if(quoteToolbarBtn) quoteToolbarBtn.onclick = openQuoteSheet;

</script>
</body>
</html>
