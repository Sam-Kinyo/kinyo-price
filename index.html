<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>KINYO æŸ¥åƒ¹ç³»çµ±</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 980px;
      margin: 40px auto;
      padding: 0 16px 80px; /* åº•éƒ¨ç•™ç™½çµ¦æ‡¸æµ®æŒ‰éˆ• */
      background: #f5f5f5;
    }

    h1 { margin-bottom: 4px; }
    .subtitle { color: #666; margin-bottom: 16px; }

    /* é ‚éƒ¨ä½¿ç”¨è€…åˆ— */
    .top-bar {
      display:flex;
      justify-content: flex-end;
      align-items:center;
      font-size: 13px;
      color:#374151;
      margin-bottom: 10px;
      gap: 8px;
    }
    .user-badge {
      padding:4px 10px;
      border-radius:999px;
      background:#e5e7eb;
    }
    .logout-btn {
      padding:4px 10px;
      border-radius:999px;
      border:1px solid #d1d5db;
      background:white;
      cursor:pointer;
      font-size:12px;
    }

    .search-box {
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      margin-bottom: 12px;
    }
    .search-row { margin-bottom: 12px; }
    label { font-weight: 600; display:block; margin-bottom:4px; }

    input, select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
      font-size: 14px;
    }

    .btn-primary {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: white;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
    }

    .btn-secondary {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      color: #111827;
      font-size: 14px;
      cursor: pointer;
    }

    .btn-outline-add {
      padding: 6px 12px;
      border-radius: 6px;
      border: 1px solid #2563eb;
      background: #eff6ff;
      color: #2563eb;
      font-size: 12px;
      cursor: pointer;
      margin-top: 6px;
      font-weight: 600;
    }
    .btn-outline-add:hover {
      background: #dbeafe;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      vertical-align: top;
    }
    th {
      background: #f9fafb;
      text-align: left;
    }

    .product-img {
      width: 70px;
      height: 70px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid #ddd;
    }

    .price-tag {
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 6px;
      margin-right: 6px;
      margin-bottom: 4px;
      display: inline-block;
      font-size: 12px;
      white-space: nowrap;
    }
    .tag50  { background:#dbeafe; color:#1e40af; }
    .tag100 { background:#e0f2fe; color:#0369a1; }
    .tag300 { background:#dcfce7; color:#15803d; }
    .tag500 { background:#ffedd5; color:#ea580c; }
    .tag1000{ background:#fee2e2; color:#b91c1c; }

    /* é›»è…¦ç‰ˆè©³ç´°å¡ç‰‡ */
    #detailCard {
      position: fixed;
      right: 20px;
      top: 120px;
      width: 320px;
      max-height: 78vh;
      overflow-y: auto;
      background: white;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.12);
      display: none;
      font-size: 14px;
      z-index: 999;
    }
    /* æ‰‹æ©Ÿç‰ˆ Bottom Sheet */
    .sheet-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.45);
      z-index: 1000;
    }
    .sheet {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      height: 75vh; /* ç¨å¾®åŠ é«˜ */
      background: #ffffff;
      border-radius: 16px 16px 0 0;
      box-shadow: 0 -2px 10px rgba(0,0,0,0.18);
      z-index: 1001;
      display: flex;
      flex-direction: column;
      transform: translateY(100%);
      transition: transform 0.22s ease-out;
    }
    .sheet.open {
      transform: translateY(0%);
    }
    .sheet-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 16px 6px;
      border-bottom:1px solid #e5e7eb;
    }
    .sheet-title {
      font-size:15px;
      font-weight:600;
    }
    .sheet-close {
      font-size:22px;
      line-height:1;
      border:none;
      background:transparent;
      cursor:pointer;
    }
    .sheet-content {
      padding:12px 16px 16px;
      overflow-y:auto;
      font-size:14px;
    }

    .hidden {
      display:none !important;
    }

    /* æ‡¸æµ®è³¼ç‰©è»ŠæŒ‰éˆ• */
    .fab-cart {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 60px;
      height: 60px;
      background: #111827;
      color: white;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.25);
      cursor: pointer;
      z-index: 990;
      transition: transform 0.2s;
    }
    .fab-cart:active { transform: scale(0.95); }
    .fab-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ef4444;
      color: white;
      font-size: 12px;
      font-weight: bold;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
    }

    /* å ±åƒ¹å–®åˆ—è¡¨æ¨£å¼ */
    .quote-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 0;
      border-bottom: 1px solid #eee;
    }
    .quote-info { font-size: 14px; }
    .quote-price { font-weight: 600; color: #2563eb; }
    .quote-del { color: #999; cursor: pointer; padding: 4px; }
    .quote-del:hover { color: #ef4444; }

    /* RWD */
    @media (max-width: 900px) {
      body {
        max-width: 100%;
        margin: 16px auto 32px;
      }
      #detailCard {
        display:none !important;
      }
    }

    @media (max-width: 600px) {
      .search-box { padding: 12px; }
      input, select { font-size: 14px; padding: 6px 10px; }
      .product-img { width: 55px; height: 55px; }
      table th, table td { padding: 6px; font-size: 13px; }
      .btn-primary, .btn-secondary { padding: 8px 12px; }
      .price-tag-container {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 4px 6px;
        margin-bottom: 4px;
      }
      .price-tag {
        display: block;
        text-align: center;
        padding: 4px 2px;
        font-size: 11.5px;
        border-radius: 5px;
        white-space: nowrap;
      }
    }
  </style>
</head>

<body>

<div class="top-bar">
  <span id="userInfo" class="user-badge">æœªç™»å…¥</span>
  <button id="logoutBtn" class="logout-btn" style="display:none;">ç™»å‡º</button>
</div>

<h1>KINYO æŸ¥åƒ¹ç³»çµ±</h1>
<div class="subtitle">éœ€ç™»å…¥å¾Œæ–¹å¯æŸ¥åƒ¹ï¼Œä¸¦ä¾å¸³è™Ÿç­‰ç´šé¡¯ç¤ºä¸åŒæ¡è³¼åƒ¹æ ¼ã€‚</div>

<div class="search-box">
  <div class="search-row">
    <label>é—œéµå­—æœå°‹ï¼ˆå‹è™Ÿ / åç¨±ï¼‰ï¼š</label>
    <input id="keyword" placeholder="å¦‚ï¼šCL528 / é™¤æ¯›çƒæ©Ÿ" />
  </div>

  <div class="search-row">
    <label>é¸æ“‡èµ·è¨‚é‡ï¼š</label>
    <select id="qtySelect"></select>
  </div>

  <div class="search-row">
    <label>é ç®—å€é–“ï¼ˆéœ€å…ˆé¸èµ·è¨‚é‡ï¼‰ï¼š</label>
    <div style="display:flex; gap:6px;">
      <input id="minPrice" type="number" placeholder="æœ€ä½é‡‘é¡" />
      <input id="maxPrice" type="number" placeholder="æœ€é«˜é‡‘é¡" />
    </div>
  </div>

  <button id="searchBtn" class="btn-primary">æŸ¥è©¢</button>
  <button id="clearBtn" class="btn-secondary" style="margin-top:10px;width:100%;">æ¸…é™¤æœå°‹æ¢ä»¶</button>
</div>

<div class="toolbar" style="display:flex; gap:10px; align-items:center; margin-bottom:6px;">
  <select id="sortSelect" class="btn-secondary" style="flex:1;">
    <option value="">ä¸æ’åº</option>
    <option value="minPriceAsc">æœ«å”®ï¼šä½ â†’ é«˜</option>
    <option value="minPriceDesc">æœ«å”®ï¼šé«˜ â†’ ä½</option>
    <option value="marketAsc">è³£å ´ï¼šä½ â†’ é«˜</option>
    <option value="marketDesc">è³£å ´ï¼šé«˜ â†’ ä½</option>
    <option value="alphaAsc">ä¸»å‹è™Ÿï¼šA â†’ Z</option>
    <option value="alphaDesc">ä¸»å‹è™Ÿï¼šZ â†’ A</option>
  </select>

  <button id="exportBtn" class="btn-secondary" disabled>åŒ¯å‡ºå‹¾é¸ Excel</button>
</div>

<table id="resultTable" style="display:none;">
  <thead>
    <tr>
      <th style="width:32px;"><input type="checkbox" id="checkAll" /></th>
      <th style="width:80px;">åœ–ç‰‡</th>
      <th style="width:100px;">ä¸»å‹è™Ÿ</th>
      <th>å•†å“è³‡è¨Š</th>
      <th style="width:80px;">æœ«å”®</th>
      <th style="width:80px;">è³£å ´</th>
    </tr>
  </thead>
  <tbody id="resultBody"></tbody>
</table>

<div id="detailCard"></div>

<div id="sheetBackdrop" class="sheet-backdrop hidden"></div>
<div id="mobileDetailSheet" class="sheet hidden">
  <div class="sheet-header">
    <span class="sheet-title">å•†å“è³‡è¨Š</span>
    <button id="sheetCloseBtn" class="sheet-close">Ã—</button>
  </div>
  <div class="sheet-content" id="sheetContent"></div>
</div>

<div id="quoteSheet" class="sheet hidden">
  <div class="sheet-header">
    <span class="sheet-title">ğŸ“‹ å ±åƒ¹å–®é è¦½</span>
    <button id="quoteCloseBtn" class="sheet-close">Ã—</button>
  </div>
  <div class="sheet-content" style="display:flex;flex-direction:column;height:100%;">
    <div id="quoteListBody" style="flex:1;overflow-y:auto;">
      </div>
    <div style="border-top:1px solid #eee; padding-top:12px; margin-top:10px;">
      <div style="display:flex;justify-content:space-between;font-weight:bold;font-size:16px;margin-bottom:12px;">
        <span>ç¸½è¨ˆé‡‘é¡</span>
        <span id="quoteTotal">$0</span>
      </div>
      <button id="copyQuoteBtn" class="btn-primary" style="width:100%;">è¤‡è£½æ•´å¼µå ±åƒ¹å–® (LINE)</button>
      <button id="clearQuoteBtn" class="btn-secondary" style="width:100%;margin-top:8px;color:#ef4444;border-color:#ef4444;">æ¸…ç©ºå ±åƒ¹å–®</button>
    </div>
  </div>
</div>

<div id="fabCart" class="fab-cart" style="display:none;">
  <span style="font-size:24px;">ğŸ“</span>
  <div id="cartCount" class="fab-badge">0</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
  // â˜…â˜…â˜… ä¿®å¾©é‡é»ï¼šé™ç´šå›ç©©å®šçš„ 10.13.0 ç‰ˆæœ¬ â˜…â˜…â˜…
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import {
    getFirestore, collection, getDocs, doc, getDoc
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtp6rwV7KmIOedLQ9793BnXbBquopP9kM",
    authDomain: "kinyo-price.firebaseapp.com",
    projectId: "kinyo-price",
    storageBucket: "kinyo-price.firebasestorage.app",
    messagingSenderId: "122464645678",
    appId: "1:122464645678:web:c0febbc6297a8ada5ea5bf"
  };

  const app = initializeApp(firebaseConfig);
  const db  = getFirestore(app);
  const auth = getAuth(app);

  let productCache = null;
  let currentResultList = [];
  let userLevel = 1;
  let currentUserEmail = "";
  
  let quoteList = [];

  const keywordInput   = document.getElementById("keyword");
  const qtySelect      = document.getElementById("qtySelect");
  const minPriceInput  = document.getElementById("minPrice");
  const maxPriceInput  = document.getElementById("maxPrice");
  const searchBtn      = document.getElementById("searchBtn");
  const clearBtn       = document.getElementById("clearBtn");
  const exportBtn      = document.getElementById("exportBtn");
  const resultBody     = document.getElementById("resultBody");
  const resultTable    = document.getElementById("resultTable");
  const detailCard     = document.getElementById("detailCard");
  const checkAllBox    = document.getElementById("checkAll");
  const sortSelect     = document.getElementById("sortSelect");
  const userInfoSpan   = document.getElementById("userInfo");
  const logoutBtn      = document.getElementById("logoutBtn");
  
  const sheetBackdrop  = document.getElementById("sheetBackdrop");
  const mobileSheet    = document.getElementById("mobileDetailSheet");
  const sheetContent   = document.getElementById("sheetContent");
  const sheetCloseBtn  = document.getElementById("sheetCloseBtn");
  const quoteSheet     = document.getElementById("quoteSheet");
  const quoteCloseBtn  = document.getElementById("quoteCloseBtn");
  const quoteListBody  = document.getElementById("quoteListBody");
  const quoteTotalEl   = document.getElementById("quoteTotal");
  const copyQuoteBtn   = document.getElementById("copyQuoteBtn");
  const clearQuoteBtn  = document.getElementById("clearQuoteBtn");
  
  const fabCart        = document.getElementById("fabCart");
  const cartCount      = document.getElementById("cartCount");

  const colorMap = {
    R: "ç´…", RD: "ç´…",
    PK: "ç²‰", P: "ç²‰",
    BL: "è—", BU: "è—",
    B: "è—/é»‘", BK: "é»‘", K: "é»‘",
    W: "ç™½", WH: "ç™½", WT: "ç™½",
    G: "ç¶ ", GN: "ç¶ ",
    O: "æ©˜", OR: "æ©˜",
    Y: "é»ƒ", YE: "é»ƒ"
  };

  function getSelectedCostInfo(item) {
    const selectedQty = qtySelect.value; 
    let cost = item.quote50;
    let label = "50å€‹";

    if (selectedQty === "100" && userLevel >= 2) {
      cost = item.quote100;
      label = "100å€‹";
    } else if (selectedQty === "300" && userLevel >= 2) {
      cost = item.quote300;
      label = "300å€‹";
    } else if (selectedQty === "500" && userLevel >= 3) {
      cost = item.quote500;
      label = "500å€‹";
    } else if (selectedQty === "1000" && userLevel >= 3) {
      cost = item.quote1000;
      label = "1000å€‹";
    }
    return { cost, label, qty: selectedQty };
  }

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }
    currentUserEmail = user.email || "";
    const shortAccount = currentUserEmail.replace(/@.*/, "");

    try {
      const userDocRef = doc(db, "Users", currentUserEmail.toLowerCase());
      const userDoc = await getDoc(userDocRef);
      if (userDoc.exists()) {
        const data = userDoc.data();
        userLevel = data.level || 1;
      } else {
        userLevel = 1;
        alert("æ­¤å¸³è™Ÿå°šæœªè¨­å®šæ¬Šé™ï¼Œæš«ä»¥ Level 1 é¡¯ç¤ºã€‚");
      }
    } catch (e) {
      console.error(e);
      userLevel = 1;
    }

    userInfoSpan.textContent = `ç™»å…¥å¸³è™Ÿï¼š${shortAccount}`;
    logoutBtn.style.display = "inline-block";
    setupQtySelectByLevel();
    fabCart.style.display = "flex"; 
  });

  function setupQtySelectByLevel() {
    qtySelect.innerHTML = "";
    const optNone = document.createElement("option");
    optNone.value = "";
    optNone.textContent = "ä¸ä½¿ç”¨èµ·è¨‚é‡";
    qtySelect.appendChild(optNone);

    const addOption = (val, label) => {
      const opt = document.createElement("option");
      opt.value = val;
      opt.textContent = label;
      qtySelect.appendChild(opt);
    };

    if (userLevel >= 1) addOption("50", "50 å€‹");
    if (userLevel >= 2) {
      addOption("100", "100 å€‹");
      addOption("300", "300 å€‹");
    }
    if (userLevel >= 3) {
      addOption("500", "500 å€‹");
      addOption("1000", "1000 å€‹");
    }
  }

  logoutBtn.addEventListener("click", async () => {
    try {
      await signOut(auth);
      window.location.href = "login.html";
    } catch (e) {
      console.error(e);
      alert("ç™»å‡ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    }
  });

  function applySorting(list) {
    const opt = sortSelect.value;
    if (opt === "minPriceAsc")  return list.sort((a,b)=>a.minPrice - b.minPrice);
    if (opt === "minPriceDesc") return list.sort((a,b)=>b.minPrice - a.minPrice);
    if (opt === "marketAsc")    return list.sort((a,b)=>a.marketPrice - b.marketPrice);
    if (opt === "marketDesc")   return list.sort((a,b)=>b.marketPrice - a.marketPrice);
    if (opt === "alphaAsc")   return list.sort((a,b)=> a.mainModel.localeCompare(b.mainModel));
    if (opt === "alphaDesc")  return list.sort((a,b)=> b.mainModel.localeCompare(a.mainModel));
    return list;
  }

  async function searchProducts() {
    const kw   = keywordInput.value.trim().toLowerCase();
    const qty  = qtySelect.value;
    const minP = minPriceInput.value;
    const maxP = maxPriceInput.value;

    // â˜…â˜…â˜… ä¿®å¾©é‡é»ï¼šæ”¾å¯¬æœå°‹æ¢ä»¶ï¼Œåªæœ‰ã€Œå¡«äº†å…¶ä¸­ä¸€å€‹åƒ¹æ ¼ä½†æ²’å¡«å¦ä¸€å€‹ã€æ‰æ“‹ â˜…â˜…â˜…
    if ( (minP && !maxP) || (!minP && maxP) ) {
      alert("è«‹è¼¸å…¥å®Œæ•´çš„é ç®—å€é–“ï¼ˆæœ€ä½ + æœ€é«˜ï¼‰");
      return;
    }

    let list = [];
    if (!productCache) {
      const snap = await getDocs(collection(db, "Products"));
      productCache = [];
      snap.forEach(docSnap => productCache.push(docSnap.data()));
    }
    list = [...productCache];

    if (kw) {
      const k = kw.toLowerCase();
      list = list.filter(item =>
        (item.model && item.model.toLowerCase().includes(k)) ||
        (item.name && item.name.toLowerCase().includes(k))
      );
    }

    if (qty && minP && maxP) {
      const mapping = {
        "50":"quote50","100":"quote100","300":"quote300",
        "500":"quote500","1000":"quote1000"
      };
      const field = mapping[qty];
      list = list.filter(item =>
        item[field] >= Number(minP) &&
        item[field] <= Number(maxP)
      );
    }

    const grouped = {};
    list.forEach(item => {
      const main = item.model.replace(/[-_ ]?[A-Za-z]+$/, "");
      if (!grouped[main]) grouped[main] = [];
      grouped[main].push(item);
    });

    list = Object.keys(grouped).map(main => {
      const items = grouped[main];
      const first = items[0];
      const colorCodes = items
        .map(i => {
          const m = i.model.match(/[-_ ]?([A-Za-z]+)$/);
          return m ? m[1].toUpperCase() : "";
        })
        .filter(c => c);
      const uniqueCodes = [...new Set(colorCodes)];
      const displayColors = uniqueCodes
        .map(code => {
          const cname = colorMap[code] || "";
          return cname ? `${code}ï¼ˆ${cname}ï¼‰` : code;
        })
        .join(" / ");

      return {
        ...first,
        mainModel: items.length > 1 ? `${main}ï¼ˆå¤šè‰²ï¼‰` : main,
        colorList: displayColors || "-"
      };
    });

    list = applySorting(list);
    currentResultList = list;
    renderResults(list);
  }

  clearBtn.addEventListener("click", () => {
    keywordInput.value = "";
    qtySelect.value    = "";
    minPriceInput.value= "";
    maxPriceInput.value= "";
    sortSelect.value   = "";
    resultBody.innerHTML = "";
    resultTable.style.display = "none";
    detailCard.style.display  = "none";
    closeSheet();
    exportBtn.disabled = true;
  });

  function renderResults(list) {
    resultBody.innerHTML = "";
    detailCard.style.display = "none";
    closeSheet();
    if (checkAllBox) checkAllBox.checked = false;

    if (list.length === 0) {
      resultTable.style.display = "none";
      exportBtn.disabled = true;
      return;
    }

    resultTable.style.display = "table";
    exportBtn.disabled = false;

    list.forEach(item => {
      const img = item.imageUrl || "https://placehold.co/120x120?text=No+Image";
      const tr  = document.createElement("tr");

      let priceHtml = "";
      if (userLevel >= 1) priceHtml += `<span class="price-tag tag50">50å€‹ï¼š${item.quote50} å…ƒ</span>`;
      if (userLevel >= 2) {
        priceHtml += `<span class="price-tag tag100">100å€‹ï¼š${item.quote100} å…ƒ</span>`;
        priceHtml += `<span class="price-tag tag300">300å€‹ï¼š${item.quote300} å…ƒ</span>`;
      }
      if (userLevel >= 3) {
        priceHtml += `<span class="price-tag tag500">500å€‹ï¼š${item.quote500} å…ƒ</span>`;
        priceHtml += `<span class="price-tag tag1000">1000å€‹ï¼š${item.quote1000} å…ƒ</span>`;
      }

      const { cost: defaultCost, label: costLabel } = getSelectedCostInfo(item);

      tr.innerHTML = `
        <td><input type="checkbox" class="row-check" data-model="${item.model}" /></td>
        <td><img src="${img}" class="product-img" loading="lazy" /></td>
        <td>${item.mainModel}</td>
        <td>
          <div style="font-weight:600;margin-bottom:4px;">${item.name}</div>
          <div class="price-tag-container" style="font-size:13px;line-height:1.6;margin-bottom:4px;">
            ${priceHtml}
          </div>
          <div style="font-size:13px;color:#444;">é¡è‰²ï¼š${item.colorList}</div>
          
          <div style="display:flex; gap:6px;">
            <button class="line-share-btn" data-model="${item.model}" 
              style="margin-top:6px;padding:6px 12px;font-size:12px;
              background:#06C755;color:#fff;border:none;border-radius:6px;cursor:pointer;">
              è¤‡è£½ LINE
            </button>
            <button class="btn-outline-add add-quote-btn" data-model="${item.model}">
              â• åŠ å…¥å ±åƒ¹å–®
            </button>
          </div>

          <div class="profit-box" style="margin-top:6px;font-size:12px;">
            <div style="display:flex; gap:6px; margin-bottom:4px;">
              <input type="number" placeholder="æˆæœ¬" value="${defaultCost}" class="cost-input" style="flex:1;padding:4px 6px;border:1px solid #ccc;border-radius:4px;">
              <input type="number" placeholder="å”®åƒ¹" value="${item.marketPrice}" class="sell-input" style="flex:1;padding:4px 6px;border:1px solid #ccc;border-radius:4px;">
            </div>
            <div style="display:flex; gap:6px; margin-bottom:4px;">
              <input type="number" placeholder="æ•¸é‡" value="1" class="qty-input" style="flex:1;padding:4px 6px;border:1px solid #ccc;border-radius:4px;">
              <div class="profit-result" style="flex:1;padding-top:4px;">é»æ“Šè©¦ç®— (é è¨­:${costLabel})</div>
            </div>
            <div class="profit-bar" style="height:6px;background:#eee;border-radius:4px;overflow:hidden;">
              <div class="profit-bar-fill" style="height:100%;width:0%;background:#4ade80;"></div>
            </div>
          </div>
        </td>
        <td style="text-align:right;">${item.minPrice} å…ƒ</td>
        <td style="text-align:right;">${item.marketPrice} å…ƒ</td>
      `;

      const isDesktop = window.innerWidth > 900;
      if (isDesktop) {
        tr.addEventListener("mouseenter", () => showDetailDesktop(item));
        tr.addEventListener("click", (e) => {
          if (e.target.classList.contains("row-check") || e.target.tagName === "INPUT" || e.target.tagName === "BUTTON") return;
          showDetailDesktop(item);
        });
      } else {
        tr.addEventListener("click", (e) => {
          if (e.target.classList.contains("row-check") || e.target.tagName === "INPUT" || e.target.tagName === "BUTTON") return;
          showDetailMobile(item);
        });
      }
      resultBody.appendChild(tr);
    });
    bindCheckAll();
  }

  function bindCheckAll() {
    const rowChecks = document.querySelectorAll(".row-check");
    if (!checkAllBox) return;
    checkAllBox.addEventListener("change", () => {
      rowChecks.forEach(chk => chk.checked = checkAllBox.checked);
    });
    rowChecks.forEach(chk => {
      chk.addEventListener("change", () => {
        const all = document.querySelectorAll(".row-check");
        const checked = document.querySelectorAll(".row-check:checked");
        checkAllBox.checked = (all.length === checked.length);
      });
    });
  }

  function showDetailDesktop(item) {
    const img = item.imageUrl || "https://placehold.co/300x300?text=No+Image";
    let priceBlock = "";
    if (userLevel >= 1) priceBlock += `<div>50 å€‹ï¼š${item.quote50} å…ƒ</div>`;
    if (userLevel >= 2) {
      priceBlock += `<div>100 å€‹ï¼š${item.quote100} å…ƒ</div>`;
      priceBlock += `<div>300 å€‹ï¼š${item.quote300} å…ƒ</div>`;
    }
    if (userLevel >= 3) {
      priceBlock += `<div>500 å€‹ï¼š${item.quote500} å…ƒ</div>`;
      priceBlock += `<div>1000 å€‹ï¼š${item.quote1000} å…ƒ</div>`;
    }

    const { cost: defaultCost, label: costLabel } = getSelectedCostInfo(item);

    detailCard.style.display = "block";
    detailCard.innerHTML = `
      <img src="${img}" style="width:260px;border-radius:12px;margin-bottom:12px;border:1px solid #ddd;" />
      <h2 style="margin:4px 0 12px;">${item.name}</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px;line-height:1.5;">
        <div><strong>å•†å“å‹è™Ÿ</strong><br>${item.model}</div>
        <div><strong>ä¸»å‹è™Ÿ</strong><br>${item.mainModel}</div>
        <div><strong>è³£å ´å”®åƒ¹</strong><br>${item.marketPrice} å…ƒ</div>
        <div><strong>æœ«å”®åƒ¹æ ¼</strong><br>${item.minPrice} å…ƒ</div>
        <div><strong>å•†å“ç¶²å€</strong><br>
          ${item.productUrl ? `<a href="${item.productUrl}" target="_blank">å‰å¾€å•†å“é </a>` : "-"}
        </div>
        <div><strong>é¡è‰²</strong><br>${item.colorList || "-"}</div>
      </div>
      <h3 style="margin-top:18px;">æ¡è³¼åƒ¹æ ¼</h3>
      <div style="margin-left:4px;line-height:1.6;">${priceBlock || "<div>æ­¤å¸³è™Ÿç„¡æ¡è³¼åƒ¹å¯è¦‹</div>"}</div>
      
      <div style="display:flex; gap:10px; margin-top:16px;">
        <button class="btn-primary line-share-btn" data-model="${item.model}" style="flex:1;">è¤‡è£½ LINE åˆ†äº«</button>
        <button class="btn-outline-add add-quote-btn" data-model="${item.model}" style="flex:1;margin-top:0;">â• åŠ å…¥å ±åƒ¹å–®</button>
      </div>

      <h3 style="margin-top:18px;">æ¯›åˆ©è©¦ç®—</h3>
      <div style="font-size:14px;margin-top:4px;">
        <div style="display:flex; gap:8px; margin-bottom:6px;">
          <input type="number" placeholder="æˆæœ¬" value="${defaultCost}" class="cost-input" style="flex:1;padding:6px 8px;border:1px solid #ccc;border-radius:6px;">
          <input type="number" placeholder="å”®åƒ¹" value="${item.marketPrice}" class="sell-input" style="flex:1;padding:6px 8px;border:1px solid #ccc;border-radius:6px;">
        </div>
        <div style="display:flex; gap:8px; margin-bottom:6px;">
          <input type="number" placeholder="æ•¸é‡" value="1" class="qty-input" style="flex:1;padding:6px 8px;border:1px solid #ccc;border-radius:6px;">
          <div class="profit-result" style="flex:1;padding-top:8px;">é»æ“Šè©¦ç®— (é è¨­:${costLabel})</div>
        </div>
        <div class="profit-bar" style="height:8px;background:#eee;border-radius:4px;overflow:hidden;">
          <div class="profit-bar-fill" style="height:100%;width:0%;background:#4ade80;"></div>
        </div>
      </div>
    `;
  }

  function showDetailMobile(item) {
    const img = item.imageUrl || "https://placehold.co/300x300?text=No+Image";
    let priceBlock = "";
    if (userLevel >= 1) priceBlock += `<div>50 å€‹ï¼š${item.quote50} å…ƒ</div>`;
    if (userLevel >= 2) {
      priceBlock += `<div>100 å€‹ï¼š${item.quote100} å…ƒ</div>`;
      priceBlock += `<div>300 å€‹ï¼š${item.quote300} å…ƒ</div>`;
    }
    if (userLevel >= 3) {
      priceBlock += `<div>500 å€‹ï¼š${item.quote500} å…ƒ</div>`;
      priceBlock += `<div>1000 å€‹ï¼š${item.quote1000} å…ƒ</div>`;
    }

    const { cost: defaultCost, label: costLabel } = getSelectedCostInfo(item);

    sheetContent.innerHTML = `
      <img src="${img}" style="width:100%;max-width:320px;border-radius:12px;margin-bottom:12px;border:1px solid #ddd;" />
      <h2 style="margin:4px 0 12px;font-size:17px;">${item.name}</h2>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:14px;line-height:1.5;">
        <div><strong>å•†å“å‹è™Ÿ</strong><br>${item.model}</div>
        <div><strong>ä¸»å‹è™Ÿ</strong><br>${item.mainModel}</div>
        <div><strong>è³£å ´å”®åƒ¹</strong><br>${item.marketPrice} å…ƒ</div>
        <div><strong>æœ«å”®åƒ¹æ ¼</strong><br>${item.minPrice} å…ƒ</div>
        <div><strong>å•†å“ç¶²å€</strong><br>
          ${item.productUrl ? `<a href="${item.productUrl}" target="_blank">å‰å¾€å•†å“é </a>` : "-"}
        </div>
      </div>
      <h3 style="margin-top:18px;">æ¡è³¼åƒ¹æ ¼</h3>
      <div style="line-height:1.6;margin-left:4px;">${priceBlock || "<div>æ­¤å¸³è™Ÿç„¡æ¡è³¼åƒ¹å¯è¦‹</div>"}</div>
      
      <h3 style="margin-top:18px;font-size:15px;">æ¯›åˆ©è©¦ç®—</h3>
      <div style="font-size:14px;margin-top:4px;margin-bottom:16px;">
        <div style="display:flex; gap:8px; margin-bottom:6px;">
          <input type="number" placeholder="æˆæœ¬" value="${defaultCost}" class="cost-input" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:6px;">
          <input type="number" placeholder="å”®åƒ¹" value="${item.marketPrice}" class="sell-input" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:6px;">
        </div>
        <div style="display:flex; gap:8px; margin-bottom:6px;">
          <input type="number" placeholder="æ•¸é‡" value="1" class="qty-input" style="flex:1;padding:8px;border:1px solid #ccc;border-radius:6px;">
          <div class="profit-result" style="flex:1;padding-top:8px;color:#555;">é»æ“Šè©¦ç®— (é è¨­:${costLabel})</div>
        </div>
        <div class="profit-bar" style="height:8px;background:#eee;border-radius:4px;overflow:hidden;">
          <div class="profit-bar-fill" style="height:100%;width:0%;background:#4ade80;"></div>
        </div>
      </div>

      <div style="display:flex; gap:10px; margin-top:6px;">
        <button class="btn-primary line-share-btn" data-model="${item.model}" style="width:100%;">è¤‡è£½ LINE åˆ†äº«</button>
        <button class="btn-outline-add add-quote-btn" data-model="${item.model}" style="width:100%;margin-top:0;">â• åŠ å…¥å ±åƒ¹å–®</button>
      </div>
    `;
    openMobileSheet();
  }

  function openMobileSheet() {
    sheetBackdrop.classList.remove("hidden");
    mobileSheet.classList.remove("hidden");
    requestAnimationFrame(() => mobileSheet.classList.add("open"));
  }
  function closeMobileSheet() {
    mobileSheet.classList.remove("open");
    setTimeout(() => { if(!mobileSheet.classList.contains("open")) mobileSheet.classList.add("hidden"); if(quoteSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden"); }, 220);
  }

  // â˜… å ±åƒ¹å–® Sheet æ“ä½œ
  function openQuoteSheet() {
    sheetBackdrop.classList.remove("hidden");
    quoteSheet.classList.remove("hidden");
    requestAnimationFrame(() => quoteSheet.classList.add("open"));
    renderQuoteList();
  }
  function closeQuoteSheet() {
    quoteSheet.classList.remove("open");
    setTimeout(() => { if(!quoteSheet.classList.contains("open")) quoteSheet.classList.add("hidden"); if(mobileSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden"); }, 220);
  }

  sheetBackdrop.addEventListener("click", () => { closeMobileSheet(); closeQuoteSheet(); });
  sheetCloseBtn.addEventListener("click", closeMobileSheet);
  quoteCloseBtn.addEventListener("click", closeQuoteSheet);
  fabCart.addEventListener("click", openQuoteSheet);

  // â˜… åŠ å…¥å ±åƒ¹å–®é‚è¼¯
  document.addEventListener("click", function(e) {
    if (e.target.classList.contains("add-quote-btn")) {
      const model = e.target.getAttribute("data-model");
      const item = currentResultList.find(p => p.model === model);
      if (!item) return;

      const { cost, label } = getSelectedCostInfo(item);
      
      quoteList.push({
        model: item.model,
        name: item.name,
        price: cost,
        qtyLabel: label,
        count: 1 // é è¨­1å€‹ï¼Œé€™è£¡å¯ä»¥è®“ç”¨æˆ¶ä¿®æ”¹
      });
      
      updateCartCount();
      alert(`å·²åŠ å…¥å ±åƒ¹å–®ï¼\nç›®å‰æ¡ç”¨ ${label} åƒ¹æ ¼ï¼š$${cost}`);
    }
  });

  function updateCartCount() {
    cartCount.textContent = quoteList.length;
    if (quoteList.length > 0) {
      fabCart.classList.add("bounce");
      setTimeout(()=>fabCart.classList.remove("bounce"), 300);
    }
  }

  function renderQuoteList() {
    quoteListBody.innerHTML = "";
    let total = 0;

    if (quoteList.length === 0) {
      quoteListBody.innerHTML = `<div style="text-align:center;padding:40px;color:#999;">å ±åƒ¹å–®æ˜¯ç©ºçš„<br>è«‹å…ˆå¾åˆ—è¡¨åŠ å…¥å•†å“</div>`;
      quoteTotalEl.textContent = "$0";
      return;
    }

    quoteList.forEach((qItem, idx) => {
      const subtotal = qItem.price * qItem.count;
      total += subtotal;

      const div = document.createElement("div");
      div.className = "quote-item";
      div.innerHTML = `
        <div style="flex:1;">
          <div style="font-weight:600;font-size:15px;">${qItem.name}</div>
          <div class="quote-info" style="color:#666;">${qItem.model} | <span style="background:#eee;padding:1px 4px;border-radius:4px;font-size:12px;">${qItem.qtyLabel}</span></div>
        </div>
        <div style="text-align:right;margin-right:12px;">
          <div class="quote-price">$${qItem.price}</div>
          <div style="font-size:12px;color:#888;">x ${qItem.count}</div>
        </div>
        <div class="quote-del" data-idx="${idx}">ğŸ—‘ï¸</div>
      `;
      quoteListBody.appendChild(div);
    });

    quoteTotalEl.textContent = "$" + total.toLocaleString();

    // ç¶å®šåˆªé™¤æŒ‰éˆ•
    document.querySelectorAll(".quote-del").forEach(btn => {
      btn.addEventListener("click", (e) => {
        const idx = e.target.getAttribute("data-idx");
        quoteList.splice(idx, 1);
        renderQuoteList();
        updateCartCount();
      });
    });
  }

  clearQuoteBtn.addEventListener("click", () => {
    if (confirm("ç¢ºå®šè¦æ¸…ç©ºå ±åƒ¹å–®å—ï¼Ÿ")) {
      quoteList = [];
      renderQuoteList();
      updateCartCount();
      closeQuoteSheet();
    }
  });

  copyQuoteBtn.addEventListener("click", () => {
    if (quoteList.length === 0) return;

    let text = "ğŸ“‹ KINYO å•†å“å ±åƒ¹å–®\n----------------------\n";
    let total = 0;
    
    quoteList.forEach((item, i) => {
      const sub = item.price * item.count;
      total += sub;
      text += `${i+1}. ã€${item.model}ã€‘${item.name}\n`;
      text += `   è¦æ ¼ï¼š${item.qtyLabel} | å–®åƒ¹ï¼š$${item.price}\n`;
    });
    
    text += "----------------------\n";
    text += `ğŸ’° ç¸½è¨ˆé‡‘é¡ï¼š$${total.toLocaleString()}`;

    navigator.clipboard.writeText(text)
      .then(() => alert("âœ… å ±åƒ¹å–®å·²è¤‡è£½ï¼"))
      .catch(() => alert("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½"));
  });


  function exportSelectedExcel() {
    const checkedBoxes = document.querySelectorAll(".row-check:checked");
    if (checkedBoxes.length === 0) {
      alert("è«‹å…ˆå‹¾é¸è¦åŒ¯å‡ºçš„å•†å“");
      return;
    }
    const selectedModels = Array.from(checkedBoxes).map(chk => chk.getAttribute("data-model"));
    const baseHeader = ["å•†å“å‹è™Ÿ", "ä¸»å‹è™Ÿ", "å•†å“åç¨±", "é¡è‰²åˆ—è¡¨", "ç®±å…¥æ•¸", "å•†å“é€£çµ"];
    let priceHeader = [];
    const selectedQty = qtySelect.value;
    if (selectedQty) {
      priceHeader = [`${selectedQty}å€‹`, "æœ«å”®", "è³£å ´"];
    } else {
      if (userLevel === 1) priceHeader = ["50å€‹", "æœ«å”®", "è³£å ´"];
      else if (userLevel === 2) priceHeader = ["50å€‹", "100å€‹", "300å€‹", "æœ«å”®", "è³£å ´"];
      else if (userLevel === 3) priceHeader = ["50å€‹", "100å€‹", "300å€‹", "500å€‹", "1000å€‹", "æœ«å”®", "è³£å ´"];
    }
    const finalHeader = [...baseHeader, ...priceHeader];
    const rows = [finalHeader];

    selectedModels.forEach(model => {
      const item = currentResultList.find(p => p.model === model);
      if (!item) return;
      const baseRow = [item.model, item.mainModel, item.name, item.colorList, item.cartonQty, item.productUrl];
      let priceRow = [];
      if (selectedQty) {
        let cost = 0;
        if (selectedQty === "50") cost = item.quote50;
        else if (selectedQty === "100") cost = item.quote100;
        else if (selectedQty === "300") cost = item.quote300;
        else if (selectedQty === "500") cost = item.quote500;
        else if (selectedQty === "1000") cost = item.quote1000;
        else cost = item.quote50;
        priceRow = [cost, item.minPrice, item.marketPrice];
      } else {
        if (userLevel === 1) priceRow = [item.quote50, item.minPrice, item.marketPrice];
        else if (userLevel === 2) priceRow = [item.quote50, item.quote100, item.quote300, item.minPrice, item.marketPrice];
        else if (userLevel === 3) priceRow = [item.quote50, item.quote100, item.quote300, item.quote500, item.quote1000, item.minPrice, item.marketPrice];
      }
      rows.push([...baseRow, ...priceRow]);
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹");
    XLSX.writeFile(wb, `KINYO_å•†å“å ±åƒ¹_${selectedQty ? selectedQty + 'å€‹' : 'å®Œæ•´ç‰ˆ'}.xlsx`);
  }

  searchBtn.addEventListener("click", searchProducts);
  exportBtn.addEventListener("click", exportSelectedExcel);

  sortSelect.addEventListener("change", () => {
    if (currentResultList.length > 0) {
      const sorted = applySorting([...currentResultList]);
      renderResults(sorted);
    }
  });

  [keywordInput, qtySelect, minPriceInput, maxPriceInput].forEach(el => {
    el.addEventListener("keydown", e => {
      if (e.key === "Enter") searchProducts();
    });
  });

  document.addEventListener("input", function(e) {
    const row = e.target.closest(".profit-box, .sheet-content, #detailCard");
    if (!row) return;
    const cost = Number(row.querySelector(".cost-input")?.value || 0);
    const sell = Number(row.querySelector(".sell-input")?.value || 0);
    const qty  = Number(row.querySelector(".qty-input")?.value || 1);
    const resultEl = row.querySelector(".profit-result");
    const barFill  = row.querySelector(".profit-bar-fill");
    if (!resultEl || !barFill) return;

    if (cost > 0 && sell > 0) {
      const profit = (sell - cost) * qty;
      const margin = (sell - cost) / sell;
      const marginPct = Math.round(margin * 100);
      resultEl.innerHTML = `æ¯›åˆ©ï¼š${profit} å…ƒï¼ˆ${marginPct}%ï¼‰`;
      const pct = Math.max(0, Math.min(100, marginPct));
      barFill.style.width = pct + "%";
      barFill.style.background = `hsl(${pct}, 70%, 50%)`;
    } else {
      resultEl.innerHTML = "æ¯›åˆ©ï¼š-";
      barFill.style.width = "0%";
      barFill.style.background = "#4ade80";
    }
  });

  document.addEventListener("click", function(e) {
     if(e.target.tagName === "INPUT" && e.target.type === "number") {
         e.target.select();
     }
  });

  document.addEventListener("click", function(e) {
    if (!e.target.classList.contains("line-share-btn")) return;
    const model = e.target.getAttribute("data-model");
    const item = currentResultList.find(p => p.model === model);
    if (!item) return;

    let costText = "";
    if (userLevel >= 1) costText += `â€¢ 50å€‹ï¼š${item.quote50} å…ƒ`;
    if (userLevel >= 2) {
      costText += `\nâ€¢ 100å€‹ï¼š${item.quote100} å…ƒ`;
      costText += `\nâ€¢ 300å€‹ï¼š${item.quote300} å…ƒ`;
    }
    if (userLevel >= 3) {
      costText += `\nâ€¢ 500å€‹ï¼š${item.quote500} å…ƒ`;
      costText += `\nâ€¢ 1000å€‹ï¼š${item.quote1000} å…ƒ`;
    }

    const text = `ğŸ”¥ ã€${item.model}ã€‘${item.name}\nğŸ’° è³£å ´å”®åƒ¹ï¼š${item.marketPrice} å…ƒ\n--------------------------\nğŸ“¦ æ‚¨çš„æ¡è³¼åƒ¹æ ¼ï¼š\n${costText}\n\nğŸ”— å•†å“é€£çµï¼š${item.productUrl || "ç„¡"}`;
    navigator.clipboard.writeText(text)
      .then(()=> alert("âœ… å·²è¤‡è£½ï¼è«‹ç›´æ¥è²¼ä¸Š LINE å°è©±æ¡†"))
      .catch(()=> alert("ç„¡æ³•è¤‡è£½ï¼Œè«‹æ‰‹å‹•é•·æŒ‰è¤‡è£½"));
  });
</script>
</body>
</html>
