<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>KINYO æŸ¥åƒ¹ç³»çµ±ï¼ˆv4.5.2 æœ€çµ‚ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* ---------------------------
   v4.5.2 â€” å°ˆæ¥­ CSSï¼ˆå«è©³ç´°å¡ç‰‡å·¦å³åˆ†æ¬„å„ªåŒ–ï¼‰
----------------------------*/
:root{
  --bg:#f6f7f9;
  --card:#ffffff;
  --primary:#0f172a;
  --border:#e5e7eb;
  --text:#1f2937;
  --muted:#6b7280;
  --radius:12px;
  --shadow:0 4px 12px rgba(0,0,0,0.06);
}

body{
  margin:0;
  padding:24px;
  background:var(--bg);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--text);
  max-width:1020px;
  margin:0 auto;
}

h1{
  margin:0 0 4px;
}
.subtitle{
  color:var(--muted);
  margin-bottom:18px;
  font-size:14px;
}

.top-bar{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:12px;
  margin-bottom:14px;
  font-size:13px;
}
.user-badge{
  background:#eef0f4;
  padding:6px 14px;
  border-radius:999px;
}
.logout-btn{
  padding:6px 14px;
  border-radius:999px;
  border:1px solid var(--border);
  cursor:pointer;
  background:white;
  font-size:12px;
}

/* Search Box */
.search-box{
  background:var(--card);
  padding:18px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  margin-bottom:12px;
}
.search-row{margin-bottom:14px;}
label{
  font-weight:600;
  margin-bottom:6px;
  display:block;
  font-size:14px;
}

input,select{
  width:100%;
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:15px;
  box-sizing:border-box;
}

.btn-primary{
  background:var(--primary);
  color:white;
  border:none;
  border-radius:999px;
  padding:12px 20px;
  font-weight:600;
  cursor:pointer;
  width:100%;
}
.btn-secondary{
  background:white;
  border:1px solid var(--border);
  padding:10px 16px;
  border-radius:999px;
  cursor:pointer;
  font-size:14px;
}

.toolbar{
  display:flex;
  gap:10px;
  align-items:center;
  margin:10px 0 6px;
}

table{
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:var(--shadow);
}
th,td{
  padding:12px 10px;
  border-bottom:1px solid var(--border);
  font-size:14px;
  vertical-align:top;
}
th{background:#fafafa;text-align:left;}

.product-img{
  width:110px;
  height:110px;
  object-fit:cover;
  border-radius:8px;
  border:1px solid #e5e7eb;
  background:#fff;
}

/* è©³ç´°è³‡æ–™å¡ï¼šæ”¹ç‚ºå·¦å³åˆ†æ¬„ï¼Œå³å´ç¸®çª„é¿å…é®ä½æœå°‹çµæœ */
#detailCard{
  position:fixed;
  right:16px;
  top:120px;
  width:320px;
  max-height:78vh;
  overflow-y:auto;
  background:white;
  padding:18px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  display:none;
  z-index:999;
}

/* æ‰‹æ©Ÿ bottom sheet */
.sheet-backdrop{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.45);
  z-index:1000;
}
.sheet{
  position:fixed;
  left:0; right:0; bottom:0;
  height:80vh; background:#fff;
  border-radius:16px 16px 0 0;
  transform:translateY(100%);
  transition:transform .25s ease;
  display:flex; flex-direction:column;
  z-index:1001;
}
.sheet.open{transform:translateY(0);}

.sheet-header{
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  font-weight:600;
  display:flex; justify-content:space-between; align-items:center;
}
.sheet-close{
  background:none; border:none;
  font-size:26px;
  cursor:pointer;
  line-height:1;
}

.sheet-content{
  padding:16px;
  overflow-y:auto;
  font-size:15px;
  flex:1;
}

.hidden{display:none !important;}

/* å ±åƒ¹å–® */
.fab-cart{
  position:fixed;
  bottom:26px; right:22px;
  width:62px; height:62px;
  background:#111827;
  color:#fff;
  border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 6px 16px rgba(0,0,0,0.25);
  cursor:pointer;
  z-index:990;
}
.fab-badge{
  position:absolute;
  top:-2px; right:-2px;
  background:#ef4444;
  color:white;
  font-size:12px;
  font-weight:700;
  width:22px; height:22px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  border:2px solid #fff;
}

@media (max-width:900px){
  #detailCard{display:none !important;}
}
</style>
</head>

<body>
<div class="top-bar">
  <span id="userInfo" class="user-badge">æœªç™»å…¥</span>
  <button id="logoutBtn" class="logout-btn" style="display:none;">ç™»å‡º</button>
</div>

<h1>KINYO æŸ¥åƒ¹ç³»çµ±</h1>
<div class="subtitle">åŒä¸»å‹è™Ÿè‡ªå‹•åˆä½µï¼Œä¸åŒé¡è‰²åƒ…é¡¯ç¤ºä¸€ç­†ï¼ˆv4.5.2ï¼‰ã€‚</div>

<div class="search-box">
  <div class="search-row">
    <label>é—œéµå­—æœå°‹ï¼ˆå‹è™Ÿ / åç¨±ï¼‰</label>
    <input id="keyword" placeholder="å¦‚ï¼šCL528 / æ•èšŠç‡ˆ / é™¤æ¯›çƒæ©Ÿ" />
  </div>

  <div class="search-row">
    <label>èµ·è¨‚é‡ï¼ˆå¯ä¸é¸ï¼‰</label>
    <select id="qtySelect"></select>
  </div>

  <div class="search-row">
    <label>é ç®—å€é–“ï¼ˆèµ·è¨‚é‡å·²é¸æ™‚æ‰ç”Ÿæ•ˆï¼›å¯åªå¡«ä¸€é‚Šï¼‰</label>
    <div style="display:flex; gap:10px;">
      <input id="minPrice" type="number" placeholder="æœ€ä½ (å¯ç©º)">
      <input id="maxPrice" type="number" placeholder="æœ€é«˜ (å¯ç©º)">
    </div>
  </div>

  <button id="searchBtn" class="btn-primary">æŸ¥è©¢</button>
  <button id="clearBtn" class="btn-secondary" style="margin-top:10px;width:100%;">æ¸…é™¤æœå°‹æ¢ä»¶</button>
</div>

<div class="toolbar">
  <select id="sortSelect" class="btn-secondary">
    <option value="">ä¸æ’åº</option>
    <option value="minPriceAsc">æœ«å”®ï¼šä½ â†’ é«˜</option>
    <option value="minPriceDesc">æœ«å”®ï¼šé«˜ â†’ ä½</option>
    <option value="marketAsc">è³£å ´ï¼šä½ â†’ é«˜</option>
    <option value="marketDesc">è³£å ´ï¼šé«˜ â†’ ä½</option>
    <option value="alphaAsc">ä¸»å‹è™Ÿï¼šA â†’ Z</option>
    <option value="alphaDesc">ä¸»å‹è™Ÿï¼šZ â†’ A</option>
  </select>

  <button id="exportBtn" class="btn-secondary" disabled>åŒ¯å‡º Excel</button>
  <button id="quoteBtn" class="btn-secondary" disabled>å ±åƒ¹å–®</button>
</div>

<table id="resultTable" style="display:none;">
  <thead>
    <tr>
      <th style="width:32px;"><input type="checkbox" id="checkAll" /></th>
      <th style="width:120px;">åœ–ç‰‡</th>
      <th style="width:100px;">ä¸»å‹è™Ÿ</th>
      <th>å•†å“è³‡è¨Š</th>
      <th style="width:80px;">æœ«å”®</th>
      <th style="width:80px;">è³£å ´</th>
    </tr>
  </thead>
  <tbody id="resultBody"></tbody>
</table>

<div id="detailCard"></div>

<!-- Mobile detail sheet -->
<div id="sheetBackdrop" class="sheet-backdrop hidden"></div>
<div id="mobileDetailSheet" class="sheet hidden">
  <div class="sheet-header">
    <span>å•†å“è³‡è¨Š</span>
    <button id="sheetCloseBtn" class="sheet-close">Ã—</button>
  </div>
  <div class="sheet-content" id="sheetContent"></div>
</div>

<!-- Quote sheet -->
<div id="quoteSheet" class="sheet hidden">
  <div class="sheet-header">
    <span>å ±åƒ¹å–®é è¦½</span>
    <button id="quoteCloseBtn" class="sheet-close">Ã—</button>
  </div>
  <div class="sheet-content" style="display:flex;flex-direction:column;">
    <div id="quoteListBody" style="flex:1;overflow-y:auto;"></div>
    <div style="border-top:1px solid #eee; padding-top:12px; margin-top:10px;">
      <div style="display:flex;justify-content:space-between;font-weight:bold;font-size:16px;margin-bottom:8px;">
        <span>ç¸½è¨ˆé‡‘é¡</span>
        <span id="quoteTotal">$0</span>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:14px;margin-bottom:12px;color:#444;">
        <span>æ¯›åˆ©(èµ·è¨‚é‡/è³£å ´)</span>
        <span id="quoteMargin">-</span>
      </div>
      <button id="copyQuoteBtn" class="btn-primary" style="width:100%;">è¤‡è£½æ•´å¼µå ±åƒ¹å–® (LINE)</button>
      <button id="exportQuoteBtn" class="btn-secondary" style="width:100%;margin-top:8px;">å ±åƒ¹å–®åŒ¯å‡º Excel</button>
      <button id="clearQuoteBtn" class="btn-secondary" style="width:100%;margin-top:8px;color:#ef4444;border-color:#ef4444;">æ¸…ç©ºå ±åƒ¹å–®</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDtp6rwV7KmIOedLQ9793BnXbBquopP9kM",
    authDomain: "kinyo-price.firebaseapp.com",
    projectId: "kinyo-price",
    storageBucket: "kinyo-price.firebasestorage.app",
    messagingSenderId: "122464645678",
    appId: "1:122464645678:web:c0febbc6297a8ada5ea5bf"
  };

  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  let productCache = [];
  let currentResultList = [];
  let userLevel = 1;
  let currentUserEmail = "";
  let quoteList = [];
  let lastSearchMode = ""; // "keyword" | "qty"

  const keywordInput   = document.getElementById("keyword");
  const qtySelect      = document.getElementById("qtySelect");
  const minPriceInput  = document.getElementById("minPrice");
  const maxPriceInput  = document.getElementById("maxPrice");
  const sortSelect     = document.getElementById("sortSelect");
  const exportBtn      = document.getElementById("exportBtn");
  const quoteBtn       = document.getElementById("quoteBtn");
  const clearBtn       = document.getElementById("clearBtn");
  const resultTable    = document.getElementById("resultTable");
  const resultBody     = document.getElementById("resultBody");
  const checkAllBox    = document.getElementById("checkAll");
  const detailCard     = document.getElementById("detailCard");

  const userInfoSpan   = document.getElementById("userInfo");
  const logoutBtn      = document.getElementById("logoutBtn");

  const sheetBackdrop  = document.getElementById("sheetBackdrop");
  const mobileSheet    = document.getElementById("mobileDetailSheet");
  const sheetContent   = document.getElementById("sheetContent");
  const sheetCloseBtn  = document.getElementById("sheetCloseBtn");

  const quoteSheet     = document.getElementById("quoteSheet");
  const quoteCloseBtn  = document.getElementById("quoteCloseBtn");
  const quoteListBody  = document.getElementById("quoteListBody");
  const quoteTotalEl   = document.getElementById("quoteTotal");
  const quoteMarginEl  = document.getElementById("quoteMargin");
  const copyQuoteBtn   = document.getElementById("copyQuoteBtn");
  const exportQuoteBtn = document.getElementById("exportQuoteBtn");
  const clearQuoteBtn  = document.getElementById("clearQuoteBtn");

  const colorMap = {
    R:"ç´…", B:"è—", G:"ç¶ ", BK:"é»‘", WH:"ç™½", PK:"ç²‰", Y:"é»ƒ", OR:"æ©˜", BL:"è—", W:"ç™½",
    PI:"ç²‰", PU:"ç´«", YL:"é»ƒ", GN:"ç¶ ", RD:"ç´…", BU:"è—", GR:"ç°"
  };

  /* ---------------------------
     v4.5.2 æœ€çµ‚ä¸»å‹è™Ÿè¦å‰‡
     - å»æ‰å°¾ç«¯é€£çºŒè‹±æ–‡å­—æ¯(é¡è‰²ç¢¼)
  ----------------------------*/
  function getMainModel(model) {
    if (!model) return "";
    let m = model.trim().toUpperCase();

    // çµå°¾é€£çºŒè‹±æ–‡å­—æ¯è¦–ç‚ºé¡è‰²ç¢¼ï¼ˆä¸ç®¡é•·åº¦ï¼‰
    const match = m.match(/^([A-Z0-9\-]+?)([A-Z]+)$/);
    if (match) {
      const core = match[1];
      const color = match[2];
      if (color.length >= 1) {
        return core.replace(/[-_]$/, "");
      }
    }
    return m;
  }

  async function preloadProducts() {
    try {
      const snap = await getDocs(collection(db, "Products"));
      productCache = [];

      snap.forEach(docSnap => {
        const d = docSnap.data() || {};
        const model = (d.model || "").trim();
        const mainModel = getMainModel(model);

        let colorList = (d.colorList || "").trim();
        if (!colorList) {
          const m = model.toUpperCase();
          const tail = (m.match(/[A-Z]+$/) || [""])[0];
          if (tail) colorList = colorMap[tail] || tail;
        }

        const searchKey = (d.searchKey || `${model} ${d.name || ""}`).toLowerCase();

        productCache.push({
          ...d,
          model,
          mainModel,
          colorList,
          searchKey
        });
      });

      console.log("å•†å“é è¼‰å®Œæˆ", productCache.length, "ç­†");
    } catch (e) {
      console.error("é è¼‰å¤±æ•—ï¼š", e);
    }
  }
/* ---------------------------
     ä¸»å‹è™Ÿåˆä½µï¼šåŒä¸»å‹è™Ÿåªé¡¯ç¤ºä¸€ç­†
  ----------------------------*/
  function mergeByMainModel(list) {
    const map = {};

    list.forEach(item => {
      const main = item.mainModel;

      if (!map[main]) {
        map[main] = {
          ...item,
          models: [item.model],
          colorList: item.colorList || ""
        };
      } else {
        map[main].models.push(item.model);

        // é¡è‰²åˆä½µï¼ˆé¿å…é‡è¤‡ï¼‰
        const exist = map[main].colorList.split(" / ").filter(Boolean);
        const add   = (item.colorList || "").split(" / ").filter(Boolean);
        map[main].colorList = [...new Set([...exist, ...add])].join(" / ");
      }
    });

    return Object.values(map);
  }

  /* ---------------------------
     æ’åºåŠŸèƒ½
  ----------------------------*/
  function applySorting(list) {
    const opt = sortSelect.value;

    if (opt === "minPriceAsc")  return list.sort((a,b)=>a.minPrice - b.minPrice);
    if (opt === "minPriceDesc") return list.sort((a,b)=>b.minPrice - a.minPrice);
    if (opt === "marketAsc")    return list.sort((a,b)=>a.marketPrice - b.marketPrice);
    if (opt === "marketDesc")   return list.sort((a,b)=>b.marketPrice - a.marketPrice);
    if (opt === "alphaAsc")     return list.sort((a,b)=>a.mainModel.localeCompare(b.mainModel));
    if (opt === "alphaDesc")    return list.sort((a,b)=>b.mainModel.localeCompare(a.mainModel));

    return list;
  }

  /* ---------------------------
     æœå°‹åŠŸèƒ½ï¼ˆv4.5.2ï¼‰
     - æ”¯æ´é—œéµå­—
     - èµ·è¨‚é‡ + é ç®—
     - ä¸‰è€…å…¨éƒ¨å¡«å¯« â†’ å…¨éƒ¨æˆç«‹æ‰é¡¯ç¤º
  ----------------------------*/
  function searchProducts() {
    const key = keywordInput.value.trim().toLowerCase();
    const qty = qtySelect.value;
    const minPraw = minPriceInput.value.trim();
    const maxPraw = maxPriceInput.value.trim();

    let useKeyword = key.length > 0;
    let useQty = qty.length > 0;
    let useBudget = minPraw || maxPraw;

    // åˆ¤æ–·æœå°‹æ¨¡å¼ï¼Œç”¨æ–¼åŒ¯å‡º Excel
    if (useQty) lastSearchMode = "qty";
    else if (useKeyword) lastSearchMode = "keyword";

    // Case Aï¼šå–®ç´”é—œéµå­—æœå°‹
    if (useKeyword && !useQty) {
      const r = productCache.filter(p =>
        (p.searchKey || "").includes(key)
      );
      currentResultList = applySorting(mergeByMainModel(r));
      renderResults(currentResultList);
      return;
    }

    // Case Bï¼šèµ·è¨‚é‡ï¼ˆå¯å«é ç®—ï¼‰æˆ– é—œéµå­— + èµ·è¨‚é‡ + é ç®—
    if (useQty) {
      const costKey = `quote${qty}`;
      const minP = minPraw ? Number(minPraw) : 0;
      const maxP = maxPraw ? Number(maxPraw) : Number.MAX_SAFE_INTEGER;

      const r = productCache.filter(p => {
        const cost = Number(p[costKey]) || 0;

        // 1. èµ·è¨‚é‡ + é ç®—
        if (cost < minP || cost > maxP) return false;

        // 2. è‹¥åŒæ™‚è¼¸å…¥é—œéµå­— â†’ å¿…é ˆä¹Ÿé€šé
        if (useKeyword) {
          if (!(p.searchKey || "").includes(key)) return false;
        }
        return true;
      });

      currentResultList = applySorting(mergeByMainModel(r));
      renderResults(currentResultList);
      return;
    }

    alert("è«‹è¼¸å…¥é—œéµå­—ï¼Œæˆ–é¸æ“‡èµ·è¨‚é‡ + é ç®—å€é–“é€²è¡Œæœå°‹ã€‚");
  }

  /* ---------------------------
     æ¸²æŸ“æœå°‹çµæœ
  ----------------------------*/
  function renderResults(list) {
    resultBody.innerHTML = "";
    detailCard.style.display = "none";
    closeSheet();

    if (checkAllBox) checkAllBox.checked = false;

    if (list.length === 0) {
      resultTable.style.display = "none";
      exportBtn.disabled = true;
      quoteBtn.disabled  = true;
      return;
    }

    resultTable.style.display = "table";
    exportBtn.disabled = false;
    quoteBtn.disabled  = false;

    list.forEach(item => {
      const img = item.imageUrl || "https://placehold.co/120x120?text=No+Image";
      const tr = document.createElement("tr");

      // åƒ¹æ ¼æ¨™ç±¤
      let priceHtml = "";
      if (userLevel >= 1)
        priceHtml += `<span class="price-tag tag50">50å€‹ï¼š${item.quote50}</span>`;
      if (userLevel >= 2)
        priceHtml += `
          <span class="price-tag tag100">100å€‹ï¼š${item.quote100}</span>
          <span class="price-tag tag300">300å€‹ï¼š${item.quote300}</span>`;
      if (userLevel >= 3)
        priceHtml += `
          <span class="price-tag tag500">500å€‹ï¼š${item.quote500}</span>
          <span class="price-tag tag1000">1000å€‹ï¼š${item.quote1000}</span>`;

      tr.innerHTML = `
        <td><input type="checkbox" class="row-check" data-model="${item.model}" /></td>
        <td><img src="${img}" class="product-img"></td>
        <td>${item.mainModel}</td>
        <td>
          <div style="font-weight:700;margin-bottom:4px;">${item.name}</div>
          <div style="font-size:13px;color:#555;">é¡è‰²ï¼š${item.colorList || "-"}</div>
          <div class="price-tag-container" style="margin-top:4px;">${priceHtml}</div>
          <div style="display:flex;gap:6px;margin-top:6px;">
            <button class="line-share-btn"
                    data-model="${item.model}"
                    style="padding:6px 10px;font-size:12px;background:#06C755;color:#fff;border:none;border-radius:6px;cursor:pointer;">
              LINE
            </button>

            <button class="btn-outline-add add-quote-btn" data-model="${item.model}">
              â• å ±åƒ¹å–®
            </button>
          </div>
        </td>
        <td style="text-align:right;">${item.minPrice}</td>
        <td style="text-align:right;">${item.marketPrice}</td>
      `;

      // æ¡Œæ©Ÿå³å´è©³ç´°å¡ç‰‡
      if (window.innerWidth > 900) {
        tr.addEventListener("mouseenter", () => showDetailDesktop(item));
        tr.addEventListener("click", (e) => {
          if (["INPUT","BUTTON"].includes(e.target.tagName)) return;
          showDetailDesktop(item);
        });
      } 
      // æ‰‹æ©Ÿ bottom sheet
      else {
        tr.addEventListener("click", (e) => {
          if (["INPUT","BUTTON"].includes(e.target.tagName)) return;
          showDetailMobile(item);
        });
      }

      resultBody.appendChild(tr);
    });

    bindCheckAll();
  }

  /* ---------------------------
     å…¨é¸ checkbox
  ----------------------------*/
  function bindCheckAll() {
    const rowChecks = document.querySelectorAll(".row-check");

    checkAllBox.onchange = () =>
      rowChecks.forEach(c => c.checked = checkAllBox.checked);

    rowChecks.forEach(chk => {
      chk.onchange = () => {
        const all = document.querySelectorAll(".row-check");
        const checked = document.querySelectorAll(".row-check:checked");
        checkAllBox.checked = (all.length === checked.length);
      };
    });
  }
/* ---------------------------
     è©³ç´°å¡ç‰‡ï¼ˆæ¡Œæ©Ÿå³å´ï¼‰
  ----------------------------*/
  function showDetailDesktop(item) {
    const img = item.imageUrl || "https://placehold.co/300x300?text=No+Image";

    let priceBlock = "";
    if (userLevel >= 1) priceBlock += `<div>50 å€‹ï¼š${item.quote50}</div>`;
    if (userLevel >= 2) priceBlock += `<div>100 å€‹ï¼š${item.quote100}</div><div>300 å€‹ï¼š${item.quote300}</div>`;
    if (userLevel >= 3) priceBlock += `<div>500 å€‹ï¼š${item.quote500}</div><div>1000 å€‹ï¼š${item.quote1000}</div>`;

    detailCard.style.display = "block";
    detailCard.innerHTML = `
      <img src="${img}" style="width:100%;border-radius:10px;border:1px solid #eee;margin-bottom:10px;">
      <div style="font-weight:700;font-size:16px;margin-bottom:8px;">${item.name}</div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:14px;line-height:1.6;">
        <div><strong>ä¸»å‹è™Ÿ</strong><br>${item.mainModel}</div>
        <div><strong>é¡è‰²</strong><br>${item.colorList || "-"}</div>
        <div><strong>è³£å ´å”®åƒ¹</strong><br>${item.marketPrice}</div>
        <div><strong>æœ«å”®åƒ¹æ ¼</strong><br>${item.minPrice}</div>
        <div style="grid-column:1 / span 2;">
          <strong>å•†å“ç¶²å€</strong><br>
          ${item.productUrl ? `<a href="${item.productUrl}" target="_blank">å‰å¾€å•†å“é </a>` : "-"}
        </div>
      </div>

      <div style="font-weight:700;margin:12px 0 6px;">æ¡è³¼åƒ¹æ ¼</div>
      <div style="line-height:1.7;">${priceBlock}</div>

      <div style="display:flex;gap:8px;margin-top:12px;">
        <button class="btn-primary line-share-btn" data-model="${item.model}" style="flex:1;">LINE åˆ†äº«</button>
        <button class="btn-outline-add add-quote-btn" data-model="${item.model}" style="flex:1;margin-top:0;">åŠ å…¥å ±åƒ¹å–®</button>
      </div>
    `;
  }

  /* ---------------------------
     è©³ç´°å¡ç‰‡ï¼ˆæ‰‹æ©Ÿ bottom sheetï¼‰
  ----------------------------*/
  function showDetailMobile(item) {
    const img = item.imageUrl || "https://placehold.co/300x300?text=No+Image";

    let priceBlock = "";
    if (userLevel >= 1) priceBlock += `<div>50 å€‹ï¼š${item.quote50}</div>`;
    if (userLevel >= 2) priceBlock += `<div>100 å€‹ï¼š${item.quote100}</div><div>300 å€‹ï¼š${item.quote300}</div>`;
    if (userLevel >= 3) priceBlock += `<div>500 å€‹ï¼š${item.quote500}</div><div>1000 å€‹ï¼š${item.quote1000}</div>`;

    sheetContent.innerHTML = `
      <img src="${img}" style="width:100%;border-radius:10px;border:1px solid #eee;margin-bottom:10px;">
      <div style="font-weight:700;font-size:16px;margin-bottom:8px;">${item.name}</div>

      <div style="font-size:14px;line-height:1.7;margin-bottom:10px;">
        <strong>ä¸»å‹è™Ÿï¼š</strong>${item.mainModel}<br>
        <strong>é¡è‰²ï¼š</strong>${item.colorList || "-"}<br>
        <strong>è³£å ´ï¼š</strong>${item.marketPrice}<br>
        <strong>æœ«å”®ï¼š</strong>${item.minPrice}<br>
        <strong>ç¶²å€ï¼š</strong>${item.productUrl ? `<a href="${item.productUrl}" target="_blank">å‰å¾€å•†å“é </a>` : "-"}
      </div>

      <div style="font-weight:700;margin-bottom:6px;">æ¡è³¼åƒ¹æ ¼</div>
      <div style="line-height:1.7;">${priceBlock}</div>

      <div style="display:flex;gap:8px;margin-top:12px;">
        <button class="btn-primary line-share-btn" data-model="${item.model}" style="flex:1;">LINE åˆ†äº«</button>
        <button class="btn-outline-add add-quote-btn" data-model="${item.model}" style="flex:1;margin-top:0;">åŠ å…¥å ±åƒ¹å–®</button>
      </div>
    `;
    openSheet();
  }

  function openSheet() {
    sheetBackdrop.classList.remove("hidden");
    mobileSheet.classList.remove("hidden");
    requestAnimationFrame(() => mobileSheet.classList.add("open"));
  }

  function closeSheet() {
    mobileSheet.classList.remove("open");
    setTimeout(() => {
      mobileSheet.classList.add("hidden");
      if (quoteSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden");
    }, 220);
  }

  /* ---------------------------
     å ±åƒ¹å–®ï¼ˆopen/close/renderï¼‰
  ----------------------------*/
  function openQuoteSheet() {
    sheetBackdrop.classList.remove("hidden");
    quoteSheet.classList.remove("hidden");
    requestAnimationFrame(() => quoteSheet.classList.add("open"));
    renderQuoteList();
  }

  function closeQuoteSheet() {
    quoteSheet.classList.remove("open");
    setTimeout(() => {
      quoteSheet.classList.add("hidden");
      if (mobileSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden");
    }, 220);
  }

  function renderQuoteList() {
    quoteListBody.innerHTML = "";
    let total = 0;

    let totalMarket = 0;
    let totalCost = 0;

    if (quoteList.length === 0) {
      quoteListBody.innerHTML = `<div style="text-align:center;padding:40px;color:#999;">å ±åƒ¹å–®æ˜¯ç©ºçš„</div>`;
      quoteTotalEl.textContent = "$0";
      quoteMarginEl.textContent = "-";
      return;
    }

    quoteList.forEach((q, idx) => {
      const sub = q.price * q.count;
      total += sub;

      totalCost += sub;
      totalMarket += (q.marketPrice || 0) * q.count;

      const div = document.createElement("div");
      div.className = "quote-item";
      div.innerHTML = `
        <div style="flex:1;">
          <div style="font-weight:700;">${q.name}</div>
          <div class="quote-info" style="color:#666;">${q.model} | ${q.qtyLabel}</div>
        </div>
        <div style="text-align:right;margin-right:8px;">
          <div class="quote-price">$${q.price}</div>
          <div style="font-size:12px;color:#888;">x ${q.count}</div>
        </div>
        <div class="quote-del" data-idx="${idx}">ğŸ—‘ï¸</div>
      `;
      quoteListBody.appendChild(div);
    });

    quoteTotalEl.textContent = "$" + total.toLocaleString();

    // æ¯›åˆ©ç‡ï¼ˆç”¨èµ·è¨‚é‡æˆæœ¬ vs è³£å ´ï¼‰
    if (totalMarket > 0) {
      const marginRate = (1 - totalCost / totalMarket) * 100;
      quoteMarginEl.textContent = marginRate.toFixed(1) + "%";
    } else {
      quoteMarginEl.textContent = "-";
    }

    document.querySelectorAll(".quote-del").forEach(btn => {
      btn.onclick = (e) => {
        const i = Number(e.target.getAttribute("data-idx"));
        quoteList.splice(i, 1);
        renderQuoteList();
      };
    });
  }

  /* ---------------------------
     åŒ¯å‡º Excelï¼ˆv4.5.2ï¼‰
     - è‹¥æ˜¯èµ·è¨‚é‡æ¨¡å¼ â†’ åªè¼¸å‡ºè©²èµ·è¨‚é‡å–®åƒ¹ + æœ«å”® + è³£å ´
     - è‹¥æ˜¯é—œéµå­—æ¨¡å¼ â†’ ä¸è¼¸å‡ºå ±åƒ¹åƒ¹æ ¼
  ----------------------------*/
  function exportSelectedExcel() {
    const checked = document.querySelectorAll(".row-check:checked");
    if (checked.length === 0) {
      alert("è«‹å…ˆå‹¾é¸è¦åŒ¯å‡ºçš„å•†å“");
      return;
    }

    const selectedModels = Array.from(checked).map(c => c.getAttribute("data-model"));
    const baseHeader = ["å•†å“å‹è™Ÿ", "ä¸»å‹è™Ÿ", "å•†å“åç¨±", "é¡è‰²åˆ—è¡¨", "ç®±å…¥æ•¸", "å•†å“é€£çµ"];
    let priceHeader = [];
    const qty = qtySelect.value;

    if (lastSearchMode === "qty" && qty) {
      priceHeader = [`${qty}å€‹å–®åƒ¹`, "æœ«å”®", "è³£å ´"];
    } else {
      // keyword æ¨¡å¼ï¼šä¸è¼¸å‡ºå ±åƒ¹æ¬„ä½
      priceHeader = ["æœ«å”®", "è³£å ´"];
    }

    const rows = [[...baseHeader, ...priceHeader]];

    selectedModels.forEach(m => {
      const item = currentResultList.find(p => p.model === m);
      if (!item) return;

      const baseRow = [
        item.model,
        item.mainModel,
        item.name,
        item.colorList,
        item.cartonQty,
        item.productUrl
      ];

      let priceRow = [];
      if (lastSearchMode === "qty" && qty) {
        const ck = `quote${qty}`;
        priceRow = [item[ck] || item.quote50, item.minPrice, item.marketPrice];
      } else {
        priceRow = [item.minPrice, item.marketPrice];
      }

      rows.push([...baseRow, ...priceRow]);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹");
    XLSX.writeFile(wb, `KINYO_å•†å“å ±åƒ¹_${lastSearchMode==="qty" ? qty+"å€‹" : "é—œéµå­—"}.xlsx`);
  }

  /* ---------------------------
     å ±åƒ¹å–®åŒ¯å‡º Excel
  ----------------------------*/
  function exportQuoteExcel() {
    if (quoteList.length === 0) { alert("å ±åƒ¹å–®æ˜¯ç©ºçš„"); return; }

    const header = ["å•†å“å‹è™Ÿ","å•†å“åç¨±","è¦æ ¼","å–®åƒ¹","æ•¸é‡","å°è¨ˆ","è³£å ´","æœ«å”®"];
    const rows = [header];

    quoteList.forEach(q => {
      const sub = q.price * q.count;
      rows.push([
        q.model,
        q.name,
        q.qtyLabel,
        q.price,
        q.count,
        sub,
        q.marketPrice || "",
        q.minPrice || ""
      ]);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®");
    XLSX.writeFile(wb, "KINYO_å ±åƒ¹å–®.xlsx");
  }
