<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>KINYO 耐嘉 查價系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 30px auto;
      padding: 0 16px;
      background: #f5f5f5;
    }
    h1 { margin-bottom: 8px; }
    .subtitle { color: #666; margin-bottom: 20px; }

    /* 搜尋區 */
    .search-box {
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 16px;
    }
    input, select {
      padding: 8px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      margin-top: 8px;
    }
    .moq-options label {
      margin-right: 12px;
      font-weight: 600;
      cursor: pointer;
    }
    button {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #111827;
      color: #fff;
      font-weight: 600;
      margin-top: 12px;
      width: 100%;
    }

    /* 搜尋結果列表 */
    .item {
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 12px;
      display: flex;
      gap: 12px;
      align-items: flex-start;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }
    .item img {
      width: 90px;
      height: 90px;
      object-fit: contain;
      background: #fafafa;
      border-radius: 8px;
    }
    .item-title {
      font-size: 16px;
      font-weight: 700;
    }
    .tags { margin-top: 4px; }
    .tag {
      padding: 2px 8px;
      border-radius: 6px;
      font-size: 12px;
      margin-right: 4px;
      font-weight: 700;
      display: inline-block;
    }
    .t50 { background:#e0f0ff; color:#005bbb; }
    .t100 { background:#e0f7ff; color:#0088cc; }
    .t300 { background:#e8ffe0; color:#3a8f00; }
    .t500 { background:#fff0d9; color:#cc7700; }
    .t1000 { background:#ffe6ee; color:#cc0055; }

    .price-right {
      font-size: 14px;
      color: #444;
      margin-top: 4px;
      text-align: right;
    }

    .export-box {
      margin-top: 16px;
      text-align: right;
    }
    .export-btn {
      background: #2563eb;
      color: #fff;
      padding: 8px 16px;
      border-radius: 8px;
      cursor:pointer;
      font-weight:600;
    }
  </style>
</head>

<body>

<h1>KINYO 耐嘉 查價系統</h1>
<div class="subtitle">支援模糊搜尋、起訂量、價格區間、匯出 Excel</div>

<!-- 搜尋區 -->
<div class="search-box">

  <label>關鍵字搜尋（型號 / 名稱）</label>
  <input id="keywordInput" type="text" placeholder="例如：CL528 / 除毛球機" />

  <label style="margin-top:16px;">選擇起訂量（必填才能使用價格區間）</label>
  <div class="moq-options">
    <label><input type="radio" name="moq" value="50"> 50</label>
    <label><input type="radio" name="moq" value="100"> 100</label>
    <label><input type="radio" name="moq" value="300"> 300</label>
    <label><input type="radio" name="moq" value="500"> 500</label>
    <label><input type="radio" name="moq" value="1000"> 1000</label>
  </div>

  <label style="margin-top:16px;">價格區間（含稅）</label>
  <input id="minBudget" type="number" placeholder="最低價格" />
  <input id="maxBudget" type="number" placeholder="最高價格" />

  <button id="searchBtn">搜尋</button>
</div>

<div class="export-box">
  <span class="export-btn" id="exportBtn">匯出勾選商品 Excel</span>
</div>

<!-- 搜尋結果 -->
<div id="resultList"></div>

<!-- Firebase -->
<script type="module">
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT_ID.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID",
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import * as XLSX from "https://cdn.jsdelivr.net/npm/xlsx@0.18.5/+esm";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const searchBtn = document.getElementById("searchBtn");
  const resultList = document.getElementById("resultList");

  let allProducts = [];

  // 初始取得所有商品
  async function loadProducts() {
    const snap = await getDocs(collection(db, "Products"));
    allProducts = snap.docs.map(doc => doc.data());
    console.log("載入商品數量：", allProducts.length);
  }

  await loadProducts();

  // 搜尋按鈕
  searchBtn.addEventListener("click", doSearch);

  function doSearch() {
    const keyword = document.getElementById("keywordInput").value.trim().toUpperCase();
    const minBudget = Number(document.getElementById("minBudget").value || 0);
    const maxBudget = Number(document.getElementById("maxBudget").value || 0);
    const moqRadio = document.querySelector("input[name='moq']:checked");
    const moq = moqRadio ? Number(moqRadio.value) : null;

    resultList.innerHTML = "";

    // ★ 若使用價格區間 → 必須選起訂量
    if ((minBudget || maxBudget) && !moq) {
      alert("請先選擇起訂量，再使用價格區間搜尋。");
      return;
    }

    let moqField = null;
    if (moq === 50) moqField = "quote50";
    if (moq === 100) moqField = "quote100";
    if (moq === 300) moqField = "quote300";
    if (moq === 500) moqField = "quote500";
    if (moq === 1000) moqField = "quote1000";

    const results = allProducts.filter(p => {
      let ok = true;

      // 關鍵字搜尋
      if (keyword) {
        if (!p.searchKey?.includes(keyword)) ok = false;
      }

      // 價格區間判斷
      if (moqField) {
        const price = Number(p[moqField] || 0);
        if (minBudget && price < minBudget) ok = false;
        if (maxBudget && price > maxBudget) ok = false;
      }

      return ok;
    });

    renderResults(results);
  }

  // 顯示搜尋結果
  function renderResults(list) {
    if (!list.length) {
      resultList.innerHTML = "<div>查無商品</div>";
      return;
    }

    resultList.innerHTML = "";

    list.forEach(p => {
      const item = document.createElement("div");
      item.className = "item";

      const imgUrl = p.imageUrl || "https://via.placeholder.com/90x90?text=No+Image";

      item.innerHTML = `
        <input type="checkbox" class="export-check" data-model="${p.model}">
        <img src="${imgUrl}">
        
        <div style="flex:1;">
          <div class="item-title">${p.name}</div>

          <div class="tags">
            ${p.quote50 ? `<span class="tag t50">50：${p.quote50}元</span>` : ""}
            ${p.quote100 ? `<span class="tag t100">100：${p.quote100}元</span>` : ""}
            ${p.quote300 ? `<span class="tag t300">300：${p.quote300}元</span>` : ""}
            ${p.quote500 ? `<span class="tag t500">500：${p.quote500}元</span>` : ""}
            ${p.quote1000 ? `<span class="tag t1000">1000：${p.quote1000}元</span>` : ""}
          </div>

          <div class="price-right">
            末售：${p.minPrice} 元<br>
            賣場：${p.marketPrice} 元
          </div>
        </div>
      `;

      resultList.appendChild(item);
    });
  }

  // 匯出 Excel
  document.getElementById("exportBtn").addEventListener("click", () => {
    const checked = [...document.querySelectorAll(".export-check:checked")];
    if (!checked.length) {
      alert("請先勾選商品！");
      return;
    }

    const exportList = [];
    checked.forEach(c => {
      const model = c.dataset.model;
      const p = allProducts.find(x => x.model === model);
      if (p) {
        exportList.push({
          商品型號: p.model,
          商品名稱: p.name,
          箱入數: p.cartonQty,
          採購100: p.quote100,
          末售價: p.minPrice,
          賣場價: p.marketPrice,
          網站: p.productUrl
        });
      }
    });

    const ws = XLSX.utils.json_to_sheet(exportList);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Export");
    XLSX.writeFile(wb, "匯出商品.xlsx");
  });

</script>
</body>
</html>
