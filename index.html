<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>KINYO æŸ¥åƒ¹ç³»çµ±ï¼ˆv6.2 å„ªåŒ–ç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- PptxGenJS for PPT export & XLSX for Excel -->
<script src="https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
/* =========================================
Â  Â Root è®Šæ•¸
========================================= */
:root{
Â  --bg:#f5f6f8;
Â  --card:#ffffff;
Â  --primary:#111827;
Â  --primary-blue:#2563eb;
Â  --border:#e5e7eb;
Â  --text:#1f2937;
Â  --muted:#6b7280;
Â  --radius:12px;
Â  --shadow:0 4px 12px rgba(0,0,0,0.06);

Â  --loading-bg:#e5e7eb;
Â  --loading-fill:#3b82f6;

Â  /* Custom UI Colors */
Â  --success: #10b981;
Â  --warning: #f59e0b;
Â  --danger: #ef4444;
}

/* =========================================
Â  Â Body
========================================= */
body{
Â  margin:0;
Â  padding:24px;
Â  background:var(--bg);
Â  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
Â  color:var(--text);
Â  max-width:980px;
Â  margin:0 auto;
}

h1{margin:0 0 4px;}
.subtitle{
Â  color:var(--muted);
Â  margin-bottom:18px;
Â  font-size:14px;
Â  font-weight: 500;
Â  letter-spacing: 0.5px;
}

/* =========================================
Â  Â Top Bar
========================================= */
.top-bar{
Â  display:flex;
Â  justify-content:space-between;
Â  align-items:center;
Â  margin-bottom:14px;
}
.user-badge{
Â  background:#eef0f4;
Â  padding:6px 14px;
Â  border-radius:999px;
Â  font-size:13px;
Â  transition: all 0.3s ease;
Â  border: 1px solid transparent;
}
.badge-lv0 { color: #666; border-color: #ddd; background: #f3f4f6; }
.badge-lv1 { background: #dbeafe; color: #1e40af; }
.badge-lv2 { background: #dcfce7; color: #15803d; }
.badge-lv3 { background: #fef3c7; color: #92400e; }
.badge-lv4 { background: #f3e8ff; color: #6b21a8; }

.logout-btn{
Â  padding:6px 14px;
Â  border-radius:999px;
Â  border:1px solid var(--border);
Â  cursor:pointer;
Â  background:white;
Â  font-size:12px;
}

/* =========================================
Â  Â Toolbar
========================================= */
.toolbar{
Â  display:flex;
Â  gap:10px;
Â  align-items:center;
Â  margin:10px 0 6px;
Â  flex-wrap: wrap;
Â  transition: all 0.3s ease;
}
.toolbar select{ flex:1; min-width: 120px; }

/* å·¥å…·åˆ—æ‡¸æµ®æ¨£å¼ */
.toolbar.fixed-active {
Â  position: fixed;
Â  top: 24px;
Â  left: 50%;
Â  transform: translateX(-50%);
Â  bottom: auto;
Â Â 
Â  z-index: 2000;
Â  background: rgba(255, 255, 255, 0.98);
Â  backdrop-filter: blur(10px);
Â  padding: 12px 20px;
Â Â 
Â  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
Â  border: 1px solid rgba(0,0,0,0.1);
Â Â 
Â  width: calc(100% - 48px);
Â  max-width: 980px;
Â  border-radius: 12px;
Â Â 
Â  justify-content: flex-start;
Â  animation: popDown 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes popDown {
Â  from { transform: translate(-50%, -120%); opacity: 0; }
Â  to { transform: translate(-50%, 0); opacity: 1; }
}

#toolbarSpacer { height: 70px; display: none; }

.quote-toolbar-btn{
Â  padding:10px 16px;
Â  border-radius:999px;
Â  border:1px solid var(--border);
Â  background:white;
Â  cursor:pointer;
Â  font-size:14px;
Â  white-space:nowrap;
Â  display:none;
}

/* =========================================
Â  Â æœå°‹å€å¡Š
========================================= */
.search-box{
Â  background:var(--card);
Â  padding:18px;
Â  border-radius:var(--radius);
Â  box-shadow:0 8px 28px rgba(0,0,0,0.15);
Â  margin-bottom:12px;
}
.search-row{margin-bottom:14px;}
label{
Â  font-weight:600;
Â  margin-bottom:6px;
Â  display:block;
Â  font-size:14px;
}
input,select{
Â  width:100%;
Â  padding:10px 12px;
Â  border-radius:8px;
Â  border:1px solid #d1d5db;
Â  font-size:15px;
Â  box-sizing:border-box;
}

/* è¤‡åˆå¼æœå°‹åˆ— (åˆ†é¡ + é—œéµå­—) */
.combo-search {
Â  Â  display: flex;
Â  Â  gap: 10px;
}
.combo-search select {
Â  Â  width: 35%;
Â  Â  min-width: 130px;
Â  Â  background-color: #f9fafb;
Â  Â  border: 1px solid #cbd5e1;
}
.combo-search input {
Â  Â  flex: 1;
}

/* =========================================
Â  Â Buttons
========================================= */
.btn-primary{
Â  background:var(--primary);
Â  color:white;
Â  border:none;
Â  border-radius:999px;
Â  padding:12px 20px;
Â  font-weight:600;
Â  cursor:pointer;
Â  width:100%;
}
.btn-secondary{
Â  background:white;
Â  border:1px solid var(--border);
Â  padding:10px 16px;
Â  border-radius:999px;
Â  cursor:pointer;
Â  font-size:14px;
Â  white-space:nowrap;
}
.btn-secondary:disabled { color: #ccc; cursor: not-allowed; }
.btn-outline-add{
Â  padding:6px 12px;
Â  border-radius:6px;
Â  border:1px solid #2563eb;
Â  background:#eff6ff;
Â  color:#2563eb;
Â  font-size:12px;
Â  cursor:pointer;
Â  font-weight:600;
}
.btn-outline-add:hover{background:#dbeafe;}

/* =========================================
Â  Â è¡¨æ ¼
========================================= */
table{
Â  width:100%;
Â  border-collapse:collapse;
Â  background:white;
Â  border-radius:var(--radius);
Â  box-shadow:0 8px 28px rgba(0,0,0,0.15);
}
th,td{
Â  padding:12px 10px;
Â  border-bottom:1px solid var(--border);
Â  font-size:14px;
Â  vertical-align:top;
}
th{background:#fafafa;text-align:left;}

.product-img{
Â  width:110px;height:110px;
Â  object-fit:cover;
Â  border-radius:14px;
Â  border:1px solid #e5e7eb;
Â  cursor: pointer;
}
.model-cell { cursor: pointer; }
.model-cell:hover { color: var(--primary-blue); text-decoration: underline; }

/* åƒ¹æ ¼æ¨™ç±¤ */
.price-tag{
Â  padding:3px 8px;
Â  font-size:12px;
Â  border-radius:6px;
Â  display:inline-block;
Â  margin-right:6px;
Â  margin-bottom:4px;
Â  font-weight:600;
Â  white-space:nowrap;
}
.tag50{background:#dbeafe;color:#1e40af;}
.tag100{background:#e0f2fe;color:#0369a1;}
.tag300{background:#dcfce7;color:#15803d;}
.tag500{background:#ffedd5;color:#ea580c;}
.tag1000{background:#fee2e2;color:#b91c1c;}

/* åˆ†é¡æ¨™ç±¤ */
.category-badge {
Â  Â  display: inline-block;
Â  Â  font-size: 11px;
Â  Â  padding: 2px 6px;
Â  Â  background: #f1f5f9;
Â  Â  color: #64748b;
Â  Â  border-radius: 4px;
Â  Â  margin-bottom: 4px;
Â  Â  border: 1px solid #e2e8f0;
}

/* åº«å­˜æ¨™ç±¤ */
.stock-badge {
Â  Â  display: inline-block;
Â  Â  font-size: 13px;
Â  Â  font-weight: bold;
Â  Â  padding: 3px 8px;
Â  Â  border-radius: 6px;
Â  Â  margin-top: 4px;
Â  Â  background: #f0fdf4;
Â  Â  color: #15803d;
Â  Â  border: 1px solid #bbf7d0;
Â  Â  transition: all 0.3s;
}
/* ä½åº«å­˜ / 100å€‹ä»¥å…§ */
.stock-low { background: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }
/* ä¸­åº«å­˜ / 300~500å€‹ */
.stock-mid { background: #fffbeb; color: #b45309; border: 1px solid #fde68a; }
/* é«˜åº«å­˜ / 1000å€‹ */
.stock-high { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }

/* =========================================
Â  Â Loading
========================================= */
#centerLoadingBox{
Â  position:fixed;
Â  inset:0;
Â  background:rgba(0,0,0,0.35);
Â  display:none;
Â  align-items:center;
Â  justify-content:center;
Â  z-index:5000; /* Increased Z-index */
}
#centerLoadingCard{
Â  background:rgba(255,255,255,0.65);backdrop-filter:blur(14px);
Â  width:280px;
Â  padding:20px;
Â  border-radius:12px;
Â  box-shadow:0 8px 28px rgba(0,0,0,0.15);
}
.loading-title{
Â  font-size:15px;
Â  font-weight:700;
Â  margin-bottom:12px;
}
.loading-bar {
Â  height: 8px;
Â  background: var(--loading-bg);
Â  border-radius: 4px;
Â  overflow: hidden;
}
.loading-bar .fill{
Â  height:100%;
Â  width:0%;
Â  background:var(--loading-fill);
Â  transition:width .15s linear;
}

/* =========================================
Â  Â Detail Card
========================================= */
#detailCard{
Â  position:fixed;
Â  right:20px;
Â  top:120px;
Â  width:360px;
Â  max-height:78vh;
Â  overflow-y:auto;
Â  background:white;
Â  padding:18px;
Â  border-radius:var(--radius);
Â  box-shadow:0 8px 28px rgba(0,0,0,0.15);
Â  display:none;
Â  z-index:999;
}
.card-close-btn {
Â  position: absolute;Â 
Â  top: 12px;Â 
Â  right: 12px;Â 
Â  width: 32px;Â 
Â  height: 32px;Â 
Â  border-radius: 50%;Â 
Â  background: #f3f4f6;Â 
Â  border: 1px solid #e5e7eb;
Â  color: #6b7280;Â 
Â  font-size: 20px;Â 
Â  cursor: pointer;Â 
Â  display: flex;Â 
Â  align-items: center;Â 
Â  justify-content: center;
Â  z-index: 20;
Â  transition: all 0.2s;
}
.card-close-btn:hover {
Â  background: #e5e7eb;
Â  color: #ef4444;
Â  transform: scale(1.1);
}

/* =========================================
Â  Â ç¶²è·¯åœ– grid
========================================= */
.net-gallery{
Â  display:grid;
Â  grid-template-columns:repeat(3,1fr);
Â  gap:6px;
Â  margin-top:10px;
}
.net-gallery img{
Â  width:100%;
Â  border-radius:6px;
Â  border:1px solid #e5e7eb;
Â  object-fit:cover;
Â  cursor: pointer;
Â  transition: transform 0.2s;
}
.net-gallery img:hover { transform: scale(1.05); }

/* =========================================
Â  Â Mobile Sheet
========================================= */
.sheet-backdrop{
Â  position:fixed;inset:0;
Â  background:rgba(0,0,0,0.45);
Â  z-index:3000; /* Increased Z-index */
}
.sheet{
Â  position:fixed;left:0;right:0;bottom:0;
Â  height:80vh;background:#fff;
Â  border-radius:16px 16px 0 0;
Â  transform:translateY(100%);
Â  transition:transform .25s ease;
Â  display:flex;flex-direction:column;
Â  z-index:3001;
}
.sheet.open{transform:translateY(0);}
.sheet-header{
Â  padding:12px 16px;
Â  border-bottom:1px solid var(--border);
Â  font-weight:700;
Â  display:flex;justify-content:space-between;align-items:center;
}
.sheet-close{
Â  background:none;border:none;
Â  font-size:26px;cursor:pointer;line-height:1;
}
.sheet-content{
Â  padding:16px;overflow-y:auto;font-size:15px;flex:1;
}
.hidden{display:none!important;}

.quote-item{
Â  display:flex;justify-content:space-between;align-items:center;
Â  padding:12px 0;border-bottom:1px solid #eee;
}
.quote-info{font-size:14px;color:#666;}
.quote-price{font-weight:700;color:#2563eb;}
.quote-del{color:#999;cursor:pointer;padding:6px;font-size:16px;}
.quote-del:hover{color:#ef4444;}

/* =========================================
Â  Â Login Overlay
========================================= */
#loginOverlay {
Â  position: fixed;
Â  inset: 0;
Â  background: #f5f6f8;
Â  z-index: 6000; /* Increased Z-index */
Â  display: flex;
Â  align-items: center;
Â  justify-content: center;
Â  flex-direction: column;
}
.login-card {
Â  background: white;
Â  padding: 30px;
Â  border-radius: 16px;
Â  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
Â  width: 90%;
Â  max-width: 400px;
Â  text-align: center;
}
.login-card h2 { margin-top: 0; color: var(--primary); }
.login-input {
Â  width: 100%;
Â  margin-bottom: 12px;
Â  padding: 12px;
Â  border: 1px solid #ddd;
Â  border-radius: 8px;
Â  box-sizing: border-box;
}
.login-btn {
Â  width: 100%;
Â  padding: 12px;
Â  background: var(--primary-blue);
Â  color: white;
Â  border: none;
Â  border-radius: 8px;
Â  font-weight: bold;
Â  cursor: pointer;
Â  margin-top: 10px;
}
.login-btn:hover { background: #1d4ed8; }
.login-error {
Â  color: #ef4444;
Â  margin-top: 10px;
Â  font-size: 14px;
Â  display: none;
}

/* =========================================
Â  Â RWD
========================================= */
@media (max-width:900px){
Â  #detailCard{display:none!important;}
}
@media (max-width:600px){
Â  body{padding:14px;}
Â  .search-box{padding:14px;}
Â  input,select{font-size:14px;}
Â Â 
Â  .toolbar.fixed-active { width: calc(100% - 28px); top: 14px; }

Â  /* RWD Card View Styles */
Â  thead { display: none; }
Â  table, tbody, tr, td { display: block; width: 100%; }
Â Â 
Â  tr {
Â  Â  margin-bottom: 16px;
Â  Â  border: 1px solid #e5e7eb;
Â  Â  border-radius: 16px;
Â  Â  background: #fff;
Â  Â  padding: 16px;
Â  Â  box-shadow: 0 2px 8px rgba(0,0,0,0.05);
Â  Â  position: relative;
Â  Â  box-sizing: border-box;Â 
Â  }

Â  /* 1. å‹¾é¸æ¡† */
Â  td:nth-of-type(1) {
Â  Â  position: absolute; top: 12px; left: 12px; width: auto; padding: 0; border: none; z-index: 10;
Â  }
Â  /* 2. åœ–ç‰‡ */
Â  td:nth-of-type(2) { text-align: center; border: none; padding-bottom: 10px; }
Â  .product-img { width: 140px; height: 140px; }

Â  /* 3. ä¸»å‹è™Ÿ */
Â  td:nth-of-type(3) { text-align: center; color: #888; font-size: 13px; border: none; padding: 0 0 8px 0; }

Â  /* 4. å•†å“è³‡è¨Š */
Â  td:nth-of-type(4) { border: none; padding: 0 0 12px 0; }

Â  /* 5. åƒ¹æ ¼å€å¡Š */
Â  td:nth-of-type(5), td:nth-of-type(6) {
Â  Â  border: none; padding: 8px 12px; background: #f9fafb;
Â  Â  margin-bottom: 4px; border-radius: 8px; display: flex;Â 
Â  Â  justify-content: space-between; align-items: center;
Â  Â  font-size: 14px; font-weight: bold;
Â  }
Â  td:nth-of-type(5)::before { content: "æœ«å”®åƒ¹æ ¼"; font-weight: normal; color: #6b7280; }
Â  td:nth-of-type(6)::before { content: "è³£å ´åƒ¹æ ¼"; font-weight: normal; color: #6b7280; }
Â  td { border-bottom: none !important; }
}

/* =========================================
Â  Â Preview Overlay
========================================= */
#previewOverlay {
Â  Â  position: fixed; inset: 0; background: rgba(0,0,0,0.5);Â 
Â  Â  display: none; align-items: center; justify-content: center; z-index: 4000;
}
.preview-card {
Â  Â  background: white; width: 90%; max-width: 900px; max-height: 80vh;
Â  Â  border-radius: 12px; padding: 20px; display: flex; flex-direction: column;
}
.preview-header { font-weight: bold; font-size: 18px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
.preview-body { flex: 1; overflow-y: auto; margin-bottom: 10px; font-size: 13px; }
.preview-footer { display: flex; justify-content: flex-end; gap: 10px; }
.preview-table { width: 100%; border-collapse: collapse; }
.preview-table th, .preview-table td { border: 1px solid #ddd; padding: 6px; text-align: left; }
.preview-table th { background: #f3f4f6; }
.field-badge {
Â  Â  background: #e0f2fe; color: #0284c7; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 4px;
}

/* =========================================
Â  Â Custom Toast/Modal (New)
========================================= */
#toastContainer {
Â  position: fixed;
Â  top: 20px;
Â  left: 50%;
Â  transform: translateX(-50%);
Â  z-index: 7000;
Â  display: flex;
Â  flex-direction: column;
Â  gap: 10px;
Â  width: 90%;
Â  max-width: 400px;
}
.toast {
Â  background: white;
Â  padding: 12px 18px;
Â  border-radius: 8px;
Â  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.15);
Â  font-size: 14px;
Â  font-weight: 500;
Â  opacity: 0;
Â  transition: opacity 0.3s, transform 0.3s;
Â  transform: translateY(-20px);
Â  border-left: 5px solid;
}
.toast.show {
Â  opacity: 1;
Â  transform: translateY(0);
}
.toast-success { border-color: var(--success); }
.toast-error { border-color: var(--danger); color: var(--danger); }
.toast-info { border-color: var(--primary-blue); }

#customModalOverlay {
Â  position: fixed;
Â  inset: 0;
Â  background: rgba(0,0,0,0.6);
Â  z-index: 6500;
Â  display: none;
Â  align-items: center;
Â  justify-content: center;
}
.custom-modal {
Â  background: white;
Â  padding: 20px;
Â  border-radius: 12px;
Â  width: 90%;
Â  max-width: 360px;
Â  box-shadow: 0 10px 30px rgba(0,0,0,0.2);
}
.modal-header {
Â  font-size: 18px;
Â  font-weight: bold;
Â  margin-bottom: 10px;
}
.modal-body {
Â  margin-bottom: 20px;
Â  color: var(--text);
Â  font-size: 15px;
Â  line-height: 1.6;
}
.modal-footer {
Â  display: flex;
Â  justify-content: flex-end;
Â  gap: 10px;
}
.modal-btn-confirm {
Â  background: var(--danger);
Â  color: white;
Â  border: none;
Â  padding: 8px 16px;
Â  border-radius: 6px;
Â  cursor: pointer;
Â  font-weight: bold;
}
.modal-btn-cancel {
Â  background: #f3f4f6;
Â  border: 1px solid #e5e7eb;
Â  color: var(--text);
Â  padding: 8px 16px;
Â  border-radius: 6px;
Â  cursor: pointer;
}
</style>
</head>
<body>

<!-- Custom Modal Overlay (New) -->
<div id="customModalOverlay">
Â  <div class="custom-modal">
Â  Â  <div class="modal-header" id="modalHeader">ç¢ºèªæ“ä½œ</div>
Â  Â  <div class="modal-body" id="modalBody">æ‚¨ç¢ºå®šè¦åŸ·è¡Œæ­¤æ“ä½œå—ï¼Ÿ</div>
Â  Â  <div class="modal-footer">
Â  Â  Â  <button class="modal-btn-cancel" id="modalCancel">å–æ¶ˆ</button>
Â  Â  Â  <button class="modal-btn-confirm" id="modalConfirm">ç¢ºå®š</button>
Â  Â  </div>
Â  </div>
</div>

<!-- Toast Container (New) -->
<div id="toastContainer">
Â  <!-- Toasts will be injected here -->
</div>

<!-- Login Overlay -->
<div id="loginOverlay">
Â  <div class="login-card">
Â  Â  <h2>KINYO æŸ¥åƒ¹ç³»çµ±</h2>
Â  Â  <p style="color:#666;margin-bottom:20px;">è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ç™»å…¥</p>
Â  Â  <input type="email" id="loginEmail" class="login-input" placeholder="é›»å­ä¿¡ç®±">
Â  Â  <input type="password" id="loginPassword" class="login-input" placeholder="å¯†ç¢¼">
Â  Â  <button id="doLoginBtn" class="login-btn">ç™»å…¥</button>
Â  Â  <div id="loginError" class="login-error"></div>
Â  </div>
</div>

<!-- Preview Overlay -->
<div id="previewOverlay">
Â  Â  <div class="preview-card">
Â  Â  Â  Â  <div class="preview-header" id="previewHeader">
Â  Â  Â  Â  Â  Â  åŒ¯å…¥é è¦½æª¢æŸ¥
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="preview-body" id="previewContent">
Â  Â  Â  Â  Â  Â  <!-- Table will be injected here -->
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="preview-footer">
Â  Â  Â  Â  Â  Â  <button id="cancelImportBtn" class="btn-secondary">å–æ¶ˆ</button>
Â  Â  Â  Â  Â  Â  <button id="confirmImportBtn" class="btn-primary">ç¢ºèªå¯«å…¥è³‡æ–™åº«</button>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<!-- Loading -->
<div id="centerLoadingBox">
Â  <div id="centerLoadingCard">
Â  Â  <div class="loading-title">å•†å“è¼‰å…¥ä¸­...</div>
Â  Â  <div id="centerLoadingBar" class="loading-bar">
Â  Â  Â  <div class="fill"></div>
Â  Â  </div>
Â  </div>
</div>

<div class="top-bar">
Â  <span id="userInfo" class="user-badge">æœªç™»å…¥</span>
Â  <button id="logoutBtn" class="logout-btn" style="display:none;">ç™»å‡º</button>
</div>

<h1>KINYO æŸ¥åƒ¹ç³»çµ±</h1>
<div class="subtitle">
Â  v6.2 å„ªåŒ–ç‰ˆ â€”â€” æå‡æ“ä½œæµæš¢æ€§èˆ‡å ±åƒ¹å–®æŒä¹…æ€§
Â  <br>
Â  Designed & Engineered by éƒ­åº­è±ª (0976-966-333)
</div>

<form id="searchForm" class="search-box">
Â  <div class="search-row">
Â  Â  <label>é—œéµå­—æœå°‹ï¼ˆåˆ†é¡ / å‹è™Ÿ / åç¨±ï¼‰</label>
Â  Â  <div class="combo-search">
Â  Â  Â  Â  <select id="categorySelect">
Â  Â  Â  Â  Â  Â  <option value="">å…¨éƒ¨åˆ†é¡</option>
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <input id="keyword" placeholder="å¦‚ï¼šCL528 / æ•èšŠç‡ˆ" autocomplete="off" />
Â  Â  </div>
Â  </div>

Â  <div class="search-row">
Â  Â  <label>èµ·è¨‚é‡ï¼ˆå¯ä¸é¸ï¼‰</label>
Â  Â  <div style="display:flex; gap:10px;">
Â  Â  Â  Â  <select id="qtySelect" style="flex:1;">
Â  Â  Â  Â  Â  Â  <!-- Options added by JS -->
Â  Â  Â  Â  </select>
Â  Â  Â  Â  <!-- é è¨­éš±è—ï¼ŒLevel 2 ä»¥ä¸Šæ‰é¡¯ç¤º -->
Â  Â  Â  Â  <select id="stockFilter" style="flex:1; border-color:#22c55e; background-color:#f0fdf4; color:#15803d; font-weight:bold; display:none;">
Â  Â  Â  Â  Â  Â  <option value="">ğŸ“¦ ä¸é™åº«å­˜</option>
Â  Â  Â  Â  Â  Â  <option value="1">ğŸ“¦ ç¾è²¨ > 0</option>
Â  Â  Â  Â  Â  Â  <option value="50">ğŸ“¦ ç¾è²¨ > 50 (å°‘é‡)</option>
Â  Â  Â  Â  Â  Â  <option value="100">ğŸ“¦ ç¾è²¨ > 100 (æ‰¹ç™¼)</option>
Â  Â  Â  Â  Â  Â  <option value="300">ğŸ“¦ ç¾è²¨ > 300 (å¤§å®—)</option>
Â  Â  Â  Â  Â  Â  <option value="500">ğŸ“¦ ç¾è²¨ > 500 (å°ˆæ¡ˆ)</option>
Â  Â  Â  Â  </select>
Â  Â  </div>
Â  </div>

Â  <div class="search-row">
Â  Â  <label>é ç®—å€é–“ï¼ˆèµ·è¨‚é‡å·²é¸æ™‚æ‰ç”Ÿæ•ˆï¼›å¯åªå¡«ä¸€é‚Šï¼‰</label>
Â  Â  <div style="display:flex; gap:10px;">
Â  Â  Â  <input id="minPrice" type="number" placeholder="æœ€ä½ (å¯ç©º)">
Â  Â  Â  <input id="maxPrice" type="number" placeholder="æœ€é«˜ (å¯ç©º)">
Â  Â  </div>
Â  </div>

Â  <button id="searchBtn" type="submit" class="btn-primary">æŸ¥è©¢</button>
Â  <button id="clearBtn" type="button" class="btn-secondary" style="margin-top:10px;width:100%;">æ¸…é™¤æœå°‹æ¢ä»¶</button>
</form>

<!-- Hidden File Inputs -->
<input type="file" id="inventoryUpload" accept=".csv, .xlsx, .xls" style="display:none" />
<input type="file" id="productUpload" accept=".csv, .xlsx, .xls" style="display:none" />

<div class="toolbar">
Â  <select id="sortSelect" class="btn-secondary">
Â  Â  <option value="">ä¸æ’åº (éš¨æ©Ÿ)</option>
Â  Â  <option value="minPriceAsc">æœ«å”®ï¼šä½ â†’ é«˜</option>
Â  Â  <option value="minPriceDesc">æœ«å”®ï¼šé«˜ â†’ ä½</option>
Â  Â  <option value="marketAsc">è³£å ´ï¼šä½ â†’ é«˜</option>
Â  Â  <option value="marketDesc">è³£å ´ï¼šé«˜ â†’ ä½</option>
Â  Â  <option value="alphaAsc">ä¸»å‹è™Ÿï¼šA â†’ Z</option>
Â  Â  <option value="alphaDesc">ä¸»å‹è™Ÿï¼šZ â†’ A</option>
Â  </select>
Â Â 
Â  <!-- é è¨­éš±è—ï¼ŒLevel 4 æ‰é¡¯ç¤º -->
Â  <button id="importInventoryBtn" class="btn-secondary" style="color:#059669; border-color:#059669; background:#ecfdf5; font-weight:bold; display:none;">ğŸ“¥ åŒ¯å…¥åº«å­˜è¡¨ (æ¢ç¢¼æ¯”å°)</button>
Â  <button id="importProductBtn" class="btn-secondary" style="color:#2563eb; border-color:#2563eb; background:#eff6ff; font-weight:bold; display:none;">ğŸ“¥ åŒ¯å…¥ç”¢å“ç¸½è¡¨ (åŒæ­¥ä¸Šä¸‹æ¶)</button>

Â  <button id="batchAddQuoteBtn" class="btn-secondary" disabled>åŠ å…¥å€™é¸æ¸…å–®</button>
Â  <button id="multiLineBtn" class="btn-secondary" disabled>å¤šé¸ LINE åˆ†äº«</button>
Â  <button id="exportBtn" class="btn-secondary" disabled>åŒ¯å‡º Excel</button>
Â  <button id="quoteToolbarBtn" class="quote-toolbar-btn">å ±åƒ¹å–®</button>
Â  <button id="pptToolbarBtn" class="btn-secondary" disabled>ç”Ÿæˆ PPTï¼ˆ1â€“20ï¼‰</button>
</div>
<div id="toolbarSpacer"></div>

<table id="resultTable" style="display:none;">
Â  <thead>
Â  Â  <tr>
Â  Â  Â  <th style="width:32px;"><input type="checkbox" id="checkAll" /></th>
Â  Â  Â  <th style="width:120px;">åœ–ç‰‡</th>
Â  Â  Â  <th style="width:100px;">ä¸»å‹è™Ÿ</th>
Â  Â  Â  <th>å•†å“è³‡è¨Š</th>
Â  Â  Â  <th style="width:80px;">æœ«å”®</th>
Â  Â  Â  <th style="width:80px;">è³£å ´</th>
Â  Â  </tr>
Â  </thead>
Â  <tbody id="resultBody"></tbody>
</table>

<div id="detailCard"></div>

<div id="sheetBackdrop" class="sheet-backdrop hidden"></div>
<div id="mobileDetailSheet" class="sheet hidden">
Â  <div class="sheet-header">
Â  Â  <span>å•†å“è³‡è¨Š</span>
Â  Â  <button id="sheetCloseBtn" class="sheet-close">Ã—</button>
Â  </div>
Â  <div class="sheet-content" id="sheetContent"></div>
</div>

<div id="quoteSheet" class="sheet hidden">
Â  <div class="sheet-header">
Â  Â  <span>å ±åƒ¹å–®é è¦½</span>
Â  Â  <button id="quoteCloseBtn" class="quote-close">Ã—</button>
Â  </div>

Â  <div class="sheet-content" style="display:flex;flex-direction:column;">
Â  Â  <div id="quoteListBody" style="flex:1;overflow-y:auto;"></div>

Â  Â  <div style="border-top:1px solid #eee; padding-top:12px; margin-top:10px;">
Â  Â  Â  <button id="pptFromQuoteBtn" class="btn-primary" style="width:100%;">ç”Ÿæˆ PPT (ä¾å ±åƒ¹å–®å…§å®¹)</button>
Â  Â  Â  <button id="copyQuoteBtn" class="btn-secondary" style="width:100%;margin-top:8px;">è¤‡è£½æ•´å¼µå ±åƒ¹å–® (LINE)</button>
Â  Â  Â  <button id="downloadQuoteExcelBtn" class="btn-secondary" style="width:100%;margin-top:8px;">ä¸‹è¼‰ Excel å ±åƒ¹å–®</button>
Â  Â  Â  <button id="clearQuoteBtn" class="btn-secondary" style="width:100%;margin-top:8px;color:#ef4444;border-color:#ef4444;">æ¸…ç©ºå ±åƒ¹å–®</button>
Â  Â  </div>
Â  </div>
</div>


<script type="module">
/* =======================================================
Â  Â 1. è¨­å®šæ‚¨çš„ LOGO ç¶²å€
======================================================= */
const COMPANY_LOGO_URL = "https://drive.google.com/file/d/1JxoU3A5qAYsE39pc2z7IMVwVS8-uTOIn/view?usp=drive_link";Â 
const QUOTE_LIST_STORAGE_KEY = "KINYO_QUOTE_LIST"; // New Storage Key

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc, writeBatch, initializeFirestore } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

const firebaseConfig = {
Â  apiKey: "AIzaSyDtp6rwV7KmIOedLQ9793BnXbBquopP9kM",
Â  authDomain: "kinyo-price.firebaseapp.com",
Â  projectId: "kinyo-price",
Â  storageBucket: "kinyo-price.firebasestorage.app",
Â  messagingSenderId: "122464645678",
Â  appId: "1:122464645678:web:c0febbc6297a8ada5ea5bf",
Â  measurementId: "G-R0PWMZNSJH"
};

const appÂ  = initializeApp(firebaseConfig);
const db = initializeFirestore(app, { experimentalForceLongPolling: true });
const auth = getAuth(app);

// ... (Existing DOM Element Selectors) ...
const searchFormÂ  Â  Â  = document.getElementById("searchForm");
const categorySelectÂ  = document.getElementById("categorySelect");
const keywordInputÂ  Â  = document.getElementById("keyword");
const qtySelectÂ  Â  Â  Â = document.getElementById("qtySelect");
const stockFilterÂ  Â  Â = document.getElementById("stockFilter");
const minPriceInputÂ  Â = document.getElementById("minPrice");
const maxPriceInputÂ  Â = document.getElementById("maxPrice");
const sortSelectÂ  Â  Â  = document.getElementById("sortSelect");
const exportBtnÂ  Â  Â  Â = document.getElementById("exportBtn");
const pptToolbarBtnÂ  Â = document.getElementById("pptToolbarBtn");
const multiLineBtnÂ  Â  = document.getElementById("multiLineBtn");
const batchAddQuoteBtn = document.getElementById("batchAddQuoteBtn");
const clearBtnÂ  Â  Â  Â  = document.getElementById("clearBtn");
const importInventoryBtn = document.getElementById("importInventoryBtn");
const importProductBtnÂ  Â = document.getElementById("importProductBtn");
const inventoryUpload = document.getElementById("inventoryUpload");
const productUploadÂ  Â = document.getElementById("productUpload");

const resultTableÂ  Â  Â = document.getElementById("resultTable");
const resultBodyÂ  Â  Â  = document.getElementById("resultBody");
const checkAllBoxÂ  Â  Â = document.getElementById("checkAll");
const detailCardÂ  Â  Â  = document.getElementById("detailCard");

const userInfoSpanÂ  Â  = document.getElementById("userInfo");
const logoutBtnÂ  Â  Â  Â = document.getElementById("logoutBtn");

const sheetBackdropÂ  Â = document.getElementById("sheetBackdrop");
const mobileSheetÂ  Â  Â = document.getElementById("mobileDetailSheet");
const sheetContentÂ  Â  = document.getElementById("sheetContent");
const sheetCloseBtnÂ  Â = document.getElementById("sheetCloseBtn");

const quoteSheetÂ  Â  Â  = document.getElementById("quoteSheet");
const quoteCloseBtnÂ  Â = document.getElementById("quoteCloseBtn");
const quoteListBodyÂ  Â = document.getElementById("quoteListBody");
const copyQuoteBtnÂ  Â  = document.getElementById("copyQuoteBtn");
const clearQuoteBtnÂ  Â = document.getElementById("clearQuoteBtn");
const downloadQuoteExcelBtn = document.getElementById("downloadQuoteExcelBtn");
const quoteToolbarBtn = document.getElementById("quoteToolbarBtn");
const pptFromQuoteBtn = document.getElementById("pptFromQuoteBtn");

const centerLoadingBox = document.getElementById("centerLoadingBox");
const centerLoadingBar = document.getElementById("centerLoadingBar");

const loginOverlay = document.getElementById("loginOverlay");
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const doLoginBtn = document.getElementById("doLoginBtn");
const loginError = document.getElementById("loginError");

// Preview Elements
const previewOverlay = document.getElementById("previewOverlay");
const previewHeaderÂ  = document.getElementById("previewHeader");
const previewContent = document.getElementById("previewContent");
const cancelImportBtn = document.getElementById("cancelImportBtn");
const confirmImportBtn = document.getElementById("confirmImportBtn");

// Custom Modal/Toast Elements (New)
const toastContainer = document.getElementById("toastContainer");
const customModalOverlay = document.getElementById("customModalOverlay");
const modalHeader = document.getElementById("modalHeader");
const modalBody = document.getElementById("modalBody");
const modalConfirm = document.getElementById("modalConfirm");
const modalCancel = document.getElementById("modalCancel");


let productCache = [];
let currentResultList = [];
let userLevel = 0;Â 
let currentUserEmail = "";
let quoteList = []; // Initialized later via loadQuoteList
let isProductsLoaded = false;
let isQuotesLoaded = false;
let hasCheckedItems = false;

// Import state
let currentImportMode = ""; // 'inventory' or 'product'
let pendingInventoryMap = new Map();Â 
let pendingProductData = []; // Array of objects containing { action, data, id? }

const CACHE_TTL = 1000 * 60 * 60 * 6;Â 

/* ğŸš€ ====================================================
Â  Â  Â  UX UTILITY: Toast & Modal (New)
Â  Â ==================================================== ğŸš€ */

// é¡¯ç¤ºéé˜»å¡å¼ Toast è¨Šæ¯
function showToast(message, type = 'info', duration = 3000) {
Â  const toast = document.createElement('div');
Â  toast.className = `toast toast-${type}`;
Â  toast.textContent = message;
Â  toastContainer.prepend(toast); // Add to top

Â  setTimeout(() => {
Â  Â  toast.classList.add('show');
Â  }, 10);

Â  setTimeout(() => {
Â  Â  toast.classList.remove('show');
Â  Â  setTimeout(() => toast.remove(), 300);
Â  }, duration);
}

// é¡¯ç¤ºå®¢è£½åŒ–ç¢ºèª Modal
function showConfirm(message, onConfirm, onCancel = () => {}) {
Â  customModalOverlay.style.display = 'flex';
Â  modalBody.textContent = message;

Â  const handleConfirm = () => {
Â  Â  customModalOverlay.style.display = 'none';
Â  Â  onConfirm();
Â  Â  removeListeners();
Â  };

Â  const handleCancel = () => {
Â  Â  customModalOverlay.style.display = 'none';
Â  Â  onCancel();
Â  Â  removeListeners();
Â  };

Â  // ç§»é™¤èˆŠçš„ç›£è½å™¨ (å¦‚æœå­˜åœ¨)
Â  const cloneConfirm = modalConfirm.cloneNode(true);
Â  const cloneCancel = modalCancel.cloneNode(true);
Â  modalConfirm.parentNode.replaceChild(cloneConfirm, modalConfirm);
Â  modalCancel.parentNode.replaceChild(cloneCancel, modalCancel);
Â Â 
Â  const newConfirm = cloneConfirm;
Â  const newCancel = cloneCancel;
Â  newConfirm.id = 'modalConfirm';
Â  newCancel.id = 'modalCancel';
Â Â 
Â  const removeListeners = () => {
Â  Â  newConfirm.removeEventListener('click', handleConfirm);
Â  Â  newCancel.removeEventListener('click', handleCancel);
Â  };

Â  // è¨­ç½®æ–°çš„ç›£è½å™¨
Â  newConfirm.addEventListener('click', handleConfirm);
Â  newCancel.addEventListener('click', handleCancel);
Â Â 
Â  // è¨­ç½®æ¨™é¡Œç‚ºé€šç”¨è­¦å‘Š
Â  modalHeader.textContent = "è«‹ç¢ºèª";
Â  newConfirm.textContent = "ç¢ºèª";
Â  newCancel.textContent = "å–æ¶ˆ";
}

/* ğŸš€ ====================================================
Â  Â  Â  CACHING & DATA LOADING
Â  Â ==================================================== ğŸš€ */

function getCacheKey() {
Â  const mail = (currentUserEmail || "guest").toLowerCase();
Â  return `KINYO_SAFE_CACHE_V580_${mail}`; // Reuse key
}

function loadCache() {
Â  try {
Â  Â  const raw = localStorage.getItem(getCacheKey());
Â  Â  if (!raw) return null;
Â  Â  const obj = JSON.parse(raw);
Â  Â  if (!obj || !obj.time || !Array.isArray(obj.data)) return null;
Â  Â  if (Date.now() - obj.time > CACHE_TTL) return null;
Â  Â  return obj.data;
Â  } catch { return null; }
}

function saveCache(data) {
Â  try {
Â  Â  localStorage.setItem(getCacheKey(), JSON.stringify({ time: Date.now(), data }));
Â  } catch {}
}

function loadQuoteList() {
Â  try {
Â  Â  const raw = localStorage.getItem(QUOTE_LIST_STORAGE_KEY);
Â  Â  return raw ? JSON.parse(raw) : [];
Â  } catch {
Â  Â  return [];
Â  }
}

function saveQuoteList() {
Â  try {
Â  Â  localStorage.setItem(QUOTE_LIST_STORAGE_KEY, JSON.stringify(quoteList));
Â  } catch {}
}

let driveMap = new Map();
let mainFolderMap = new Map();
let netMapÂ  Â  = new Map();
let netImagesMap = new Map();
let isDriveLoaded = false;

/* ğŸš€ ====================================================
Â  Â  Â  HELPER FUNCTIONS
Â  Â ==================================================== ğŸš€ */

function getInventoryRangeLabel(qty) {
Â  Â  if (qty === null || qty === undefined || qty === "") return null;
Â  Â  const val = parseInt(qty, 10);
Â  Â  if (isNaN(val)) return null;

Â  Â  if (val > 1000) return "1000å€‹ä»¥ä¸Š";
Â  Â  if (val <= 100) return "100å€‹ä»¥å…§";
Â  Â  if (val <= 300) return "300å€‹ä»¥å…§";
Â  Â  if (val <= 500) return "500å€‹ä»¥å…§";
Â  Â  if (val <= 1000) return "1000å€‹ä»¥å…§";
Â  Â  return "1000å€‹ä»¥ä¸Š";
}

function getGoogleDriveId(url) {
Â  if (!url) return null;
Â  const patterns = [
Â  Â  /\/d\/([a-zA-Z0-9_-]+)/,Â  Â  Â  Â Â 
Â  Â  /id=([a-zA-Z0-9_-]+)/,Â  Â  Â  Â  Â Â 
Â  Â  /open\?id=([a-zA-Z0-9_-]+)/Â  Â Â 
Â  ];
Â  for (let p of patterns) {
Â  Â  const m = url.match(p);
Â  Â  if (m && m[1]) return m[1];
Â  }
Â  return null;
}

async function fetchAsDataURL(url) {
Â  if (!url) return null;
Â  let targetUrl = url;
Â  if (url.includes("drive.google.com") || url.includes("googleusercontent.com")) {
Â  Â  const id = getGoogleDriveId(url);
Â  Â  if (id) {
Â  Â  Â  Â const directLink = `https://drive.google.com/uc?id=${id}`;
Â  Â  Â  Â targetUrl = "https://images.weserv.nl/?url=" + encodeURIComponent(directLink) + "&output=jpg&w=400&q=70";
Â  Â  } else {
Â  Â  Â  Â targetUrl = "https://images.weserv.nl/?url=" + encodeURIComponent(url) + "&output=jpg&w=400&q=70";
Â  Â  }
Â  } else {
Â  Â  Â  if(targetUrl.includes("weserv.nl")) {
Â  Â  Â  Â  Â  if(!targetUrl.includes("&w=")) targetUrl += "&w=400&q=70";
Â  Â  Â  } else {
Â  Â  Â  Â  Â  targetUrl = "https://images.weserv.nl/?url=" + encodeURIComponent(url) + "&output=jpg&w=400&q=70";
Â  Â  Â  }
Â  }

Â  try {
Â  Â  const res = await fetch(targetUrl, { mode: 'cors', credentials: 'omit' });
Â  Â  if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
Â  Â  const blob = await res.blob();
Â  Â  return new Promise((resolve) => {
Â  Â  Â  const reader = new FileReader();
Â  Â  Â  reader.onloadend = () => resolve(reader.result);
Â  Â  Â  reader.readAsDataURL(blob);
Â  Â  });
Â  } catch (e) {
Â  Â  console.warn("åœ–ç‰‡è®€å–å¤±æ•—:", url);
Â  Â  return null;
Â  }
}

function pickRandom(arr, count) {
Â  if (!Array.isArray(arr)) return [];
Â  const _arr = [...arr];
Â  for (let i = _arr.length - 1; i > 0; i--) {
Â  Â  Â  const j = Math.floor(Math.random() * (i + 1));
Â  Â  Â  [_arr[i], _arr[j]] = [_arr[j], _arr[i]];
Â  }
Â  return _arr.slice(0, count);
}

function showLoading() {
Â  centerLoadingBox.style.display = "flex";
Â  centerLoadingBar.querySelector(".fill").style.width = "0%";
Â  setTimeout(() => { centerLoadingBar.querySelector(".fill").style.width = "55%"; }, 120);
}
function hideLoading() {
Â  centerLoadingBar.querySelector(".fill").style.width = "100%";
Â  setTimeout(() => { centerLoadingBox.style.display = "none"; }, 0);
}

function openSheet() { sheetBackdrop.classList.remove("hidden"); mobileSheet.classList.remove("hidden"); requestAnimationFrame(() => mobileSheet.classList.add("open")); }
function closeSheet() { mobileSheet.classList.remove("open"); setTimeout(() => { mobileSheet.classList.add("hidden"); if (quoteSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden"); }, 220); }

function openQuoteSheet() { sheetBackdrop.classList.remove("hidden"); quoteSheet.classList.remove("hidden"); requestAnimationFrame(() => quoteSheet.classList.add("open")); renderQuoteList(); }
function closeQuoteSheet() { quoteSheet.classList.remove("open"); setTimeout(() => quoteSheet.classList.add("hidden"), 220); if (mobileSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden"); }

function updateQuoteToolbarBtn() {Â 
Â  if (quoteList.length > 0) {Â 
Â  Â  quoteToolbarBtn.style.display = "inline-block";Â 
Â  Â  quoteToolbarBtn.textContent = `å ±åƒ¹å–®ï¼ˆ${quoteList.length}ï¼‰`;Â 
Â  } else {Â 
Â  Â  quoteToolbarBtn.style.display = "none";Â 
Â  }Â 
}

function updateToolbarScrollState() {
Â  const toolbar = document.querySelector('.toolbar');
Â  const spacer = document.getElementById('toolbarSpacer');
Â  const searchForm = document.getElementById('searchForm');

Â  if (!hasCheckedItems) {
Â  Â  toolbar.classList.remove('fixed-active');
Â  Â  if(spacer) spacer.style.display = 'none';
Â  Â  return;
Â  }
Â  const triggerPoint = searchForm.offsetTop + searchForm.offsetHeight;
Â  if (window.scrollY > triggerPoint) {
Â  Â  if (!toolbar.classList.contains('fixed-active')) {
Â  Â  Â  toolbar.classList.add('fixed-active');
Â  Â  Â  if(spacer) spacer.style.display = 'block';
Â  Â  }
Â  } else {
Â  Â  if (toolbar.classList.contains('fixed-active')) {
Â  Â  Â  toolbar.classList.remove('fixed-active');
Â  Â  Â  if(spacer) spacer.style.display = 'none';
Â  Â  }
Â  }
}

function updateMultiLineBtnState() {Â 
Â  const checked = document.querySelectorAll(".row-check:checked");
Â  hasCheckedItems = checked.length > 0;
Â Â 
Â  if(multiLineBtn) multiLineBtn.disabled = !hasCheckedItems;
Â  if(exportBtn) exportBtn.disabled = !hasCheckedItems;Â 
Â  if(pptToolbarBtn) pptToolbarBtn.disabled = !hasCheckedItems;Â 
Â  if(batchAddQuoteBtn) batchAddQuoteBtn.disabled = !hasCheckedItems;
Â Â 
Â  updateToolbarScrollState();
}

function renderQuoteList() {
Â  saveQuoteList(); // Save on every render/change
Â  quoteListBody.innerHTML = ""; if (quoteList.length === 0) { quoteListBody.innerHTML = `<div style="text-align:center;padding:40px;color:#999;">å ±åƒ¹å–®æ˜¯ç©ºçš„</div>`; return; }
Â  quoteList.forEach((q, idx) => {
Â  Â  const div = document.createElement("div"); div.className = "quote-item";
Â  Â  const priceDisplay = `$${q.price}`;
Â  Â  div.innerHTML = `<div style="flex:1;"><div style="font-weight:700;">${q.name}</div><div class="quote-info">${q.model} | ${q.qtyLabel}</div></div><div style="text-align:right;margin-right:8px;"><div class="quote-price">${priceDisplay}</div><div style="font-size:12px;color:#888;">x ${q.count}</div></div><div class="quote-del" data-idx="${idx}">ğŸ—‘ï¸</div>`;
Â  Â  quoteListBody.appendChild(div);
Â  });
Â  document.querySelectorAll(".quote-del").forEach(btn => { btn.onclick = (e) => { 
Â  Â  const i = Number(e.target.getAttribute("data-idx")); 
Â  Â  quoteList.splice(i, 1); 
Â  Â  renderQuoteList(); 
Â  Â  updateQuoteToolbarBtn(); 
Â  Â  showToast("å·²å¾å ±åƒ¹å–®ç§»é™¤", 'info');
Â  }; });
}

function bindCheckAll() {
Â  const rowChecks = document.querySelectorAll(".row-check");
Â  checkAllBox.onchange = () => { rowChecks.forEach(c => c.checked = checkAllBox.checked); updateMultiLineBtnState(); };
Â  rowChecks.forEach(chk => { chk.onchange = () => { const all = document.querySelectorAll(".row-check"); const checked = document.querySelectorAll(".row-check:checked"); checkAllBox.checked = (all.length === checked.length); updateMultiLineBtnState(); }; });
}

function updateUserDisplay(status) {
Â  if (!userInfoSpan) return;
Â  if (status === 'searching') {
Â  Â  userInfoSpan.textContent = "ğŸ” æœå°‹é‹ç®—ä¸­...";
Â  Â  userInfoSpan.style.background = "#fef9c3";
Â  Â  userInfoSpan.style.color = "#854d0e";
Â  Â  userInfoSpan.className = "user-badge";
Â  } else {
Â  Â  let badgeClass = "badge-lv0";
Â  Â  if (userLevel === 1) badgeClass = "badge-lv1";
Â  Â  else if (userLevel === 2) badgeClass = "badge-lv2";
Â  Â  else if (userLevel >= 3) badgeClass = "badge-lv3";
Â  Â Â 
Â  Â  userInfoSpan.textContent = `${currentUserEmail.replace(/@.*/, "")}`;
Â  Â  userInfoSpan.className = `user-badge ${badgeClass}`;
Â  Â  userInfoSpan.style.background = "";Â 
Â  Â  userInfoSpan.style.color = "";
Â  }
}

// ğŸš€ Updates UI permissions based on user level
function updatePermissions() {
Â  Â  // 1. Level 4 Only: Import Inventory & Product Data
Â  Â  if (userLevel >= 4) {
Â  Â  Â  Â  importInventoryBtn.style.display = 'inline-block';
Â  Â  Â  Â  importProductBtn.style.display = 'inline-block';Â 
Â  Â  } else {
Â  Â  Â  Â  importInventoryBtn.style.display = 'none';
Â  Â  Â  Â  importProductBtn.style.display = 'none';Â 
Â  Â  }

Â  Â  // 2. Level 2+ Only: Stock Filter
Â  Â  if (userLevel >= 2) {
Â  Â  Â  Â  stockFilter.style.display = 'block';Â 
Â  Â  } else {
Â  Â  Â  Â  stockFilter.style.display = 'none';
Â  Â  }
}

async function getDocsWithRetry(queryRef, retries = 3, delay = 1000) {
Â  Â  for (let i = 0; i < retries; i++) {
Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  return await getDocs(queryRef);
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.warn(`Attempt ${i + 1} failed. Retrying in ${delay}ms...`, err);
Â  Â  Â  Â  Â  Â  if (i === retries - 1) throw err;
Â  Â  Â  Â  Â  Â  await new Promise(res => setTimeout(res, delay));
Â  Â  Â  Â  }
Â  Â  }
}

function normalizeKey(key) {
Â  Â  if (!key) return "";
Â  Â  let base = key.split('.')[0].split('_')[0].toUpperCase();
Â  Â  base = base.replace(/-/g, '');
Â  Â  let m = base.match(/^([a-zA-Z]+)(\d+)([a-zA-Z]*)$/);
Â  Â  if (m) { return (m[1] + m[2]); }
Â  Â  return base;
}

function shuffleArray(arr) {
Â  const a = arr.slice();
Â  for (let i = a.length - 1; i > 0; i--) {
Â  Â  Â  const j = Math.floor(Math.random() * (i + 1));
Â  Â  Â  [a[i], a[j]] = [a[j], a[i]];
Â  }
Â  return a;
}

async function preloadDriveModelData() {
Â  try {
Â  Â  const res = await fetch(`./modelData.json?v=${Date.now()}`, { cache: "no-store" });
Â  Â  if (!res.ok) throw new Error("modelData.json è®€å–å¤±æ•—");
Â  Â  const data = await res.json();

Â  Â  driveMap.clear(); netMap.clear(); netImagesMap.clear(); mainFolderMap.clear();

Â  Â  (data.models || []).forEach(m => {
Â  Â  Â  const rawKey = String(m.mainModel || m.model || "").trim();
Â  Â  Â  if (!rawKey) return;
Â  Â  Â  const key = normalizeKey(rawKey);

Â  Â  Â  if (m.mainImage) driveMap.set(key, m.mainImage);
Â  Â  Â  if (m.folderUrl) mainFolderMap.set(key, m.folderUrl);
Â  Â  Â Â 
Â  Â  Â  const folderUrl = m.netGalleryUrl || m.netFolderUrl || m.folderUrl || m.folderLink || "";
Â  Â  Â  if (folderUrl) netMap.set(key, folderUrl);

Â  Â  Â  let finalImages = [];
Â  Â  Â  if (Array.isArray(m.netImages) && m.netImages.length > 0) {
Â  Â  Â  Â  Â  finalImages = m.netImages.filter(Boolean);
Â  Â  Â  }
Â  Â  Â  else if (Array.isArray(m.images) && m.images.length > 0) {
Â  Â  Â  Â  Â  finalImages = m.images.map(x => x.url).filter(Boolean);
Â  Â  Â  }
Â  Â  Â  if (finalImages.length > 0) netImagesMap.set(key, finalImages);
Â  Â  });
Â  Â  isDriveLoaded = true;
Â  } catch (e) {
Â  Â  console.warn("Drive è¼‰å…¥å¤±æ•—", e);
Â  Â  isDriveLoaded = false;
Â  }
}

function getDriveMainImage(model, mainModel) {
Â  const k1 = normalizeKey(model);
Â  const k2 = normalizeKey(mainModel);
Â  return driveMap.get(k1) || driveMap.get(k2) || "";
}
function getDriveMainFolder(model, mainModel){
Â  const k1 = normalizeKey(model);
Â  const k2 = normalizeKey(mainModel);
Â  return mainFolderMap.get(k1)||mainFolderMap.get(k2)||"";
}
function getDriveNetGallery(model, mainModel) {
Â  const k1 = normalizeKey(model);
Â  const k2 = normalizeKey(mainModel);
Â  return netMap.get(k1) || netMap.get(k2) || "";
}
function getDriveNetImages(model, mainModel){
Â  const k1 = normalizeKey(model);
Â  const k2 = normalizeKey(mainModel);
Â  return netImagesMap.get(k1) || netImagesMap.get(k2) || [];
}

function getMainModel(model) {
Â  if (!model) return "";
Â  const raw = String(model).trim().toUpperCase();
Â  if (!raw) return "";
Â  const m = raw.match(/^([A-Z]+[0-9]+)([A-Z]{1,3})$/);
Â  if (m) return m[1];
Â  if (raw.includes("-")) {
Â  Â  const parts = raw.split("-");
Â  Â  const last = parts[parts.length - 1];
Â  Â  if (/^[A-Z]{1,3}$/.test(last)) return raw.replace(/-[A-Z]{1,3}$/, "");
Â  }
Â  return raw;
}

function updateCategoryOptions() {
Â  const cats = new Set();
Â  productCache.forEach(p => {
Â  Â  // Only show category if status is not inactive
Â  Â  if(p.status !== 'inactive' && p.category) cats.add(p.category.trim());
Â  });
Â Â 
Â  const sortedCats = Array.from(cats).sort();
Â Â 
Â  const currentVal = categorySelect.value;
Â Â 
Â  categorySelect.innerHTML = `<option value="">å…¨éƒ¨åˆ†é¡</option>`;
Â  sortedCats.forEach(c => {
Â  Â  const opt = document.createElement("option");
Â  Â  opt.value = c;
Â  Â  opt.textContent = c;
Â  Â  categorySelect.appendChild(opt);
Â  });
Â Â 
Â  if(currentVal && sortedCats.includes(currentVal)) {
Â  Â  categorySelect.value = currentVal;
Â  }
}

async function preloadProducts() {
Â  // Load Quote List on start
Â  quoteList = loadQuoteList(); 
Â  updateQuoteToolbarBtn();

Â  const cached = loadCache();
Â  if (cached && cached.length) {
Â  Â  productCache = cached.map(p => ({
Â  Â  Â  ...p,
Â  Â  Â  model: (p.model || "").trim(),
Â  Â  Â  mainModel: p.mainModel || getMainModel(p.model || ""),
Â  Â  Â  searchKey: (p.searchKey || `${p.model||""} ${p.mainModel||""} ${p.name||""}`.toLowerCase())
Â  Â  }));
Â  Â  isProductsLoaded = true;
Â  Â  isQuotesLoaded = false;
Â  Â  updateCategoryOptions();Â 
Â  Â  refreshProductsFromFirestore();
Â  Â  return;
Â  }
Â  showLoading();
Â  isProductsLoaded = false;
Â  isQuotesLoaded = false;
Â  try {
Â  Â  const snap = await getDocsWithRetry(collection(db, "Products"));
Â  Â  const fullList = [];
Â  Â  snap.forEach(docSnap => {
Â  Â  Â  const d = docSnap.data() || {};
Â  Â  Â  const id = docSnap.id;
Â  Â  Â Â 
Â  Â  Â  const model = (d.model || "").trim();
Â  Â  Â  const mainModel = getMainModel(model);
Â  Â  Â  let colorList = (d.colorList || "").trim();
Â  Â  Â  if (!colorList) {
Â  Â  Â  Â  const suffix = model.toUpperCase().replace(mainModel, "");
Â  Â  Â  Â  if (suffix && /^[A-Z]{1,3}$/.test(suffix)) colorList = suffix;
Â  Â  Â  }
Â  Â  Â  const searchKey = `${model} ${mainModel} ${d.name || ""}`.toLowerCase();
Â  Â  Â  const category = d.category ? String(d.category).trim() : "";
Â  Â  Â  const netSalesPermission = d.netSalesPermission ? String(d.netSalesPermission).trim() : "";
Â  Â  Â Â 
Â  Â  Â  fullList.push({ id, ...d, model, mainModel, colorList, searchKey, category, netSalesPermission });
Â  Â  });
Â  Â  productCache = fullList;
Â  Â  isProductsLoaded = true;
Â  Â  isQuotesLoaded = true;
Â  Â  updateCategoryOptions();Â 
Â  Â Â 
Â  Â  const safeList = fullList.map(p => {
Â  Â  Â  const c = { ...p };
Â  Â  Â  delete c.quote50; delete c.quote100; delete c.quote300; delete c.quote500; delete c.quote1000;
Â  Â  Â  return c;
Â  Â  });
Â  Â  saveCache(safeList);
Â  Â  showToast("å•†å“è³‡æ–™å·²å¾é›²ç«¯è¼‰å…¥å®Œæˆ", 'success');
Â  } catch (e) {
Â  Â  console.error(e);
Â  Â  showToast("âŒ å•†å“è³‡æ–™è¼‰å…¥å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ–è¯çµ¡ç®¡ç†å“¡ã€‚", 'error');
Â  }
Â  hideLoading();
}

async function refreshProductsFromFirestore() {
Â  try {
Â  Â  const snap = await getDocsWithRetry(collection(db, "Products"));
Â  Â  const fullList = [];
Â  Â  snap.forEach(docSnap => {
Â  Â  Â  const d = docSnap.data() || {};
Â  Â  Â  const id = docSnap.id;
Â  Â  Â Â 
Â  Â  Â  const model = (d.model || "").trim();
Â  Â  Â  const mainModel = getMainModel(model);
Â  Â  Â  let colorList = (d.colorList || "").trim();
Â  Â  Â  if (!colorList) {
Â  Â  Â  Â  const suffix = model.toUpperCase().replace(mainModel, "");
Â  Â  Â  Â  if (suffix && /^[A-Z]{1,3}$/.test(suffix)) colorList = suffix;
Â  Â  Â  }
Â  Â  Â  const searchKey = `${model} ${mainModel} ${d.name || ""}`.toLowerCase();
Â  Â  Â  const category = d.category ? String(d.category).trim() : "";
Â  Â  Â  const netSalesPermission = d.netSalesPermission ? String(d.netSalesPermission).trim() : "";
Â  Â  Â Â 
Â  Â  Â  fullList.push({ id, ...d, model, mainModel, colorList, searchKey, category, netSalesPermission });
Â  Â  });
Â  Â  productCache = fullList;
Â  Â  isQuotesLoaded = true;
Â  Â  updateCategoryOptions();Â 
Â  Â Â 
Â  Â  const safeList = fullList.map(p => {
Â  Â  Â  const c = { ...p };
Â  Â  Â  delete c.quote50; delete c.quote100; delete c.quote300; delete c.quote500; delete c.quote1000;
Â  Â  Â  return c;
Â  Â  });
Â  Â  saveCache(safeList);
Â  } catch(e) { console.warn(e); }
}

function setupQtySelectByLevel() {
Â  qtySelect.innerHTML = "";
Â  const emptyOpt = document.createElement("option");
Â  emptyOpt.value = ""; emptyOpt.textContent = "ä¸ä½¿ç”¨èµ·è¨‚é‡";
Â  qtySelect.appendChild(emptyOpt);
Â Â 
Â  const add = (v,t)=>{
Â  Â  const o = document.createElement("option"); o.value = v; o.textContent = t; qtySelect.appendChild(o);
Â  };
Â Â 
Â  if (userLevel >= 1) add("50", "50 å€‹");
Â  if (userLevel >= 2) { add("100", "100 å€‹"); add("300", "300 å€‹"); }
Â  if (userLevel >= 3) { add("500", "500 å€‹"); add("1000", "1000 å€‹"); }
}

function mergeByMainModel(list) {
Â  const map = {};
Â  list.forEach(item => {
Â  Â  const main = item.mainModel || getMainModel(item.model);
Â  Â  if (!map[main]) {
Â  Â  Â  map[main] = { ...item, models: [item.model], colorList: item.colorList || "-" };
Â  Â  } else {
Â  Â  Â  map[main].models.push(item.model);
Â  Â  Â  const exist = map[main].colorList.split(" / ").filter(Boolean);
Â  Â  Â  const incoming = (item.colorList || "").split(" / ").filter(Boolean);
Â  Â  Â  map[main].colorList = [...new Set([...exist, ...incoming])].join(" / ");
Â  Â  }
Â  Â Â 
Â  Â  if(item.inventory) {
Â  Â  Â  Â  if(!map[main].inventory || parseInt(item.inventory) > parseInt(map[main].inventory)) {
Â  Â  Â  Â  Â  Â  map[main].inventory = item.inventory;
Â  Â  Â  Â  }
Â  Â  }
Â  });
Â  return Object.values(map);
}

function applySorting(list) {
Â  const o = sortSelect.value;
Â  if (o === "minPriceAsc")Â  return list.sort((a,b)=> (a.minPrice||0) - (b.minPrice||0));
Â  if (o === "minPriceDesc") return list.sort((a,b)=> (b.minPrice||0) - (a.minPrice||0));
Â  if (o === "marketAsc")Â  Â  return list.sort((a,b)=> (a.marketPrice||0) - (b.marketPrice||0));
Â  if (o === "marketDesc")Â  Â return list.sort((a,b)=> (b.marketPrice||0) - (a.marketPrice||0));
Â  if (o === "alphaAsc")Â  Â  Â return list.sort((a,b)=> (a.mainModel||"").localeCompare(b.mainModel||""));
Â  if (o === "alphaDesc")Â  Â  return list.sort((a,b)=> (b.mainModel||"").localeCompare(a.mainModel||""));
Â  return list;
}

function searchProducts() {
Â  if (!isProductsLoaded) { showToast("å•†å“è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™å†è©¦ã€‚", 'info'); return; }
Â Â 
Â  const key = keywordInput.value.trim().toLowerCase();
Â  const qty = qtySelect.value;
Â  const minPraw = minPriceInput.value.trim();
Â  const maxPraw = maxPriceInput.value.trim();
Â  const cat = categorySelect.value;Â 
Â  const stockReq = stockFilter.value;Â 
Â Â 
Â  const hasKey = !!key;
Â  const hasQty = !!qty;
Â  const hasBudget = !!minPraw || !!maxPraw;
Â  const hasCat = !!cat;Â 
Â  const hasStockReq = !!stockReq;

Â  if (hasBudget && !hasQty && userLevel >= 1) {
Â  Â  showToast("æœå°‹é ç®—å€é–“æ™‚ï¼Œå¿…é ˆé¸æ“‡ã€Œèµ·è¨‚é‡ã€ï¼", 'error');
Â  Â  return;
Â  }
Â Â 
Â  if (hasQty && !hasKey && !hasBudget && !hasCat && !hasStockReq) {
Â  Â  showToast("è«‹è¼¸å…¥æœå°‹æ¢ä»¶ï¼ˆé—œéµå­—ã€åˆ†é¡ã€èµ·è¨‚é‡ã€é ç®—æˆ–åº«å­˜éœ€æ±‚ï¼‰", 'error');
Â  Â  return;
Â  }

Â  const _needsQuote = hasQty && hasBudget;
Â  if (_needsQuote && !isQuotesLoaded) { showToast("å ±åƒ¹è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™", 'info'); return; }

Â  showLoading();
Â  updateUserDisplay('searching');

Â  setTimeout(() => {
Â  Â  let r = productCache;

Â  Â  // ğŸš€ Filter out inactive products
Â  Â  r = r.filter(p => p.status !== 'inactive');

Â  Â  if (hasCat) {
Â  Â  Â  Â  r = r.filter(p => p.category === cat);
Â  Â  }

Â  Â  if (hasKey) {
Â  Â  Â  r = r.filter(p => (p.searchKey || "").includes(key));
Â  Â  }

Â  Â  if (hasStockReq) {
Â  Â  Â  Â  const minStock = parseInt(stockReq, 10);
Â  Â  Â  Â  r = r.filter(p => {
Â  Â  Â  Â  Â  Â  const inv = parseInt(p.inventory || 0, 10);
Â  Â  Â  Â  Â  Â  return inv >= minStock;
Â  Â  Â  Â  });
Â  Â  }

Â  Â  if (hasBudget) {
Â  Â  Â  const min = minPraw ? Number(minPraw) : 0;
Â  Â  Â  const max = maxPraw ? Number(maxPraw) : Number.MAX_SAFE_INTEGER;
Â  Â  Â Â 
Â  Â  Â  r = r.filter(p => {
Â  Â  Â  Â  let price = 0;
Â  Â  Â  Â  if (qty) {
Â  Â  Â  Â  Â  Â  const k = `quote${qty}`;
Â  Â  Â  Â  Â  Â  price = Number(p[k]) || 0;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  price = Number(p.marketPrice) || 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  return price >= min && price <= max;
Â  Â  Â  });
Â  Â  }

Â  Â  currentResultList = mergeByMainModel(r);
Â  Â  if (!sortSelect.value) {
Â  Â  Â  Â  currentResultList = shuffleArray(currentResultList);
Â  Â  } else {
Â  Â  Â  Â  currentResultList = applySorting(currentResultList);
Â  Â  }
Â  Â Â 
Â  Â  renderResults(currentResultList);
Â  Â  hideLoading();
Â  Â  updateUserDisplay('normal');
Â  Â  showToast(`æ‰¾åˆ° ${currentResultList.length} ç­†ç¬¦åˆæ¢ä»¶çš„å•†å“`, 'info');
Â  }, 0);
}

function renderResults(list) {
Â  resultBody.innerHTML = ""; detailCard.style.display = "none"; checkAllBox.checked = false; updateMultiLineBtnState();
Â  if (list.length === 0) {
Â  Â  resultTable.style.display = "none"; exportBtn.disabled = true; pptToolbarBtn.disabled = true; return;
Â  }
Â  resultTable.style.display = "table"; exportBtn.disabled = false; pptToolbarBtn.disabled = false;

Â  list.forEach(item => {
Â  Â  // ğŸŒŸ æ™ºæ…§åœ–ç‰‡éè£œé‚è¼¯ï¼šä¸»åœ– -> Driveä¸»åœ– -> ç¶²è·¯åœ–(ç¬¬1å¼µ) -> No Image
Â  Â  let img = item.imageUrl;
Â  Â  const netImages = getDriveNetImages(item.model, item.mainModel);

Â  Â  if (!img || !img.startsWith("http")) {
Â  Â  Â  const driveImg = getDriveMainImage(item.model, item.mainModel);
Â  Â  Â  if (driveImg) {
Â  Â  Â  Â  Â  img = driveImg;
Â  Â  Â  } else if (netImages && netImages.length > 0) {
Â  Â  Â  Â  Â  img = netImages[0];
Â  Â  Â  } else {
Â  Â  Â  Â  Â  img = "https://placehold.co/110x110?text=No+Image";
Â  Â  Â  }
Â  Â  }
Â Â 
Â  Â  const tr = document.createElement("tr");
Â  Â  let priceHtml = "";

Â  Â  const getPrice = (p) => (item[p] ?? "-");

Â  Â  if (userLevel >= 1) priceHtml += `<span class="price-tag tag50">50å€‹ï¼š${getPrice('quote50')}</span>`;
Â  Â  if (userLevel >= 2) {
Â  Â  Â  priceHtml += `<span class="price-tag tag100">100å€‹ï¼š${getPrice('quote100')}</span>`;
Â  Â  Â  priceHtml += `<span class="price-tag tag300">300å€‹ï¼š${getPrice('quote300')}</span>`;
Â  Â  }
Â  Â  if (userLevel >= 3) {
Â  Â  Â  priceHtml += `<span class="price-tag tag500">500å€‹ï¼š${getPrice('quote500')}</span>`;
Â  Â  Â  priceHtml += `<span class="price-tag tag1000">1000å€‹ï¼š${getPrice('quote1000')}</span>`;
Â  Â  }

Â  Â  const showMinPrice = userLevel >= 1;

Â  Â  const catBadge = item.category ? `<span class="category-badge">${item.category}</span>` : "";
Â  Â Â 
Â  Â  // ğŸš€ Stock Logic - Level 2+ only (Removed stockHtml from tr for simplicity, only for desktop view)
Â  Â Â 
Â  Â  tr.innerHTML = `
Â  Â  Â  <td><input type="checkbox" class="row-check" data-model="${item.model}"></td>
Â  Â  Â  <td>
Â  Â  Â  Â  <img src="${img}" class="product-img" onerror="this.onerror=null;this.src='https://placehold.co/110x110?text=No+Image';">
Â  Â  Â  </td>
Â  Â  Â  <td class="model-cell">${item.mainModel || "-"}</td>
Â  Â  Â  <td>
Â  Â  Â  Â  ${catBadge}Â 
Â  Â  Â  Â  <div style="font-weight:700;margin-bottom:4px;">${item.name || "-"}</div>
Â  Â  Â  Â  <div style="font-size:13px;color:#555;margin-bottom:4px;">é¡è‰²ï¼š${item.colorList || "-"}</div>
Â  Â  Â  Â  <div class="price-tag-container" style="font-size:13px;margin-bottom:4px;">${priceHtml}</div>
Â  Â  Â  Â  <div style="display:flex; gap:6px;">
Â  Â  Â  Â  Â  <button class="line-share-btn" data-model="${item.model}" style="margin-top:6px;padding:6px 10px;font-size:12px;background:#06C755;color:#fff;border:none;border-radius:6px;cursor:pointer;">LINE</button>
Â  Â  Â  Â  Â  <button class="btn-outline-add add-quote-btn" data-model="${item.model}">â• å ±åƒ¹å–®</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </td>
Â  Â  Â  <td style="text-align:right;">${showMinPrice ? (item.minPrice ?? "-") : "---"}</td>
Â  Â  Â  <td style="text-align:right;">${item.marketPrice ?? "-"}</td>
Â  Â  `;

Â  Â  const imgEl = tr.querySelector('.product-img');
Â  Â  const modelEl = tr.querySelector('.model-cell');

Â  Â  const openDetail = () => {
Â  Â  Â  if (window.innerWidth > 900) {
Â  Â  Â  Â  if (window.hideDetailTimer) clearTimeout(window.hideDetailTimer);
Â  Â  Â  Â  showDetailDesktop(item);
Â  Â  Â  } else {
Â  Â  Â  Â  showDetailMobile(item);
Â  Â  Â  }
Â  Â  };

Â  Â  if (imgEl) {
Â  Â  Â  imgEl.addEventListener('click', openDetail);
Â  Â  Â  if (window.innerWidth > 900) {
Â  Â  Â  Â  Â  imgEl.addEventListener('mouseenter', openDetail);
Â  Â  Â  Â  Â  imgEl.addEventListener('mouseleave', () => {
Â  Â  Â  Â  Â  Â  Â window.hideDetailTimer = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â detailCard.style.display = "none";
Â  Â  Â  Â  Â  Â  Â }, 200);Â 
Â  Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }
Â  Â  if (modelEl) {
Â  Â  Â  modelEl.addEventListener('click', openDetail);
Â  Â  Â  Â if (window.innerWidth > 900) {
Â  Â  Â  Â  Â  modelEl.addEventListener('mouseenter', openDetail);
Â  Â  Â  Â  Â  modelEl.addEventListener('mouseleave', () => {
Â  Â  Â  Â  Â  Â  Â window.hideDetailTimer = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â detailCard.style.display = "none";
Â  Â  Â  Â  Â  Â  Â }, 200);Â 
Â  Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }

Â  Â  resultBody.appendChild(tr);
Â  });
Â  bindCheckAll();
}

function showDetailMobile(item) {
Â  const driveMainFolder = getDriveMainFolder(item.model, item.mainModel);
Â  const netImages = getDriveNetImages(item.model, item.mainModel);
Â  const netFolderUrl = getDriveNetGallery(item.model, item.mainModel);
Â  const actMainLink = driveMainFolder || getDriveMainImage(item.model, item.mainModel);
Â  const actNetLink = netFolderUrl || (netImages && netImages.length > 0 ? netImages[0] : "");

Â  // ğŸŒŸ æ™ºæ…§åœ–ç‰‡éè£œé‚è¼¯ï¼šä¸»åœ– -> Driveä¸»åœ– -> ç¶²è·¯åœ–(ç¬¬1å¼µ) -> No Image
Â  let img = item.imageUrl;
Â  if (!img || !img.startsWith("http")) {
Â  Â  const driveImg = getDriveMainImage(item.model, item.mainModel);
Â  Â  if (driveImg) {
Â  Â  Â  Â  img = driveImg;
Â  Â  } else if (netImages && netImages.length > 0) {
Â  Â  Â  Â  img = netImages[0];
Â  Â  } else {
Â  Â  Â  Â  img = "https://placehold.co/300x300?text=No+Image";
Â  Â  }
Â  }

Â  const getPrice = (p) => (item[p] ?? "-");
Â  const showMinPrice = userLevel >= 1;

Â  let quoteHtml = "";
Â  const tiers = [50, 100, 300, 500, 1000];
Â  tiers.forEach(t => {
Â  Â  Â  let isVisible = false;
Â  Â  Â  if (userLevel >= 1 && t === 50) isVisible = true;
Â  Â  Â  if (userLevel >= 2 && (t === 100 || t === 300)) isVisible = true;
Â  Â  Â  if (userLevel >= 3 && (t === 500 || t === 1000)) isVisible = true;

Â  Â  Â  if (isVisible) {
Â  Â  Â  Â  Â  quoteHtml += `<div style="display:flex; justify-content:space-between; padding:4px 0; border-bottom:1px dashed #eee;">
Â  Â  Â  Â  Â  Â  Â  <span style="color:#666;">${t}å€‹</span>
Â  Â  Â  Â  Â  Â  Â  <span style="font-weight:bold; color:#2563eb;">${getPrice('quote' + t)}</span>
Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  }
Â  });

Â  let netThumbHtml = "";
Â  if (netImages && netImages.length > 0) {
Â  Â  Â  const imgsHtml = netImages.slice(0, 6).map(url => {Â 
Â  Â  Â  Â  Â  const displayUrl = "https://images.weserv.nl/?url=" + encodeURIComponent(url);
Â  Â  Â  Â  Â  return `<img src="${displayUrl}" loading="lazy" style="width:100%; aspect-ratio:1; object-fit:cover; border-radius:4px; border:1px solid #eee;" onclick="window.open('${url}', '_blank')">`;
Â  Â  Â  }).join("");
Â  Â  Â  netThumbHtml = `<div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:8px; margin-top:12px;">${imgsHtml}</div>`;
Â  }
Â Â 
Â  // ğŸš€ Stock Logic - Level 2+ only
Â  let stockHtml = "";
Â  if(userLevel >= 2 && item.inventory !== undefined && item.inventory !== null) {
Â  Â  Â  Â  const label = getInventoryRangeLabel(item.inventory);
Â  Â  Â  Â  const qtyVal = parseInt(item.inventory, 10);
Â  Â  Â  Â  let color = "#b45309"; // mid
Â  Â  Â  Â  let bg = "#fffbeb";

Â  Â  Â  Â  if(qtyVal <= 100) { color = "#b91c1c"; bg = "#fef2f2"; }
Â  Â  Â  Â  else if(qtyVal > 1000) { color = "#15803d"; bg = "#f0fdf4"; }

Â  Â  Â  Â  if(label) {
Â  Â  Â  Â  Â  Â  stockHtml = `<div style="margin-bottom:16px; background:${bg}; color:${color}; border:1px solid ${color}; padding:8px; border-radius:8px; text-align:center; font-weight:bold;">
Â  Â  Â  Â  Â  Â  ğŸ“¦ åº«å­˜ï¼š${label}
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }
Â  }

Â  const sheetContent = document.getElementById("sheetContent");
Â  sheetContent.innerHTML = `
Â  Â  <div style="text-align:center; margin-bottom:16px;">
Â  Â  Â  <img src="${img}" style="max-height:200px; max-width:100%; border-radius:8px; box-shadow:0 4px 12px rgba(0,0,0,0.1);" onerror="this.onerror=null;this.src='https://placehold.co/300x300?text=No+Image';">
Â  Â  </div>
Â  Â Â 
Â  Â  <div style="font-weight:700; font-size:18px; margin-bottom:8px;">${item.name || "-"}</div>
Â  Â Â 
Â  Â  <div style="display:flex; gap:8px; margin-bottom:12px; flex-wrap:wrap;">
Â  Â  Â  Â  ${item.category ? `<span style="background:#f3f4f6; color:#4b5563; padding:4px 8px; border-radius:4px; font-size:12px;">åˆ†é¡ï¼š${item.category}</span>` : ""}
Â  Â  Â  Â  ${item.netSalesPermission ? `<span style="background:#e0e7ff; color:#3730a3; padding:4px 8px; border-radius:4px; font-size:12px;">æ¬Šé™ï¼š${item.netSalesPermission}</span>` : ""}
Â  Â  </div>

Â  Â  ${stockHtml}

Â  Â  <div style="color:#666; font-size:14px; margin-bottom:16px;">
Â  Â  Â  Â <div>å‹è™Ÿï¼š${item.model}</div>
Â  Â  Â  Â <div>ä¸»å‹è™Ÿï¼š${item.mainModel}</div>
Â  Â  Â  Â <div>é¡è‰²ï¼š${item.colorList || "-"}</div>
Â  Â  Â  Â <div>ç®±å…¥æ•¸ï¼š${item.cartonQty || "-"}</div>
Â  Â  Â  Â <div>åœ‹éš›æ¢ç¢¼ï¼š${item.barcode || item.internationalBarcode || "-"}</div>
Â  Â  </div>

Â  Â  <div style="background:#f9fafb; padding:12px; border-radius:8px; margin-bottom:16px;">
Â  Â  Â  Â <div style="font-weight:700; margin-bottom:8px;">åƒ¹æ ¼è³‡è¨Š</div>
Â  Â  Â  Â <div style="display:flex; justify-content:space-between; margin-bottom:4px;">
Â  Â  Â  Â  Â <span>è³£å ´å”®åƒ¹</span>
Â  Â  Â  Â  Â <span style="font-weight:bold;">${getPrice('marketPrice')}</span>
Â  Â  Â  Â </div>
Â  Â  Â  Â <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
Â  Â  Â  Â  Â <span>æœ«å”®åƒ¹æ ¼</span>
Â  Â  Â  Â  Â <span style="font-weight:bold; color:#dc2626;">${showMinPrice ? getPrice('minPrice') : '---'}</span>
Â  Â  Â  Â </div>
Â  Â  Â  Â ${quoteHtml ? `<div style="background:#fff; padding:8px; border-radius:6px; margin-top:8px; border:1px solid #eee;">${quoteHtml}</div>` : ''}
Â  Â  </div>

Â  Â  <div style="display:flex; gap:10px; flex-wrap:wrap; margin-bottom:16px;">
Â  Â  Â  Â  ${actMainLink ? `<a href="${actMainLink}" target="_blank" class="btn-secondary" style="flex:1; text-align:center;">ä¸‹è¼‰å¤§åœ–</a>` : ''}
Â  Â  Â  Â  ${actNetLink ? `<a href="${actNetLink}" target="_blank" class="btn-secondary" style="flex:1; text-align:center;">ä¸‹è¼‰ç¶²è·¯åœ–</a>` : ''}
Â  Â  </div>

Â  Â  ${netThumbHtml}

Â  Â  <div style="height:20px;"></div>
Â  Â  <div style="display:flex; gap:10px;">
Â  Â  Â  Â <button class="btn-primary line-share-btn" data-model="${item.model}" style="flex:1;">LINE åˆ†äº«</button>
Â  Â  Â  Â <button class="btn-outline-add add-quote-btn" data-model="${item.model}" style="flex:1;">åŠ å…¥å ±åƒ¹å–®</button>
Â  Â  </div>
Â  Â  <div style="height:30px;"></div>
Â  `;

Â  openSheet();
}

function showDetailDesktop(item) {
Â  if (window.hideDetailTimer) clearTimeout(window.hideDetailTimer);

Â  const driveMainFolder = getDriveMainFolder(item.model, item.mainModel);
Â  const netImages = getDriveNetImages(item.model, item.mainModel); // Retrieve net images
Â  const netFolderUrl = getDriveNetGallery(item.model, item.mainModel);
Â  const actMainLink = driveMainFolder || getDriveMainImage(item.model, item.mainModel);
Â  const actNetLink = netFolderUrl || (netImages && netImages.length > 0 ? netImages[0] : "");

Â  // ğŸŒŸ æ™ºæ…§åœ–ç‰‡éè£œé‚è¼¯ï¼šä¸»åœ– -> Driveä¸»åœ– -> ç¶²è·¯åœ–(ç¬¬1å¼µ) -> No Image
Â  let img = item.imageUrl;
Â  if (!img || !img.startsWith("http")) {
Â  Â  const driveImg = getDriveMainImage(item.model, item.mainModel);
Â  Â  if (driveImg) {
Â  Â  Â  Â  img = driveImg;
Â  Â  } else if (netImages && netImages.length > 0) {
Â  Â  Â  Â  img = netImages[0];
Â  Â  } else {
Â  Â  Â  Â  img = "https://placehold.co/300x300?text=No+Image";
Â  Â  }
Â  }

Â  let netThumbHtml = "";
Â  if (netImages && netImages.length > 0) {
Â  Â  Â  const imgsHtml = netImages.slice(0, 6).map(url => {Â 
Â  Â  Â  Â  Â  const displayUrl = "https://images.weserv.nl/?url=" + encodeURIComponent(url);
Â  Â  Â  Â  Â  return `<img src="${displayUrl}" loading="lazy" style="cursor:pointer; width:100%; height:60px; object-fit:cover; border-radius:4px;" onclick="window.open('${url}', '_blank')">`;
Â  Â  Â  }).join("");
Â  Â  Â  netThumbHtml = `<div class="net-gallery" style="grid-template-columns:repeat(6, 1fr); gap:4px; margin-top:8px;">${imgsHtml}</div>`;
Â  }

Â  const getPrice = (p) => (item[p] ?? "-");
Â  const showMinPrice = userLevel >= 1;

Â  let quoteHtml = "";
Â  const tiers = [50, 100, 300, 500, 1000];
Â  tiers.forEach(t => {
Â  Â  Â  let isVisible = false;
Â  Â  Â  if (userLevel >= 1 && t === 50) isVisible = true;
Â  Â  Â  if (userLevel >= 2 && (t === 100 || t === 300)) isVisible = true;
Â  Â  Â  if (userLevel >= 3 && (t === 500 || t === 1000)) isVisible = true;

Â  Â  Â  if (isVisible) {
Â  Â  Â  Â  Â  quoteHtml += `<div style="display:flex; justify-content:space-between; padding:2px 0; border-bottom:1px dashed #eee;">
Â  Â  Â  Â  Â  Â  Â  <span style="color:#666;">${t}å€‹</span>
Â  Â  Â  Â  Â  Â  Â  <span style="font-weight:bold; color:#2563eb;">${getPrice('quote' + t)}</span>
Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  }
Â  });
Â Â 
Â  // ğŸš€ Stock Logic - Level 2+ only
Â  let stockHtml = "";
Â  if(userLevel >= 2 && item.inventory !== undefined && item.inventory !== null) {
Â  Â  Â  Â  const label = getInventoryRangeLabel(item.inventory);
Â  Â  Â  Â  const qtyVal = parseInt(item.inventory, 10);
Â  Â  Â  Â  let color = "#b45309";Â 
Â  Â  Â  Â  let bg = "#fffbeb";

Â  Â  Â  Â  if(qtyVal <= 100) { color = "#b91c1c"; bg = "#fef2f2"; }
Â  Â  Â  Â  else if(qtyVal > 1000) { color = "#15803d"; bg = "#f0fdf4"; }

Â  Â  Â  Â  if(label) {
Â  Â  Â  Â  Â  Â  stockHtml = `<div style="margin-bottom:12px; background:${bg}; color:${color}; border:1px solid ${color}; padding:6px; border-radius:6px; font-size:13px; font-weight:bold;">
Â  Â  Â  Â  Â  Â  ğŸ“¦ åº«å­˜ï¼š${label}
Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  }
Â  }
Â Â 
Â  detailCard.style.display = "block";
Â  detailCard.innerHTML = `
Â  Â  <button class="card-close-btn" onclick="document.getElementById('detailCard').style.display='none'">Ã—</button>
Â  Â Â 
Â  Â  <img src="${img}" style="width:100%; border-radius:10px; border:1px solid #eee; margin-bottom:12px;" onerror="this.onerror=null;this.src='https://placehold.co/300x300?text=No+Image';">

Â  Â  <div style="margin-bottom:16px;">
Â  Â  Â  <div style="display:flex; gap:8px; flex-wrap:wrap;">
Â  Â  Â  Â  ${actMainLink ? `<a href="${actMainLink}" target="_blank" class="btn-secondary" style="flex:1; text-align:center; font-size:13px; padding:8px;">ä¸‹è¼‰å¤§åœ–</a>` : `<button disabled class="btn-secondary" style="flex:1; color:#ccc;">ç„¡å¤§åœ–</button>`}
Â  Â  Â  Â  ${actNetLink ? `<a href="${actNetLink}" target="_blank" class="btn-secondary" style="flex:1; text-align:center; font-size:13px; padding:8px;">ä¸‹è¼‰ç¶²è·¯åœ–</a>` : `<button disabled class="btn-secondary" style="flex:1; color:#ccc;">ç„¡ç¶²è·¯åœ–</button>`}
Â  Â  Â  </div>
Â  Â  Â  ${netThumbHtml}
Â  Â  </div>

Â  Â  <div style="margin-bottom:16px; background:#f9fafb; padding:12px; border-radius:8px;">
Â  Â  Â  <div style="font-weight:700; font-size:16px; margin-bottom:8px; color:#111;">${item.name || "-"}</div>
Â  Â  Â Â 
Â  Â  Â  <div style="margin-bottom:8px; font-size:13px; color:#555;">
Â  Â  Â  Â  ${item.category ? `<span style="background:#e5e7eb; padding:2px 6px; border-radius:4px; margin-right:6px;">åˆ†é¡: ${item.category}</span>` : ""}
Â  Â  Â  Â  ${item.netSalesPermission ? `<span style="background:#dbeafe; padding:2px 6px; border-radius:4px; color:#1e40af;">ç¶²è·¯æ¬Šé™: ${item.netSalesPermission}</span>` : ""}
Â  Â  Â  </div>
Â  Â  Â Â 
Â  Â  Â  ${stockHtml}

Â  Â  Â  <div style="font-size:14px; line-height:1.8; color:#444;">
Â  Â  Â  Â  <div><span style="color:#888;">é¡è‰²ï¼š</span> ${item.colorList || "-"}</div>
Â  Â  Â  Â  <div><span style="color:#888;">ç®±å…¥æ•¸ï¼š</span> ${item.cartonQty || "-"}</div>
Â  Â  Â  Â  <div><span style="color:#888;">åœ‹éš›æ¢ç¢¼ï¼š</span> ${item.barcode || item.internationalBarcode || "-"}</div>
Â  Â  Â  Â  <div><span style="color:#888;">é€£çµï¼š</span> ${item.productUrl ? `<a href="${item.productUrl}" target="_blank" style="color:#2563eb;text-decoration:underline;">é–‹å•Ÿç¶²é </a>` : "-"}</div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div style="margin-bottom:12px;">
Â  Â  Â  <div style="font-weight:700; margin-bottom:8px; border-left:4px solid #2563eb; padding-left:8px;">åƒ¹æ ¼è³‡è¨Š</div>
Â  Â  Â  <div style="background:#fff; border:1px solid #eee; border-radius:8px; padding:12px;">
Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
Â  Â  Â  Â  Â  Â <span>è³£å ´å”®åƒ¹</span>
Â  Â  Â  Â  Â  Â <span style="font-weight:bold;">${getPrice('marketPrice')}</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="display:flex; justify-content:space-between; margin-bottom:12px;">
Â  Â  Â  Â  Â  Â <span>æœ«å”®åƒ¹æ ¼</span>
Â  Â  Â  Â  Â  Â <span style="font-weight:bold; color:#dc2626;">${showMinPrice ? getPrice('minPrice') : '---'}</span>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div style="background:#f0f9ff; padding:8px 12px; border-radius:6px;">
Â  Â  Â  Â  Â  Â <div style="font-size:12px; color:#666; margin-bottom:4px; font-weight:600;">æ¡è³¼å ±åƒ¹</div>
Â  Â  Â  Â  Â  Â ${quoteHtml || '<div style="color:#999; font-size:12px;">ç„¡æ¬Šé™æŸ¥çœ‹å ±åƒ¹</div>'}
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div style="display:flex; gap:8px; margin-top:16px;">
Â  Â  Â  <button class="btn-primary line-share-btn" data-model="${item.model}" style="flex:1;">LINE åˆ†äº«</button>
Â  Â  Â  <button class="btn-outline-add add-quote-btn" data-model="${item.model}" style="flex:1;">åŠ å…¥å ±åƒ¹å–®</button>
Â  Â  </div>
Â  `;
}

async function buildProductSlide(pptx, item, tier, customQuoteInfo) {
Â  Â  const slide = pptx.addSlide();
Â  Â  slide.background = { color: "FFFFFF" };

Â  Â  // --- 1. Image Logic: Strict "Net Image 1 at Top-Left" ---
Â  Â  // Get all available net images
Â  Â  const netImages = getDriveNetImages(item.model, item.mainModel) || [];
Â  Â Â 
Â  Â  // Prepare the list of 6 images
Â  Â  let imagesToDisplay = [];
Â  Â Â 
Â  Â  // Add Net Images first (up to 6)
Â  Â  imagesToDisplay = [...netImages];

Â  Â  // If we don't have enough net images, fill with other sources
Â  Â  const driveMain = getDriveMainImage(item.model, item.mainModel);
Â  Â  const rawImg = item.imageUrl;

Â  Â  // Helper to add unique
Â  Â  const addUnique = (url) => {
Â  Â  Â  Â  if(url && !imagesToDisplay.includes(url) && imagesToDisplay.length < 6) {
Â  Â  Â  Â  Â  Â  imagesToDisplay.push(url);
Â  Â  Â  Â  }
Â  Â  };

Â  Â  addUnique(driveMain);
Â  Â  if(rawImg && rawImg.startsWith('http')) addUnique(rawImg);

Â  Â  // --- 2. Header Section (Common) ---
Â  Â  // Logo
Â  Â  try {
Â  Â  Â  Â  const logoUrl = "https://drive.google.com/uc?id=1JxoU3A5qAYsE39pc2z7IMVwVS8-uTOIn";Â 
Â  Â  Â  Â  const logoB64 = await fetchAsDataURL(logoUrl);
Â  Â  Â  Â  if(logoB64) slide.addImage({ data: logoB64, x: 0.2, y: 0.2, w: 1.5, h: 0.6 });Â 
Â  Â  } catch(e) {}

Â  Â  // Title (Name ONLY, No Model)
Â  Â  // ğŸŒŸ é€™è£¡ç¢ºä¿åªé¡¯ç¤ºå“å
Â  Â  slide.addText(item.name || "æœªå‘½åå•†å“", {
Â  Â  Â  Â  x: 1.8, y: 0.2, w: 5.5, h: 0.6,
Â  Â  Â  Â  fontSize: 20, bold: true, color: "000000", fontFace: "å¾®è»Ÿæ­£é»‘é«”", valign: "middle"
Â  Â  });

Â  Â  // Pricing
Â  Â  let quoteText = "", quotePrice = "";
Â  Â  if (customQuoteInfo) {
Â  Â  Â  Â  quoteText = `å ±åƒ¹(${customQuoteInfo.qtyLabel}):`;
Â  Â  Â  Â  quotePrice = `$${customQuoteInfo.price}`;
Â  Â  } else {
Â  Â  Â  Â  const quoteKey = `quote${tier}`;
Â  Â  Â  Â  const p = item[quoteKey] || item.quote50 || "-";
Â  Â  Â  Â  quoteText = `å ±åƒ¹(${tier}å€‹):`;
Â  Â  Â  Â  quotePrice = `$${p}`;
Â  Â  }

Â  Â  slide.addText(`è³£å ´åƒ¹: $${item.marketPrice}`, {
Â  Â  Â  Â  x: 7.5, y: 0.2, w: 2.3, h: 0.3,
Â  Â  Â  Â  fontSize: 12, color: "888888", align: "right", fontFace: "å¾®è»Ÿæ­£é»‘é«”"
Â  Â  });
Â  Â  slide.addText(quoteText, {
Â  Â  Â  Â  x: 7.0, y: 0.5, w: 1.8, h: 0.4,
Â  Â  Â  Â  fontSize: 14, color: "2563eb", align: "right", fontFace: "å¾®è»Ÿæ­£é»‘é«”", bold:true
Â  Â  });
Â  Â  slide.addText(quotePrice, {
Â  Â  Â  Â  x: 8.8, y: 0.5, w: 1.0, h: 0.4,
Â  Â  Â  Â  fontSize: 18, color: "DC2626", align: "right", fontFace: "å¾®è»Ÿæ­£é»‘é«”", bold:true
Â  Â  });

Â  Â  // --- 3. Grid Generation (Fixed 2x3 Gallery) ---
Â  Â  const startY = 1.2;
Â  Â  const marginX = 0.5;
Â  Â  const gridW = 9.0;Â 
Â  Â  const cols = 3;
Â  Â  const gap = 0.2;
Â  Â  const imgW = (gridW - (gap * (cols - 1))) / cols; // ~2.86
Â  Â  const imgH = 2.4;Â 

Â  Â  // Fill slots. If we have fewer than 6 images, we just stop filling.
Â  Â  for (let i = 0; i < 6; i++) {
Â  Â  Â  Â  if (i < imagesToDisplay.length) {
Â  Â  Â  Â  Â  Â  const url = imagesToDisplay[i];
Â  Â  Â  Â  Â  Â  const r = Math.floor(i / cols);
Â  Â  Â  Â  Â  Â  const c = i % cols;
Â  Â  Â  Â  Â  Â  const x = marginX + c * (imgW + gap);
Â  Â  Â  Â  Â  Â  const y = startY + r * (imgH + gap);

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const b64 = await fetchAsDataURL(url);
Â  Â  Â  Â  Â  Â  Â  Â  if(b64) slide.addImage({ data: b64, x: x, y: y, w: imgW, h: imgH, sizing: { type: "contain", w: imgW, h: imgH } });
Â  Â  Â  Â  Â  Â  } catch(e) {}
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // 4. Footer
Â  Â  const dateStr = new Date().toISOString().split('T')[0];
Â  Â  slide.addText(`KINYO | ç”Ÿæˆæ—¥æœŸ: ${dateStr}`, {
Â  Â  Â  Â  x: 0.5, y: 7.0, w: 5.0, h: 0.3,
Â  Â  Â  Â  fontSize: 10, color: "AAAAAA", fontFace: "å¾®è»Ÿæ­£é»‘é«”"
Â  Â  });
}

async function exportSelectedPPT(source = 'checked') {
Â  if (typeof PptxGenJS === "undefined") { showToast("PPT æ¨¡çµ„æœªè¼‰å…¥", 'error'); return; }
Â Â 
Â  let selectedItems = [];
Â  let tier = qtySelect.value || "50";
Â  let isFromQuoteList = false;

Â  if (source === 'quote') {
Â  Â  Â  if (quoteList.length === 0) { showToast("å ±åƒ¹å–®æ˜¯ç©ºçš„", 'error'); return; }
Â  Â  Â  selectedItems = quoteList.map(q => {
Â  Â  Â  Â  Â  let fullItem = currentResultList.find(p => p.model === q.model) || productCache.find(p => p.model === q.model);
Â  Â  Â  Â  Â  if (!fullItem) {
Â  Â  Â  Â  Â  Â  Â  Â // Create a mock item if the product is no longer in cache, using quote data
Â  Â  Â  Â  Â  Â  Â  Â fullItem = { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  ...q, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  name: q.name, // Ensure name is passed
Â  Â  Â  Â  Â  Â  Â  Â  Â  marketPrice: '-', // Placeholder
Â  Â  Â  Â  Â  Â  Â  Â  Â  imageUrl: '', netImages: [] 
Â  Â  Â  Â  Â  Â  Â  Â };Â 
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  return {Â 
Â  Â  Â  Â  Â  Â  Â  ...fullItem,Â 
Â  Â  Â  Â  Â  Â  Â  customQuoteInfo: { price: q.price, qtyLabel: q.qtyLabel }Â 
Â  Â  Â  Â  Â  };
Â  Â  Â  });
Â  Â  Â  isFromQuoteList = true;
Â  } else {
Â  Â  Â  const checks = Array.from(document.querySelectorAll(".row-check:checked"));
Â  Â  Â  if (checks.length < 1) { showToast("è«‹è‡³å°‘å‹¾é¸ 1 å€‹å•†å“æ‰èƒ½ç”Ÿæˆ PPTã€‚", 'error'); return; }
Â  Â  Â Â 
Â  Â  Â  selectedItems = checks.map(cb => {
Â  Â  Â  Â  Â  const model = cb.dataset.model;
Â  Â  Â  Â  Â  let item = currentResultList.find(p => p.model === model);
Â  Â  Â  Â  Â  if(!item) item = currentResultList.find(p => p.mainModel === model);
Â  Â  Â  Â  Â  if(!item) item = currentResultList.find(p => Array.isArray(p.models) && p.models.includes(model));
Â  Â  Â  Â  Â  return item;
Â  Â  Â  }).filter(Boolean);
Â  }

Â  if (selectedItems.length === 0) { showToast("æ‰¾ä¸åˆ°å•†å“è³‡æ–™ï¼Œç„¡æ³•ç”Ÿæˆ PPTã€‚", 'error'); return; }

Â  const btn = source === 'quote' ? pptFromQuoteBtn : pptToolbarBtn;
Â  const originalText = btn.textContent;
Â  btn.disabled = true;Â 

Â  try {
Â  Â  // ğŸŒŸ Batch Processing: All lines start together in chunks
Â  Â  const CHUNK_SIZE = 20;Â 
Â  Â  const batches = [];
Â  Â  for (let i = 0; i < selectedItems.length; i += CHUNK_SIZE) {
Â  Â  Â  Â  batches.push(selectedItems.slice(i, i + CHUNK_SIZE));
Â  Â  }

Â  Â  const salesName = currentUserEmail.replace(/@.*/, "") || "æ¥­å‹™";
Â  Â  const salesPhone = "0976-966333";

Â  Â  for (let i = 0; i < batches.length; i++) {
Â  Â  Â  Â  btn.textContent = `ç”Ÿæˆä¸­ (${i + 1}/${batches.length})...`;

Â  Â  Â  Â  const pptx = new PptxGenJS();
Â  Â  Â  Â  pptx.layout = "LAYOUT_4x3";Â 
Â  Â  Â  Â  pptx.author = "KINYO Price System";
Â  Â  Â  Â  pptx.company = "KINYO";
Â  Â  Â  Â  pptx.title = `KINYO Quote`;

Â  Â  Â  Â  const currentBatch = batches[i];
Â  Â  Â  Â Â 
Â  Â  Â  Â  await Promise.all(currentBatch.map(async (item) => {
Â  Â  Â  Â  Â  Â  await buildProductSlide(pptx, item, tier, item.customQuoteInfo);
Â  Â  Â  Â  }));
Â  Â  Â  Â Â 
Â  Â  Â  Â  let filename = `KINYO-å•†å“æ¨è–¦å ±åƒ¹-@${salesName}-@${salesPhone}`;
Â  Â  Â  Â  if (batches.length > 1) {
Â  Â  Â  Â  Â  Â  filename += `_Part${i + 1}`;
Â  Â  Â  Â  }
Â  Â  Â  Â  filename += ".pptx";

Â  Â  Â  Â  await pptx.writeFile({ fileName: filename });
Â  Â  }
Â  Â  showToast("PPT æ–‡ä»¶ç”ŸæˆæˆåŠŸï¼", 'success');

Â  } catch (e) {
Â  Â  console.error(e);
Â  Â  showToast("âŒ PPT ç”Ÿæˆå¤±æ•—ï¼Œè«‹æŸ¥çœ‹ Consoleã€‚", 'error');
Â  } finally {
Â  Â  btn.disabled = false;
Â  Â  btn.textContent = originalText;
Â  }
}

function exportSelectedExcel() {
Â  const checked = document.querySelectorAll(".row-check:checked");
Â  if (checked.length === 0) { showToast("è«‹å…ˆå‹¾é¸è¦åŒ¯å‡ºçš„å•†å“", 'error'); return; }
Â  const selectedModels = Array.from(checked).map(c => c.getAttribute("data-model"));
Â Â 
Â  const baseHeader = ["å•†å“å‹è™Ÿ","ä¸»å‹è™Ÿ","åˆ†é¡","å•†å“åç¨±","é¡è‰²åˆ—è¡¨","ç¶²è·¯æ¬Šé™","ç®±å…¥æ•¸","å•†å“é€£çµ","å•†å“å¤§åœ–","ç¶²è·¯åœ–"];
Â  const qty = qtySelect.value;
Â  let priceHeader = qty ? [`${qty}å€‹`, "æœ«å”®", "è³£å ´", "åº«å­˜"] : ["æœ«å”®", "è³£å ´", "åº«å­˜"];
Â  const rows = [[...baseHeader, ...priceHeader]];
Â  selectedModels.forEach(m => {
Â  Â  const item = currentResultList.find(p => p.model === m);
Â  Â  if (!item) return;
Â  Â  const driveMain = getDriveMainImage(item.model, item.mainModel);
Â  Â  const driveNetList = getDriveNetImages(item.model, item.mainModel);
Â  Â Â 
Â  Â  const baseRow = [item.model, item.mainModel, item.category || "", item.name, item.colorList || "", item.netSalesPermission || "", item.cartonQty || "", item.productUrl || "", driveMain || "", driveNetList.join(" | ")];
Â  Â  let priceRow = [];
Â  Â Â 
Â  Â  const showMinPrice = userLevel >= 1;
Â  Â  const stock = getInventoryRangeLabel(item.inventory) || "-";
Â  Â Â 
Â  Â  if (qty) {
Â  Â  Â  const ck = `quote${qty}`;
Â  Â  Â  let canSeeQuote = false;
Â  Â  Â  if (userLevel >= 1 && qty == 50) canSeeQuote = true;
Â  Â  Â  if (userLevel >= 2 && (qty == 100 || qty == 300)) canSeeQuote = true;
Â  Â  Â  if (userLevel >= 3 && (qty == 500 || qty == 1000)) canSeeQuote = true;

Â  Â  Â  priceRow = [
Â  Â  Â  Â  Â  canSeeQuote ? (item[ck] ?? item.quote50 ?? "-") : "---",Â 
Â  Â  Â  Â  Â  showMinPrice ? (item.minPrice ?? "-") : "---",Â 
Â  Â  Â  Â  Â  item.marketPrice ?? "-",
Â  Â  Â  Â  Â  stock
Â  Â  Â  ];
Â  Â  } else {
Â  Â  Â  priceRow = [showMinPrice ? (item.minPrice ?? "-") : "---", item.marketPrice ?? "-", stock];
Â  Â  }
Â  Â  rows.push([...baseRow, ...priceRow]);
Â  });
Â  const wb = XLSX.utils.book_new();
Â  const ws = XLSX.utils.aoa_to_sheet(rows);
Â  XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹");
Â  XLSX.writeFile(wb, `KINYO_å•†å“å ±åƒ¹_${qty ? qty+'å€‹' : 'é—œéµå­—æœå°‹'}.xlsx`);
Â  showToast("Excel åŒ¯å‡ºæˆåŠŸï¼", 'success');
}

function downloadQuoteExcel() {
Â  if (quoteList.length === 0) { showToast("å ±åƒ¹å–®æ˜¯ç©ºçš„", 'error'); return; }
Â  const header = ["å•†å“å‹è™Ÿ","å•†å“åç¨±","æ¡è³¼è¦æ ¼","å–®åƒ¹","æ•¸é‡"];
Â  const rows = [header];
Â  quoteList.forEach(q => rows.push([q.model, q.name, q.qtyLabel, q.price, q.count]));
Â  const wb = XLSX.utils.book_new();
Â  const ws = XLSX.utils.aoa_to_sheet(rows);
Â  XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®");
Â  XLSX.writeFile(wb, `KINYO_å ±åƒ¹å–®_${new Date().toISOString().slice(0,10)}.xlsx`);
Â  showToast("å ±åƒ¹å–® Excel åŒ¯å‡ºæˆåŠŸï¼", 'success');
}

/* =======================================================
Â  Â Event Listeners (Bind within Module)
======================================================= */
searchForm.onsubmit = (e)=>{ e.preventDefault(); searchProducts(); };
exportBtn.onclick = exportSelectedExcel;
logoutBtn.onclick = () => {
Â  Â  showConfirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿé€™å°‡æœƒæ¸…é™¤æœ¬åœ°ç·©å­˜çš„ç”¢å“è³‡æ–™ã€‚", () => {
Â  Â  Â  Â  signOut(auth).then(() => {
Â  Â  Â  Â  Â  Â  localStorage.removeItem(getCacheKey()); // Clear product cache on logout
Â  Â  Â  Â  Â  Â  window.location.reload();
Â  Â  Â  Â  Â  Â  showToast("å·²æˆåŠŸç™»å‡º", 'info');
Â  Â  Â  Â  }).catch((error) => {
Â  Â  Â  Â  Â  Â  console.error("ç™»å‡ºéŒ¯èª¤:", error);
Â  Â  Â  Â  Â  Â  showToast("ç™»å‡ºç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡æ–°æ•´ç†ç¶²é ", 'error');
Â  Â  Â  Â  });
Â  Â  });
};

// Open File Dialog
if(importInventoryBtn) {
Â  Â  importInventoryBtn.onclick = () => {
Â  Â  Â  Â  inventoryUpload.value = ''; // Reset
Â  Â  Â  Â  inventoryUpload.click();
Â  Â  };
}

if(importProductBtn) {
Â  Â  importProductBtn.onclick = () => {
Â  Â  Â  Â  productUpload.value = ''; // Reset
Â  Â  Â  Â  productUpload.click();
Â  Â  }
}

// Cancel Import
if(cancelImportBtn) {
Â  Â  cancelImportBtn.onclick = () => {
Â  Â  Â  Â  previewOverlay.style.display = "none";
Â  Â  Â  Â  pendingInventoryMap.clear();
Â  Â  Â  Â  pendingProductData = [];
Â  Â  Â  Â  inventoryUpload.value = '';Â 
Â  Â  Â  Â  productUpload.value = '';
Â  Â  Â  Â  showToast("å·²å–æ¶ˆåŒ¯å…¥æ“ä½œ", 'info');
Â  Â  };
}

// Confirm Import
if(confirmImportBtn) {
Â  Â  confirmImportBtn.onclick = () => {
Â  Â  Â  Â  if(currentImportMode === 'inventory') {
Â  Â  Â  Â  Â  Â  if(pendingInventoryMap.size === 0) return;
Â  Â  Â  Â  Â  Â  previewOverlay.style.display = "none";
Â  Â  Â  Â  Â  Â  saveInventoryToFirestore(pendingInventoryMap);
Â  Â  Â  Â  } else if(currentImportMode === 'product') {
Â  Â  Â  Â  Â  Â  if(pendingProductData.length === 0) return;
Â  Â  Â  Â  Â  Â  previewOverlay.style.display = "none";
Â  Â  Â  Â  Â  Â  saveProductDataToFirestore(pendingProductData);
Â  Â  Â  Â  }
Â  Â  };
}

async function saveProductDataToFirestore(actions) {
Â  Â  if(!productCache) {
Â  Â  Â  Â  showToast("è³‡æ–™è¼‰å…¥ç•°å¸¸ï¼Œè«‹é‡æ–°æ•´ç†ã€‚", 'error');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  importProductBtn.disabled = true;
Â  Â  importProductBtn.textContent = "åŒæ­¥ä¸­...";
Â  Â Â 
Â  Â  let batch = writeBatch(db);
Â  Â  let opCount = 0;
Â  Â  const BATCH_LIMIT = 400;Â 
Â  Â  let successCount = 0;

Â  Â  try {
Â  Â  Â  Â  for(const item of actions) {
Â  Â  Â  Â  Â  Â  if(item.action === 'add') {
Â  Â  Â  Â  Â  Â  Â  Â  const newDocRef = doc(collection(db, "Products")); // auto-id
Â  Â  Â  Â  Â  Â  Â  Â  batch.set(newDocRef, { ...item.data, status: 'active', inventory: 0 }); // Default active
Â  Â  Â  Â  Â  Â  Â  Â  opCount++;
Â  Â  Â  Â  Â  Â  } else if(item.action === 'update') {
Â  Â  Â  Â  Â  Â  Â  Â  const docRef = doc(db, "Products", item.id);
Â  Â  Â  Â  Â  Â  Â  Â  // ğŸŒŸ Smart Update: Only update fields present in item.data
Â  Â  Â  Â  Â  Â  Â  Â  // item.data contains only non-empty fields from Excel
Â  Â  Â  Â  Â  Â  Â  Â  batch.update(docRef, { ...item.data, status: 'active' });Â 
Â  Â  Â  Â  Â  Â  Â  Â  opCount++;
Â  Â  Â  Â  Â  Â  } else if(item.action === 'remove') {
Â  Â  Â  Â  Â  Â  Â  Â  const docRef = doc(db, "Products", item.id);
Â  Â  Â  Â  Â  Â  Â  Â  batch.update(docRef, { status: 'inactive' });
Â  Â  Â  Â  Â  Â  Â  Â  opCount++;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if(opCount >= BATCH_LIMIT) {
Â  Â  Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  Â  Â  Â  Â  batch = writeBatch(db);
Â  Â  Â  Â  Â  Â  Â  Â  opCount = 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  successCount++;
Â  Â  Â  Â  }

Â  Â  Â  Â  if(opCount > 0) {
Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  }

Â  Â  Â  Â  showToast(`ç”¢å“ç¸½è¡¨åŒæ­¥å®Œæˆï¼å…±è™•ç†äº† ${successCount} ç­†è®Šæ›´ã€‚ç³»çµ±å°‡è‡ªå‹•é‡æ–°æ•´ç†ã€‚`, 'success');
Â  Â  Â  Â  setTimeout(() => window.location.reload(), 2000);

Â  Â  } catch(e) {
Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  showToast("âŒ å¯«å…¥è³‡æ–™åº«æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Consoleã€‚", 'error');
Â  Â  } finally {
Â  Â  Â  Â  importProductBtn.disabled = false;
Â  Â  Â  Â  importProductBtn.textContent = "ğŸ“¥ åŒ¯å…¥ç”¢å“ç¸½è¡¨ (åŒæ­¥ä¸Šä¸‹æ¶)";
Â  Â  }
}

async function saveInventoryToFirestore(invMap) {
Â  Â  if(!productCache || productCache.length === 0) {
Â  Â  Â  Â  showToast("å°šæœªè¼‰å…¥ç”¢å“è³‡æ–™ï¼Œç„¡æ³•æ¯”å°æ›´æ–°ã€‚", 'error');
Â  Â  Â  Â  return;
Â  Â  }

Â  Â  importInventoryBtn.disabled = true;
Â  Â  importInventoryBtn.textContent = "æ›´æ–°ä¸­...";
Â  Â Â 
Â  Â  let updatedCount = 0;
Â  Â  let batch = writeBatch(db);
Â  Â  let opCount = 0;
Â  Â  const BATCH_LIMIT = 400;Â 

Â  Â  try {
Â  Â  Â  Â  for (const product of productCache) {
Â  Â  Â  Â  Â  Â  // ğŸŒŸ å„ªå…ˆä½¿ç”¨ internationalBarcode é€²è¡Œæ¯”å°
Â  Â  Â  Â  Â  Â  const bc = (product.internationalBarcode || product.barcode || "").trim();
Â  Â  Â  Â  Â  Â  if(bc && invMap.has(bc)) {
Â  Â  Â  Â  Â  Â  Â  Â  const newQty = invMap.get(bc);
Â  Â  Â  Â  Â  Â  Â  Â  const docRef = doc(db, "Products", product.id);
Â  Â  Â  Â  Â  Â  Â  Â  batch.update(docRef, { inventory: newQty });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  opCount++;
Â  Â  Â  Â  Â  Â  Â  Â  updatedCount++;

Â  Â  Â  Â  Â  Â  Â  Â  if (opCount >= BATCH_LIMIT) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  batch = writeBatch(db); // Reset batch
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opCount = 0;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if (opCount > 0) {
Â  Â  Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  }

Â  Â  Â  Â  showToast(`è³‡æ–™åº«æ›´æ–°å®Œæˆï¼å…±æ›´æ–°äº† ${updatedCount} ç­†åº«å­˜æ•¸æ“šã€‚ç³»çµ±å°‡è‡ªå‹•é‡æ–°æ•´ç†ã€‚`, 'success');
Â  Â  Â  Â  setTimeout(() => window.location.reload(), 2000);

Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Batch update failed", e);
Â  Â  Â  Â  if (e.code === 'permission-denied') {
Â  Â  Â  Â  Â  Â  showToast(
Â  Â  Â  Â  Â  Â  Â  Â  "âŒ æ¬Šé™éŒ¯èª¤ï¼šFirebase è³‡æ–™åº«æ‹’çµ•äº†å¯«å…¥è«‹æ±‚ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡ç¢ºèªæ¬Šé™è¨­å®šã€‚", 'error'
Â  Â  Â  Â  Â  Â  );
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showToast(`æ›´æ–°è³‡æ–™åº«æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼š${e.message}`, 'error');
Â  Â  Â  Â  }
Â  Â  } finally {
Â  Â  Â  Â  importInventoryBtn.disabled = false;
Â  Â  Â  Â  importInventoryBtn.textContent = "ğŸ“¥ åŒ¯å…¥ä¸¦æ›´æ–°è³‡æ–™åº«";
Â  Â  }
}

// ----------------------------------------------------
// PRODUCT IMPORT LOGIC (Smart Sync)
// ----------------------------------------------------
if(productUpload) {
Â  Â  productUpload.onchange = (e) => {
Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  if(!file) return;
Â  Â  Â  Â  currentImportMode = 'product';

Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = (evt) => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const data = evt.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  const workbook = XLSX.read(data, { type: 'binary' });
Â  Â  Â  Â  Â  Â  Â  Â  const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
Â  Â  Â  Â  Â  Â  Â  Â  const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });Â 

Â  Â  Â  Â  Â  Â  Â  Â  // Header Mapping
Â  Â  Â  Â  Â  Â  Â  Â  let h = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  model: -1, name: -1,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  market: -1, min: -1,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  q50: -1, q100: -1, q300: -1, q500: -1, q1000: -1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cat: -1, color: -1, barcode: -1, box: -1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // New fields
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  url: -1, perm: -1, bsmi: -1, ncc: -1, groupBuy: -1
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  // Scan first 10 rows for headers
Â  Â  Â  Â  Â  Â  Â  Â  for(let r=0; r<Math.min(jsonData.length, 10); r++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const row = jsonData[r];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(let c=0; c<row.length; c++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cell = String(row[c] || "").trim().toLowerCase();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cell === 'model' || cell === 'å‹è™Ÿ' || cell === 'ç”¢å“') h.model = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cell === 'name' || cell === 'å“å' || cell === 'ç”¢å“åç¨±') h.name = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cell.includes('è³£å ´') || cell.includes('å»ºè­°å”®åƒ¹')) h.market = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cell.includes('æœ«å”®') || cell.includes('åº•åƒ¹')) h.min = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cell.includes('åœ˜è³¼')) h.groupBuy = c;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Quotes
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cell.includes('50') && !cell.includes('500') && (cell.includes('å ±åƒ¹') || cell.includes('quote') || cell === '50')) h.q50 = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cell.includes('100') && !cell.includes('1000') && (cell.includes('å ±åƒ¹') || cell.includes('quote') || cell === '100')) h.q100 = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cell.includes('300') && (cell.includes('å ±åƒ¹') || cell.includes('quote') || cell === '300')) h.q300 = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cell.includes('500') && (cell.includes('å ±åƒ¹') || cell.includes('quote') || cell === '500')) h.q500 = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cell.includes('1000') && (cell.includes('å ±åƒ¹') || cell.includes('quote') || cell === '1000')) h.q1000 = c;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cell.includes('é¡è‰²')) h.color = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cell.includes('åˆ†é¡') || cell.includes('é¡åˆ¥') || cell === 'category') h.cat = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cell.includes('æ¢ç¢¼') || cell === 'barcode' || cell === 'åœ‹éš›æ¢ç¢¼') h.barcode = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cell.includes('ç®±å…¥') || cell.includes('carton')) h.box = c;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // New Fields
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cell.includes('ç¶²ç«™') || cell.includes('ç¶²å€') || cell.includes('url') || cell.includes('link') || cell.includes('å°æ‡‰ç¶²ç«™')) h.url = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cell.includes('æ¬Šé™') || cell.includes('permission')) h.perm = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cell.includes('bsmi')) h.bsmi = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (cell.includes('ncc')) h.ncc = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if(h.model === -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ã€Œå‹è™Ÿã€æ¬„ä½ï¼Œç„¡æ³•é€²è¡ŒåŒæ­¥æ¯”å°ã€‚", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // Process Data
Â  Â  Â  Â  Â  Â  Â  Â  let excelModels = new Set();
Â  Â  Â  Â  Â  Â  Â  Â  let actions = [];
Â  Â  Â  Â  Â  Â  Â  Â  let stats = { add: 0, update: 0, remove: 0 };

Â  Â  Â  Â  Â  Â  Â  Â  // ğŸŒŸ Smart Check Helper
Â  Â  Â  Â  Â  Â  Â  Â  const hasVal = (v) => v !== undefined && v !== null && String(v).trim() !== "";

Â  Â  Â  Â  Â  Â  Â  Â  // 1. Identify Add & Update
Â  Â  Â  Â  Â  Â  Â  Â  jsonData.forEach((row) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rawModel = row[h.model];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!rawModel || String(rawModel).includes("å‹è™Ÿ")) return; // Skip empty or header

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const modelVal = String(rawModel).trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  excelModels.add(modelVal);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Build object - Only include if value exists!
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let obj = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.name !== -1 && hasVal(row[h.name])) obj.name = row[h.name];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.market !== -1 && hasVal(row[h.market])) obj.marketPrice = row[h.market];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.min !== -1 && hasVal(row[h.min])) obj.minPrice = row[h.min];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.groupBuy !== -1 && hasVal(row[h.groupBuy])) obj.groupBuyPrice = row[h.groupBuy];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.q50 !== -1 && hasVal(row[h.q50])) obj.quote50 = row[h.q50];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.q100 !== -1 && hasVal(row[h.q100])) obj.quote100 = row[h.q100];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.q300 !== -1 && hasVal(row[h.q300])) obj.quote300 = row[h.q300];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.q500 !== -1 && hasVal(row[h.q500])) obj.quote500 = row[h.q500];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.q1000 !== -1 && hasVal(row[h.q1000])) obj.quote1000 = row[h.q1000];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.cat !== -1 && hasVal(row[h.cat])) obj.category = row[h.cat];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.color !== -1 && hasVal(row[h.color])) obj.colorList = row[h.color];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.barcode !== -1 && hasVal(row[h.barcode])) obj.internationalBarcode = row[h.barcode];Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.box !== -1 && hasVal(row[h.box])) obj.cartonQty = row[h.box];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.url !== -1 && hasVal(row[h.url])) obj.productUrl = row[h.url];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.perm !== -1 && hasVal(row[h.perm])) obj.netSalesPermission = row[h.perm];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.bsmi !== -1 && hasVal(row[h.bsmi])) obj.bsmi = row[h.bsmi];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(h.ncc !== -1 && hasVal(row[h.ncc])) obj.ncc = row[h.ncc];

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  obj.model = modelVal;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  obj.mainModel = modelVal.split('-')[0]; // Simple heuristic

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const existing = productCache.find(p => p.model === modelVal);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(existing) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actions.push({ action: 'update', id: existing.id, data: obj, model: modelVal });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stats.update++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actions.push({ action: 'add', data: obj, model: modelVal });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stats.add++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // 2. Identify Remove (Items in DB but not in Excel)
Â  Â  Â  Â  Â  Â  Â  Â  productCache.forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If active in DB but NOT in Excel list -> Remove (Inactive)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(p.status !== 'inactive' && !excelModels.has(p.model)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actions.push({ action: 'remove', id: p.id, model: p.model, name: p.name });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  stats.remove++;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  pendingProductData = actions;

Â  Â  Â  Â  Â  Â  Â  Â  // Show Preview
Â  Â  Â  Â  Â  Â  Â  Â  previewHeader.textContent = "ç”¢å“ç¸½è¡¨åŒæ­¥é è¦½ (æ™ºæ…§åŒæ­¥)";
Â  Â  Â  Â  Â  Â  Â  Â  let tableHtml = `<div style="margin-bottom:10px; font-weight:bold;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  é è¨ˆè®Šæ›´ï¼š<span style="color:var(--success)">æ–°å¢ ${stats.add}</span> |Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color:var(--primary-blue)">æ™ºæ…§æ›´æ–° ${stats.update}</span> |Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span style="color:var(--danger)">ä¸‹æ¶ (Inactive) ${stats.remove}</span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom:10px; font-size:12px; color:#666;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  â„¹ï¸ ç³»çµ±å°‡è‡ªå‹•å¿½ç•¥ Excel ä¸­çš„ç©ºç™½æ¬„ä½ï¼Œä¿ç•™è³‡æ–™åº«åŸæœ‰æ•¸å€¼ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <table class="preview-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead><tr><th>å‹•ä½œ</th><th>å‹è™Ÿ</th><th>å“å</th><th>å‚™è¨»</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Show top 20 changes
Â  Â  Â  Â  Â  Â  Â  Â  actions.slice(0, 20).forEach(a => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let color = a.action === 'add' ? 'var(--success)' : (a.action === 'remove' ? 'var(--danger)' : 'var(--primary-blue)');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let label = a.action === 'add' ? 'æ–°å¢' : (a.action === 'remove' ? 'ä¸‹æ¶' : 'æ›´æ–°');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let name = a.data ? a.data.name : a.name;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tableHtml += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="color:${color};font-weight:bold;">${label}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${a.model}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${name || '-'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${a.action==='remove'?'éš±è—æ–¼å‰å°': (a.action==='update' ? 'æ›´æ–°æœ‰å¡«å¯«çš„æ¬„ä½' : 'å…¨æ–°å»ºç«‹')}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(actions.length > 20) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tableHtml += `<tr><td colspan="4" style="text-align:center;">... é‚„æœ‰ ${actions.length - 20} ç­†è®Šæ›´ ...</td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  tableHtml += `</tbody></table>`;
Â  Â  Â  Â  Â  Â  Â  Â  previewContent.innerHTML = tableHtml;
Â  Â  Â  Â  Â  Â  Â  Â  previewOverlay.style.display = "flex";

Â  Â  Â  Â  Â  Â  } catch(e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(e);
Â  Â  Â  Â  Â  Â  Â  Â  showToast("æª”æ¡ˆè®€å–å¤±æ•—", 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsBinaryString(file);
Â  Â  };
}

// ----------------------------------------------------
// INVENTORY IMPORT LOGIC
// ----------------------------------------------------
if(inventoryUpload) {
Â  Â  inventoryUpload.onchange = (e) => {
Â  Â  Â  Â  const file = e.target.files[0];
Â  Â  Â  Â  if(!file) return;
Â  Â  Â  Â  currentImportMode = 'inventory';

Â  Â  Â  Â  const reader = new FileReader();
Â  Â  Â  Â  reader.onload = (evt) => {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const data = evt.target.result;
Â  Â  Â  Â  Â  Â  Â  Â  const workbook = XLSX.read(data, { type: 'binary' });
Â  Â  Â  Â  Â  Â  Â  Â  const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
Â  Â  Â  Â  Â  Â  Â  Â  const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });Â 

Â  Â  Â  Â  Â  Â  Â  Â  // --- HEADER DETECTION ---
Â  Â  Â  Â  Â  Â  Â  Â  let barcodeIdx = -1;
Â  Â  Â  Â  Â  Â  Â  Â  let finishedIdx = -1;
Â  Â  Â  Â  Â  Â  Â  Â  let exclusiveIdx = -1;
Â  Â  Â  Â  Â  Â  Â  Â  let fallbackIdx = -1;

Â  Â  Â  Â  Â  Â  Â  Â  // Scan first 10 rows
Â  Â  Â  Â  Â  Â  Â  Â  for(let r=0; r<Math.min(jsonData.length, 10); r++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const row = jsonData[r];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  for(let c=0; c<row.length; c++) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const cell = String(row[c]).trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cell === "æ¢ç¢¼" || cell === "åœ‹éš›æ¢ç¢¼") barcodeIdx = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cell === "æˆå“å€‰") finishedIdx = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cell === "å°ˆè³£å€‰") exclusiveIdx = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(cell.includes("åº«å­˜") && cell.includes("å¯ç”¨é‡")) fallbackIdx = c;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (barcodeIdx === -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°ã€Œæ¢ç¢¼ã€æ¬„ä½ï¼Œè«‹æª¢æŸ¥ Excel æ ¼å¼ã€‚", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  pendingInventoryMap.clear();
Â  Â  Â  Â  Â  Â  Â  Â  let previewData = [];
Â  Â  Â  Â  Â  Â  Â  Â  let count = 0;

Â  Â  Â  Â  Â  Â  Â  Â  // --- DATA PARSING ---
Â  Â  Â  Â  Â  Â  Â  Â  jsonData.forEach((row, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(!row[barcodeIdx]) return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const rawBarcode = row[barcodeIdx];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(String(rawBarcode).includes("æ¢ç¢¼")) return;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let totalQty = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let finishedVal = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let exclusiveVal = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let source = "";

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(finishedIdx !== -1 && exclusiveIdx !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finishedVal = parseInt(row[finishedIdx], 10) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exclusiveVal = parseInt(row[exclusiveIdx], 10) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalQty = Math.floor((finishedVal + exclusiveVal) * 0.9);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  source = "æˆå“+å°ˆè³£";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  else if (fallbackIdx !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const fb = parseInt(row[fallbackIdx], 10) || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalQty = Math.floor(fb * 0.9);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  source = "åº«å­˜(å¯ç”¨é‡)";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const bc = String(rawBarcode).trim();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pendingInventoryMap.set(bc, totalQty);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count++;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Collect first 10 for preview
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if(previewData.length < 10) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Find product name for better context
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // ğŸŒŸ å„ªå…ˆä½¿ç”¨ internationalBarcode é€²è¡Œæ¯”å°ï¼Œä¿®å¾© "barcode mismatch" å•é¡Œ
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const matchedProduct = productCache.find(p => (p.internationalBarcode || p.barcode) == bc);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewData.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bc: bc,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: matchedProduct ? matchedProduct.name : "(ç„¡å°æ‡‰å•†å“)",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fin: finishedVal,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  exc: exclusiveVal,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rawTotal: (finishedVal + exclusiveVal),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  final: totalQty,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  src: source
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  if(count > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Show Preview Modal
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewHeader.textContent = "åº«å­˜åŒ¯å…¥é è¦½";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let tableHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-bottom:10px; font-size:12px; color:#666;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  âœ… æŠ“åˆ°æ¬„ä½ï¼š
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${barcodeIdx!==-1?`<span class="field-badge">æ¢ç¢¼</span>`:''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${finishedIdx!==-1?`<span class="field-badge">æˆå“å€‰</span>`:''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${exclusiveIdx!==-1?`<span class="field-badge">å°ˆè³£å€‰</span>`:''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${fallbackIdx!==-1?`<span class="field-badge">åº«å­˜(å¯ç”¨é‡)</span>`:''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="preview-table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>æ¢ç¢¼</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>å•†å“åç¨± (ç³»çµ±)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>æˆå“å€‰</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>å°ˆè³£å€‰</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>åŸå§‹ç¸½å’Œ</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="color:#2563eb;">å®‰å…¨åº«å­˜ (90%)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewData.forEach(row => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tableHtml += `<tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${row.bc}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${row.name}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${row.fin}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${row.exc}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${row.rawTotal}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="font-weight:bold; color:#2563eb;">${row.final}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tableHtml += `</tbody></table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div style="margin-top:10px; color:#666;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  å…±è§£æå‡º ${count} ç­†æœ‰æ•ˆè³‡æ–™ã€‚<br>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ç¢ºèªç„¡èª¤å¾Œï¼Œè«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å¯«å…¥è³‡æ–™åº«ã€‚
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewContent.innerHTML = tableHtml;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  previewOverlay.style.display = "flex";

Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast("æœªåœ¨æª”æ¡ˆä¸­æ‰¾åˆ°æœ‰æ•ˆçš„åº«å­˜æ•¸æ“šã€‚", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  } catch(err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  Â  Â  showToast("è®€å–æª”æ¡ˆå¤±æ•—ï¼Œè«‹ç¢ºèªæ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚", 'error');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  };
Â  Â  Â  Â  reader.readAsBinaryString(file);
Â  Â  };
}


if(pptToolbarBtn) {
Â  pptToolbarBtn.onclick = () => exportSelectedPPT('checked');
}
if(pptFromQuoteBtn) {
Â  pptFromQuoteBtn.onclick = () => exportSelectedPPT('quote');
}
if(downloadQuoteExcelBtn) {
Â  downloadQuoteExcelBtn.onclick = downloadQuoteExcel;
}
if(copyQuoteBtn) {
Â  copyQuoteBtn.onclick = () => {
Â  Â  if (quoteList.length === 0) return showToast("å ±åƒ¹å–®æ˜¯ç©ºçš„", 'error');
Â  Â  let text = "KINYO å ±åƒ¹å–®\n--------------------\n";
Â  Â  quoteList.forEach((q,i)=>{
Â  Â  Â  const priceDisplay = `$${q.price}`;
Â  Â  Â  const link = q.productUrl ? `Â  Â ğŸ”— é€£çµï¼š${q.productUrl}\n` : "";
Â  Â  Â  text += `${i+1}. ã€${q.model}ã€‘${q.name}\nÂ  Â ${q.qtyLabel}ï¼š${priceDisplay} x ${q.count}\n${link}`;
Â  Â  });
Â  Â  text += "--------------------\n";
Â  Â  navigator.clipboard.writeText(text)
Â  Â  Â  .then(() => showToast("å ±åƒ¹å–®å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿", 'success'))
Â  Â  Â  .catch(() => showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½", 'error'));
Â  };
}

if(clearBtn) {
Â  clearBtn.onclick = () => {
Â  Â  keywordInput.value = "";
Â  Â  qtySelect.value = "";
Â  Â  minPriceInput.value = "";
Â  Â  maxPriceInput.value = "";
Â  Â  stockFilter.value = "";
Â  Â  categorySelect.value = "";Â 

Â  Â  resultBody.innerHTML = "";
Â  Â  resultTable.style.display = "none";
Â  Â  exportBtn.disabled = true;
Â  Â  if(pptToolbarBtn) pptToolbarBtn.disabled = true;
Â  Â  if(multiLineBtn) multiLineBtn.disabled = true;
Â  Â  if(batchAddQuoteBtn) batchAddQuoteBtn.disabled = true;Â 
Â  Â  checkAllBox.checked = false;
Â  Â  detailCard.style.display = "none";
Â  Â  showToast("æœå°‹æ¢ä»¶å·²æ¸…é™¤", 'info');
Â  };
}

if(clearQuoteBtn) {
Â  clearQuoteBtn.onclick = () => {
Â  Â  if(quoteList.length === 0) {
Â  Â  Â  Â  showToast("å ±åƒ¹å–®å·²ç¶“æ˜¯ç©ºçš„", 'info');
Â  Â  Â  Â  return;
Â  Â  }
Â  Â  showConfirm("ç¢ºå®šè¦æ¸…ç©ºå ±åƒ¹å–®å—ï¼Ÿé€™å°‡ç„¡æ³•å¾©åŸã€‚", () => {
Â  Â  Â  Â  quoteList = [];
Â  Â  Â  Â  renderQuoteList();
Â  Â  Â  Â  updateQuoteToolbarBtn();
Â  Â  Â  Â  showToast("å ±åƒ¹å–®å·²æ¸…ç©º", 'success');
Â  Â  });
Â  };
}

// Login Button Click Logic
if(doLoginBtn) {
Â  doLoginBtn.onclick = async () => {
Â  Â  let email = loginEmail.value.trim();
Â  Â  const password = loginPassword.value.trim();
Â  Â Â 
Â  Â  if (email && !email.includes('@')) {
Â  Â  Â  Â  email += '@kinyo.com';
Â  Â  }

Â  Â  if(!email || !password) {
Â  Â  Â  loginError.textContent = "è«‹è¼¸å…¥å¸³è™Ÿå’Œå¯†ç¢¼";
Â  Â  Â  loginError.style.display = "block";
Â  Â  Â  return;
Â  Â  }

Â  Â  loginError.style.display = "none";
Â  Â  doLoginBtn.disabled = true;
Â  Â  doLoginBtn.textContent = "ç™»å…¥ä¸­...";

Â  Â  try {
Â  Â  Â  await signInWithEmailAndPassword(auth, email, password);
Â  Â  Â  showToast("ç™»å…¥æˆåŠŸï¼æ­£åœ¨è¼‰å…¥è³‡æ–™...", 'success');
Â  Â  } catch (error) {
Â  Â  Â  if (error.message && error.message.includes("message channel closed")) {
Â  Â  Â  Â  Â  console.warn("Ignored non-fatal auth error:", error);
Â  Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  console.error(error);
Â  Â  Â  loginError.textContent = "ç™»å…¥å¤±æ•—ï¼šè«‹æª¢æŸ¥å¸³è™Ÿå¯†ç¢¼";
Â  Â  Â  loginError.style.display = "block";
Â  Â  Â  doLoginBtn.disabled = false;
Â  Â  Â  doLoginBtn.textContent = "ç™»å…¥";
Â  Â  }
Â  };
}

/* =======================================================
Â  Â Firebase Authï¼šç™»å…¥å¾Œæµç¨‹
======================================================= */
onAuthStateChanged(auth, async (user) => {
Â  if (!user) {
Â  Â  if(loginOverlay) loginOverlay.style.display = "flex";
Â  Â  return;
Â  }
Â Â 
Â  if(loginOverlay) loginOverlay.style.display = "none";

Â  currentUserEmail = user.email || "";
Â  userLevel = 0;Â 

Â  try {
Â  Â  Â  const userDoc = await getDoc(doc(db, "Users", currentUserEmail.toLowerCase()));
Â  Â  Â  if (userDoc.exists()) {
Â  Â  Â  Â  Â  userLevel = userDoc.data().level ?? 0;
Â  Â  Â  } else {
Â  Â  Â  Â  Â  userLevel = 0;
Â  Â  Â  }
Â  } catch (e) {
Â  Â  Â  console.error("Auth Error:", e);
Â  Â  Â  userLevel = 0;
Â  }

Â  if (currentUserEmail.toLowerCase() === 'show@kinyo.com') userLevel = 0;

Â  updateUserDisplay('normal');
Â  logoutBtn.style.display = "inline-block";

Â  setupQtySelectByLevel();
Â Â 
Â  // ğŸš€ Trigger permissions update after level is loaded
Â  updatePermissions();

Â  await preloadDriveModelData();
Â  await preloadProducts(); // This also loads quote list on start
});

/* =======================================================
Â  Â Quote Button Listeners inside Module
======================================================= */
document.addEventListener("click", (e) => {
Â  if (e.target.classList.contains("add-quote-btn")) {
Â  Â  const model = e.target.getAttribute("data-model");
Â  Â  const itemÂ  = currentResultList.find(p => p.model === model);
Â  Â  if (!item) return;

Â  Â  const qty = qtySelect.value || "50";
Â  Â  const ckÂ  = `quote${qty}`;
Â  Â  const cost = item[ck] ?? item.quote50 ?? 0;

Â  Â  const existingIndex = quoteList.findIndex(q => q.model === item.model && q.qtyLabel === `${qty}å€‹`);
Â  Â Â 
Â  Â  if (existingIndex > -1) {
Â  Â  Â  Â  quoteList[existingIndex].count += 1;
Â  Â  Â  Â  showToast(`å·²æ›´æ–°å ±åƒ¹å–®ï¼š${item.name} (æ•¸é‡: ${quoteList[existingIndex].count})`, 'info');
Â  Â  } else {
Â  Â  Â  Â  quoteList.push({
Â  Â  Â  Â  Â  model: item.model,
Â  Â  Â  Â  Â  name: item.name,
Â  Â  Â  Â  Â  price: cost,
Â  Â  Â  Â  Â  qtyLabel: `${qty}å€‹`,
Â  Â  Â  Â  Â  count: 1,
Â  Â  Â  Â  Â  productUrl: item.productUrl || ""
Â  Â  Â  Â  });
Â  Â  Â  Â  showToast(`å·²åŠ å…¥å ±åƒ¹å–®ï¼ˆ${qty}å€‹ï¼š$${cost}ï¼‰`, 'success');
Â  Â  }
Â  Â  saveQuoteList();
Â  Â  updateQuoteToolbarBtn();
Â  Â  return;
Â  }

Â  if (e.target.classList.contains("line-share-btn")) {
Â  Â  const model = e.target.getAttribute("data-model");
Â  Â  const itemÂ  = currentResultList.find(p => p.model === model);
Â  Â  if (!item) return;

Â  Â  const showMinPrice = userLevel >= 1;
Â  Â  const getPrice = (p) => (item[p] ?? "-");

Â  Â  let costText = "";
Â  Â  const currentQty = qtySelect.value;Â 

Â  Â  if (currentQty) {
Â  Â  Â  Â  const k = `quote${currentQty}`;
Â  Â  Â  Â  let canSee = false;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (userLevel >= 1 && currentQty == 50) canSee = true;
Â  Â  Â  Â  if (userLevel >= 2 && (currentQty == 100 || currentQty == 300)) canSee = true;
Â  Â  Â  Â  if (userLevel >= 3 && (currentQty == 500 || currentQty == 1000)) canSee = true;
Â  Â  Â  Â Â 
Â  Â  Â  Â  if(canSee) {
Â  Â  Â  Â  Â  Â  Â  costText += `${currentQty}å€‹ï¼š$${getPrice(k)}\n`;
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  costText += `${currentQty}å€‹ï¼š(ç„¡æ¬Šé™)\n`;
Â  Â  Â  Â  }
Â  Â  } else {
Â  Â  Â  Â  if (userLevel >= 1) costText += `50å€‹ï¼š$${getPrice('quote50')}\n`;
Â  Â  Â  Â  if (userLevel >= 2) costText += `100å€‹ï¼š$${getPrice('quote100')}\n300å€‹ï¼š$${getPrice('quote300')}\n`;
Â  Â  Â  Â  if (userLevel >= 3) costText += `500å€‹ï¼š$${getPrice('quote500')}\n1000å€‹ï¼š$${getPrice('quote1000')}\n`;
Â  Â  }

Â  Â  const text = `ã€${item.model}ã€‘${item.name}
è³£å ´å”®åƒ¹ï¼š$${getPrice('marketPrice')}
æœ«å”®åƒ¹æ ¼ï¼š$${showMinPrice ? getPrice('minPrice') : '---'}
--------------------
æ¡è³¼åƒ¹æ ¼ï¼š
${costText}
å•†å“é€£çµï¼š${item.productUrl || "ç„¡"}`;

Â  Â  navigator.clipboard.writeText(text)
Â  Â  Â  .then(() => showToast("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿", 'success'))
Â  Â  Â  .catch(() => showToast("è¤‡è£½å¤±æ•—", 'error'));
Â  }

Â  const card = document.getElementById("detailCard");
Â  if (card && card.style.display !== "none") {
Â  Â  if (!card.contains(e.target) && !e.target.closest("tr")) {
Â  Â  Â  card.style.display = "none";
Â  Â  }
Â  }

Â  if(card && !card.hasAttribute("data-listeners-added")){
Â  Â  Â  card.setAttribute("data-listeners-added", "true");
Â  Â  Â  card.addEventListener("mouseenter", () => {
Â  Â  Â  Â  if (window.hideDetailTimer) clearTimeout(window.hideDetailTimer);
Â  Â  Â  });
Â  Â  Â  card.addEventListener("mouseleave", () => {
Â  Â  Â  Â  window.hideDetailTimer = setTimeout(() => {
Â  Â  Â  Â  Â  card.style.display = "none";
Â  Â  Â  Â  }, 200);
Â  Â  Â  });
Â  }
});

if (batchAddQuoteBtn) {
Â  Â  batchAddQuoteBtn.onclick = () => {
Â  Â  Â  Â  const checked = document.querySelectorAll(".row-check:checked");
Â  Â  Â  Â  if (checked.length === 0) {
Â  Â  Â  Â  Â  Â  showToast("è«‹å…ˆå‹¾é¸è¦åŠ å…¥å€™é¸æ¸…å–®çš„å•†å“", 'error');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const qty = qtySelect.value || "50";
Â  Â  Â  Â  let addedCount = 0;

Â  Â  Â  Â  Array.from(checked).forEach(c => {
Â  Â  Â  Â  Â  Â  const model = c.getAttribute("data-model");
Â  Â  Â  Â  Â  Â  const item = currentResultList.find(p => p.model === model);
Â  Â  Â  Â  Â  Â  if (!item) return;

Â  Â  Â  Â  Â  Â  const ck = `quote${qty}`;
Â  Â  Â  Â  Â  Â  const cost = item[ck] ?? item.quote50 ?? 0;
Â  Â  Â  Â  Â  Â  const qtyLabel = `${qty}å€‹`;

Â  Â  Â  Â  Â  Â  const existingIndex = quoteList.findIndex(q => q.model === item.model && q.qtyLabel === qtyLabel);

Â  Â  Â  Â  Â  Â  if (existingIndex > -1) {
Â  Â  Â  Â  Â  Â  Â  Â  quoteList[existingIndex].count += 1;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  quoteList.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  model: item.model,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: item.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  price: cost,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  qtyLabel: qtyLabel,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  count: 1,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  productUrl: item.productUrl || ""
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  addedCount++;
Â  Â  Â  Â  });

Â  Â  Â  Â  saveQuoteList();
Â  Â  Â  Â  updateQuoteToolbarBtn();
Â  Â  Â  Â  showToast(`å·²æˆåŠŸå°‡ ${addedCount} é …å•†å“åŠ å…¥å ±åƒ¹å–®ï¼`, 'success');
Â  Â  };
}

if (multiLineBtn) {
Â  Â  multiLineBtn.onclick = () => {
Â  Â  Â  Â  const checked = document.querySelectorAll(".row-check:checked");
Â  Â  Â  Â  if (checked.length === 0) {
Â  Â  Â  Â  Â  Â  showToast("è«‹å…ˆå‹¾é¸è¦åˆ†äº«çš„å•†å“", 'error');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  const qty = qtySelect.value || "50";
Â  Â  Â  Â  let text = `KINYO å¤šå“é …å ±åƒ¹ï¼ˆèµ·è¨‚é‡ï¼š${qty}å€‹ï¼‰\n--------------------\n`;

Â  Â  Â  Â  Array.from(checked).forEach((c, i) => {
Â  Â  Â  Â  Â  Â  const model = c.getAttribute("data-model");
Â  Â  Â  Â  Â  Â  const item = currentResultList.find(p => p.model === model);
Â  Â  Â  Â  Â  Â  if (!item) return;

Â  Â  Â  Â  Â  Â  const ck = `quote${qty}`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let canSeeQuote = false;
Â  Â  Â  Â  Â  Â  if (userLevel >= 1 && qty == 50) canSeeQuote = true;
Â  Â  Â  Â  Â  Â  if (userLevel >= 2 && (qty == 100 || qty == 300)) canSeeQuote = true;
Â  Â  Â  Â  Â  Â  if (userLevel >= 3 && (qty == 500 || qty == 1000)) canSeeQuote = true;

Â  Â  Â  Â  Â  Â  const cost = canSeeQuote ? (item[ck] ?? item.quote50 ?? "-") : "---";
Â  Â  Â  Â  Â  Â  const market = item.marketPrice ?? "-";
Â  Â  Â  Â  Â  Â  const link = item.productUrl || "ç„¡é€£çµ";

Â  Â  Â  Â  Â  Â  text += `${i + 1}. ã€${item.model}ã€‘${item.name}\n`;
Â  Â  Â  Â  Â  Â  text += `Â  Â ğŸ’° ${qty}å€‹å ±åƒ¹ï¼š$${cost}\n`;
Â  Â  Â  Â  Â  Â  text += `Â  Â ğŸ›’ è³£å ´å”®åƒ¹ï¼š$${market}\n`;
Â  Â  Â  Â  Â  Â  text += `Â  Â ğŸ”— å•†å“é€£çµï¼š${link}\n\n`;
Â  Â  Â  Â  });

Â  Â  Â  Â  text += "--------------------\n";
Â  Â  Â  Â  text += "ä»¥ä¸Šå ±åƒ¹åƒ…ä¾›åƒè€ƒï¼Œå¯¦éš›ä»¥æœ€çµ‚ç¢ºèªç‚ºä¸»ã€‚";

Â  Â  Â  Â  navigator.clipboard.writeText(text)
Â  Â  Â  Â  Â  Â  .then(() => showToast(`å·²è¤‡è£½ ${checked.length} é …å•†å“çš„å ±åƒ¹è³‡è¨Šï¼è«‹ç›´æ¥åœ¨ LINE è²¼ä¸Šã€‚`, 'success'))
Â  Â  Â  Â  Â  Â  .catch(() => showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½ã€‚", 'error'));
Â  Â  };
}

if(sortSelect) {
Â  sortSelect.onchange = () => {
Â  Â  if (currentResultList.length > 0) {
Â  Â  Â  currentResultList = applySorting([...currentResultList]);
Â  Â  Â  renderResults(currentResultList);
Â  Â  }
Â  };
}

if(sheetCloseBtn) sheetCloseBtn.onclick = closeSheet;
if(quoteCloseBtn) quoteCloseBtn.onclick = closeQuoteSheet;

if(sheetBackdrop) {
Â  sheetBackdrop.onclick = () => {
Â  Â  if (!mobileSheet.classList.contains("hidden")) closeSheet();
Â  Â  if (!quoteSheet.classList.contains("hidden")) closeQuoteSheet();
Â  };
}

window.addEventListener('scroll', updateToolbarScrollState);

if(quoteToolbarBtn) quoteToolbarBtn.onclick = openQuoteSheet;

</script>
</body>
</html>
