<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>KINYO 商品查價系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 920px;
      margin: 40px auto;
      padding: 0 16px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }
    .search-box {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.08);
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
    }
    label {
      font-weight: 600;
    }
    input {
      flex: 1;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 14px;
    }
    button {
      padding: 8px 18px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.5;
      cursor: default;
    }
    .card {
      margin-top: 20px;
      background: #fff;
      padding: 18px;
      border-radius: 10px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.08);
    }
    .row {
      margin-bottom: 8px;
      font-size: 15px;
    }
    .label {
      font-weight: 600;
      display: inline-block;
      width: 160px;
    }
    a {
      color: #2563eb;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 14px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: #f3f4f6;
      font-weight: 600;
    }
    tr:hover {
      background: #f9fafb;
      cursor: pointer;
    }
    .hint {
      font-size: 12px;
      color: #888;
      margin-top: 6px;
    }
  </style>
</head>
<body>
  <h1>KINYO 商品查價系統</h1>
  <div class="subtitle">
    輸入商品型號，可支援模糊查詢（前綴）。例如輸入「AWP」會列出所有 AWP 開頭的商品。
  </div>

  <div class="search-box">
    <label for="modelInput">商品型號：</label>
    <input id="modelInput" placeholder="例如：AWP5712 或 AWP" />
    <button id="searchBtn">查詢</button>
  </div>

  <div id="loading" class="card" style="display:none;">查詢中，請稍候…</div>
  <div id="noResult" class="card" style="display:none;">查無此型號，請確認輸入是否正確。</div>

  <!-- 多筆結果列表 -->
  <div id="list" class="card" style="display:none;">
    <div>
      找到 <span id="list-count"></span> 筆商品：
    </div>
    <table>
      <thead>
        <tr>
          <th>商品型號</th>
          <th>商品名稱</th>
          <th>團購(直播)售價</th>
          <th>末售價格</th>
          <th>賣場價格</th>
        </tr>
      </thead>
      <tbody id="list-body"></tbody>
    </table>
    <div class="hint">提示：點選任一列，即可在下方顯示完整詳細資訊。</div>
  </div>

  <!-- 單筆詳細資料 -->
  <div id="result" class="card" style="display:none;">
    <h2 id="r-name"></h2>

    <div class="row"><span class="label">商品型號：</span><span id="r-model"></span></div>
    <div class="row"><span class="label">商品名稱：</span><span id="r-name2"></span></div>
    <div class="row"><span class="label">國際條碼：</span><span id="r-barcode"></span></div>
    <div class="row"><span class="label">箱入數：</span><span id="r-cartonQty"></span></div>

    <div class="row"><span class="label">團購(直播)售價：</span><span id="r-groupPriceLive"></span></div>
    <div class="row"><span class="label">末售價格：</span><span id="r-minPrice"></span></div>
    <div class="row"><span class="label">賣場價格：</span><span id="r-marketPrice"></span></div>

    <div class="row"><span class="label">採購100個報價：</span><span id="r-quote100"></span></div>
    <div class="row"><span class="label">採購300個報價：</span><span id="r-quote300"></span></div>
    <div class="row"><span class="label">採購500個報價：</span><span id="r-quote500"></span></div>

    <div class="row"><span class="label">BSMI：</span><span id="r-bsmi"></span></div>
    <div class="row"><span class="label">NCC：</span><span id="r-ncc"></span></div>

    <div class="row">
      <span class="label">官方商品頁：</span>
      <a id="r-url" href="#" target="_blank">點我前往</a>
    </div>
  </div>

  <script type="module">
    // 你的 Firebase 設定
    const firebaseConfig = {
      apiKey: "AIzaSyDtp6rwV7KmIOedLQ9793BnXbBquopP9kM",
      authDomain: "kinyo-price.firebaseapp.com",
      projectId: "kinyo-price",
      storageBucket: "kinyo-price.firebasestorage.app",
      messagingSenderId: "122464645678",
      appId: "1:122464645678:web:c0febbc6297a8ada5ea5bf",
      measurementId: "G-R0PWMZNSJH"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import {
      getFirestore,
      collection,
      query,
      where,
      getDocs
    } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const modelInput = document.getElementById("modelInput");
    const searchBtn = document.getElementById("searchBtn");

    const resultCard = document.getElementById("result");
    const noResultCard = document.getElementById("noResult");
    const loadingCard = document.getElementById("loading");
    const listCard = document.getElementById("list");
    const listCount = document.getElementById("list-count");
    const listBody = document.getElementById("list-body");

    const rName = document.getElementById("r-name");
    const rName2 = document.getElementById("r-name2");
    const rModel = document.getElementById("r-model");
    const rBarcode = document.getElementById("r-barcode");
    const rCartonQty = document.getElementById("r-cartonQty");
    const rGroupPriceLive = document.getElementById("r-groupPriceLive");
    const rMinPrice = document.getElementById("r-minPrice");
    const rMarketPrice = document.getElementById("r-marketPrice");
    const rQuote100 = document.getElementById("r-quote100");
    const rQuote300 = document.getElementById("r-quote300");
    const rQuote500 = document.getElementById("r-quote500");
    const rBsmi = document.getElementById("r-bsmi");
    const rNcc = document.getElementById("r-ncc");
    const rUrl = document.getElementById("r-url");

    function showLoading(show) {
      loadingCard.style.display = show ? "block" : "none";
      searchBtn.disabled = show;
    }

    function showDetail(data) {
      if (!data) {
        resultCard.style.display = "none";
        return;
      }

      rName.textContent = data.name ?? "";
      rName2.textContent = data.name ?? "";
      rModel.textContent = data.model ?? "";
      rBarcode.textContent = data.barcode ?? "";
      rCartonQty.textContent = data.cartonQty ?? "";

      rGroupPriceLive.textContent = data.groupPriceLive ?? "";
      rMinPrice.textContent = data.minPrice ?? "";
      rMarketPrice.textContent = data.marketPrice ?? "";

      rQuote100.textContent = data.quote100 ?? "";
      rQuote300.textContent = data.quote300 ?? "";
      rQuote500.textContent = data.quote500 ?? "";

      rBsmi.textContent = data.bsmi ?? "";
      rNcc.textContent = data.ncc ?? "";

      if (data.productUrl) {
        rUrl.href = data.productUrl;
        rUrl.style.pointerEvents = "auto";
        rUrl.style.opacity = "1";
      } else {
        rUrl.href = "#";
        rUrl.style.pointerEvents = "none";
        rUrl.style.opacity = "0.5";
      }

      resultCard.style.display = "block";
    }

    async function search() {
      let model = modelInput.value.trim();
      if (!model) return;

      model = model.toUpperCase();

      resultCard.style.display = "none";
      noResultCard.style.display = "none";
      listCard.style.display = "none";
      listBody.innerHTML = "";
      showLoading(true);

      try {
        // 一律用前綴模糊搜尋 searchKey
        const q = query(
          collection(db, "Products"),
          where("searchKey", ">=", model),
          where("searchKey", "<=", model + "\uf8ff")
        );

        const qsnap = await getDocs(q);

        if (qsnap.empty) {
          noResultCard.style.display = "block";
          return;
        }

        const results = [];
        qsnap.forEach((docSnap) => {
          results.push(docSnap.data());
        });

        // 如果只有一筆，直接顯示詳細
        if (results.length === 1) {
          listCard.style.display = "none";
          showDetail(results[0]);
          return;
        }

        // 多筆 → 列出列表，並預設顯示第一筆詳細
        listCount.textContent = results.length;
        results.forEach((item) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.model ?? ""}</td>
            <td>${item.name ?? ""}</td>
            <td>${item.groupPriceLive ?? ""}</td>
            <td>${item.minPrice ?? ""}</td>
            <td>${item.marketPrice ?? ""}</td>
          `;
          tr.addEventListener("click", () => {
            showDetail(item);
          });
          listBody.appendChild(tr);
        });

        listCard.style.display = "block";
        showDetail(results[0]);
      } catch (err) {
        console.error(err);
        noResultCard.style.display = "block";
      } finally {
        showLoading(false);
      }
    }

    searchBtn.addEventListener("click", search);
    modelInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") search();
    });
  </script>
</body>
</html>
