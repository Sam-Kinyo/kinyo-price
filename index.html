<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>KINYO 查價系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 0 16px;
      background: #f5f5f5;
    }
    h1 { margin-bottom: 4px; }
    .subtitle { color: #666; margin-bottom: 20px; }

    .search-box {
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      margin-bottom: 20px;
    }

    .search-row { margin-bottom: 10px; }
    label { font-weight: 600; }
    input, select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }

    button {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: white;
      font-weight: 600;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }
    th, td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }
    tr:hover { background: #f1f5f9; cursor: pointer; }

    .price-tag {
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 6px;
      margin-right: 6px;
      display: inline-block;
    }

    #detailCard {
      display:none;
      background:white;
      padding:20px;
      border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
      margin-top:20px;
    }
  </style>
</head>
<body>

<h1>KINYO 查價系統</h1>
<div class="subtitle">輸入商品型號或名稱，或設定採購量與預算區間查詢。</div>

<div class="search-box">

  <div class="search-row">
    <label>關鍵字搜尋（型號 / 名稱）：</label>
    <input id="keyword" placeholder="如：CL528 / 除毛球機" />
  </div>

  <div class="search-row">
    <label>選擇起訂量：</label>
    <select id="qtySelect">
      <option value="">不使用起訂量</option>
      <option value="100">100 個</option>
      <option value="300">300 個</option>
      <option value="500">500 個</option>
    </select>
  </div>

  <div class="search-row">
    <label>預算區間：</label>
    <div style="display:flex; gap:6px;">
      <input id="minPrice" type="number" placeholder="最低金額" />
      <input id="maxPrice" type="number" placeholder="最高金額" />
    </div>
  </div>

  <button id="searchBtn">查詢</button>
</div>


<table id="resultTable" style="display:none;">
  <thead>
    <tr>
      <th style="width:100px;">型號</th>
      <th>商品資訊</th>
      <th>末售</th>
      <th>賣場</th>
    </tr>
  </thead>
  <tbody id="resultBody"></tbody>
</table>

<div id="detailCard"></div>


<!-- Firebase -->
<script type="module">
  const firebaseConfig = {
    apiKey: "AIzaSyDtp6rwV7KmIOedLQ9793BnXbBquopP9kM",
    authDomain: "kinyo-price.firebaseapp.com",
    projectId: "kinyo-price",
    storageBucket: "kinyo-price.firebasestorage.app",
    messagingSenderId: "122464645678",
    appId: "1:122464645678:web:c0febbc6297a8ada5ea5bf",
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);


  // ======= 搜尋功能 =======
  async function searchProducts() {
    const kw = document.getElementById("keyword").value.trim().toLowerCase();
    const qty = document.getElementById("qtySelect").value;
    const minP = document.getElementById("minPrice").value;
    const maxP = document.getElementById("maxPrice").value;

    // 檢查：如果有選起訂量 → 必須完整價格區間
    if (qty && (!minP || !maxP)) {
      alert("使用起訂量搜尋時，請輸入完整的價格範圍。");
      return;
    }

    if (minP && maxP && Number(maxP) < Number(minP)) {
      alert("最高金額必須大於最低金額。");
      return;
    }

    const snap = await getDocs(collection(db, "Products"));
    let list = [];

    snap.forEach(doc => list.push(doc.data()));

    // 關鍵字搜尋（型號 or 名稱）
    if (kw) {
      list = list.filter(item =>
        (item.model && item.model.toLowerCase().includes(kw)) ||
        (item.name && item.name.toLowerCase().includes(kw))
      );
    }

    // 起訂量價格搜尋
    if (qty && minP && maxP) {
      const field = qty === "100" ? "quote100" :
                    qty === "300" ? "quote300" : "quote500";

      list = list.filter(item =>
        item[field] >= Number(minP) && item[field] <= Number(maxP)
      );
    }

    renderResults(list);
  }


  // ======= 渲染搜尋結果 =======
  function renderResults(list) {
    const table = document.getElementById("resultTable");
    const body = document.getElementById("resultBody");

    body.innerHTML = "";
    if (list.length === 0) {
      table.style.display = "none";
      alert("查無符合商品");
      return;
    }

    table.style.display = "table";

    list.forEach(item => {
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${item.model}</td>

        <td>
          <div style="font-weight:600; margin-bottom:4px;">${item.name}</div>

          <div style="font-size:13px; line-height:1.6;">

            <span class="price-tag" style="background:#dbeafe;">
              100：
              <span style="color:#2563eb; font-weight:600;">
                ${item.quote100 ? item.quote100 + " 元" : "-"}
              </span>
            </span>

            <span class="price-tag" style="background:#dcfce7;">
              300：
              <span style="color:#16a34a; font-weight:600;">
                ${item.quote300 ? item.quote300 + " 元" : "-"}
              </span>
            </span>

            <span class="price-tag" style="background:#ffedd5;">
              500：
              <span style="color:#ea580c; font-weight:600;">
                ${item.quote500 ? item.quote500 + " 元" : "-"}
              </span>
            </span>

          </div>
        </td>

        <td style="text-align:right;">
          ${item.minPrice ? item.minPrice + " 元" : "-"}
        </td>

        <td style="text-align:right;">
          ${item.marketPrice ? item.marketPrice + " 元" : "-"}
        </td>
      `;

      tr.onclick = () => showDetail(item);

      body.appendChild(tr);
    });
  }


  // ======= 詳細資料卡 =======
  function showDetail(item) {
    const card = document.getElementById("detailCard");
    card.style.display = "block";

    card.innerHTML = `
      <h2>${item.name}</h2>
      <p>型號：${item.model}</p>
      <p>國際條碼：${item.barcode}</p>
      <p>箱入數：${item.cartonQty}</p>
      <p>末售價格：${item.minPrice} 元</p>
      <p>賣場售價：${item.marketPrice} 元</p>
      <p>100 個：${item.quote100} 元</p>
      <p>300 個：${item.quote300} 元</p>
      <p>500 個：${item.quote500} 元</p>
      <p><a href="${item.productUrl}" target="_blank">官方商品頁</a></p>
    `;
  }

  document.getElementById("searchBtn").onclick = searchProducts;
</script>

</body>
</html>
