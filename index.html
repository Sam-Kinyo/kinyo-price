<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>KINYO æŸ¥åƒ¹ç³»çµ±ï¼ˆv4.8.0 â€” GDrive æ•´åˆç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* =========================================
   Root è®Šæ•¸
========================================= */
:root{
  --bg:#f5f6f8;
  --card:#ffffff;
  --primary:#111827;
  --border:#e5e7eb;
  --text:#1f2937;
  --muted:#6b7280;
  --radius:12px;
  --shadow:0 4px 12px rgba(0,0,0,0.06);

  --loading-bg:#e5e7eb;
  --loading-fill:#3b82f6;
}

/* =========================================
   Body
========================================= */
body{
  margin:0;
  padding:24px;
  background:var(--bg);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--text);
  max-width:980px;
  margin:0 auto;
}

h1{margin:0 0 4px;}
.subtitle{
  color:var(--muted);
  margin-bottom:18px;
  font-size:14px;
}

/* =========================================
   Top Bar
========================================= */
.top-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:14px;
}
.user-badge{
  background:#eef0f4;
  padding:6px 14px;
  border-radius:999px;
  font-size:13px;
}
.logout-btn{
  padding:6px 14px;
  border-radius:999px;
  border:1px solid var(--border);
  cursor:pointer;
  background:white;
  font-size:12px;
}

/* =========================================
   Toolbarï¼ˆæ’åº/åŒ¯å‡º/å ±åƒ¹å–®ï¼‰
========================================= */
.toolbar{
  display:flex;
  gap:10px;
  align-items:center;
  margin:10px 0 6px;
}
.toolbar select{ flex:1; }

/* å ±åƒ¹å–®æŒ‰éˆ• */
.quote-toolbar-btn{
  padding:10px 16px;
  border-radius:999px;
  border:1px solid var(--border);
  background:white;
  cursor:pointer;
  font-size:14px;
  white-space:nowrap;
  display:none;
}

/* =========================================
   æœå°‹å€å¡Š
========================================= */
.search-box{
  background:var(--card);
  padding:18px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  margin-bottom:12px;
}
.search-row{margin-bottom:14px;}
label{
  font-weight:600;
  margin-bottom:6px;
  display:block;
  font-size:14px;
}
input,select{
  width:100%;
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:15px;
  box-sizing:border-box;
}

/* =========================================
   Buttons
========================================= */
.btn-primary{
  background:var(--primary);
  color:white;
  border:none;
  border-radius:999px;
  padding:12px 20px;
  font-weight:600;
  cursor:pointer;
  width:100%;
}
.btn-secondary{
  background:white;
  border:1px solid var(--border);
  padding:10px 16px;
  border-radius:999px;
  cursor:pointer;
  font-size:14px;
  white-space:nowrap;
}
.btn-outline-add{
  padding:6px 12px;
  border-radius:6px;
  border:1px solid #2563eb;
  background:#eff6ff;
  color:#2563eb;
  font-size:12px;
  cursor:pointer;
  font-weight:600;
}
.btn-outline-add:hover{background:#dbeafe;}

/* =========================================
   è¡¨æ ¼
========================================= */
table{
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:var(--shadow);
}
th,td{
  padding:12px 10px;
  border-bottom:1px solid var(--border);
  font-size:14px;
  vertical-align:top;
}
th{background:#fafafa;text-align:left;}

.product-img{
  width:110px;height:110px;
  object-fit:cover;
  border-radius:8px;
  border:1px solid #e5e7eb;
  background:#fff;
}

.price-tag{
  padding:3px 8px;
  font-size:12px;
  border-radius:6px;
  display:inline-block;
  margin-right:6px;
  margin-bottom:4px;
  font-weight:600;
  white-space:nowrap;
}
.tag50 { background:#dbeafe;color:#1e40af; }
.tag100{ background:#e0f2fe;color:#0369a1; }
.tag300{ background:#dcfce7;color:#15803d; }
.tag500{ background:#ffedd5;color:#ea580c; }
.tag1000{ background:#fee2e2;color:#b91c1c; }

/* loading */
#centerLoadingBox{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.35);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
#centerLoadingCard{
  background:white;
  width:280px;
  padding:20px;
  border-radius:12px;
  text-align:center;
  box-shadow:var(--shadow);
}
.loading-title{ font-size:15px;font-weight:700;margin-bottom:12px; }
.loading-bar{ width:100%;height:10px;background:var(--loading-bg);border-radius:6px;overflow:hidden; }
.loading-bar .fill{ height:100%;width:0%;background:var(--loading-fill);transition:width .15s linear; }
</style>
</head>
<body>

<!-- loading  -->
<div id="centerLoadingBox">
  <div id="centerLoadingCard">
    <div class="loading-title">å•†å“è¼‰å…¥ä¸­...</div>
    <div id="centerLoadingBar" class="loading-bar">
      <div class="fill"></div>
    </div>
  </div>
</div>

<div class="top-bar">
  <span id="userInfo" class="user-badge">æœªç™»å…¥</span>
  <button id="logoutBtn" class="logout-btn" style="display:none;">ç™»å‡º</button>
</div>

<h1>KINYO æŸ¥åƒ¹ç³»çµ±</h1>
<div class="subtitle">
  éƒ­åº­è±ªå˜”å¿ƒç€è¡€ä¹‹ä½œï¼ˆv4.8.0 â€” Google Drive æ•´åˆç‰ˆï¼‰
</div>

<!-- æœå°‹å€ -->
<form id="searchForm" class="search-box">
  <div class="search-row">
    <label>é—œéµå­—æœå°‹ï¼ˆå‹è™Ÿ / åç¨±ï¼‰</label>
    <input id="keyword" placeholder="å¦‚ï¼šCL528 / æ•èšŠç‡ˆ / é™¤æ¯›çƒæ©Ÿ" autocomplete="off" />
  </div>

  <div class="search-row">
    <label>èµ·è¨‚é‡ï¼ˆå¯ä¸é¸ï¼‰</label>
    <select id="qtySelect"></select>
  </div>

  <div class="search-row">
    <label>é ç®—å€é–“ï¼ˆèµ·è¨‚é‡å·²é¸æ™‚æ‰ç”Ÿæ•ˆï¼›å¯åªå¡«ä¸€é‚Šï¼‰</label>
    <div style="display:flex; gap:10px;">
      <input id="minPrice" type="number" placeholder="æœ€ä½ (å¯ç©º)">
      <input id="maxPrice" type="number" placeholder="æœ€é«˜ (å¯ç©º)">
    </div>
  </div>

  <button id="searchBtn" type="submit" class="btn-primary">æŸ¥è©¢</button>
  <button id="clearBtn" type="button" class="btn-secondary" style="margin-top:10px;width:100%;">æ¸…é™¤æœå°‹æ¢ä»¶</button>
</form>

<div class="toolbar">
  <select id="sortSelect" class="btn-secondary">
    <option value="">ä¸æ’åº</option>
    <option value="minPriceAsc">æœ«å”®ï¼šä½ â†’ é«˜</option>
    <option value="minPriceDesc">æœ«å”®ï¼šé«˜ â†’ ä½</option>
    <option value="marketAsc">è³£å ´ï¼šä½ â†’ é«˜</option>
    <option value="marketDesc">è³£å ´ï¼šé«˜ â†’ ä½</option>
    <option value="alphaAsc">ä¸»å‹è™Ÿï¼šA â†’ Z</option>
    <option value="alphaDesc">ä¸»å‹è™Ÿï¼šZ â†’ A</option>
  </select>

  <button id="exportBtn" class="btn-secondary" disabled>åŒ¯å‡º Excel</button>
  <button id="quoteToolbarBtn" class="quote-toolbar-btn">å ±åƒ¹å–®</button>
</div>

<table id="resultTable" style="display:none;">
  <thead>
    <tr>
      <th style="width:32px;"><input type="checkbox" id="checkAll" /></th>
      <th style="width:120px;">åœ–ç‰‡</th>
      <th style="width:100px;">ä¸»å‹è™Ÿ</th>
      <th>å•†å“è³‡è¨Š</th>
      <th style="width:80px;">æœ«å”®</th>
      <th style="width:80px;">è³£å ´</th>
    </tr>
  </thead>
  <tbody id="resultBody"></tbody>
</table>

<div id="detailCard"></div>

<!-- æ‰‹æ©Ÿç‰ˆ Sheet -->
<div id="sheetBackdrop" class="sheet-backdrop hidden"></div>
<div id="mobileDetailSheet" class="sheet hidden">
  <div class="sheet-header">
    <span>å•†å“è³‡è¨Š</span>
    <button id="sheetCloseBtn" class="sheet-close">Ã—</button>
  </div>
  <div class="sheet-content" id="sheetContent"></div>
</div>

<!-- å ±åƒ¹å–® Sheet -->
<div id="quoteSheet" class="sheet hidden">
  <div class="sheet-header">
    <span>å ±åƒ¹å–®é è¦½</span>
    <button id="quoteCloseBtn" class="sheet-close">Ã—</button>
  </div>
  <div class="sheet-content" style="display:flex;flex-direction:column;">
    <div id="quoteListBody" style="flex:1;overflow-y:auto;"></div>
    <div style="border-top:1px solid #eee; padding-top:12px; margin-top:10px;">
      <button id="copyQuoteBtn" class="btn-primary" style="width:100%;">è¤‡è£½æ•´å¼µå ±åƒ¹å–® (LINE)</button>
      <button id="downloadQuoteExcelBtn" class="btn-secondary" style="width:100%;margin-top:8px;">ä¸‹è¼‰ Excel å ±åƒ¹å–®</button>
      <button id="clearQuoteBtn" class="btn-secondary" style="width:100%;margin-top:8px;color:#ef4444;border-color:#ef4444;">æ¸…ç©ºå ±åƒ¹å–®</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
/* =======================================================
   Firebase åˆå§‹åŒ–
======================================================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtp6rwV7KmIOedLQ9793BnXbBquopP9kM",
  authDomain: "kinyo-price.firebaseapp.com",
  projectId: "kinyo-price",
  storageBucket: "kinyo-price.appspot.com",
  messagingSenderId: "122464645678",
  appId: "1:122464645678:web:c0febbc6297a8ada5ea5bf"
};

const app  = initializeApp(firebaseConfig);
const db   = getFirestore(app);
const auth = getAuth(app);

/* =======================================================
   Google Drive modelData.json è¼‰å…¥
======================================================= */
let modelData = {};  // <<<<<< é‡è¦ï¼šGoogle Drive è³‡æ–™

async function loadModelData() {
  try {
    const res = await fetch("modelData.json");
    modelData = await res.json();
    console.log("Google Drive modelData loaded:", modelData);
  } catch (err) {
    console.error("modelData.json ç„¡æ³•è¼‰å…¥ï¼š", err);
  }
}

/* =======================================================
   å…¨åŸŸè®Šæ•¸ï¼ˆv4.7.7 åŸæœ¬é‚è¼¯ï¼‰
======================================================= */
let productCache = [];
let currentResultList = [];
let userLevel = 1;
let currentUserEmail = "";
let quoteList = [];
let isProductsLoaded = false;

/* =======================================================
   Loading Bar æ§åˆ¶
======================================================= */
const centerLoadingBox = document.getElementById("centerLoadingBox");
const centerLoadingBar = document.getElementById("centerLoadingBar");
function showLoading() {
  centerLoadingBox.style.display = "flex";
  centerLoadingBar.querySelector(".fill").style.width = "0%";
  setTimeout(() => {
    centerLoadingBar.querySelector(".fill").style.width = "55%";
  }, 120);
}
function hideLoading() {
  centerLoadingBar.querySelector(".fill").style.width = "100%";
  setTimeout(() => {
    centerLoadingBox.style.display = "none";
  }, 260);
}

/* =======================================================
   ä¸»å‹è™Ÿè§£æï¼ˆv4.7.x è¦å‰‡ï¼‰
======================================================= */
function getMainModel(model) {
  if (!model) return "";
  const raw = model.toUpperCase().trim();

  if (raw.includes("-")) {
    const parts = raw.split("-");
    const lastPart = parts[parts.length - 1];
    if (/^[A-Z]{1,3}$/.test(lastPart)) {
      return raw.replace(/-[A-Z]{1,3}$/,"");
    }
    return raw;
  }

  const m = raw.match(/^([A-Z]+[0-9]+)([A-Z]{1,3})$/);
  if (m) return m[1];

  return raw;
}

/* =======================================================
   ğŸ”¥ å•†å“é è¼‰å…¥ï¼ˆFirestore + Google Drive æ•´åˆï¼‰
======================================================= */
async function preloadProducts() {
  showLoading();
  isProductsLoaded = false;

  try {
    const snap = await getDocs(collection(db, "Products"));
    productCache = [];

    snap.forEach(docSnap => {
      const d = docSnap.data() || {};
      const model     = (d.model || "").trim();
      const mainModel = getMainModel(model);

      // é¡è‰²åˆ—è¡¨
      let colorList = (d.colorList || "").trim();
      if (!colorList) {
        const suffix = model.toUpperCase().replace(mainModel, "");
        if (suffix && /^[A-Z]{1,3}$/.test(suffix)) colorList = suffix;
      }

      // æœå°‹ key
      const searchKey = (d.searchKey || `${model} ${d.name || ""}`).toLowerCase();

      /* ---------------------------------------------
         ğŸ”¥ Google Drive æ•´åˆï¼ˆä¸»åœ– + ç¶²è·¯åœ–ï¼‰
      ---------------------------------------------- */
      const g = modelData[mainModel] || modelData[model] || {};

      const imageUrl = g.mainImage || d.imageUrl || "";  // è‹¥ GDrive æœ‰ä¸»åœ– â†’ å–ä»£åŸåœ–
      const networkImages = g.networkImages || [];
      const networkFolderId = g.networkFolderId || "";

      productCache.push({
        ...d,
        model,
        mainModel,
        colorList,
        searchKey,

        // Google Drive æ–°å¢æ¬„ä½
        imageUrl,
        networkImages,
        networkFolderId
      });
    });

    isProductsLoaded = true;
    console.log(`å•†å“è¼‰å…¥å®Œæˆï¼š${productCache.length} ç­†(å« GDrive æ•´åˆ)`);

  } catch (e) {
    console.error("å•†å“è¼‰å…¥å¤±æ•—ï¼š", e);
    alert("å•†å“è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡æ•´é é¢");
  }

  hideLoading();
}

/* =======================================================
   èµ·è¨‚é‡æ¬Šé™
======================================================= */
const qtySelect      = document.getElementById("qtySelect");
function setupQtySelectByLevel() {
  qtySelect.innerHTML = "";
  const emptyOpt = document.createElement("option");
  emptyOpt.value = "";
  emptyOpt.textContent = "ä¸ä½¿ç”¨èµ·è¨‚é‡";
  qtySelect.appendChild(emptyOpt);

  const add = (v,t)=>{
    const o = document.createElement("option");
    o.value = v; o.textContent = t;
    qtySelect.appendChild(o);
  };

  if (userLevel >= 1) add("50", "50 å€‹");
  if (userLevel >= 2) { add("100", "100 å€‹"); add("300", "300 å€‹"); }
  if (userLevel >= 3) { add("500", "500 å€‹"); add("1000", "1000 å€‹"); }
}

/* =======================================================
   åˆä½µä¸»å‹è™Ÿï¼ˆv4.7.7 åŸé‚è¼¯ï¼‰
======================================================= */
const sortSelect     = document.getElementById("sortSelect");
function mergeByMainModel(list) {
  const map = {};

  list.forEach(item => {
    const main = item.mainModel;

    if (!map[main]) {
      map[main] = {
        ...item,
        models: [item.model],
        colorList: item.colorList || "-"
      };
    } else {
      map[main].models.push(item.model);
      const exist = map[main].colorList.split(" / ").filter(Boolean);
      const incoming = (item.colorList || "").split(" / ").filter(Boolean);
      map[main].colorList = [...new Set([...exist, ...incoming])].join(" / ");
    }
  });

  return Object.values(map);
}

/* =======================================================
   æ’åºï¼ˆåŸç‰ˆä¿ç•™ï¼‰
======================================================= */
function applySorting(list) {
  const o = sortSelect.value;
  if (o === "minPriceAsc")  return list.sort((a,b)=> (a.minPrice||0) - (b.minPrice||0));
  if (o === "minPriceDesc") return list.sort((a,b)=> (b.minPrice||0) - (a.minPrice||0));
  if (o === "marketAsc")    return list.sort((a,b)=> (a.marketPrice||0) - (b.marketPrice||0));
  if (o === "marketDesc")   return list.sort((a,b)=> (b.marketPrice||0) - (a.marketPrice||0));
  if (o === "alphaAsc")     return list.sort((a,b)=> (a.mainModel||"").localeCompare(b.mainModel||""));
  if (o === "alphaDesc")    return list.sort((a,b)=> (b.mainModel||"").localeCompare(a.mainModel||""));
  return list;
}

/* =======================================================
   æœå°‹ï¼ˆA/B/Cï¼‰
======================================================= */
const keywordInput   = document.getElementById("keyword");
const minPriceInput  = document.getElementById("minPrice");
const maxPriceInput  = document.getElementById("maxPrice");
function searchProducts() {
  if (!isProductsLoaded) {
    alert("å•†å“å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨ç­‰ 1~2 ç§’å†æœå°‹");
    return;
  }

  const key = keywordInput.value.trim().toLowerCase();
  const qty = qtySelect.value;
  const minPraw = minPriceInput.value.trim();
  const maxPraw = maxPriceInput.value.trim();

  showLoading();

  setTimeout(() => {

    // Aï¼šåªæ‰“é—œéµå­—
    if (key && !qty && !minPraw && !maxPraw) {
      const r = productCache.filter(p => (p.searchKey || "").includes(key));
      currentResultList = applySorting(mergeByMainModel(r));
      renderResults(currentResultList);
      hideLoading();
      return;
    }

    // Bï¼šèµ·è¨‚é‡ + é ç®—ï¼ˆç„¡é—œéµå­—ï¼‰
    if (!key && qty && (minPraw || maxPraw)) {
      const minP = minPraw ? Number(minPraw) : 0;
      const maxP = maxPraw ? Number(maxPraw) : Number.MAX_SAFE_INTEGER;
      const costKey = `quote${qty}`;
      const r = productCache.filter(p => {
        const price = Number(p[costKey]) || 0;
        return price >= minP && price <= maxP;
      });
      currentResultList = applySorting(mergeByMainModel(r));
      renderResults(currentResultList);
      hideLoading();
      return;
    }

    // Cï¼šä¸‰é …éƒ½å¡«
    if (key && qty && (minPraw || maxPraw)) {
      const minP = minPraw ? Number(minPraw) : 0;
      const maxP = maxPraw ? Number(maxPraw) : Number.MAX_SAFE_INTEGER;
      const costKey = `quote${qty}`;

      const r = productCache.filter(p => {
        const hitKey = (p.searchKey || "").includes(key);
        const price  = Number(p[costKey]) || 0;
        return hitKey && price >= minP && price <= maxP;
      });

      currentResultList = applySorting(mergeByMainModel(r));
      renderResults(currentResultList);
      hideLoading();
      return;
    }

    alert("è«‹è¼¸å…¥é—œéµå­—ï¼Œæˆ–èµ·è¨‚é‡+é ç®—ï¼Œæˆ–ä¸‰é …éƒ½å¡«æ»¿ã€‚");
    hideLoading();

  }, 240);
}

/* =======================================================
   DOM ç¶å®šï¼ˆè£œé½Š v4.7.7 éœ€è¦çš„å…ƒç´ ï¼‰
======================================================= */
const searchForm     = document.getElementById("searchForm");
const exportBtn      = document.getElementById("exportBtn");
const clearBtn       = document.getElementById("clearBtn");
const resultTable    = document.getElementById("resultTable");
const resultBody     = document.getElementById("resultBody");
const checkAllBox    = document.getElementById("checkAll");
const detailCard     = document.getElementById("detailCard");

const userInfoSpan   = document.getElementById("userInfo");
const logoutBtn      = document.getElementById("logoutBtn");

const sheetBackdrop  = document.getElementById("sheetBackdrop");
const mobileSheet    = document.getElementById("mobileDetailSheet");
const sheetContent   = document.getElementById("sheetContent");
const sheetCloseBtn  = document.getElementById("sheetCloseBtn");

const quoteSheet     = document.getElementById("quoteSheet");
const quoteCloseBtn  = document.getElementById("quoteCloseBtn");
const quoteListBody  = document.getElementById("quoteListBody");
const copyQuoteBtn   = document.getElementById("copyQuoteBtn");
const clearQuoteBtn  = document.getElementById("clearQuoteBtn");
const downloadQuoteExcelBtn = document.getElementById("downloadQuoteExcelBtn");
const quoteToolbarBtn = document.getElementById("quoteToolbarBtn");

/* =======================================================
   æ¸²æŸ“æœå°‹çµæœï¼ˆv4.7.7 åŸç‰ˆä¿ç•™ï¼‰
======================================================= */
function renderResults(list) {
  resultBody.innerHTML = "";
  detailCard.style.display = "none";
  checkAllBox.checked = false;
  updateMultiLineBtnState();

  if (list.length === 0) {
    resultTable.style.display = "none";
    exportBtn.disabled = true;
    return;
  }

  resultTable.style.display = "table";
  exportBtn.disabled = false;

  list.forEach(item => {
    const img = item.imageUrl || "https://placehold.co/120x120?text=No+Image";
    const tr = document.createElement("tr");

    let priceHtml = "";
    if (userLevel >= 1) priceHtml += `<span class="price-tag tag50">50å€‹ï¼š${item.quote50 ?? "-"}</span>`;
    if (userLevel >= 2) {
      priceHtml += `<span class="price-tag tag100">100å€‹ï¼š${item.quote100 ?? "-"}</span>`;
      priceHtml += `<span class="price-tag tag300">300å€‹ï¼š${item.quote300 ?? "-"}</span>`;
    }
    if (userLevel >= 3) {
      priceHtml += `<span class="price-tag tag500">500å€‹ï¼š${item.quote500 ?? "-"}</span>`;
      priceHtml += `<span class="price-tag tag1000">1000å€‹ï¼š${item.quote1000 ?? "-"}</span>`;
    }

    tr.innerHTML = `
      <td><input type="checkbox" class="row-check" data-model="${item.model}"></td>
      <td><img src="${img}" class="product-img"></td>
      <td>${item.mainModel || "-"}</td>
      <td>
        <div style="font-weight:700;margin-bottom:4px;">${item.name || "-"}</div>
        <div style="font-size:13px;color:#555;margin-bottom:4px;">é¡è‰²ï¼š${item.colorList || "-"}</div>
        <div class="price-tag-container" style="font-size:13px;margin-bottom:4px;">${priceHtml}</div>
        <div style="display:flex; gap:6px;">
          <button class="line-share-btn"
            data-model="${item.model}"
            style="margin-top:6px;padding:6px 10px;font-size:12px;background:#06C755;color:#fff;border:none;border-radius:6px;cursor:pointer;">
            LINE
          </button>
          <button class="btn-outline-add add-quote-btn" data-model="${item.model}">
            â• å ±åƒ¹å–®
          </button>
        </div>
      </td>
      <td style="text-align:right;">${item.minPrice ?? "-"}</td>
      <td style="text-align:right;">${item.marketPrice ?? "-"}</td>
    `;

    // æ¡Œæ©Ÿ hover / click é¡¯ç¤ºå³å´å¡ç‰‡ï¼›æ‰‹æ©Ÿé»æ“Šé–‹ Sheet
    if (window.innerWidth > 900) {
      tr.addEventListener("mouseenter", () => showDetailDesktop(item));
      tr.addEventListener("click", (e)=> {
        if (e.target.tagName === "INPUT" || e.target.tagName === "BUTTON") return;
        showDetailDesktop(item);
      });
    } else {
      tr.addEventListener("click", (e)=> {
        if (e.target.tagName === "INPUT" || e.target.tagName === "BUTTON") return;
        showDetailMobile(item);
      });
    }

    resultBody.appendChild(tr);
  });

  bindCheckAll();
}

/* =======================================================
   æ¡Œæ©Ÿå³å´è©³ç´°å¡ï¼ˆğŸ”¥ åŠ å…¥å•†å“å¤§åœ–ä¸‹è¼‰ + ç¶²è·¯åœ–ï¼‰
======================================================= */
function showDetailDesktop(item) {
  const img = item.imageUrl || "https://placehold.co/300x300?text=No+Image";

  let priceBlock = "";
  if (userLevel >= 1) priceBlock += `<div>50 å€‹ï¼š${item.quote50 ?? "-"}</div>`;
  if (userLevel >= 2) priceBlock += `<div>100 å€‹ï¼š${item.quote100 ?? "-"}</div><div>300 å€‹ï¼š${item.quote300 ?? "-"}</div>`;
  if (userLevel >= 3) priceBlock += `<div>500 å€‹ï¼š${item.quote500 ?? "-"}</div><div>1000 å€‹ï¼š${item.quote1000 ?? "-"}</div>`;

  const netImgs = Array.isArray(item.networkImages) ? item.networkImages : [];
  const netFolderId = item.networkFolderId || "";

  let netHtml = "";
  if (netImgs.length > 0) {
    netHtml = `
      <div style="margin-top:16px;">
        <div style="font-weight:800;margin-bottom:6px;">å•†å“ç¶²è·¯åœ–ï¼ˆ${netImgs.length} å¼µï¼‰</div>
        <div>
          ${netImgs.map(x => `
            <div style="display:flex;justify-content:space-between;align-items:center;
                        padding:6px 0;border-bottom:1px dashed #eee;font-size:14px;">
              <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%;">${x.name || "image"}</span>
              <a href="${x.url}" target="_blank" style="color:#2563eb;font-weight:700;">ä¸‹è¼‰</a>
            </div>
          `).join("")}
        </div>
        ${netFolderId ? `
          <a href="https://drive.google.com/drive/folders/${netFolderId}" target="_blank"
             style="display:inline-block;margin-top:8px;color:#2563eb;font-size:14px;font-weight:700;">
             æŸ¥çœ‹ä¸‹è¼‰å•†å“ç¶²è·¯åœ–
          </a>
        ` : ""}
      </div>
    `;
  }

  detailCard.style.display = "block";
  detailCard.innerHTML = `
    <a href="${img}" target="_blank"
       style="display:block;background:#2563eb;color:#fff;text-align:center;
              padding:10px 0;border-radius:999px;font-size:16px;font-weight:800;
              text-decoration:none;margin-bottom:12px;">
      å•†å“å¤§åœ–ä¸‹è¼‰
    </a>

    <img src="${img}" style="width:100%;border-radius:10px;border:1px solid #eee;margin-bottom:10px;">
    <div style="font-weight:700;font-size:16px;margin-bottom:6px;">${item.name || "-"}</div>

    <div style="font-size:14px;line-height:1.6;margin-bottom:10px;">
      <strong>ä¸»å‹è™Ÿï¼š</strong>${item.mainModel || "-"}<br>
      <strong>é¡è‰²ï¼š</strong>${item.colorList || "-"}<br>
      <strong>è³£å ´ï¼š</strong>${item.marketPrice ?? "-"}<br>
      <strong>æœ«å”®ï¼š</strong>${item.minPrice ?? "-"}<br>
      <strong>ç¶²å€ï¼š</strong>${item.productUrl ? `<a href="${item.productUrl}" target="_blank">å‰å¾€</a>` : "-"}
    </div>

    <div style="font-weight:700;margin-bottom:6px;">æ¡è³¼åƒ¹æ ¼</div>
    <div style="line-height:1.6;">${priceBlock}</div>

    <div style="display:flex; gap:8px; margin-top:12px;">
      <button class="btn-primary line-share-btn" data-model="${item.model}" style="flex:1;">LINE åˆ†äº«</button>
      <button class="btn-outline-add add-quote-btn" data-model="${item.model}" style="flex:1;">åŠ å…¥å ±åƒ¹å–®</button>
    </div>

    ${netHtml}
  `;
}

/* =======================================================
   æ‰‹æ©Ÿ bottom-sheet è©³ç´°ï¼ˆğŸ”¥ åŠ å…¥å•†å“å¤§åœ–ä¸‹è¼‰ + ç¶²è·¯åœ–ï¼‰
======================================================= */
function showDetailMobile(item) {
  const img = item.imageUrl || "https://placehold.co/300x300?text=No+Image";

  let priceBlock = "";
  if (userLevel >= 1) priceBlock += `<div>50 å€‹ï¼š${item.quote50 ?? "-"}</div>`;
  if (userLevel >= 2) priceBlock += `<div>100 å€‹ï¼š${item.quote100 ?? "-"}</div><div>300 å€‹ï¼š${item.quote300 ?? "-"}</div>`;
  if (userLevel >= 3) priceBlock += `<div>500 å€‹ï¼š${item.quote500 ?? "-"}</div><div>1000 å€‹ï¼š${item.quote1000 ?? "-"}</div>`;

  const netImgs = Array.isArray(item.networkImages) ? item.networkImages : [];
  const netFolderId = item.networkFolderId || "";

  let netHtml = "";
  if (netImgs.length > 0) {
    netHtml = `
      <div style="margin-top:18px;">
        <div style="font-weight:800;margin-bottom:6px;">å•†å“ç¶²è·¯åœ–ï¼ˆ${netImgs.length} å¼µï¼‰</div>

        ${netFolderId ? `
          <a href="https://drive.google.com/drive/folders/${netFolderId}" target="_blank"
             style="display:inline-block;background:#0ea5e9;color:#fff;
                    padding:8px 12px;border-radius:999px;font-size:14px;
                    font-weight:800;text-decoration:none;margin-bottom:10px;">
            æŸ¥çœ‹ä¸‹è¼‰å•†å“ç¶²è·¯åœ–
          </a>
        ` : ""}

        <div>
          ${netImgs.map(x => `
            <div style="display:flex;justify-content:space-between;align-items:center;
                        padding:6px 0;border-bottom:1px dashed #eee;font-size:14px;">
              <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;max-width:70%;">${x.name || "image"}</span>
              <a href="${x.url}" target="_blank" style="color:#2563eb;font-weight:700;">ä¸‹è¼‰</a>
            </div>
          `).join("")}
        </div>
      </div>
    `;
  }

  sheetContent.innerHTML = `
    <a href="${img}" target="_blank"
       style="display:block;background:#2563eb;color:#fff;text-align:center;
              padding:10px 0;border-radius:999px;font-size:16px;font-weight:800;
              text-decoration:none;margin-bottom:12px;">
      å•†å“å¤§åœ–ä¸‹è¼‰
    </a>

    <img src="${img}" style="width:100%;border-radius:10px;border:1px solid #eee;margin-bottom:10px;">
    <div style="font-weight:700;font-size:16px;margin-bottom:6px;">${item.name || "-"}</div>

    <div style="font-size:14px;line-height:1.6;margin-bottom:10px;">
      <strong>ä¸»å‹è™Ÿï¼š</strong>${item.mainModel || "-"}<br>
      <strong>é¡è‰²ï¼š</strong>${item.colorList || "-"}<br>
      <strong>è³£å ´ï¼š</strong>${item.marketPrice ?? "-"}<br>
      <strong>æœ«å”®ï¼š</strong>${item.minPrice ?? "-"}<br>
      <strong>ç¶²å€ï¼š</strong>${item.productUrl ? `<a href="${item.productUrl}" target="_blank">å‰å¾€</a>` : "-"}
    </div>

    <div style="font-weight:700;margin-bottom:6px;">æ¡è³¼åƒ¹æ ¼</div>
    <div style="line-height:1.6;">${priceBlock}</div>

    <div style="display:flex; gap:8px; margin-top:12px;">
      <button class="btn-primary line-share-btn" data-model="${item.model}" style="flex:1;">LINE åˆ†äº«</button>
      <button class="btn-outline-add add-quote-btn" data-model="${item.model}" style="flex:1;">åŠ å…¥å ±åƒ¹å–®</button>
    </div>

    ${netHtml}
  `;
  openSheet();
}

/* =======================================================
   Mobile Sheet æ§åˆ¶ï¼ˆåŸç‰ˆä¿ç•™ï¼‰
======================================================= */
function openSheet() {
  sheetBackdrop.classList.remove("hidden");
  mobileSheet.classList.remove("hidden");
  requestAnimationFrame(() => mobileSheet.classList.add("open"));
}
function closeSheet() {
  mobileSheet.classList.remove("open");
  setTimeout(() => {
    mobileSheet.classList.add("hidden");
    if (quoteSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden");
  }, 220);
}

/* =======================================================
   å…¨é¸å‹¾é¸ï¼ˆåŸç‰ˆä¿ç•™ï¼‰
======================================================= */
function bindCheckAll() {
  const rowChecks = document.querySelectorAll(".row-check");

  checkAllBox.onchange = () => {
    rowChecks.forEach(c => c.checked = checkAllBox.checked);
    updateMultiLineBtnState();
  };

  rowChecks.forEach(chk => {
    chk.onchange = () => {
      const all = document.querySelectorAll(".row-check");
      const checked = document.querySelectorAll(".row-check:checked");
      checkAllBox.checked = (all.length === checked.length);
      updateMultiLineBtnState();
    };
  });
}

/* =======================================================
   å¤šé¸ LINE åˆ†äº« â€” å·¥å…·åˆ—æŒ‰éˆ•ï¼ˆåŸç‰ˆä¿ç•™ï¼‰
======================================================= */
const toolbarEl = document.querySelector(".toolbar");
const multiLineBtn = document.createElement("button");
multiLineBtn.id = "multiLineBtn";
multiLineBtn.className = "btn-secondary";
multiLineBtn.textContent = "å¤šé¸ LINE åˆ†äº«";
multiLineBtn.disabled = true;
toolbarEl.insertBefore(multiLineBtn, exportBtn);

function updateMultiLineBtnState() {
  const checked = document.querySelectorAll(".row-check:checked");
  multiLineBtn.disabled = checked.length === 0;
}

/* =======================================================
   å ±åƒ¹å–®æŒ‰éˆ•é¡¯ç¤º / å…§å®¹æ¸²æŸ“ï¼ˆåŸç‰ˆä¿ç•™ï¼‰
======================================================= */
function updateQuoteToolbarBtn() {
  if (quoteList.length > 0) {
    quoteToolbarBtn.style.display = "inline-block";
    quoteToolbarBtn.textContent = `å ±åƒ¹å–®ï¼ˆ${quoteList.length}ï¼‰`;
  } else {
    quoteToolbarBtn.style.display = "none";
  }
}

function renderQuoteList() {
  quoteListBody.innerHTML = "";

  if (quoteList.length === 0) {
    quoteListBody.innerHTML = `<div style="text-align:center;padding:40px;color:#999;">å ±åƒ¹å–®æ˜¯ç©ºçš„</div>`;
    return;
  }

  quoteList.forEach((q, idx) => {
    const div = document.createElement("div");
    div.className = "quote-item";
    div.innerHTML = `
      <div style="flex:1;">
        <div style="font-weight:700;">${q.name}</div>
        <div class="quote-info">${q.model} | ${q.qtyLabel}</div>
      </div>
      <div style="text-align:right;margin-right:8px;">
        <div class="quote-price">$${q.price}</div>
        <div style="font-size:12px;color:#888;">x ${q.count}</div>
      </div>
      <div class="quote-del" data-idx="${idx}">ğŸ—‘ï¸</div>
    `;
    quoteListBody.appendChild(div);
  });

  document.querySelectorAll(".quote-del").forEach(btn => {
    btn.onclick = (e) => {
      const i = Number(e.target.getAttribute("data-idx"));
      quoteList.splice(i, 1);
      renderQuoteList();
      updateQuoteToolbarBtn();
    };
  });
}

function openQuoteSheet() {
  sheetBackdrop.classList.remove("hidden");
  quoteSheet.classList.remove("hidden");
  requestAnimationFrame(() => quoteSheet.classList.add("open"));
  renderQuoteList();
}
function closeQuoteSheet() {
  quoteSheet.classList.remove("open");
  setTimeout(() => quoteSheet.classList.add("hidden"), 220);
  if (mobileSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden");
}

/* =======================================================
   åŒ¯å‡º Excelï¼ˆæœå°‹çµæœå¤šé¸ï¼‰
======================================================= */
function exportSelectedExcel() {
  const checked = document.querySelectorAll(".row-check:checked");
  if (checked.length === 0) { alert("è«‹å…ˆå‹¾é¸è¦åŒ¯å‡ºçš„å•†å“"); return; }

  const selectedModels = Array.from(checked).map(c => c.getAttribute("data-model"));
  const baseHeader = ["å•†å“å‹è™Ÿ","ä¸»å‹è™Ÿ","å•†å“åç¨±","é¡è‰²åˆ—è¡¨","ç®±å…¥æ•¸","å•†å“é€£çµ","å•†å“å¤§åœ–"];

  const qty = qtySelect.value;
  let priceHeader = qty ? [`${qty}å€‹`, "æœ«å”®", "è³£å ´"] : ["æœ«å”®", "è³£å ´"];
  const rows = [[...baseHeader, ...priceHeader]];

  selectedModels.forEach(m => {
    const item = currentResultList.find(p => p.model === m);
    if (!item) return;

    const baseRow = [
      item.model,
      item.mainModel,
      item.name,
      item.colorList || "",
      item.cartonQty || "",
      item.productUrl || "",
      item.imageUrl || ""   // ğŸ”¥ æ–°å¢å•†å“å¤§åœ–ç¶²å€
    ];

    let priceRow = [];
    if (qty) {
      const ck = `quote${qty}`;
      priceRow = [item[ck] ?? "-", item.minPrice ?? "-", item.marketPrice ?? "-"];
    } else {
      priceRow = [item.minPrice ?? "-", item.marketPrice ?? "-"];
    }

    rows.push([...baseRow, ...priceRow]);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹");
  XLSX.writeFile(wb, `KINYO_å•†å“å ±åƒ¹_${qty ? qty+'å€‹' : 'æœå°‹'}.xlsx`);
}

/* =======================================================
   å ±åƒ¹å–®é å…§ â€” åŒ¯å‡º Excel
======================================================= */
function downloadQuoteExcel() {
  if (quoteList.length === 0) { alert("å ±åƒ¹å–®æ˜¯ç©ºçš„"); return; }

  const header = ["å•†å“å‹è™Ÿ","å•†å“åç¨±","æ¡è³¼è¦æ ¼","å–®åƒ¹","æ•¸é‡"];
  const rows = [header];
  quoteList.forEach(q => rows.push([q.model, q.name, q.qtyLabel, q.price, q.count]));

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®");
  XLSX.writeFile(wb, `KINYO_å ±åƒ¹å–®_${new Date().toISOString().slice(0,10)}.xlsx`);
}

/* =======================================================
   å–®ç­† LINE åˆ†äº«
======================================================= */
document.addEventListener("click", (e) => {

  if (e.target.classList.contains("add-quote-btn")) {
    const model = e.target.getAttribute("data-model");
    const item  = currentResultList.find(p => p.model === model);
    if (!item) return;

    const qty = qtySelect.value || "50";
    const ck  = `quote${qty}`;
    const cost = item[ck] ?? item.quote50 ?? 0;

    quoteList.push({
      model: item.model,
      name: item.name,
      price: cost,
      qtyLabel: `${qty}å€‹`,
      count: 1
    });

    updateQuoteToolbarBtn();
    alert(`å·²åŠ å…¥å ±åƒ¹å–®ï¼ˆ${qty}å€‹ï¼š$${cost}ï¼‰`);
    return;
  }

  if (e.target.classList.contains("line-share-btn")) {
    const model = e.target.getAttribute("data-model");
    const item  = currentResultList.find(p => p.model === model);
    if (!item) return;

    let costText = "";
    if (userLevel >= 1) costText += `50å€‹ï¼š${item.quote50 ?? "-"}\n`;
    if (userLevel >= 2) costText += `100å€‹ï¼š${item.quote100 ?? "-"}\n300å€‹ï¼š${item.quote300 ?? "-"}\n`;
    if (userLevel >= 3) costText += `500å€‹ï¼š${item.quote500 ?? "-"}\n1000å€‹ï¼š${item.quote1000 ?? "-"}\n`;

    const text = `ğŸ”¥ã€${item.model}ã€‘${item.name}
è³£å ´å”®åƒ¹ï¼š${item.marketPrice ?? "-"}
æœ«å”®åƒ¹æ ¼ï¼š${item.minPrice ?? "-"}
--------------------
æ¡è³¼åƒ¹æ ¼ï¼š
${costText}
å•†å“é€£çµï¼š${item.productUrl || "ç„¡"}
å•†å“å¤§åœ–ï¼š${item.imageUrl || "ç„¡"}`;

    navigator.clipboard.writeText(text)
      .then(() => alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿"))
      .catch(() => alert("è¤‡è£½å¤±æ•—"));
  }
});

/* =======================================================
   å¤šé¸ LINE åˆ†äº«
======================================================= */
multiLineBtn.onclick = () => {
  const checked = document.querySelectorAll(".row-check:checked");
  if (checked.length === 0) return;

  let text = "ğŸ“Œ KINYO å¤šå“é …å ±åƒ¹\n--------------------\n";
  Array.from(checked).forEach((c, i) => {
    const model = c.getAttribute("data-model");
    const item  = currentResultList.find(p => p.model === model);
    if (!item) return;

    const qty  = qtySelect.value || "50";
    const ck   = `quote${qty}`;
    const cost = item[ck] ?? item.quote50 ?? "-";

    text += `${i+1}. ã€${item.model}ã€‘${item.name}\n   ${qty}å€‹ï¼š$${cost}\n   å¤§åœ–ï¼š${item.imageUrl || "ç„¡"}\n`;
  });

  text += "--------------------\n";
  navigator.clipboard.writeText(text)
    .then(() => alert("å¤šé¸å ±åƒ¹å·²è¤‡è£½"))
    .catch(() => alert("è¤‡è£½å¤±æ•—"));
};

/* =======================================================
   ä»‹é¢äº‹ä»¶ç¶å®šï¼ˆæœå°‹ / æ’åº / æ¸…é™¤ï¼‰
======================================================= */
searchForm.addEventListener("submit", (e) => {
  e.preventDefault();
  searchProducts();
});

exportBtn.onclick = exportSelectedExcel;
quoteToolbarBtn.onclick = openQuoteSheet;
downloadQuoteExcelBtn.onclick = downloadQuoteExcel;

quoteCloseBtn.onclick = closeQuoteSheet;
sheetCloseBtn.onclick = closeSheet;

sheetBackdrop.onclick = () => { closeSheet(); closeQuoteSheet(); };

copyQuoteBtn.onclick = () => {
  if (quoteList.length === 0) return;
  let text = "ğŸ“‹ KINYO å•†å“å ±åƒ¹å–®\n----------------------\n";
  quoteList.forEach((q, i) => {
    text += `${i+1}. ã€${q.model}ã€‘${q.name}\n   è¦æ ¼ï¼š${q.qtyLabel} | å–®åƒ¹ï¼š$${q.price} | æ•¸é‡ï¼š${q.count}\n`;
  });
  text += "----------------------\n";
  navigator.clipboard.writeText(text)
    .then(() => alert("å ±åƒ¹å–®å·²è¤‡è£½"))
    .catch(() => alert("è¤‡è£½å¤±æ•—"));
};

clearBtn.onclick = () => {
  keywordInput.value = "";
  qtySelect.value = "";
  minPriceInput.value = "";
  maxPriceInput.value = "";

  resultBody.innerHTML = "";
  resultTable.style.display = "none";
  exportBtn.disabled = true;
  multiLineBtn.disabled = true;
  checkAllBox.checked = false;
  detailCard.style.display = "none";
};

sortSelect.onchange = () => {
  if (currentResultList.length > 0) {
    currentResultList = applySorting([...currentResultList]);
    renderResults(currentResultList);
  }
};

/* =======================================================
   Firebase Authï¼šç™»å…¥å¾Œæµç¨‹
======================================================= */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  currentUserEmail = user.email || "";

  try {
    const userDoc = await getDoc(doc(db, "Users", currentUserEmail.toLowerCase()));
    if (userDoc.exists()) userLevel = userDoc.data().level || 1;
  } catch {
    userLevel = 1;
  }

  userInfoSpan.textContent = `ç™»å…¥å¸³è™Ÿï¼š${currentUserEmail.replace(/@.*/, "")}`;
  logoutBtn.style.display = "inline-block";

  setupQtySelectByLevel();

  /* ğŸ”¥ å…ˆè¼‰å…¥ Google Drive modelDataï¼Œå†è¼‰å…¥ Products */
  await loadModelData();
  await preloadProducts();
});

/* ç™»å‡º */
logoutBtn.onclick = () => signOut(auth);

</script>
</body>
</html>
