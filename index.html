<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>KINYO æŸ¥åƒ¹ç³»çµ±ï¼ˆv4.7 æœ€çµ‚åˆä½µç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* ---------------------------
   v4.7 C ç‰ˆ â€” å°ˆæ¥­é‡å¯« CSSï¼ˆå«å…¨éƒ¨å…ƒä»¶ï¼‰
----------------------------*/
:root{
  --bg:#f5f6f8;
  --card:#ffffff;
  --primary:#111827;
  --border:#e5e7eb;
  --text:#1f2937;
  --muted:#6b7280;
  --radius:12px;
  --shadow:0 4px 12px rgba(0,0,0,0.06);
}

body{
  margin:0;
  padding:24px;
  background:var(--bg);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--text);
  max-width:980px;
  margin:0 auto;
}

h1{margin:0 0 4px;}
.subtitle{color:var(--muted);margin-bottom:18px;font-size:14px;line-height:1.6;}

/* Top Bar */
.top-bar{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:12px;
  margin-bottom:14px;
  font-size:13px;
}
.user-badge{
  background:#eef0f4;
  padding:6px 14px;
  border-radius:999px;
}
.logout-btn{
  padding:6px 14px;
  border-radius:999px;
  border:1px solid var(--border);
  cursor:pointer;
  background:white;
  font-size:12px;
}

/* Search Box */
.search-box{
  background:var(--card);
  padding:18px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  margin-bottom:12px;
}
.search-row{margin-bottom:14px;}
label{font-weight:600;margin-bottom:6px;display:block;font-size:14px;}

input,select{
  width:100%;
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:15px;
  box-sizing:border-box;
}

/* Buttons */
.btn-primary{
  background:var(--primary);
  color:white;
  border:none;
  border-radius:999px;
  padding:12px 20px;
  font-weight:600;
  cursor:pointer;
  width:100%;
}
.btn-secondary{
  background:white;
  border:1px solid var(--border);
  padding:10px 16px;
  border-radius:999px;
  cursor:pointer;
  font-size:14px;
  white-space:nowrap;
}
.btn-outline-add{
  padding:6px 12px;
  border-radius:6px;
  border:1px solid #2563eb;
  background:#eff6ff;
  color:#2563eb;
  font-size:12px;
  cursor:pointer;
  font-weight:600;
}
.btn-outline-add:hover{background:#dbeafe;}

/* Toolbar */
.toolbar{
  display:flex;
  gap:10px;
  align-items:center;
  margin:10px 0 6px;
}
.toolbar select{flex:1;}

/* Table */
table{
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:var(--shadow);
}
th,td{
  padding:12px 10px;
  border-bottom:1px solid var(--border);
  font-size:14px;
  vertical-align:top;
}
th{background:#fafafa;text-align:left;}

/* Images */
.product-img{
  width:110px;height:110px;
  object-fit:cover;
  border-radius:8px;
  border:1px solid #e5e7eb;
  background:#fff;
}

/* Price Tags */
.price-tag{
  padding:3px 8px;
  font-size:12px;
  border-radius:6px;
  display:inline-block;
  margin-right:6px;
  margin-bottom:4px;
  font-weight:600;
  white-space:nowrap;
}
.tag50{background:#dbeafe;color:#1e40af;}
.tag100{background:#e0f2fe;color:#0369a1;}
.tag300{background:#dcfce7;color:#15803d;}
.tag500{background:#ffedd5;color:#ea580c;}
.tag1000{background:#fee2e2;color:#b91c1c;}

/* Detail Card (Desktop hover) */
#detailCard{
  position:fixed;
  right:16px;
  top:110px;
  width:320px;              /* è®Šçª„é¿å…æ“‹å·¦å´ */
  max-height:78vh;
  overflow-y:auto;
  background:white;
  padding:14px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  display:none;
  z-index:999;
}

/* Sheet (Mobile Detail & Quote) */
.sheet-backdrop{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.45);
  z-index:1000;
}
.sheet{
  position:fixed;left:0;right:0;bottom:0;
  height:82vh;background:#fff;
  border-radius:16px 16px 0 0;
  transform:translateY(100%);
  transition:transform .25s ease;
  display:flex;flex-direction:column;
  z-index:1001;
}
.sheet.open{transform:translateY(0);}
.sheet-header{
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  font-weight:600;
  display:flex;justify-content:space-between;align-items:center;
}
.sheet-close{
  background:none;border:none;
  font-size:26px;cursor:pointer;line-height:1;
}
.sheet-content{
  padding:16px;overflow-y:auto;font-size:15px;flex:1;
}
.hidden{display:none!important;}

/* Quote list */
.quote-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 0;border-bottom:1px solid #eee;
}
.quote-info{font-size:14px;}
.quote-price{font-weight:700;color:#2563eb;}
.quote-del{color:#999;cursor:pointer;padding:6px;font-size:16px;}
.quote-del:hover{color:#ef4444;}

/* FAB cart */
.fab-cart{
  position:fixed;
  bottom:26px;right:22px;
  width:62px;height:62px;
  background:#111827;color:#fff;
  border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 6px 16px rgba(0,0,0,0.25);
  cursor:pointer;z-index:990;
}
.fab-badge{
  position:absolute;top:-2px;right:-2px;
  background:#ef4444;color:#fff;
  font-size:12px;font-weight:700;
  width:22px;height:22px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  border:2px solid #fff;
}
.bounce{animation:bounce .3s ease-in-out;}
@keyframes bounce{
  0%,100%{transform:scale(1);}
  50%{transform:scale(1.2);}
}

/* Loading overlay */
#loadingOverlay{
  position:fixed; inset:0;
  background:rgba(0,0,0,0.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
.loading-card{
  width:min(420px, 86vw);
  background:#fff;
  border-radius:14px;
  padding:18px 16px;
  box-shadow:0 10px 30px rgba(0,0,0,0.2);
}
#loadingText{
  font-weight:700;
  margin-bottom:10px;
}
.loading-bar{
  height:10px;
  background:#eee;
  border-radius:999px;
  overflow:hidden;
}
#loadingBarFill{
  height:100%;
  width:0%;
  background:#111827;
  transition:width .2s ease;
}

/* RWD */
@media (max-width:900px){
  #detailCard{display:none!important;}
}
@media (max-width:600px){
  body{padding:14px;}
  .search-box{padding:14px;}
  input,select{font-size:14px;}
  .product-img{width:90px;height:90px;}
  th,td{padding:8px 6px;font-size:13px;}
  .price-tag-container{
    display:grid;grid-template-columns:repeat(2,1fr);
    gap:4px 6px;margin-bottom:4px;
  }
  .price-tag{width:100%;text-align:center;margin:0;}
}
</style>
</head>

<body>

<!-- Loading overlay -->
<div id="loadingOverlay">
  <div class="loading-card">
    <div id="loadingText">å•†å“è¼‰å…¥ä¸­...</div>
    <div class="loading-bar">
      <div id="loadingBarFill"></div>
    </div>
  </div>
</div>

<div class="top-bar">
  <span id="userInfo" class="user-badge">æœªç™»å…¥</span>
  <button id="logoutBtn" class="logout-btn" style="display:none;">ç™»å‡º</button>
</div>

<h1>KINYO æŸ¥åƒ¹ç³»çµ±</h1>
<div class="subtitle">
  éƒ­åº­è±ªå˜”å¿ƒç€è¡€ä¹‹ä½œï¼ˆv4.7 ç‰ˆæœ¬ï¼‰<br>
  ä»»ä½•å»ºè­°ğŸ“±ï¼š0976-966-333
</div>

<div class="search-box">
  <div class="search-row">
    <label>é—œéµå­—æœå°‹ï¼ˆå‹è™Ÿ / åç¨±ï¼‰</label>
    <input id="keyword" placeholder="å¦‚ï¼šCL528 / æ•èšŠç‡ˆ / é™¤æ¯›çƒæ©Ÿ" />
  </div>

  <div class="search-row">
    <label>èµ·è¨‚é‡ï¼ˆå¯ä¸é¸ï¼‰</label>
    <select id="qtySelect"></select>
  </div>

  <div class="search-row">
    <label>é ç®—å€é–“ï¼ˆèµ·è¨‚é‡å·²é¸æ™‚æ‰ç”Ÿæ•ˆï¼›å¯åªå¡«ä¸€é‚Šï¼‰</label>
    <div style="display:flex; gap:10px;">
      <input id="minPrice" type="number" placeholder="æœ€ä½ (å¯ç©º)">
      <input id="maxPrice" type="number" placeholder="æœ€é«˜ (å¯ç©º)">
    </div>
  </div>

  <button id="searchBtn" class="btn-primary">æŸ¥è©¢</button>
  <button id="clearBtn" class="btn-secondary" style="margin-top:10px;width:100%;">æ¸…é™¤æœå°‹æ¢ä»¶</button>
</div>

<div class="toolbar">
  <select id="sortSelect" class="btn-secondary">
    <option value="">ä¸æ’åº</option>
    <option value="minPriceAsc">æœ«å”®ï¼šä½ â†’ é«˜</option>
    <option value="minPriceDesc">æœ«å”®ï¼šé«˜ â†’ ä½</option>
    <option value="marketAsc">è³£å ´ï¼šä½ â†’ é«˜</option>
    <option value="marketDesc">è³£å ´ï¼šé«˜ â†’ ä½</option>
    <option value="alphaAsc">ä¸»å‹è™Ÿï¼šA â†’ Z</option>
    <option value="alphaDesc">ä¸»å‹è™Ÿï¼šZ â†’ A</option>
  </select>

  <button id="exportBtn" class="btn-secondary" disabled>åŒ¯å‡º Excel</button>
  <button id="openQuoteBtn" class="btn-secondary" style="display:none;">å ±åƒ¹å–®</button>
</div>

<table id="resultTable" style="display:none;">
  <thead>
    <tr>
      <th style="width:32px;"><input type="checkbox" id="checkAll" /></th>
      <th style="width:120px;">åœ–ç‰‡</th>
      <th style="width:100px;">ä¸»å‹è™Ÿ</th>
      <th>å•†å“è³‡è¨Š</th>
      <th style="width:80px;">æœ«å”®</th>
      <th style="width:80px;">è³£å ´</th>
    </tr>
  </thead>
  <tbody id="resultBody"></tbody>
</table>

<div id="detailCard"></div>

<!-- Mobile detail sheet -->
<div id="sheetBackdrop" class="sheet-backdrop hidden"></div>
<div id="mobileDetailSheet" class="sheet hidden">
  <div class="sheet-header">
    <span>å•†å“è³‡è¨Š</span>
    <button id="sheetCloseBtn" class="sheet-close">Ã—</button>
  </div>
  <div class="sheet-content" id="sheetContent"></div>
</div>

<!-- Quote sheet -->
<div id="quoteSheet" class="sheet hidden">
  <div class="sheet-header">
    <span>å ±åƒ¹å–®é è¦½</span>
    <button id="quoteCloseBtn" class="sheet-close">Ã—</button>
  </div>
  <div class="sheet-content" style="display:flex;flex-direction:column;">
    <div id="quoteListBody" style="flex:1;overflow-y:auto;"></div>
    <div style="border-top:1px solid #eee; padding-top:12px; margin-top:10px;">
      <button id="copyQuoteBtn" class="btn-primary" style="width:100%;">è¤‡è£½æ•´å¼µå ±åƒ¹å–® (LINE)</button>
      <button id="quoteExcelBtn" class="btn-secondary" style="width:100%;margin-top:8px;">ä¸‹è¼‰ Excel å ±åƒ¹å–®</button>
      <button id="clearQuoteBtn" class="btn-secondary" style="width:100%;margin-top:8px;color:#ef4444;border-color:#ef4444;">æ¸…ç©ºå ±åƒ¹å–®</button>
    </div>
  </div>
</div>

<!-- FAB cart -->
<div id="fabCart" class="fab-cart hidden">
  <span style="font-size:24px;">ğŸ“</span>
  <div id="cartCount" class="fab-badge">0</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  /* ========================================================
     1) Firebase åˆå§‹åŒ–
  ======================================================== */
  const firebaseConfig = {
    apiKey: "AIzaSyDtp6rwV7KmIOedLQ9793BnXbBquopP9kM",
    authDomain: "kinyo-price.firebaseapp.com",
    projectId: "kinyo-price",
    storageBucket: "kinyo-price.firebasestorage.app",
    messagingSenderId: "122464645678",
    appId: "1:122464645678:web:c0febbc6297a8ada5ea5bf"
  };

  const app  = initializeApp(firebaseConfig);
  const db   = getFirestore(app);
  const auth = getAuth(app);

  /* ========================================================
     2) å…¨åŸŸç‹€æ…‹
  ======================================================== */
  let productCache = [];
  let currentResultList = [];
  let userLevel = 1;
  let currentUserEmail = "";
  let quoteList = [];

  /* ========================================================
     3) DOM
  ======================================================== */
  const keywordInput   = document.getElementById("keyword");
  const qtySelect      = document.getElementById("qtySelect");
  const minPriceInput  = document.getElementById("minPrice");
  const maxPriceInput  = document.getElementById("maxPrice");
  const sortSelect     = document.getElementById("sortSelect");
  const exportBtn      = document.getElementById("exportBtn");
  const openQuoteBtn   = document.getElementById("openQuoteBtn");
  const clearBtn       = document.getElementById("clearBtn");
  const resultTable    = document.getElementById("resultTable");
  const resultBody     = document.getElementById("resultBody");
  const checkAllBox    = document.getElementById("checkAll");
  const detailCard     = document.getElementById("detailCard");

  const userInfoSpan   = document.getElementById("userInfo");
  const logoutBtn      = document.getElementById("logoutBtn");

  const sheetBackdrop  = document.getElementById("sheetBackdrop");
  const mobileSheet    = document.getElementById("mobileDetailSheet");
  const sheetContent   = document.getElementById("sheetContent");
  const sheetCloseBtn  = document.getElementById("sheetCloseBtn");

  const quoteSheet     = document.getElementById("quoteSheet");
  const quoteCloseBtn  = document.getElementById("quoteCloseBtn");
  const quoteListBody  = document.getElementById("quoteListBody");
  const copyQuoteBtn   = document.getElementById("copyQuoteBtn");
  const clearQuoteBtn  = document.getElementById("clearQuoteBtn");
  const quoteExcelBtn  = document.getElementById("quoteExcelBtn");
  const fabCart        = document.getElementById("fabCart");
  const cartCount      = document.getElementById("cartCount");

  const loadingOverlay = document.getElementById("loadingOverlay");
  const loadingText    = document.getElementById("loadingText");
  const loadingBarFill = document.getElementById("loadingBarFill");

  /* ========================================================
     4) ä¸»å‹è™Ÿ / é¡è‰²åˆä½µè¦å‰‡ï¼ˆv4.7 æœ€çµ‚ç‰ˆï¼‰
     - è‹±æ–‡+æ•¸å­—+è‹±æ–‡(1~3ç¢¼) â†’ æœ€å¾Œè‹±æ–‡æ˜¯é¡è‰²
     - WV-KHP1230W / WV-KHP1230-BK â†’ æœ€å¾Œ 1~3 è‹±æ–‡æ˜¯é¡è‰²
  ======================================================== */
  function getMainModel(model = "") {
    const raw = model.trim();
    if (!raw) return "";

    let m = raw;

    // è¦å‰‡1ï¼šå°¾ç«¯ "-XX"(1~3å­—æ¯)
    const dashColor = m.match(/^(.*?)-([A-Za-z]{1,3})$/);
    if (dashColor) return dashColor[1];

    // è¦å‰‡2ï¼šå°¾ç«¯é€£çºŒå­—æ¯(1~3)ä¸”å‰é¢å«æ•¸å­—
    const tailAlpha = m.match(/^(.*\d)([A-Za-z]{1,3})$/);
    if (tailAlpha) return tailAlpha[1];

    return m;
  }

  function buildSearchKey(d) {
    return `${d.model || ""} ${d.mainModel || ""} ${d.name || ""} ${d.searchKey || ""}`
      .toLowerCase();
  }

  /* ========================================================
     5) Loading Overlay
  ======================================================== */
  function showLoading(text="å•†å“æœå°‹ä¸­...", pct=0){
    loadingText.textContent = text;
    loadingBarFill.style.width = `${pct}%`;
    loadingOverlay.style.display = "flex";
  }
  function updateLoading(pct){
    loadingBarFill.style.width = `${pct}%`;
  }
  function hideLoading(){
    loadingOverlay.style.display = "none";
    loadingBarFill.style.width = "0%";
  }

  /* ========================================================
     6) å•†å“é è¼‰ + é€²åº¦æ¢
  ======================================================== */
  async function preloadProducts() {
    try {
      showLoading("å•†å“è¼‰å…¥ä¸­...", 5);

      const snap = await getDocs(collection(db, "Products"));
      const total = snap.size || 1;
      let i = 0;

      productCache = [];

      snap.forEach(docSnap => {
        const d = docSnap.data() || {};
        const model = (d.model || "").trim();
        const mainModel = getMainModel(model);

        const item = {
          ...d,
          model,
          mainModel,
          minPrice: Number(d.minPrice || 0),
          marketPrice: Number(d.marketPrice || 0),
          quote50: Number(d.quote50 || 0),
          quote100: Number(d.quote100 || 0),
          quote300: Number(d.quote300 || 0),
          quote500: Number(d.quote500 || 0),
          quote1000: Number(d.quote1000 || 0),
        };

        item.searchKey = buildSearchKey(item);

        productCache.push(item);

        i++;
        if (i % 20 === 0) {
          const pct = Math.min(95, Math.round((i / total) * 100));
          updateLoading(pct);
        }
      });

      updateLoading(100);
      setTimeout(hideLoading, 180);

      console.log("å•†å“é è¼‰å®Œæˆï¼š", productCache.length);
    } catch (e) {
      hideLoading();
      console.error("é è¼‰å¤±æ•—ï¼š", e);
      alert("å•†å“è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¢ºèª Firestore æ¬Šé™æˆ–ç¶²è·¯ç‹€æ…‹ã€‚");
    }
  }

  /* ========================================================
     7) ä¸»å‹è™Ÿåˆä½µï¼ˆé¡è‰²åˆä½µï¼‰
  ======================================================== */
  function mergeByMainModel(list) {
    const map = {};
    list.forEach(item => {
      const main = item.mainModel || getMainModel(item.model);

      if (!map[main]) {
        map[main] = {
          ...item,
          mainModel: main,
          models: [item.model],
        };
      } else {
        map[main].models.push(item.model);
      }
    });
    return Object.values(map);
  }

  /* ========================================================
     8) æ’åº
  ======================================================== */
  function applySorting(list) {
    const opt = sortSelect.value;
    if (opt === "minPriceAsc")  return list.sort((a,b)=>a.minPrice - b.minPrice);
    if (opt === "minPriceDesc") return list.sort((a,b)=>b.minPrice - a.minPrice);
    if (opt === "marketAsc")    return list.sort((a,b)=>a.marketPrice - b.marketPrice);
    if (opt === "marketDesc")   return list.sort((a,b)=>b.marketPrice - a.marketPrice);
    if (opt === "alphaAsc")     return list.sort((a,b)=>a.mainModel.localeCompare(b.mainModel));
    if (opt === "alphaDesc")    return list.sort((a,b)=>b.mainModel.localeCompare(a.mainModel));
    return list;
  }

  /* ========================================================
     9) æœå°‹æ ¸å¿ƒï¼ˆv4.7 ä¸‰ç¨®æ¨¡å¼ï¼‰
     A. åªé—œéµå­—
     B. èµ·è¨‚é‡ + é ç®—ï¼ˆå¯åªå¡«ä¸€é‚Šï¼‰
     C. é—œéµå­— + èµ·è¨‚é‡ + é ç®—
  ======================================================== */
  function searchProducts() {
    const key = keywordInput.value.trim().toLowerCase();
    const qty = qtySelect.value;
    const minPraw = minPriceInput.value.trim();
    const maxPraw = maxPriceInput.value.trim();

    showLoading("æœå°‹ä¸­...", 25);

    let base = productCache;

    if (key) {
      base = base.filter(p => (p.searchKey || "").includes(key));
    }

    if (qty) {
      const costKey = `quote${qty}`;
      const minP = minPraw ? Number(minPraw) : 0;
      const maxP = maxPraw ? Number(maxPraw) : Number.MAX_SAFE_INTEGER;

      base = base.filter(p => {
        const price = Number(p[costKey]) || 0;
        return price >= minP && price <= maxP;
      });
    }

    if (!key && !qty) {
      hideLoading();
      alert("è«‹è¼¸å…¥é—œéµå­—ï¼Œæˆ–é¸æ“‡èµ·è¨‚é‡ + é ç®—å€é–“å…¶ä¸€ï¼Œå†æœå°‹ã€‚");
      return;
    }

    if (key && !qty) lastSearchMode = "keyword";
    else if (!key && qty) lastSearchMode = "qty";
    else lastSearchMode = "mixed";

    updateLoading(70);

    const merged = mergeByMainModel(base);
    currentResultList = applySorting(merged);

    updateLoading(100);
    setTimeout(() => {
      hideLoading();
      renderResults(currentResultList);
    }, 120);
  }

  /* ========================================================
     10) Enter æœå°‹
  ======================================================== */
  [keywordInput, qtySelect, minPriceInput, maxPriceInput].forEach(el => {
    el.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        searchProducts();
      }
    });
  });

  /* ========================================================
     11) v4.7 æœå°‹æ¨¡å¼è¨˜éŒ„ï¼ˆfor Excel åŒ¯å‡ºè¦å‰‡ï¼‰
  ======================================================== */
  let lastSearchMode = ""; // "keyword" | "qty" | "mixed"

  /* ========================================================
     12) ä¾å¸³è™Ÿç­‰ç´šæ±ºå®šé è¨­æˆæœ¬ï¼ˆç”¨èµ·è¨‚é‡ï¼‰
  ======================================================== */
  function getSelectedCostInfo(item) {
    const selectedQty = qtySelect.value || "50";
    let cost = item.quote50;
    let label = "50å€‹";

    if (selectedQty === "100" && userLevel >= 2) { cost = item.quote100; label="100å€‹"; }
    else if (selectedQty === "300" && userLevel >= 2) { cost = item.quote300; label="300å€‹"; }
    else if (selectedQty === "500" && userLevel >= 3) { cost = item.quote500; label="500å€‹"; }
    else if (selectedQty === "1000" && userLevel >= 3) { cost = item.quote1000; label="1000å€‹"; }

    return { cost:Number(cost||0), label };
  }

  /* ========================================================
     13) çµæœæ¸²æŸ“
  ======================================================== */
  function renderResults(list) {
    resultBody.innerHTML = "";
    detailCard.style.display = "none";
    closeSheet();
    if (checkAllBox) checkAllBox.checked = false;

    if (list.length === 0) {
      resultTable.style.display = "none";
      exportBtn.disabled = true;
      return;
    }

    resultTable.style.display = "table";
    exportBtn.disabled = false;

    list.forEach(item => {
      const img = item.imageUrl || "https://placehold.co/120x120?text=No+Image";
      const tr = document.createElement("tr");

      let priceHtml = "";
      if (userLevel >= 1) priceHtml += `<span class="price-tag tag50">50å€‹ï¼š${item.quote50}</span>`;
      if (userLevel >= 2) {
        priceHtml += `<span class="price-tag tag100">100å€‹ï¼š${item.quote100}</span>`;
        priceHtml += `<span class="price-tag tag300">300å€‹ï¼š${item.quote300}</span>`;
      }
      if (userLevel >= 3) {
        priceHtml += `<span class="price-tag tag500">500å€‹ï¼š${item.quote500}</span>`;
        priceHtml += `<span class="price-tag tag1000">1000å€‹ï¼š${item.quote1000}</span>`;
      }

      tr.innerHTML = `
        <td><input type="checkbox" class="row-check" data-model="${item.model}" /></td>
        <td><img src="${img}" class="product-img"></td>
        <td>${item.mainModel || "-"}</td>
        <td>
          <div style="font-weight:700;margin-bottom:4px;">${item.name || "-"}</div>
          <div style="font-size:13px;color:#555;margin-bottom:4px;">é¡è‰²ï¼š${item.models?.length>1 ? "å¤šè‰²åˆä½µ" : (item.colorList||"-")}</div>
          <div class="price-tag-container" style="font-size:13px;margin-bottom:4px;">${priceHtml}</div>

          <div style="display:flex; gap:6px;">
            <button class="line-share-btn" data-model="${item.model}"
              style="margin-top:6px;padding:6px 10px;font-size:12px;background:#06C755;color:#fff;border:none;border-radius:6px;cursor:pointer;">
              LINE
            </button>
            <button class="btn-outline-add add-quote-btn" data-model="${item.model}">
              â• å ±åƒ¹å–®
            </button>
          </div>
        </td>
        <td style="text-align:right;">${item.minPrice || 0}</td>
        <td style="text-align:right;">${item.marketPrice || 0}</td>
      `;

      if (window.innerWidth > 900) {
        tr.addEventListener("mouseenter", () => showDetailDesktop(item));
        tr.addEventListener("click", (e) => {
          if (e.target.tagName === "INPUT" || e.target.tagName === "BUTTON") return;
          showDetailDesktop(item);
        });
      } else {
        tr.addEventListener("click", (e) => {
          if (e.target.tagName === "INPUT" || e.target.tagName === "BUTTON") return;
          showDetailMobile(item);
        });
      }

      resultBody.appendChild(tr);
    });

    bindCheckAll();
  }

  /* ========================================================
     14) Desktop è©³ç´°å¡ï¼ˆå·¦å³åˆ†æ¬„ã€ç¸®çª„ä¸æ“‹ï¼‰
  ======================================================== */
  function showDetailDesktop(item) {
    const img = item.imageUrl || "https://placehold.co/300x300?text=No+Image";

    let priceBlock = "";
    if (userLevel >= 1) priceBlock += `<div>50 å€‹ï¼š${item.quote50}</div>`;
    if (userLevel >= 2) priceBlock += `<div>100 å€‹ï¼š${item.quote100}</div><div>300 å€‹ï¼š${item.quote300}</div>`;
    if (userLevel >= 3) priceBlock += `<div>500 å€‹ï¼š${item.quote500}</div><div>1000 å€‹ï¼š${item.quote1000}</div>`;

    detailCard.style.display = "block";
    detailCard.innerHTML = `
      <img src="${img}" style="width:100%;border-radius:10px;border:1px solid #eee;margin-bottom:10px;">
      <div style="font-weight:800;font-size:16px;margin-bottom:8px;">${item.name || "-"}</div>

      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;font-size:13px;line-height:1.6;">
        <div><strong>ä¸»å‹è™Ÿ</strong><br>${item.mainModel || "-"}</div>
        <div><strong>é¡è‰²</strong><br>${item.models?.length>1 ? "å¤šè‰²åˆä½µ" : (item.colorList||"-")}</div>
        <div><strong>è³£å ´</strong><br>${item.marketPrice || 0}</div>
        <div><strong>æœ«å”®</strong><br>${item.minPrice || 0}</div>
        <div style="grid-column:1/-1;">
          <strong>ç¶²å€</strong><br>
          ${item.productUrl ? `<a href="${item.productUrl}" target="_blank">å‰å¾€å•†å“é </a>` : "-"}
        </div>
      </div>

      <div style="font-weight:800;margin:10px 0 6px;">æ¡è³¼åƒ¹æ ¼</div>
      <div style="line-height:1.6;font-size:13px;">${priceBlock || "-"}</div>

      <div style="display:flex; gap:8px; margin-top:12px;">
        <button class="btn-primary line-share-btn" data-model="${item.model}" style="flex:1;">LINE åˆ†äº«</button>
        <button class="btn-outline-add add-quote-btn" data-model="${item.model}" style="flex:1;margin-top:0;">åŠ å…¥å ±åƒ¹å–®</button>
      </div>
    `;
  }

  /* ========================================================
     15) Mobile è©³ç´°å¡ï¼ˆBottom Sheetï¼‰
  ======================================================== */
  function showDetailMobile(item) {
    const img = item.imageUrl || "https://placehold.co/300x300?text=No+Image";

    let priceBlock = "";
    if (userLevel >= 1) priceBlock += `<div>50 å€‹ï¼š${item.quote50}</div>`;
    if (userLevel >= 2) priceBlock += `<div>100 å€‹ï¼š${item.quote100}</div><div>300 å€‹ï¼š${item.quote300}</div>`;
    if (userLevel >= 3) priceBlock += `<div>500 å€‹ï¼š${item.quote500}</div><div>1000 å€‹ï¼š${item.quote1000}</div>`;

    sheetContent.innerHTML = `
      <img src="${img}" style="width:100%;border-radius:10px;border:1px solid #eee;margin-bottom:10px;">
      <div style="font-weight:800;font-size:16px;margin-bottom:8px;">${item.name || "-"}</div>

      <div style="font-size:14px;line-height:1.7;">
        <strong>ä¸»å‹è™Ÿï¼š</strong>${item.mainModel || "-"}<br>
        <strong>é¡è‰²ï¼š</strong>${item.models?.length>1 ? "å¤šè‰²åˆä½µ" : (item.colorList||"-")}<br>
        <strong>è³£å ´å”®åƒ¹ï¼š</strong>${item.marketPrice || 0}<br>
        <strong>æœ«å”®åƒ¹æ ¼ï¼š</strong>${item.minPrice || 0}<br>
        <strong>å•†å“ç¶²å€ï¼š</strong>${item.productUrl ? `<a href="${item.productUrl}" target="_blank">å‰å¾€å•†å“é </a>` : "-"}
      </div>

      <div style="font-weight:800;margin:12px 0 6px;">æ¡è³¼åƒ¹æ ¼</div>
      <div style="line-height:1.6;">${priceBlock || "-"}</div>

      <div style="display:flex; gap:8px; margin-top:12px;">
        <button class="btn-primary line-share-btn" data-model="${item.model}" style="flex:1;">LINE åˆ†äº«</button>
        <button class="btn-outline-add add-quote-btn" data-model="${item.model}" style="flex:1;margin-top:0;">åŠ å…¥å ±åƒ¹å–®</button>
      </div>
    `;
    openSheet();
  }

  /* ========================================================
     16) Sheet é–‹é—œ
  ======================================================== */
  function openSheet() {
    sheetBackdrop.classList.remove("hidden");
    mobileSheet.classList.remove("hidden");
    requestAnimationFrame(() => mobileSheet.classList.add("open"));
  }
  function closeSheet() {
    mobileSheet.classList.remove("open");
    setTimeout(() => {
      mobileSheet.classList.add("hidden");
      if (quoteSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden");
    }, 220);
  }

  function openQuoteSheet() {
    sheetBackdrop.classList.remove("hidden");
    quoteSheet.classList.remove("hidden");
    requestAnimationFrame(()=>quoteSheet.classList.add("open"));
    renderQuoteList();
  }
  function closeQuoteSheet() {
    quoteSheet.classList.remove("open");
    setTimeout(()=>quoteSheet.classList.add("hidden"),220);
    if(mobileSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden");
  }

  /* ========================================================
     17) å‹¾é¸å…¨é¸
  ======================================================== */
  function bindCheckAll() {
    const rowChecks = document.querySelectorAll(".row-check");
    checkAllBox.onchange = () => rowChecks.forEach(c=>c.checked=checkAllBox.checked);
    rowChecks.forEach(chk=>{
      chk.onchange = () => {
        const all = document.querySelectorAll(".row-check");
        const checked = document.querySelectorAll(".row-check:checked");
        checkAllBox.checked = (all.length===checked.length);
      };
    });
  }

  /* ========================================================
     18) å ±åƒ¹å–®ï¼šè¨ˆæ•¸ / æ¸²æŸ“ / æ¯›åˆ©ç‡ï¼ˆä¸é¡¯ç¤ºç¸½è¨ˆï¼‰
  ======================================================== */
  function updateCartCount() {
    cartCount.textContent = quoteList.length;
    if (quoteList.length>0){
      fabCart.classList.remove("hidden");
      fabCart.classList.add("bounce");
      setTimeout(()=>fabCart.classList.remove("bounce"),300);
    } else {
      fabCart.classList.add("hidden");
    }
  }

  function calcMarginPct(cost, market) {
    const c = Number(cost||0);
    const m = Number(market||0);
    if (m <= 0) return null;
    return Math.round(((m - c) / m) * 100);
  }

  function renderQuoteList() {
    quoteListBody.innerHTML = "";
    if (quoteList.length===0){
      quoteListBody.innerHTML = `<div style="text-align:center;padding:40px;color:#999;">å ±åƒ¹å–®æ˜¯ç©ºçš„</div>`;
      return;
    }

    quoteList.forEach((q,idx)=>{
      const marginPct = calcMarginPct(q.price, q.marketPrice);
      const div=document.createElement("div");
      div.className="quote-item";
      div.innerHTML=`
        <div style="flex:1;">
          <div style="font-weight:800;">${q.name}</div>
          <div class="quote-info" style="color:#666;margin-top:2px;">
            ${q.mainModel}ï¼ˆ${q.qtyLabel}ï¼‰<br>
            å–®åƒ¹ï¼š$${q.price}ã€€æ•¸é‡ï¼š${q.count}
          </div>
          <div style="font-size:13px;color:#111827;margin-top:6px;">
            æ¯›åˆ©ç‡ï¼š${marginPct===null ? "-" : marginPct + "%"}
          </div>
        </div>

        <div style="text-align:right;margin-right:8px;">
          <div class="quote-price">$${q.price}</div>
          <div style="font-size:12px;color:#888;">x ${q.count}</div>
        </div>
        <div class="quote-del" data-idx="${idx}">ğŸ—‘ï¸</div>
      `;
      quoteListBody.appendChild(div);
    });

    document.querySelectorAll(".quote-del").forEach(btn=>{
      btn.onclick=(e)=>{
        const i=Number(e.target.getAttribute("data-idx"));
        quoteList.splice(i,1);
        renderQuoteList(); updateCartCount();
      };
    });
  }

  /* ========================================================
     19) å…¨åŸŸ clickï¼šåŠ å…¥å ±åƒ¹å–® / LINE åˆ†äº«
  ======================================================== */
  document.addEventListener("click",(e)=>{
    if(e.target.classList.contains("add-quote-btn")){
      const model=e.target.getAttribute("data-model");
      const item=currentResultList.find(p=>p.model===model);
      if(!item)return;

      const { cost, label } = getSelectedCostInfo(item);

      quoteList.push({
        model:item.model,
        mainModel:item.mainModel,
        name:item.name,
        price:cost,
        qtyLabel:label,
        count:1,
        marketPrice:item.marketPrice
      });

      updateCartCount();
      alert(`å·²åŠ å…¥å ±åƒ¹å–®ï¼ˆ${label}ï¼š$${cost}ï¼‰`);
    }

    if(e.target.classList.contains("line-share-btn")){
      const model=e.target.getAttribute("data-model");
      const item=currentResultList.find(p=>p.model===model);
      if(!item)return;

      let costText="";
      if(userLevel>=1) costText+=`â€¢ 50å€‹ï¼š${item.quote50} å…ƒ\n`;
      if(userLevel>=2) costText+=`â€¢ 100å€‹ï¼š${item.quote100} å…ƒ\nâ€¢ 300å€‹ï¼š${item.quote300} å…ƒ\n`;
      if(userLevel>=3) costText+=`â€¢ 500å€‹ï¼š${item.quote500} å…ƒ\nâ€¢ 1000å€‹ï¼š${item.quote1000} å…ƒ\n`;

      const text=`ğŸ”¥ã€${item.model}ã€‘${item.name}
è³£å ´å”®åƒ¹ï¼š${item.marketPrice}
--------------------
æ¡è³¼åƒ¹æ ¼ï¼š
${costText}
å•†å“é€£çµï¼š${item.productUrl||"ç„¡"}`;

      navigator.clipboard.writeText(text)
        .then(()=>alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿"))
        .catch(()=>alert("è¤‡è£½å¤±æ•—"));
    }
  });

  /* ========================================================
     20) å ±åƒ¹å–®é–‹é—œäº‹ä»¶ï¼ˆå·¥å…·åˆ— + FABï¼‰
  ======================================================== */
  openQuoteBtn.onclick = openQuoteSheet;
  fabCart.onclick = openQuoteSheet;
  quoteCloseBtn.onclick = closeQuoteSheet;

  /* ========================================================
     21) Backdrop / Mobile é—œé–‰
  ======================================================== */
  sheetBackdrop.onclick = () => {
    closeSheet();
    closeQuoteSheet();
  };
  sheetCloseBtn.onclick = closeSheet;

  /* ========================================================
     22) æ¸…ç©ºå ±åƒ¹å–® / è¤‡è£½å ±åƒ¹å–®
  ======================================================== */
  clearQuoteBtn.onclick = () => {
    if(confirm("ç¢ºå®šè¦æ¸…ç©ºå ±åƒ¹å–®å—ï¼Ÿ")){
      quoteList=[];
      renderQuoteList();
      updateCartCount();
      closeQuoteSheet();
    }
  };

  copyQuoteBtn.onclick = () => {
    if(quoteList.length===0)return;

    let text="ğŸ“‹ KINYO å•†å“å ±åƒ¹å–®\n----------------------\n";
    quoteList.forEach((q,i)=>{
      text+=`${i+1}. ã€${q.mainModel}ã€‘${q.name}\n   è¦æ ¼ï¼š${q.qtyLabel} | å–®åƒ¹ï¼š$${q.price} | æ•¸é‡ï¼š${q.count}\n`;
      const m = calcMarginPct(q.price, q.marketPrice);
      text+=`   æ¯›åˆ©ç‡ï¼š${m===null ? "-" : m+"%"}\n`;
    });
    text+="----------------------";

    navigator.clipboard.writeText(text)
      .then(()=>alert("å ±åƒ¹å–®å·²è¤‡è£½"))
      .catch(()=>alert("è¤‡è£½å¤±æ•—"));
  };

  /* ========================================================
     23) æ¸…é™¤æœå°‹æ¢ä»¶
  ======================================================== */
  clearBtn.onclick = () => {
    keywordInput.value="";
    qtySelect.value="";
    minPriceInput.value="";
    maxPriceInput.value="";
    resultBody.innerHTML="";
    resultTable.style.display="none";
    exportBtn.disabled=true;
    detailCard.style.display="none";
    lastSearchMode="";
  };

  /* ========================================================
     24) æ’åºå‹•ä½œ
  ======================================================== */
  sortSelect.onchange = () => {
    if(currentResultList.length>0){
      currentResultList = applySorting([...currentResultList]);
      renderResults(currentResultList);
    }
  };

  /* ========================================================
     25) æœå°‹æŒ‰éˆ•
  ======================================================== */
  document.getElementById("searchBtn").onclick = searchProducts;

  /* ========================================================
     26) åŒ¯å‡º Excelï¼ˆä¸»æœå°‹çµæœï¼‰
        keyword-only â†’ ä¸åŒ¯å‡ºæ¡è³¼åƒ¹
        qty/mixed    â†’ ä¾èµ·è¨‚é‡åŒ¯å‡ºæ¡è³¼åƒ¹
  ======================================================== */
  function exportSelectedExcel() {
    const checked = document.querySelectorAll(".row-check:checked");
    if (checked.length===0){
      alert("è«‹å…ˆå‹¾é¸è¦åŒ¯å‡ºçš„å•†å“");
      return;
    }

    const selectedModels = Array.from(checked).map(c=>c.getAttribute("data-model"));
    const rows = [];
    const headerBase = ["å•†å“å‹è™Ÿ","ä¸»å‹è™Ÿ","å•†å“åç¨±","é¡è‰²","ç®±å…¥æ•¸","å•†å“é€£çµ"];
    let headerFinal = [];

    if (lastSearchMode === "keyword") {
      headerFinal = [...headerBase, "æœ«å”®", "è³£å ´"];
    } else {
      const qty = qtySelect.value || "50";
      headerFinal = [...headerBase, `${qty}å€‹`, "æœ«å”®", "è³£å ´"];
    }

    rows.push(headerFinal);

    selectedModels.forEach(model=>{
      const item = currentResultList.find(p=>p.model===model);
      if(!item)return;

      const base = [
        item.model,
        item.mainModel,
        item.name,
        item.models?.length>1 ? "å¤šè‰²åˆä½µ" : (item.colorList||"-"),
        item.cartonQty || "",
        item.productUrl || ""
      ];

      if (lastSearchMode === "keyword") {
        rows.push([
          ...base,
          item.minPrice || 0,
          item.marketPrice || 0
        ]);
      } else {
        const qty = qtySelect.value || "50";
        const ck = `quote${qty}`;
        const cost = item[ck] || item.quote50;

        rows.push([
          ...base,
          cost,
          item.minPrice || 0,
          item.marketPrice || 0
        ]);
      }
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹");
    XLSX.writeFile(wb, "KINYO_æŸ¥åƒ¹ç³»çµ±_åŒ¯å‡º.xlsx");
  }
  exportBtn.onclick = exportSelectedExcel;

  /* ========================================================
     27) å ±åƒ¹å–® Excel åŒ¯å‡ºï¼ˆä¾å ±åƒ¹å–®å…§å®¹ï¼‰
  ======================================================== */
  quoteExcelBtn.onclick = () => {
    if (quoteList.length === 0) {
      alert("å ±åƒ¹å–®æ˜¯ç©ºçš„");
      return;
    }

    const rows = [];
    rows.push(["ä¸»å‹è™Ÿ","å•†å“åç¨±","æ•¸é‡","æ¡è³¼åƒ¹","è³£å ´åƒ¹","æ¯›åˆ©ç‡"]);

    quoteList.forEach(q=>{
      const margin = calcMarginPct(q.price, q.marketPrice);
      rows.push([
        q.mainModel,
        q.name,
        q.count,
        q.price,
        q.marketPrice,
        margin === null ? "-" : (margin + "%")
      ]);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®");
    XLSX.writeFile(wb, "KINYO_å ±åƒ¹å–®.xlsx");
  };

  /* ========================================================
     28) èµ·è¨‚é‡æ¬Šé™ï¼ˆLevel 1/2/3ï¼‰
  ======================================================== */
  function setupQtySelectByLevel() {
    qtySelect.innerHTML = "";
    const optNone = document.createElement("option");
    optNone.value=""; optNone.textContent="ä¸ä½¿ç”¨èµ·è¨‚é‡";
    qtySelect.appendChild(optNone);

    const add = (v,t)=>{
      const o=document.createElement("option");
      o.value=v; o.textContent=t;
      qtySelect.appendChild(o);
    };

    if (userLevel >= 1) add("50","50 å€‹");
    if (userLevel >= 2) {
      add("100","100 å€‹");
      add("300","300 å€‹");
    }
    if (userLevel >= 3) {
      add("500","500 å€‹");
      add("1000","1000 å€‹");
    }
  }

  /* ========================================================
     29) Firebase Auth
  ======================================================== */
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    currentUserEmail = user.email || "";
    try {
      const userDoc = await getDoc(doc(db,"Users",currentUserEmail.toLowerCase()));
      if (userDoc.exists()) userLevel = userDoc.data().level || 1;
    } catch {
      userLevel = 1;
    }

    userInfoSpan.textContent = `ç™»å…¥å¸³è™Ÿï¼š${currentUserEmail.replace(/@.*/, "")}`;
    logoutBtn.style.display = "inline-block";
    openQuoteBtn.style.display = "inline-block";

    setupQtySelectByLevel();
    preloadProducts();
  });

  logoutBtn.onclick = () => signOut(auth);
</script>

</body>
</html>