<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>KINYO 查價系統</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body { font-family: system-ui; max-width: 900px; margin: 40px auto; background:#f5f5f5; padding:16px;}
.card{background:#fff;padding:16px;border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.06);}
</style>
</head>
<body>
<h1>KINYO 查價系統</h1>
<div class="card">
  <label>帳號</label><br/>
  <input id="acc" /><br/>
  <label>密碼</label><br/>
  <input id="pwd" type="password"/><br/><br/>
  <button onclick="login()">登入</button>
</div>

<br/>
<div class="card">
  <input id="searchInput" placeholder="搜尋型號或名稱" oninput="searchProducts()" style="width:100%;padding:8px;">
  <button id="exportBtn">匯出 Excel</button>
</div>

<div id="results"></div>

<script>
// 假資料示範（實際請替換為 Firestore 取得資料）
const allProducts = [
  {name:"商品A", model:"AA01", barcode:"123", imageUrl:"", category:"", qunto50:100, qunto100:95, qunto300:90, priceRetail:150, priceVIP:140, priceWholesale:130, priceMin:120},
  {name:"商品B", model:"BB02", barcode:"456", imageUrl:"", category:"", qunto50:200, qunto100:190, qunto300:185, priceRetail:260, priceVIP:245, priceWholesale:230, priceMin:220}
];

let currentUserLevel = 1;
let currentSearchResults = [];

// 簡易登入示範
function login(){
  const a = document.getElementById('acc').value;
  const p = document.getElementById('pwd').value;

  if(a==="l1"){ currentUserLevel=1; alert("Level1 登入成功"); }
  else if(a==="l2"){ currentUserLevel=2; alert("Level2 登入成功"); }
  else if(a==="l3"){ currentUserLevel=3; alert("Level3 登入成功"); }
  else { alert("帳密錯誤"); return; }
}

// 搜尋
function searchProducts(){
  const key = document.getElementById('searchInput').value.trim();
  currentSearchResults = allProducts.filter(p => 
    p.name.includes(key) || p.model.includes(key)
  );
  renderResults();
}

function renderResults(){
  const div = document.getElementById("results");
  div.innerHTML = "";
  currentSearchResults.forEach(p => {
    const item = document.createElement("div");
    item.className="card";
    item.style.marginTop="10px";
    item.innerHTML = `<b>${p.name}</b> / ${p.model}<br/>條碼：${p.barcode}`;
    div.appendChild(item);
  });
}

// 權限欄位設定
const priceFieldsByLevel = {
  1: ["qunto50"],
  2: ["qunto50", "qunto100", "qunto300"],
  3: ["qunto50", "qunto100", "qunto300", "priceRetail", "priceVIP", "priceWholesale", "priceMin"]
};

// 匯出 Excel 主程式
function exportToExcel(filteredData, userLevel) {
  const baseFields = ["name", "model", "barcode", "imageUrl", "category"];
  const allowedPriceFields = priceFieldsByLevel[userLevel];
  const finalFields = [...baseFields, ...allowedPriceFields];

  const exportData = filteredData.map(item => {
    const obj = {};
    finalFields.forEach(f => { obj[f] = item[f] || ""; });
    return obj;
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.json_to_sheet(exportData);
  XLSX.utils.book_append_sheet(wb, ws, "products");
  XLSX.writeFile(wb, "products.xlsx");
}

document.getElementById("exportBtn").addEventListener("click", () => {
  exportToExcel(currentSearchResults, currentUserLevel);
});
</script>
</body>
</html>
