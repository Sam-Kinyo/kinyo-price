<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>KINYO 查價系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 900px;
      margin: 40px auto;
      padding: 0 16px 40px;
      background: #f5f5f5;
    }

    h1 { margin-bottom: 4px; }
    .subtitle { color: #666; margin-bottom: 20px; }

    .search-box {
      background: #fff;
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.06);
      margin-bottom: 12px;
    }

    .search-row { margin-bottom: 12px; }

    label { font-weight: 600; }

    input, select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
    }

    .btn-primary {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: white;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
    }

    .btn-secondary {
      padding: 8px 16px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background: #fff;
      color: #111827;
      font-size: 14px;
      cursor: pointer;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 4px;
      background: white;
      border-radius: 10px;
      overflow: hidden;
    }

    th, td {
      padding: 10px 8px;
      border-bottom: 1px solid #eee;
      font-size: 14px;
      vertical-align: top;
    }

    th {
      background: #f9fafb;
      text-align: left;
    }

    .product-img {
      width: 70px;
      height: 70px;
      border-radius: 8px;
      object-fit: cover;
      border: 1px solid #ddd;
    }

    /* 價格標籤顏色 */
    .price-tag {
      font-weight: 600;
      padding: 3px 8px;
      border-radius: 6px;
      display: inline-block;
      font-size: 14px;
      margin-right: 6px;
      margin-bottom: 4px;
    }
    .tag50  { background:#dbeafe; color:#1e40af; }
    .tag100 { background:#e0f2fe; color:#0369a1; }
    .tag300 { background:#dcfce7; color:#15803d; }
    .tag500 { background:#ffedd5; color:#ea580c; }
    .tag1000{ background:#fee2e2; color:#b91c1c; }

    /* 電腦版右側詳細資訊 */
    #detailCard {
      display:none;
      background:white;
      padding:20px;
      border-radius:12px;
      box-shadow:0 2px 6px rgba(0,0,0,0.08);
      margin-top:20px;
      font-size:14px;
    }

    /* 手機版 Bottom Sheet */
    #mobileDetail {
      display:none;
      position: fixed;
      bottom:0;
      left:0;
      width:100%;
      max-height:80%;
      overflow-y:auto;
      background:white;
      border-radius:16px 16px 0 0;
      box-shadow:0 -2px 12px rgba(0,0,0,0.15);
      z-index:9999;
      padding:10px 14px;
    }

    /* 手機 UI 優化 */
    @media (max-width: 600px) {
      body { margin: 20px auto; padding: 0 12px 40px; }

      .search-box { padding: 12px; }
      .search-row label { font-size: 14px; }
      input, select { font-size: 14px; padding: 6px 10px; }
      .product-img { width: 55px; height: 55px; }
      table th, table td { padding: 6px; font-size: 13px; }
      #detailCard { display:none !important; } /* 手機隱藏右側欄 */

      .btn-primary, .btn-secondary { padding: 8px 12px; font-size: 14px; }
    }
  </style>
</head>

<body>

<h1>KINYO 查價系統</h1>
<div class="subtitle">輸入商品型號或名稱，可依起訂量與預算查詢並匯出 Excel。</div>

<!-- 搜尋區塊 -->
<div class="search-box">

  <div class="search-row">
    <label>關鍵字搜尋（型號 / 名稱）：</label>
    <input id="keyword" placeholder="如：CL528 / 除毛球機" />
  </div>

  <div class="search-row">
    <label>選擇起訂量：</label>
    <select id="qtySelect">
      <option value="">不使用起訂量</option>
      <option value="50">50 個</option>
      <option value="100">100 個</option>
      <option value="300">300 個</option>
      <option value="500">500 個</option>
      <option value="1000">1000 個</option>
    </select>
  </div>

  <div class="search-row">
    <label>預算區間（需先選起訂量）：</label>
    <div style="display:flex; gap:6px;">
      <input id="minPrice" type="number" placeholder="最低金額" />
      <input id="maxPrice" type="number" placeholder="最高金額" />
    </div>
  </div>

  <button id="searchBtn" class="btn-primary">查詢</button>
  <button id="clearBtn" class="btn-secondary" style="margin-top:10px;width:100%;">清除搜尋條件</button>

</div>

<!-- 工具列：排序 + 匯出 -->
<div class="toolbar" style="display:flex; gap:10px; align-items:center; margin-bottom:6px;">
  <select id="sortSelect" class="btn-secondary" style="flex:1;">
    <option value="">不排序</option>
    <option value="minPriceAsc">末售：低 → 高</option>
    <option value="minPriceDesc">末售：高 → 低</option>
    <option value="marketAsc">賣場：低 → 高</option>
    <option value="marketDesc">賣場：高 → 低</option>
  </select>

  <button id="exportBtn" class="btn-secondary" disabled>匯出勾選 Excel</button>
</div>

<!-- 結果表格 -->
<table id="resultTable" style="display:none;">
  <thead>
    <tr>
      <th style="width:32px;"><input type="checkbox" id="checkAll" /></th>
      <th style="width:80px;">圖片</th>
      <th style="width:90px;">型號</th>
      <th>商品資訊</th>
      <th style="width:80px;">末售</th>
      <th style="width:80px;">賣場</th>
    </tr>
  </thead>
  <tbody id="resultBody"></tbody>
</table>

<!-- 電腦版右側詳細資訊 -->
<div id="detailCard"></div>

<!-- 手機版 Bottom Sheet -->
<div id="mobileDetail"></div>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
  // Firebase 設定（與 login.html 相同）
  const firebaseConfig = {
    apiKey: "AIzaSyDtp6rwV7KmIOedLQ9793BnXbBquopP9kM",
    authDomain: "kinyo-price.firebaseapp.com",
    projectId: "kinyo-price",
    storageBucket: "kinyo-price.firebasestorage.app",
    messagingSenderId: "122464645678",
    appId: "1:122464645678:web:c0febbc6297a8ada5ea5bf",
  };

  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  import { 
    getFirestore, collection, getDocs 
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
  import {
    getAuth, onAuthStateChanged, signOut
  } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";

  // 初始化
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  // 全域變數
  let currentUser = null;
  let currentUserLevel = 1;      // 1 / 2 / 3
  let currentResultList = [];    // 目前搜尋結果（主品項後的清單）

  // DOM 元素
  const keywordInput   = document.getElementById("keyword");
  const qtySelect      = document.getElementById("qtySelect");
  const minPriceInput  = document.getElementById("minPrice");
  const maxPriceInput  = document.getElementById("maxPrice");
  const searchBtn      = document.getElementById("searchBtn");
  const clearBtn       = document.getElementById("clearBtn");
  const exportBtn      = document.getElementById("exportBtn");
  const sortSelect     = document.getElementById("sortSelect");
  const resultBody     = document.getElementById("resultBody");
  const resultTable    = document.getElementById("resultTable");
  const detailCard     = document.getElementById("detailCard");
  const mobileDetail   = document.getElementById("mobileDetail");
  const checkAllBox    = document.getElementById("checkAll");

  // 這裡可以先簡單用帳號（email）對應等級，之後你要再改成 Firestore 也可以
  // 你可以依實際帳號調整這個對照表
  const USER_LEVEL_MAP = {
    "kinyo001@kinyo.com": 1,
    "kinyo002@kinyo.com": 2,
    "kinyo003@kinyo.com": 3
  };

  function getLevelFromEmail(email) {
    if (!email) return 1;
    return USER_LEVEL_MAP[email] || 1;
  }

  // 依照 Level 調整「起訂量下拉選單」可選項目
  function adjustQtyOptionsByLevel() {
    const allOptions = [
      { value: "",    text: "不使用起訂量" },
      { value: "50",  text: "50 個" },
      { value: "100", text: "100 個" },
      { value: "300", text: "300 個" },
      { value: "500", text: "500 個" },
      { value: "1000",text: "1000 個" },
    ];

    let allowedValues = [];
    if (currentUserLevel === 1) {
      allowedValues = ["", "50"];
    } else if (currentUserLevel === 2) {
      allowedValues = ["", "50", "100", "300"];
    } else {
      allowedValues = ["", "50", "100", "300", "500", "1000"];
    }

    // 重建下拉選單
    qtySelect.innerHTML = "";
    allOptions.forEach(opt => {
      if (allowedValues.includes(opt.value)) {
        const o = document.createElement("option");
        o.value = opt.value;
        o.textContent = opt.text;
        qtySelect.appendChild(o);
      }
    });
  }

  // 判斷目前 Level 可以看到哪些價格欄位（後面搜尋 + 渲染會用到）
  function getVisibleQuoteFields() {
    if (currentUserLevel === 1) {
      return ["quote50"];
    } else if (currentUserLevel === 2) {
      return ["quote50", "quote100", "quote300"];
    } else {
      return ["quote50", "quote100", "quote300", "quote500", "quote1000"];
    }
  }

  // 登入狀態監聽：未登入 → 強制回 login.html
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "login.html";
      return;
    }

    currentUser = user;
    currentUserLevel = getLevelFromEmail(user.email);
    console.log("登入帳號：", user.email, "等級：", currentUserLevel);

    // 根據等級調整 UI（起訂量選項）
    adjustQtyOptionsByLevel();
  });

  // 後面第 4、5 段：會接續在這個 <script type="module"> 裡
  // 包含：
  // - 搜尋 / 主品項合併
  // - 渲染結果（依 Level 顯示不同價格）
  // - 詳細資訊（桌機 + 手機）
  // - 匯出 Excel

  /* ============================================================
   *  主品項整併：去掉型號後面的英文字元（顏色）
   *  EX: CL528R → CL528
   *      JR321W → JR321
   * ============================================================ */
  function getMainModel(model) {
    if (!model) return model;
    return model.replace(/[A-Z]$/i, "");  // 移除結尾一個英文字母
  }

  /* ============================================================
   *  排序功能
   * ============================================================ */
  function applySorting(list) {
    const opt = sortSelect.value;

    if (opt === "minPriceAsc")  return list.sort((a,b)=>a.minPrice - b.minPrice);
    if (opt === "minPriceDesc") return list.sort((a,b)=>b.minPrice - a.minPrice);
    if (opt === "marketAsc")    return list.sort((a,b)=>a.marketPrice - b.marketPrice);
    if (opt === "marketDesc")   return list.sort((a,b)=>b.marketPrice - a.marketPrice);

    return list;
  }

  /* ============================================================
   *  Firestore 抓商品 + 搜尋邏輯
   * ============================================================ */
  async function searchProducts() {
    const kw = keywordInput.value.trim().toLowerCase();
    const qty = qtySelect.value;
    const minP = minPriceInput.value;
    const maxP = maxPriceInput.value;

    // 預算區間錯誤檢查
    if (!qty && (minP || maxP)) {
      alert("請先選擇起訂量，才能使用預算區間搜尋");
      return;
    }

    if (qty && (!minP || !maxP)) {
      alert("請輸入完整的預算區間（最低金額 + 最高金額）");
      return;
    }

    const snap = await getDocs(collection(db, "Products"));
    let rawList = [];
    snap.forEach(doc => rawList.push(doc.data()));

    /* ============================================================
     *  主品項整併
     * ============================================================ */
    let merged = {};
    rawList.forEach(item => {
      const main = getMainModel(item.model);
      if (!merged[main]) merged[main] = item;
    });

    let list = Object.values(merged);

    /* ============================================================
     *  模糊搜尋（型號 / 名稱）
     * ============================================================ */
    if (kw) {
      list = list.filter(item =>
        (item.model && item.model.toLowerCase().includes(kw)) ||
        (item.name  && item.name.toLowerCase().includes(kw))
      );
    }

    /* ============================================================
     *  起訂量 + 預算區間
     * ============================================================ */
    if (qty && minP && maxP) {
      const mapping = {
        "50": "quote50",
        "100": "quote100",
        "300": "quote300",
        "500": "quote500",
        "1000": "quote1000"
      };
      const field = mapping[qty];

      list = list.filter(item =>
        item[field] >= Number(minP) &&
        item[field] <= Number(maxP)
      );
    }

    /* ============================================================
     *  套用排序
     * ============================================================ */
    list = applySorting(list);

    currentResultList = list;
    renderResults(list);
  }

  /* ============================================================
   *  清除搜尋條件
   * ============================================================ */
  clearBtn.addEventListener("click", () => {
    keywordInput.value = "";
    qtySelect.value = "";
    minPriceInput.value = "";
    maxPriceInput.value = "";
    sortSelect.value = "";

    resultTable.style.display = "none";
    resultBody.innerHTML = "";
    detailCard.style.display = "none";
    mobileDetail.style.display = "none";
    exportBtn.disabled = true;
  });

  /* ============================================================
   *  渲染結果表格（依 Level 顯示不同價格）
   * ============================================================ */
  function renderResults(list) {
    resultBody.innerHTML = "";
    detailCard.style.display = "none";
    mobileDetail.style.display = "none";
    checkAllBox.checked = false;

    if (list.length === 0) {
      resultTable.style.display = "none";
      exportBtn.disabled = true;
      alert("查無符合商品");
      return;
    }

    resultTable.style.display = "table";
    exportBtn.disabled = false;

    const visibleFields = getVisibleQuoteFields();

    list.forEach(item => {
      const img = item.imageUrl || "https://placehold.co/120x120?text=No+Image";

      let priceHtml = "";
      visibleFields.forEach(f => {
        if (f === "quote50")   priceHtml += `<span class="price-tag tag50">50個：${item.quote50}</span>`;
        if (f === "quote100")  priceHtml += `<span class="price-tag tag100">100個：${item.quote100}</span>`;
        if (f === "quote300")  priceHtml += `<span class="price-tag tag300">300個：${item.quote300}</span>`;
        if (f === "quote500")  priceHtml += `<span class="price-tag tag500">500個：${item.quote500}</span>`;
        if (f === "quote1000") priceHtml += `<span class="price-tag tag1000">1000個：${item.quote1000}</span>`;
      });

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input type="checkbox" class="row-check" data-model="${item.model}" /></td>
        <td><img src="${img}" class="product-img" /></td>
        <td>${item.model}</td>
        <td>
          <div style="font-weight:600;margin-bottom:4px;">${item.name}</div>
          <div style="font-size:13px;line-height:1.6;">${priceHtml}</div>
        </td>
        <td style="text-align:right;">${item.minPrice} 元</td>
        <td style="text-align:right;">${item.marketPrice} 元</td>
      `;

      // 桌機版：點整行顯示右側詳細資訊
      tr.addEventListener("click", (e) => {
        if (window.innerWidth < 600) return; // 手機不開 detailCard
        if (e.target.classList.contains("row-check") || e.target.tagName === "IMG") return;
        showDetail(item);
      });

      // 手機版：點擊則打開 bottom sheet
      tr.addEventListener("click", (e) => {
        if (window.innerWidth >= 600) return;
        if (e.target.classList.contains("row-check") || e.target.tagName === "IMG") return;
        showMobileDetail(item);
      });

      resultBody.appendChild(tr);
    });

    bindCheckAll();
  }

  /* ============================================================
   *  全選勾選框
   * ============================================================ */
  function bindCheckAll() {
    const rowChecks = document.querySelectorAll(".row-check");

    checkAllBox.addEventListener("change", () => {
      rowChecks.forEach(chk => chk.checked = checkAllBox.checked);
    });

    rowChecks.forEach(chk => {
      chk.addEventListener("change", () => {
        const all = document.querySelectorAll(".row-check");
        const checked = document.querySelectorAll(".row-check:checked");
        checkAllBox.checked = (all.length === checked.length);
      });
    });
  }

  /* ============================================================
   *  綁定搜尋事件（按 Enter 也能搜尋）
   * ============================================================ */
  [keywordInput, qtySelect, minPriceInput, maxPriceInput].forEach(el => {
    el.addEventListener("keydown", e => {
      if (e.key === "Enter") searchProducts();
    });
  });

  searchBtn.addEventListener("click", searchProducts);

  /* ============================================================
   *  電腦版詳細資料（右側卡片）
   *  順序：
   *  商品型號 → 國際條碼 → 箱入數 → 商品網址
   *  價格資訊兩行排列 → 特色 → 規格
   * ============================================================ */
  function showDetail(item) {
    const img = item.imageUrl || "https://placehold.co/300x300?text=No+Image";
    detailCard.style.display = "block";
    mobileDetail.style.display = "none";

    detailCard.innerHTML = `
      <img src="${img}" style="width:240px;border-radius:12px;margin-bottom:16px;border:1px solid #ddd;" />

      <h2 style="margin-bottom:12px;">${item.name}</h2>

      <p><strong>商品型號：</strong> ${item.model}</p>
      <p><strong>國際條碼：</strong> ${item.barcode || "－"}</p>
      <p><strong>箱入數：</strong> ${item.cartonQty || "－"}</p>

      <p><strong>商品網址：</strong>
        ${item.productUrl 
          ? `<a href="${item.productUrl}" target="_blank">${item.productUrl}</a>` 
          : "－"}
      </p>

      <h3 style="margin-top:18px;">價格資訊</h3>

      <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;">
        <span class="price-tag tag50">50 個：${item.quote50}</span>
        <span class="price-tag tag100">100 個：${item.quote100}</span>

        <span class="price-tag tag300">300 個：${item.quote300}</span>
        <span class="price-tag tag500">500 個：${item.quote500}</span>

        <span class="price-tag tag1000">1000 個：${item.quote1000}</span>

        <span class="price-tag" style="background:#e5e7eb;color:#111827;">末售：${item.minPrice}</span>
        <span class="price-tag" style="background:#e5e7eb;color:#111827;">賣場：${item.marketPrice}</span>
      </div>

      <h3 style="margin-top:20px;">商品特色</h3>
      <pre style="
          white-space: pre-wrap;
          background:#f9fafb;
          padding:12px;
          border-radius:8px;
          border:1px solid #eee;
          font-size:14px;
      ">${item.features ? item.features : "－"}</pre>

      <h3 style="margin-top:20px;">商品規格</h3>
      <pre style="
          white-space: pre-wrap;
          background:#f9fafb;
          padding:12px;
          border-radius:8px;
          border:1px solid #eee;
          font-size:14px;
      ">${item.specs ? item.specs : "－"}</pre>
    `;
  }

  /* ============================================================
   *  手機版 Bottom Sheet 詳細資料
   *  排版與桌機版一致
   * ============================================================ */
  function showMobileDetail(item) {
    detailCard.style.display = "none";
    mobileDetail.style.display = "block";

    mobileDetail.innerHTML = `
      <div style="padding:16px;">

        <img src="${item.imageUrl || "https://placehold.co/300x300?text=No+Image"}"
             style="width:100%; max-width:260px; display:block; margin:0 auto 16px; border-radius:12px; border:1px solid #ddd;" />

        <h2 style="margin-bottom:12px; font-size:20px; text-align:center;">${item.name}</h2>

        <p><strong>商品型號：</strong> ${item.model}</p>
        <p><strong>國際條碼：</strong> ${item.barcode || "－"}</p>
        <p><strong>箱入數：</strong> ${item.cartonQty || "－"}</p>

        <p style="margin-top:6px;"><strong>商品網址：</strong>
          ${item.productUrl
            ? `<a href="${item.productUrl}" target="_blank">${item.productUrl}</a>`
            : "－"}
        </p>

        <h3 style="margin-top:18px;">價格資訊</h3>

        <div style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;">
          <span class="price-tag tag50">50 個：${item.quote50}</span>
          <span class="price-tag tag100">100 個：${item.quote100}</span>

          <span class="price-tag tag300">300 個：${item.quote300}</span>
          <span class="price-tag tag500">500 個：${item.quote500}</span>

          <span class="price-tag tag1000">1000 個：${item.quote1000}</span>

          <span class="price-tag" style="background:#e5e7eb;color:#111827;">末售：${item.minPrice}</span>
          <span class="price-tag" style="background:#e5e7eb;color:#111827;">賣場：${item.marketPrice}</span>
        </div>

        <h3 style="margin-top:20px;">商品特色</h3>
        <pre style="
            white-space: pre-wrap;
            background:#f9fafb;
            padding:12px;
            border-radius:8px;
            border:1px solid #eee;
            font-size:14px;
        ">${item.features ? item.features : "－"}</pre>

        <h3 style="margin-top:20px;">商品規格</h3>
        <pre style="
            white-space: pre-wrap;
            background:#f9fafb;
            padding:12px;
            border-radius:8px;
            border:1px solid #eee;
            font-size:14px;
        ">${item.specs ? item.specs : "－"}</pre>

        <button onclick="closeMobileDetail()"
            style="margin-top:20px; width:100%; padding:12px; background:#111827; color:white; border:none; border-radius:8px;">
            關閉
        </button>

      </div>
    `;
  }

  // 手機 Bottom Sheet 關閉
  window.closeMobileDetail = function() {
    mobileDetail.style.display = "none";
  };

  /* ============================================================
   *  匯出勾選 Excel
   *  - 只匯出目前 Level 可見的數量價格
   *  - 一律包含：型號 / 名稱 / 箱入數 / 末售 / 賣場 / 商品網址
   * ============================================================ */
  function exportSelectedExcel() {
    const checkedBoxes = document.querySelectorAll(".row-check:checked");
    if (checkedBoxes.length === 0) {
      alert("請先勾選要匯出的商品");
      return;
    }

    const visibleFields = getVisibleQuoteFields();

    const header = [
      "商品型號",
      "商品名稱",
      "箱入數",
    ];

    if (visibleFields.includes("quote50"))   header.push("50 個報價");
    if (visibleFields.includes("quote100"))  header.push("100 個報價");
    if (visibleFields.includes("quote300"))  header.push("300 個報價");
    if (visibleFields.includes("quote500"))  header.push("500 個報價");
    if (visibleFields.includes("quote1000")) header.push("1000 個報價");

    header.push("末售價格", "賣場價格", "商品網址");

    const rows = [];
    rows.push(header);

    const selectedModels = Array.from(checkedBoxes).map(chk => chk.getAttribute("data-model"));

    selectedModels.forEach(model => {
      const item = currentResultList.find(p => p.model === model);
      if (!item) return;

      const row = [
        item.model,
        item.name,
        item.cartonQty,
      ];

      if (visibleFields.includes("quote50"))   row.push(item.quote50);
      if (visibleFields.includes("quote100"))  row.push(item.quote100);
      if (visibleFields.includes("quote300"))  row.push(item.quote300);
      if (visibleFields.includes("quote500"))  row.push(item.quote500);
      if (visibleFields.includes("quote1000")) row.push(item.quote1000);

      row.push(
        item.minPrice,
        item.marketPrice,
        item.productUrl || ""
      );

      rows.push(row);
    });

    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "報價");

    XLSX.writeFile(wb, "KINYO_勾選商品.xlsx");
  }

  // 排序選單變更時重新排序並渲染
  sortSelect.addEventListener("change", () => {
    if (currentResultList.length > 0) {
      const sorted = applySorting([...currentResultList]);
      renderResults(sorted);
    }
  });

  // 匯出按鈕事件
  exportBtn.addEventListener("click", exportSelectedExcel);

</script>

</body>
</html>
