<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>KINYO æŸ¥åƒ¹ç³»çµ±ï¼ˆv4.6ãƒ»æœ€å®Œæ•´æ•´åˆç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* ---------------------------
   v4.6 â€” C ç‰ˆ ìµœì¢…æ•´åˆ CSS
   æ–°å¢ï¼šLoading / Detail ä¸æ“‹ç‰ˆ / å·¥å…·åˆ—æ•´åˆ
----------------------------*/
:root{
  --bg:#f5f6f8;
  --card:#ffffff;
  --primary:#111827;
  --border:#e5e7eb;
  --text:#1f2937;
  --muted:#6b7280;
  --radius:12px;
  --shadow:0 4px 12px rgba(0,0,0,0.06);
}

body{
  margin:0;
  padding:24px;
  background:var(--bg);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--text);
  max-width:980px;
  margin:0 auto;
}

h1{margin:0 0 4px;}
.subtitle{color:var(--muted);margin-bottom:18px;font-size:14px;}

/* Top Bar */
.top-bar{
  display:flex;
  justify-content:flex-end;
  align-items:center;
  gap:12px;
  margin-bottom:14px;
  font-size:13px;
}
.user-badge{
  background:#eef0f4;
  padding:6px 14px;
  border-radius:999px;
}
.logout-btn{
  padding:6px 14px;
  border-radius:999px;
  border:1px solid var(--border);
  cursor:pointer;
  background:white;
  font-size:12px;
}

/* Search Box */
.search-box{
  background:var(--card);
  padding:18px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  margin-bottom:12px;
}
.search-row{margin-bottom:14px;}
label{font-weight:600;margin-bottom:6px;display:block;font-size:14px;}

input,select{
  width:100%;
  padding:10px 12px;
  border-radius:8px;
  border:1px solid #d1d5db;
  font-size:15px;
  box-sizing:border-box;
}

/* Buttons */
.btn-primary{
  background:var(--primary);
  color:white;
  border:none;
  border-radius:999px;
  padding:12px 20px;
  font-weight:600;
  cursor:pointer;
  width:100%;
}
.btn-primary:disabled{
  opacity:.55;
  cursor:not-allowed;
}
.btn-secondary{
  background:white;
  border:1px solid var(--border);
  padding:10px 16px;
  border-radius:999px;
  cursor:pointer;
  font-size:14px;
}
.btn-secondary:disabled{
  opacity:.6;
  cursor:not-allowed;
}
.btn-outline-add{
  padding:6px 12px;
  border-radius:6px;
  border:1px solid #2563eb;
  background:#eff6ff;
  color:#2563eb;
  font-size:12px;
  cursor:pointer;
  font-weight:600;
}
.btn-outline-add:hover{background:#dbeafe;}

/* Toolbar */
.toolbar{
  display:flex;
  gap:10px;
  align-items:center;
  margin:10px 0 6px;
}
.toolbar select{flex:1;}
.toolbar .btn-secondary{
  white-space:nowrap;
}

/* Table */
table{
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:var(--radius);
  overflow:hidden;
  box-shadow:var(--shadow);
}
th,td{
  padding:12px 10px;
  border-bottom:1px solid var(--border);
  font-size:14px;
  vertical-align:top;
}
th{background:#fafafa;text-align:left;}

/* Images */
.product-img{
  width:110px;height:110px;
  object-fit:cover;
  border-radius:8px;
  border:1px solid #e5e7eb;
  background:#fff;
}

/* Price Tags */
.price-tag{
  padding:3px 8px;
  font-size:12px;
  border-radius:6px;
  display:inline-block;
  margin-right:6px;
  margin-bottom:4px;
  font-weight:600;
  white-space:nowrap;
}
.tag50{background:#dbeafe;color:#1e40af;}
.tag100{background:#e0f2fe;color:#0369a1;}
.tag300{background:#dcfce7;color:#15803d;}
.tag500{background:#ffedd5;color:#ea580c;}
.tag1000{background:#fee2e2;color:#b91c1c;}

/* Loading overlay (å–ä»£ alert) */
#loadingOverlay{
  position:fixed; inset:0;
  background:rgba(245,246,248,.8);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
.loading-card{
  background:#fff;
  padding:16px 18px;
  border-radius:12px;
  box-shadow:var(--shadow);
  display:flex; align-items:center; gap:12px;
  font-size:14px; color:#111827; font-weight:600;
}
.spinner{
  width:18px;height:18px;border-radius:50%;
  border:3px solid #e5e7eb;
  border-top-color:#111827;
  animation:spin 0.9s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg);}}

/* Detail Card (Desktop hover) â€” ç¸®çª„é¿å…æ“‹åˆ—è¡¨ */
#detailCard{
  position:fixed;
  right:16px;
  top:110px;
  width:300px;              /* v4.6 ç¸®çª„ */
  max-height:78vh;
  overflow-y:auto;
  background:white;
  padding:16px;
  border-radius:var(--radius);
  box-shadow:var(--shadow);
  display:none;
  z-index:999;
  opacity:0;
  transform:translateY(6px);
  transition:opacity .15s ease, transform .15s ease;
}
#detailCard.show{
  opacity:1;
  transform:translateY(0);
}

/* Sheet (Mobile Detail & Quote) */
.sheet-backdrop{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.45);
  z-index:1000;
}
.sheet{
  position:fixed;left:0;right:0;bottom:0;
  height:80vh;background:#fff;
  border-radius:16px 16px 0 0;
  transform:translateY(100%);
  transition:transform .25s ease;
  display:flex;flex-direction:column;
  z-index:1001;
}
.sheet.open{transform:translateY(0);}
.sheet-header{
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  font-weight:600;
  display:flex;justify-content:space-between;align-items:center;
}
.sheet-close{
  background:none;border:none;
  font-size:26px;cursor:pointer;line-height:1;
}
.sheet-content{
  padding:16px;overflow-y:auto;font-size:15px;flex:1;
}
.hidden{display:none!important;}

/* Quote list */
.quote-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 0;border-bottom:1px solid #eee;
}
.quote-info{font-size:14px;}
.quote-price{font-weight:700;color:#2563eb;}
.quote-del{color:#999;cursor:pointer;padding:6px;font-size:16px;}
.quote-del:hover{color:#ef4444;}
.quote-footer{
  border-top:1px solid #eee;
  padding-top:12px;margin-top:10px;
}
.quote-metric{
  font-size:13px;color:#374151;margin-top:8px;line-height:1.6;
}

/* FAB cart (ä¿ç•™ï¼Œä½†æ¡Œæ©Ÿæ”¹ç”¨å·¥å…·åˆ—æŒ‰éˆ•ä¹Ÿå¯æ‰“é–‹) */
.fab-cart{
  position:fixed;
  bottom:26px;right:22px;
  width:62px;height:62px;
  background:#111827;color:#fff;
  border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  box-shadow:0 6px 16px rgba(0,0,0,0.25);
  cursor:pointer;z-index:990;
}
.fab-badge{
  position:absolute;top:-2px;right:-2px;
  background:#ef4444;color:#fff;
  font-size:12px;font-weight:700;
  width:22px;height:22px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  border:2px solid #fff;
}
.bounce{animation:bounce .3s ease-in-out;}
@keyframes bounce{
  0%,100%{transform:scale(1);}
  50%{transform:scale(1.2);}
}

/* RWD */
@media (max-width:1200px){
  #detailCard{ width:270px; }
}
@media (max-width:900px){
  #detailCard{display:none!important;}
}
@media (max-width:600px){
  body{padding:14px;}
  .search-box{padding:14px;}
  input,select{font-size:14px;}
  .product-img{width:90px;height:90px;}
  th,td{padding:8px 6px;font-size:13px;}
  .price-tag-container{
    display:grid;grid-template-columns:repeat(2,1fr);
    gap:4px 6px;margin-bottom:4px;
  }
  .price-tag{width:100%;text-align:center;margin:0;}
}
</style>
</head>
<body>

<!-- Loading è¦†è“‹å±¤ï¼ˆå–ä»£ alertï¼‰ -->
<div id="loadingOverlay">
  <div class="loading-card">
    <div class="spinner"></div>
    <span>å•†å“è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™â€¦</span>
  </div>
</div>

<!-- Top Bar -->
<div class="top-bar">
  <span id="userInfo" class="user-badge">æœªç™»å…¥</span>
  <button id="logoutBtn" class="logout-btn" style="display:none;">ç™»å‡º</button>
</div>

<h1>KINYO æŸ¥åƒ¹ç³»çµ±</h1>
<div class="subtitle">åŒä¸»å‹è™Ÿè‡ªå‹•åˆä½µï¼Œä¸åŒé¡è‰²åƒ…é¡¯ç¤ºä¸€ç­†ï¼ˆv4.6ï¼‰</div>

<!-- æœå°‹å€ -->
<div class="search-box">

  <div class="search-row">
    <label>é—œéµå­—æœå°‹ï¼ˆå‹è™Ÿ / åç¨±ï¼‰</label>
    <input id="keyword" placeholder="å¦‚ï¼šCL528 / æ•èšŠç‡ˆ / é™¤æ¯›çƒæ©Ÿ" />
  </div>

  <div class="search-row">
    <label>èµ·è¨‚é‡ï¼ˆå¯ä¸é¸ï¼‰</label>
    <select id="qtySelect"></select>
  </div>

  <div class="search-row">
    <label>é ç®—å€é–“ï¼ˆèµ·è¨‚é‡å·²é¸æ™‚æ‰ç”Ÿæ•ˆï¼›å¯åªå¡«ä¸€é‚Šï¼‰</label>
    <div style="display:flex; gap:10px;">
      <input id="minPrice" type="number" placeholder="æœ€ä½ (å¯ç©º)">
      <input id="maxPrice" type="number" placeholder="æœ€é«˜ (å¯ç©º)">
    </div>
  </div>

  <!-- æŸ¥è©¢æŒ‰éˆ•æœƒåœ¨ç”¢å“æœªè¼‰å…¥æ™‚ disabled -->
  <button id="searchBtn" class="btn-primary" disabled>æŸ¥è©¢</button>
  <button id="clearBtn" class="btn-secondary" style="margin-top:10px;width:100%;">æ¸…é™¤æœå°‹æ¢ä»¶</button>
</div>

<!-- å·¥å…·åˆ—ï¼ˆæ’åº + åŒ¯å‡º + å ±åƒ¹å–®ï¼‰ -->
<div class="toolbar">
  <select id="sortSelect" class="btn-secondary">
    <option value="">ä¸æ’åº</option>
    <option value="minPriceAsc">æœ«å”®ï¼šä½ â†’ é«˜</option>
    <option value="minPriceDesc">æœ«å”®ï¼šé«˜ â†’ ä½</option>
    <option value="marketAsc">è³£å ´ï¼šä½ â†’ é«˜</option>
    <option value="marketDesc">è³£å ´ï¼šé«˜ â†’ ä½</option>
    <option value="alphaAsc">ä¸»å‹è™Ÿï¼šA â†’ Z</option>
    <option value="alphaDesc">ä¸»å‹è™Ÿï¼šZ â†’ A</option>
  </select>

  <button id="exportBtn" class="btn-secondary" disabled>åŒ¯å‡º Excel</button>
  <button id="openQuoteBtn" class="btn-secondary">å ±åƒ¹å–®</button>
</div>

<!-- çµæœè¡¨æ ¼ -->
<table id="resultTable" style="display:none;">
  <thead>
    <tr>
      <th style="width:32px;"><input type="checkbox" id="checkAll" /></th>
      <th style="width:120px;">åœ–ç‰‡</th>
      <th style="width:100px;">ä¸»å‹è™Ÿ</th>
      <th>å•†å“è³‡è¨Š</th>
      <th style="width:80px;">æœ«å”®</th>
      <th style="width:80px;">è³£å ´</th>
    </tr>
  </thead>
  <tbody id="resultBody"></tbody>
</table>

<!-- æ¡Œæ©Ÿè©³ç´°è³‡è¨Š -->
<div id="detailCard"></div>

<!-- Mobile detail sheet -->
<div id="sheetBackdrop" class="sheet-backdrop hidden"></div>
<div id="mobileDetailSheet" class="sheet hidden">
  <div class="sheet-header">
    <span>å•†å“è³‡è¨Š</span>
    <button id="sheetCloseBtn" class="sheet-close">Ã—</button>
  </div>
  <div class="sheet-content" id="sheetContent"></div>
</div>

<!-- å ±åƒ¹å–® sheet -->
<div id="quoteSheet" class="sheet hidden">
  <div class="sheet-header">
    <span>å ±åƒ¹å–®é è¦½</span>
    <button id="quoteCloseBtn" class="sheet-close">Ã—</button>
  </div>

  <div class="sheet-content" style="display:flex;flex-direction:column;">

    <!-- å ±åƒ¹æ¸…å–® -->
    <div id="quoteListBody" style="flex:1;overflow-y:auto;"></div>

    <!-- é‡‘é¡èˆ‡æŒ‰éˆ• -->
    <div class="quote-footer">
      <div style="display:flex;justify-content:space-between;font-weight:bold;font-size:16px;margin-bottom:12px;">
        <span>ç¸½è¨ˆé‡‘é¡</span>
        <span id="quoteTotal">$0</span>
      </div>

      <!-- æ¯›åˆ© -->
      <div id="quoteProfit" class="quote-metric"></div>

      <!-- LINE åˆ†äº« -->
      <button id="copyQuoteBtn" class="btn-primary" style="width:100%;margin-top:12px;">
        è¤‡è£½æ•´å¼µå ±åƒ¹å–® (LINE)
      </button>

      <!-- v4.6 æ–°å¢ï¼šä¸‹è¼‰ Excel å ±åƒ¹å–® -->
      <button id="exportQuoteExcelBtn" class="btn-secondary" style="width:100%;margin-top:10px;">
        ä¸‹è¼‰ Excel å ±åƒ¹å–®
      </button>

      <!-- æ¸…ç©º -->
      <button id="clearQuoteBtn" class="btn-secondary" 
        style="width:100%;margin-top:10px;color:#ef4444;border-color:#ef4444;">
        æ¸…ç©ºå ±åƒ¹å–®
      </button>
    </div>
  </div>
</div>

<!-- ä¿ç•™ FABï¼ˆæ‰‹æ©Ÿæ–¹ä¾¿ç”¨ï¼‰ -->
<div id="fabCart" class="fab-cart hidden">
  <span style="font-size:24px;">ğŸ“</span>
  <div id="cartCount" class="fab-badge">0</div>
</div>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script type="module">
/* ---------------------------------------------
   Firebase åˆå§‹åŒ–
----------------------------------------------*/
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtp6rwV7KmIOedLQ9793BnXbBquopP9kM",
  authDomain: "kinyo-price.firebaseapp.com",
  projectId: "kinyo-price",
  storageBucket: "kinyo-price.firebasestorage.app",
  messagingSenderId: "122464645678",
  appId: "1:122464645678:web:c0febbc6297a8ada5ea5bf"
};

const app = initializeApp(firebaseConfig);
const db  = getFirestore(app);
const auth = getAuth(app);

/* ---------------------------------------------
   å…¨åŸŸè®Šæ•¸
----------------------------------------------*/
let productCache = [];
let currentResultList = [];
let userLevel = 1;
let quoteList = [];
let productsLoaded = false;

/* DOM è®Šæ•¸ */
const keywordInput  = document.getElementById("keyword");
const qtySelect     = document.getElementById("qtySelect");
const minPriceInput = document.getElementById("minPrice");
const maxPriceInput = document.getElementById("maxPrice");
const sortSelect    = document.getElementById("sortSelect");
const exportBtn     = document.getElementById("exportBtn");
const clearBtn      = document.getElementById("clearBtn");
const searchBtn     = document.getElementById("searchBtn");
const loadingOverlay = document.getElementById("loadingOverlay");

const resultTable = document.getElementById("resultTable");
const resultBody  = document.getElementById("resultBody");
const checkAllBox = document.getElementById("checkAll");

const sheetBackdrop = document.getElementById("sheetBackdrop");
const mobileSheet   = document.getElementById("mobileDetailSheet");
const sheetCloseBtn = document.getElementById("sheetCloseBtn");
const sheetContent  = document.getElementById("sheetContent");

const detailCard = document.getElementById("detailCard");

const quoteSheet  = document.getElementById("quoteSheet");
const quoteCloseBtn = document.getElementById("quoteCloseBtn");
const quoteListBody = document.getElementById("quoteListBody");
const quoteTotalEl  = document.getElementById("quoteTotal");
const quoteProfitEl = document.getElementById("quoteProfit");

/* ---------------------------------------------
   ä¸»å‹è™Ÿåˆ¤æ–·ï¼ˆv4.6 æœ€çµ‚ç‰ˆï¼‰
   è¦å‰‡ï¼š
   è‹±æ–‡ + æ•¸å­— + è‹±æ–‡(1~3ç¢¼) â†’ æœ€å¾Œè‹±æ–‡å°±æ˜¯é¡è‰²
   æ”¯æ´ï¼š
   - KH195PI â†’ KH195
   - KH195PU â†’ KH195
   - KH193B â†’ KH193
   - WV-KHP1230W â†’ WV-KHP1230
   - WV-KHP1230-BK â†’ WV-KHP1230
----------------------------------------------*/
function getMainModel(model) {
  if (!model) return "";

  const m = model.toUpperCase().trim();

  // æ”¯æ´ WV-KHP1230-BK
  if (m.includes("-")) {
    const parts = m.split("-");
    const last = parts[parts.length - 1];

    // è‹¥æœ€å¾Œæ®µéƒ½æ˜¯è‹±æ–‡ â†’ é¡è‰²
    if (/^[A-Z]{1,3}$/.test(last)) {
      return parts.slice(0, -1).join("-");
    }
  }

  // ä¸€èˆ¬ KH195PI / KH193B
  const match = m.match(/^([A-Z\-]+[0-9]+)([A-Z]{1,3})$/);
  if (match) {
    return match[1];   // å‰é¢æ˜¯ä¸»å‹è™Ÿ
  }

  return m;
}

/* ---------------------------------------------
   é è¼‰å•†å“ï¼ˆå« loadingï¼‰
----------------------------------------------*/
async function preloadProducts() {
  loadingOverlay.style.display = "flex";

  try {
    const snap = await getDocs(collection(db, "Products"));
    productCache = [];

    snap.forEach(docSnap => {
      const d = docSnap.data() || {};
      const model = (d.model || "").trim();
      const mainModel = getMainModel(model);

      productCache.push({
        ...d,
        model,
        mainModel,
        searchKey: (d.searchKey || `${model} ${d.name}`).toLowerCase()
      });
    });

    productsLoaded = true;
    searchBtn.disabled = false;

  } catch (e) {
    alert("å•†å“è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢");
    console.error(e);
  }

  loadingOverlay.style.display = "none";
}

/* ---------------------------------------------
   èµ·è¨‚é‡é¸å–®æŒ‰ç­‰ç´šé¡¯ç¤º
----------------------------------------------*/
function setupQtySelect() {
  qtySelect.innerHTML = "";
  qtySelect.innerHTML += `<option value="">ä¸ä½¿ç”¨èµ·è¨‚é‡</option>`;

  if (userLevel >= 1) qtySelect.innerHTML += `<option value="50">50 å€‹</option>`;
  if (userLevel >= 2) qtySelect.innerHTML += `<option value="100">100 å€‹</option><option value="300">300 å€‹</option>`;
  if (userLevel >= 3) qtySelect.innerHTML += `<option value="500">500 å€‹</option><option value="1000">1000 å€‹</option>`;
}

/* ---------------------------------------------
   æœå°‹é‚è¼¯ï¼ˆv4.6ï¼‰ï¼š
   æ”¯æ´ä¸‰è€… ANDï¼š
   é—œéµå­— + èµ·è¨‚é‡ + é ç®—
----------------------------------------------*/
function searchProducts() {
  if (!productsLoaded) return;

  const key = keywordInput.value.trim().toLowerCase();
  const qty = qtySelect.value;
  const minPraw = minPriceInput.value.trim();
  const maxPraw = maxPriceInput.value.trim();

  let list = [...productCache];

  /* A. é—œéµå­— */
  if (key) {
    list = list.filter(p => (p.searchKey || "").includes(key));
  }

  /* B. èµ·è¨‚é‡ + é ç®— */
  if (qty) {
    const costKey = `quote${qty}`;
    const minP = minPraw ? Number(minPraw) : 0;
    const maxP = maxPraw ? Number(maxPraw) : Number.MAX_SAFE_INTEGER;

    list = list.filter(p => {
      const price = Number(p[costKey]) || 0;
      return price >= minP && price <= maxP;
    });
  }

  /* åˆä½µä¸»å‹è™Ÿï¼ˆé¡è‰²åˆä½µï¼‰ */
  list = mergeByMainModel(list);

  /* æ’åº */
  list = applySorting(list);

  currentResultList = list;
  renderResults(list);
}

/* ---------------------------------------------
   ä¸»å‹è™Ÿåˆä½µç‚º 1 ç­†ï¼ˆé¡è‰²åˆä½µï¼‰
----------------------------------------------*/
function mergeByMainModel(list) {
  const map = {};

  list.forEach(item => {
    const main = item.mainModel;

    if (!map[main]) {
      map[main] = {
        ...item,
        models: [item.model],
        colorList: item.colorList || ""
      };
    } else {
      map[main].models.push(item.model);
    }
  });

  return Object.values(map);
}

/* ---------------------------------------------
   æ’åº
----------------------------------------------*/
function applySorting(list) {
  const opt = sortSelect.value;

  if (opt === "minPriceAsc")  return list.sort((a,b)=>a.minPrice - b.minPrice);
  if (opt === "minPriceDesc") return list.sort((a,b)=>b.minPrice - a.minPrice);
  if (opt === "marketAsc")    return list.sort((a,b)=>a.marketPrice - b.marketPrice);
  if (opt === "marketDesc")   return list.sort((a,b)=>b.marketPrice - a.marketPrice);
  if (opt === "alphaAsc")     return list.sort((a,b)=>a.mainModel.localeCompare(b.mainModel));
  if (opt === "alphaDesc")    return list.sort((a,b)=>b.mainModel.localeCompare(a.mainModel));

  return list;
}

/* ---------------------------------------------
   æ¸²æŸ“æœå°‹çµæœ
----------------------------------------------*/
function renderResults(list) {
  resultBody.innerHTML = "";
  resultTable.style.display = list.length === 0 ? "none" : "table";
  exportBtn.disabled = list.length === 0;

  list.forEach(item => {
    const tr = document.createElement("tr");
    const img = item.imageUrl || "https://placehold.co/120x120?text=No+Image";

    /* åƒ¹æ ¼æ¨™ç±¤ */
    let priceHtml = "";
    if (userLevel >= 1) priceHtml += `<span class="price-tag tag50">50å€‹ï¼š${item.quote50}</span>`;
    if (userLevel >= 2) {
      priceHtml += `<span class="price-tag tag100">100å€‹ï¼š${item.quote100}</span>`;
      priceHtml += `<span class="price-tag tag300">300å€‹ï¼š${item.quote300}</span>`;
    }
    if (userLevel >= 3) {
      priceHtml += `<span class="price-tag tag500">500å€‹ï¼š${item.quote500}</span>`;
      priceHtml += `<span class="price-tag tag1000">1000å€‹ï¼š${item.quote1000}</span>`;
    }

    /* åˆ—å…§å®¹ */
    tr.innerHTML = `
      <td><input type="checkbox" class="row-check" data-model="${item.model}" /></td>
      <td><img src="${img}" class="product-img"></td>
      <td>${item.mainModel}</td>
      <td>
        <div style="font-weight:700;margin-bottom:4px;">${item.name}</div>
        <div style="font-size:13px;color:#555;margin-bottom:4px;">å‹è™Ÿï¼š${item.models.join(" / ")}</div>
        <div class="price-tag-container">${priceHtml}</div>
        <div style="display:flex; gap:6px;">
          <button class="line-share-btn" data-model="${item.model}"
            style="margin-top:6px;padding:6px 10px;font-size:12px;background:#06C755;color:#fff;border:none;border-radius:6px;cursor:pointer;">
            LINE
          </button>
          <button class="btn-outline-add add-quote-btn" data-model="${item.model}">
            â• å ±åƒ¹å–®
          </button>
        </div>
      </td>
      <td style="text-align:right;">${item.minPrice}</td>
      <td style="text-align:right;">${item.marketPrice}</td>
    `;

    /* æ¡Œæ©Ÿï¼šå³å´å¡ç‰‡ */
    if (window.innerWidth > 900) {
      tr.addEventListener("mouseenter", () => showDetailDesktop(item));
      tr.addEventListener("mouseleave", () => hideDetailDesktop());
      tr.addEventListener("click", e => {
        if (e.target.tagName !== "BUTTON" && e.target.tagName !== "INPUT") {
          showDetailDesktop(item);
        }
      });
    } 
    /* æ‰‹æ©Ÿï¼šé–‹ bottom sheet */
    else {
      tr.addEventListener("click", e => {
        if (e.target.tagName !== "BUTTON" && e.target.tagName !== "INPUT") {
          showDetailMobile(item);
        }
      });
    }

    resultBody.appendChild(tr);
  });

  bindCheckAll();
}

/* ---------------------------------------------
   æ¡Œæ©Ÿè©³ç´°è³‡è¨Š
----------------------------------------------*/
function showDetailDesktop(item) {
  const img = item.imageUrl || "https://placehold.co/300x300?text=No+Image";
  detailCard.innerHTML = `
    <img src="${img}" style="width:100%;border-radius:10px;border:1px solid #eee;margin-bottom:10px;">
    <div style="font-weight:700;font-size:16px;margin-bottom:6px;">${item.name}</div>
    <div style="font-size:14px;line-height:1.6;margin-bottom:10px;">
      <strong>ä¸»å‹è™Ÿï¼š</strong>${item.mainModel}<br>
      <strong>è³£å ´ï¼š</strong>${item.marketPrice}<br>
      <strong>æœ«å”®ï¼š</strong>${item.minPrice}<br>
      <strong>ç¶²å€ï¼š</strong>${item.productUrl ? `<a href="${item.productUrl}" target="_blank">å‰å¾€</a>` : "-"}
    </div>
  `;

  detailCard.classList.add("show");
  detailCard.style.display = "block";
}

function hideDetailDesktop() {
  detailCard.classList.remove("show");
}
/* ---------------------------------------------
   æ‰‹æ©Ÿè©³ç´°è³‡è¨Š bottom-sheet
----------------------------------------------*/
function openSheet() {
  sheetBackdrop.classList.remove("hidden");
  mobileSheet.classList.remove("hidden");
  requestAnimationFrame(() => mobileSheet.classList.add("open"));
}
function closeSheet() {
  mobileSheet.classList.remove("open");
  setTimeout(() => {
    mobileSheet.classList.add("hidden");
    if (quoteSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden");
  }, 220);
}

function showDetailMobile(item) {
  const img = item.imageUrl || "https://placehold.co/300x300?text=No+Image";

  let priceBlock = "";
  if (userLevel >= 1) priceBlock += `<div>50 å€‹ï¼š${item.quote50}</div>`;
  if (userLevel >= 2) priceBlock += `<div>100 å€‹ï¼š${item.quote100}</div><div>300 å€‹ï¼š${item.quote300}</div>`;
  if (userLevel >= 3) priceBlock += `<div>500 å€‹ï¼š${item.quote500}</div><div>1000 å€‹ï¼š${item.quote1000}</div>`;

  sheetContent.innerHTML = `
    <img src="${img}" style="width:100%;border-radius:10px;border:1px solid #eee;margin-bottom:10px;">
    <div style="font-weight:700;font-size:16px;margin-bottom:6px;">${item.name}</div>
    <div style="font-size:14px;line-height:1.6;margin-bottom:10px;">
      <strong>ä¸»å‹è™Ÿï¼š</strong>${item.mainModel}<br>
      <strong>å‹è™Ÿï¼š</strong>${item.models ? item.models.join(" / ") : item.model}<br>
      <strong>è³£å ´ï¼š</strong>${item.marketPrice}<br>
      <strong>æœ«å”®ï¼š</strong>${item.minPrice}<br>
      <strong>ç¶²å€ï¼š</strong>${item.productUrl ? `<a href="${item.productUrl}" target="_blank">å‰å¾€</a>` : "-"}
    </div>
    <div style="font-weight:700;margin-bottom:6px;">æ¡è³¼åƒ¹æ ¼</div>
    <div style="line-height:1.6;">${priceBlock}</div>
    <div style="display:flex; gap:8px; margin-top:12px;">
      <button class="btn-primary line-share-btn" data-model="${item.model}" style="flex:1;">LINE åˆ†äº«</button>
      <button class="btn-outline-add add-quote-btn" data-model="${item.model}" style="flex:1;margin-top:0;">åŠ å…¥å ±åƒ¹å–®</button>
    </div>
  `;
  openSheet();
}

/* ---------------------------------------------
   CheckAll
----------------------------------------------*/
function bindCheckAll() {
  const rowChecks = document.querySelectorAll(".row-check");
  if (!checkAllBox) return;

  checkAllBox.onchange = () => rowChecks.forEach(c => c.checked = checkAllBox.checked);

  rowChecks.forEach(chk => {
    chk.onchange = () => {
      const all = document.querySelectorAll(".row-check");
      const checked = document.querySelectorAll(".row-check:checked");
      checkAllBox.checked = (all.length === checked.length);
    };
  });
}

/* ---------------------------------------------
   å ±åƒ¹å–®ï¼šè¨ˆæ•¸ / æ¸²æŸ“ / æ¯›åˆ©ç‡
----------------------------------------------*/
const fabCart = document.getElementById("fabCart");
const cartCount = document.getElementById("cartCount");
const openQuoteBtn = document.getElementById("openQuoteBtn");
const exportQuoteExcelBtn = document.getElementById("exportQuoteExcelBtn");
const copyQuoteBtn = document.getElementById("copyQuoteBtn");
const clearQuoteBtn = document.getElementById("clearQuoteBtn");

function updateCartCount() {
  cartCount.textContent = quoteList.length;
  if (quoteList.length > 0) {
    fabCart.classList.remove("hidden");
    fabCart.classList.add("bounce");
    setTimeout(() => fabCart.classList.remove("bounce"), 300);
  } else {
    fabCart.classList.add("hidden");
  }
}

function renderQuoteList() {
  quoteListBody.innerHTML = "";
  let total = 0;

  if (quoteList.length === 0) {
    quoteListBody.innerHTML = `<div style="text-align:center;padding:40px;color:#999;">å ±åƒ¹å–®æ˜¯ç©ºçš„</div>`;
    quoteTotalEl.textContent = "$0";
    quoteProfitEl.textContent = "";
    return;
  }

  let marketSum = 0;
  let profitSum = 0;

  quoteList.forEach((q, idx) => {
    const subtotal = q.price * q.count;
    total += subtotal;

    const marketSubtotal = (q.marketPrice || 0) * q.count;
    marketSum += marketSubtotal;

    const profit = (q.marketPrice - q.price) * q.count;
    profitSum += profit;

    const marginPct = q.marketPrice ? ((q.marketPrice - q.price) / q.marketPrice * 100) : 0;

    const div = document.createElement("div");
    div.className = "quote-item";
    div.innerHTML = `
      <div style="flex:1;">
        <div style="font-weight:700;">${q.name}</div>
        <div class="quote-info" style="color:#666;">
          ${q.model} | ${q.qtyLabel}
        </div>
        <div style="font-size:12px;color:#6b7280;margin-top:2px;">
          æ¯›åˆ©ç‡ï¼š${marginPct.toFixed(1)}%
        </div>
      </div>
      <div style="text-align:right;margin-right:8px;">
        <div class="quote-price">$${q.price}</div>
        <div style="font-size:12px;color:#888;">x ${q.count}</div>
      </div>
      <div class="quote-del" data-idx="${idx}">ğŸ—‘ï¸</div>
    `;
    quoteListBody.appendChild(div);
  });

  quoteTotalEl.textContent = "$" + total.toLocaleString();

  const avgMarginPct = marketSum > 0 ? (profitSum / marketSum * 100) : 0;
  quoteProfitEl.innerHTML = `
    æˆæœ¬æ¯›åˆ©è¨ˆç®—ï¼ˆä¾èµ·è¨‚é‡åƒ¹ / è³£å ´åƒ¹ï¼‰<br>
    å¹³å‡æ¯›åˆ©ç‡ï¼š<strong>${avgMarginPct.toFixed(2)}%</strong>
  `;

  document.querySelectorAll(".quote-del").forEach(btn => {
    btn.onclick = (e) => {
      const i = Number(e.target.getAttribute("data-idx"));
      quoteList.splice(i, 1);
      renderQuoteList();
      updateCartCount();
    };
  });
}

/* ---------------------------------------------
   å ±åƒ¹å–® Sheet é–‹é—œ
----------------------------------------------*/
function openQuoteSheet() {
  sheetBackdrop.classList.remove("hidden");
  quoteSheet.classList.remove("hidden");
  requestAnimationFrame(() => quoteSheet.classList.add("open"));
  renderQuoteList();
}
function closeQuoteSheet() {
  quoteSheet.classList.remove("open");
  setTimeout(() => quoteSheet.classList.add("hidden"), 220);
  if (mobileSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden");
}

/* ---------------------------------------------
   åŒ¯å‡º Excelï¼ˆå•†å“æ¸…å–®ï¼‰
   è¦å‰‡ï¼š
   - æœ‰é¸èµ·è¨‚é‡ qty â†’ åªåŒ¯å‡ºè©² qty åƒ¹æ ¼ + æœ«å”® + è³£å ´
   - æ²’é¸ qtyï¼ˆé—œéµå­—æœå°‹ï¼‰â†’ ä¸åŒ¯å‡ºæ¡è³¼åƒ¹ï¼ŒåªåŒ¯å‡º æœ«å”® + è³£å ´
   - æ°¸é åŠ ã€Œåœ–ç‰‡ URLã€æ¬„ä½
----------------------------------------------*/
function exportSelectedExcel() {
  const checked = document.querySelectorAll(".row-check:checked");
  if (checked.length === 0) {
    alert("è«‹å…ˆå‹¾é¸è¦åŒ¯å‡ºçš„å•†å“");
    return;
  }

  const selectedModels = Array.from(checked).map(c => c.getAttribute("data-model"));
  const qty = qtySelect.value;

  const baseHeader = [
    "å•†å“å‹è™Ÿ", "ä¸»å‹è™Ÿ", "å•†å“åç¨±", "å‹è™Ÿ(é¡è‰²åˆä½µ)", "ç®±å…¥æ•¸",
    "æœ«å”®", "è³£å ´", "å•†å“é€£çµ", "åœ–ç‰‡URL"
  ];

  if (qty) baseHeader.splice(5, 0, `${qty}å€‹å–®åƒ¹`);

  const rows = [baseHeader];

  selectedModels.forEach(m => {
    const item = currentResultList.find(p => p.model === m);
    if (!item) return;

    const modelsText = item.models ? item.models.join(" / ") : item.model;

    const row = [
      item.model,
      item.mainModel,
      item.name,
      modelsText,
      item.cartonQty || "",
      item.minPrice || "",
      item.marketPrice || "",
      item.productUrl || "",
      item.imageUrl || ""
    ];

    if (qty) {
      const ck = `quote${qty}`;
      const cost = item[ck] || item.quote50 || 0;
      row.splice(5, 0, cost);
    }

    rows.push(row);
  });

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "å•†å“å ±åƒ¹");
  XLSX.writeFile(wb, `KINYO_å•†å“å ±åƒ¹_${qty ? qty + "å€‹" : "é—œéµå­—"}.xlsx`);
}

/* ---------------------------------------------
   åŒ¯å‡º Excelï¼ˆå ±åƒ¹å–®ï¼‰
----------------------------------------------*/
function exportQuoteExcel() {
  if (quoteList.length === 0) {
    alert("å ±åƒ¹å–®æ˜¯ç©ºçš„");
    return;
  }

  const rows = [
    ["å•†å“å‹è™Ÿ", "å•†å“åç¨±", "èµ·è¨‚é‡", "å–®åƒ¹", "è³£å ´åƒ¹", "æ•¸é‡", "å°è¨ˆ", "æ¯›åˆ©ç‡%"]
  ];

  let total = 0;
  let marketSum = 0;
  let profitSum = 0;

  quoteList.forEach(q => {
    const sub = q.price * q.count;
    total += sub;

    const marketSub = (q.marketPrice || 0) * q.count;
    marketSum += marketSub;
    profitSum += (q.marketPrice - q.price) * q.count;

    const marginPct = q.marketPrice ? ((q.marketPrice - q.price) / q.marketPrice * 100) : 0;

    rows.push([
      q.model, q.name, q.qtyLabel, q.price, q.marketPrice, q.count, sub, marginPct.toFixed(1)
    ]);
  });

  rows.push([]);
  rows.push(["", "", "", "", "", "ç¸½è¨ˆ", total]);
  const avgMarginPct = marketSum > 0 ? (profitSum / marketSum * 100) : 0;
  rows.push(["", "", "", "", "", "å¹³å‡æ¯›åˆ©ç‡", avgMarginPct.toFixed(2) + "%"]);

  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å–®");
  XLSX.writeFile(wb, "KINYO_å ±åƒ¹å–®.xlsx");
}

/* ---------------------------------------------
   äº‹ä»¶ç¶å®š
----------------------------------------------*/
exportBtn.onclick = exportSelectedExcel;
exportQuoteExcelBtn.onclick = exportQuoteExcel;

clearBtn.onclick = () => {
  keywordInput.value = "";
  qtySelect.value = "";
  minPriceInput.value = "";
  maxPriceInput.value = "";

  resultBody.innerHTML = "";
  resultTable.style.display = "none";
  exportBtn.disabled = true;
  detailCard.style.display = "none";
  if (checkAllBox) checkAllBox.checked = false;
};

sortSelect.onchange = () => {
  if (currentResultList.length > 0) {
    currentResultList = applySorting([...currentResultList]);
    renderResults(currentResultList);
  }
};

sheetBackdrop.onclick = () => {
  closeSheet();
  closeQuoteSheet();
};
sheetCloseBtn.onclick = closeSheet;
quoteCloseBtn.onclick = closeQuoteSheet;
fabCart.onclick = openQuoteSheet;
openQuoteBtn.onclick = openQuoteSheet;

/* å ±åƒ¹å–®åŠŸèƒ½æŒ‰éˆ• */
clearQuoteBtn.onclick = () => {
  if (confirm("ç¢ºå®šè¦æ¸…ç©ºå ±åƒ¹å–®å—ï¼Ÿ")) {
    quoteList = [];
    renderQuoteList();
    updateCartCount();
    closeQuoteSheet();
  }
};

copyQuoteBtn.onclick = () => {
  if (quoteList.length === 0) return;

  let text = "ğŸ“‹ KINYO å•†å“å ±åƒ¹å–®\n----------------------\n";
  let total = 0;

  quoteList.forEach((q, i) => {
    const sub = q.price * q.count;
    total += sub;
    text += `${i + 1}. ã€${q.model}ã€‘${q.name}\n   è¦æ ¼ï¼š${q.qtyLabel} | å–®åƒ¹ï¼š$${q.price}\n`;
  });

  text += "----------------------\n";
  text += `ç¸½è¨ˆé‡‘é¡ï¼š$${total.toLocaleString()}`;

  navigator.clipboard.writeText(text)
    .then(() => alert("å ±åƒ¹å–®å·²è¤‡è£½"))
    .catch(() => alert("è¤‡è£½å¤±æ•—"));
};

/* ---------------------------------------------
   å…¨ç«™ clickï¼šåŠ å…¥å ±åƒ¹å–® / LINE åˆ†äº«
----------------------------------------------*/
document.addEventListener("click", (e) => {
  // åŠ å…¥å ±åƒ¹å–®
  if (e.target.classList.contains("add-quote-btn")) {
    const model = e.target.getAttribute("data-model");
    const item = currentResultList.find(p => p.model === model);
    if (!item) return;

    const qty = qtySelect.value || "50";
    const ck = `quote${qty}`;
    const cost = item[ck] || item.quote50 || 0;

    quoteList.push({
      model: item.model,
      name: item.name,
      price: cost,
      marketPrice: Number(item.marketPrice) || 0,
      qtyLabel: `${qty}å€‹`,
      count: 1
    });

    updateCartCount();
    alert(`å·²åŠ å…¥å ±åƒ¹å–®ï¼ˆ${qty}å€‹ï¼š$${cost}ï¼‰`);
  }

  // LINE åˆ†äº«
  if (e.target.classList.contains("line-share-btn")) {
    const model = e.target.getAttribute("data-model");
    const item = currentResultList.find(p => p.model === model);
    if (!item) return;

    let costText = "";
    if (userLevel >= 1) costText += `50å€‹ï¼š${item.quote50}\n`;
    if (userLevel >= 2) costText += `100å€‹ï¼š${item.quote100}\n300å€‹ï¼š${item.quote300}\n`;
    if (userLevel >= 3) costText += `500å€‹ï¼š${item.quote500}\n1000å€‹ï¼š${item.quote1000}\n`;

    const text =
`ğŸ”¥ã€${item.model}ã€‘${item.name}
è³£å ´å”®åƒ¹ï¼š${item.marketPrice}
--------------------
æ¡è³¼åƒ¹æ ¼ï¼š
${costText}
å•†å“é€£çµï¼š${item.productUrl || "ç„¡"}`;

    navigator.clipboard.writeText(text)
      .then(() => alert("å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿"))
      .catch(() => alert("è¤‡è£½å¤±æ•—"));
  }
});

/* ---------------------------------------------
   Auth / æ¬Šé™ / é è¼‰
----------------------------------------------*/
const userInfoSpan = document.getElementById("userInfo");
const logoutBtn = document.getElementById("logoutBtn");

onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "login.html";
    return;
  }

  try {
    const userDoc = await getDoc(doc(db, "Users", (user.email || "").toLowerCase()));
    if (userDoc.exists()) userLevel = userDoc.data().level || 1;
  } catch {
    userLevel = 1;
  }

  userInfoSpan.textContent = `ç™»å…¥å¸³è™Ÿï¼š${(user.email || "").replace(/@.*/, "")}`;
  logoutBtn.style.display = "inline-block";

  setupQtySelect();
  preloadProducts();
});

logoutBtn.onclick = () => signOut(auth);

</script>

</body>
</html>