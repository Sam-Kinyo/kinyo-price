<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>KINYO 商品查價系統</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      max-width: 920px;
      margin: 40px auto;
      padding: 0 16px;
      background: #f5f5f5;
    }
    h1 {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .subtitle {
      font-size: 14px;
      color: #666;
      margin-bottom: 20px;
    }
    .section-title {
      font-weight: 700;
      margin-top: 20px;
      margin-bottom: 10px;
      font-size: 16px;
    }
    .search-box {
      background: #fff;
      padding: 16px;
      border-radius: 10px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.08);
      margin-bottom: 20px;
    }
    input[type="text"], input[type="number"] {
      padding: 8px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-size: 14px;
      width: 100%;
      box-sizing: border-box;
    }
    .radio-group label {
      display: flex;
      align-items: center;
      gap: 6px;
      margin: 4px 0;
      font-size: 14px;
    }
    button {
      padding: 10px 20px;
      border-radius: 999px;
      border: none;
      background: #111827;
      color: white;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
    .card {
      background: #fff;
      padding: 18px;
      border-radius: 10px;
      box-shadow: 0 1px 6px rgba(0,0,0,0.08);
      margin-top: 20px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      font-size: 14px;
    }
    th, td {
      padding: 6px 8px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      white-space: nowrap;
    }
    th {
      background: #f3f4f6;
      font-weight: 600;
    }
    tr:hover {
      background: #f9fafb;
      cursor: pointer;
    }
    .row {
      margin-bottom: 8px;
      font-size: 15px;
    }
    .label {
      font-weight: 600;
      display: inline-block;
      width: 160px;
    }
    a {
      color: #2563eb;
    }
  </style>
</head>
<body>

  <h1>KINYO 商品查價系統</h1>
  <div class="subtitle">支援：型號/名稱、起定量單選、預算區間篩選</div>

  <!-- 搜尋條件區 -->
  <div class="search-box">

    <div class="section-title">關鍵字搜尋（可留空）</div>
    <input id="keywordInput" type="text" placeholder="型號、名稱，例如：5712、風扇、無線…">

    <div class="section-title">起定量（必選一項）</div>
    <div class="radio-group">
      <label><input type="radio" name="qty" value="100">起定量 100</label>
      <label><input type="radio" name="qty" value="300">起定量 300</label>
      <label><input type="radio" name="qty" value="500">起定量 500</label>
    </div>

    <div class="section-title">預算範圍（必填，最低+最高）</div>
    <input id="minPrice" type="number" placeholder="最低價格，例如：200">
    <input id="maxPrice" style="margin-top:8px;" type="number" placeholder="最高價格，例如：400">

    <button id="searchBtn">搜尋</button>
  </div>

  <!-- 載入 -->
  <div id="loading" class="card" style="display:none;">查詢中，請稍候…</div>

  <!-- 查無 -->
  <div id="noResult" class="card" style="display:none;">查無符合的商品。</div>

  <!-- 多筆列表 -->
  <div id="list" class="card" style="display:none;">
    <div>找到 <span id="list-count"></span> 筆商品：</div>
    <table>
      <thead>
        <tr>
          <th>型號</th>
          <th>名稱</th>
          <th>直播價</th>
          <th>末售</th>
          <th>賣場</th>
        </tr>
      </thead>
      <tbody id="list-body"></tbody>
    </table>
  </div>

  <!-- 詳細 -->
  <div id="result" class="card" style="display:none;">
    <h2 id="r-name"></h2>

    <div class="row"><span class="label">商品型號：</span><span id="r-model"></span></div>
    <div class="row"><span class="label">商品名稱：</span><span id="r-name2"></span></div>
    <div class="row"><span class="label">國際條碼：</span><span id="r-barcode"></span></div>
    <div class="row"><span class="label">箱入數：</span><span id="r-cartonQty"></span></div>

    <div class="row"><span class="label">直播售價：</span><span id="r-groupPriceLive"></span></div>
    <div class="row"><span class="label">末售價格：</span><span id="r-minPrice"></span></div>
    <div class="row"><span class="label">賣場價格：</span><span id="r-marketPrice"></span></div>

    <div class="row"><span class="label">採購 100：</span><span id="r-quote100"></span></div>
    <div class="row"><span class="label">採購 300：</span><span id="r-quote300"></span></div>
    <div class="row"><span class="label">採購 500：</span><span id="r-quote500"></span></div>

    <div class="row"><span class="label">BSMI：</span><span id="r-bsmi"></span></div>
    <div class="row"><span class="label">NCC：</span><span id="r-ncc"></span></div>

    <div class="row">
      <span class="label">官方頁面：</span>
      <a id="r-url" target="_blank">前往</a>
    </div>
  </div>

  <script type="module">
    /* Firebase */
    const firebaseConfig = {
      apiKey: "AIzaSyDtp6rwV7KmIOedLQ9793BnXbBquopP9kM",
      authDomain: "kinyo-price.firebaseapp.com",
      projectId: "kinyo-price",
      storageBucket: "kinyo-price.firebasestorage.app",
      messagingSenderId: "122464645678",
      appId: "1:122464645678:web:c0febbc6297a8ada5ea5bf",
      measurementId: "G-R0PWMZNSJH"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
    import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    /* DOM */
    const keywordInput = document.getElementById("keywordInput");
    const minPriceInput = document.getElementById("minPrice");
    const maxPriceInput = document.getElementById("maxPrice");
    const searchBtn = document.getElementById("searchBtn");

    const loading = document.getElementById("loading");
    const noResult = document.getElementById("noResult");
    const listCard = document.getElementById("list");
    const listBody = document.getElementById("list-body");
    const listCount = document.getElementById("list-count");
    const resultCard = document.getElementById("result");

    const rName = document.getElementById("r-name");
    const rName2 = document.getElementById("r-name2");
    const rModel = document.getElementById("r-model");
    const rBarcode = document.getElementById("r-barcode");
    const rCartonQty = document.getElementById("r-cartonQty");
    const rGroupPriceLive = document.getElementById("r-groupPriceLive");
    const rMinPrice = document.getElementById("r-minPrice");
    const rMarketPrice = document.getElementById("r-marketPrice");
    const rQuote100 = document.getElementById("r-quote100");
    const rQuote300 = document.getElementById("r-quote300");
    const rQuote500 = document.getElementById("r-quote500");
    const rBsmi = document.getElementById("r-bsmi");
    const rNcc = document.getElementById("r-ncc");
    const rUrl = document.getElementById("r-url");

    function showDetail(d) {
      rName.textContent = d.name ?? "";
      rName2.textContent = d.name ?? "";
      rModel.textContent = d.model ?? "";
      rBarcode.textContent = d.barcode ?? "";
      rCartonQty.textContent = d.cartonQty ?? "";

      rGroupPriceLive.textContent = d.groupPriceLive ?? "";
      rMinPrice.textContent = d.minPrice ?? "";
      rMarketPrice.textContent = d.marketPrice ?? "";

      rQuote100.textContent = d.quote100 ?? "";
      rQuote300.textContent = d.quote300 ?? "";
      rQuote500.textContent = d.quote500 ?? "";

      rBsmi.textContent = d.bsmi ?? "";
      rNcc.textContent = d.ncc ?? "";

      rUrl.href = d.productUrl || "#";
      rUrl.textContent = d.productUrl ? "前往" : "";
      resultCard.style.display = "block";
    }

    async function search() {
      const keyword = keywordInput.value.trim();
      const kwUpper = keyword.toUpperCase();
      const kwLower = keyword.toLowerCase();

      const min = minPriceInput.value ? Number(minPriceInput.value) : null;
      const max = maxPriceInput.value ? Number(maxPriceInput.value) : null;

      /* 讀 radio */
      const qty = document.querySelector('input[name="qty"]:checked');
      if (!qty) {
        alert("請選擇起定量。");
        return;
      }
      const qtyVal = Number(qty.value);

      /* 預算必須完整 */
      if (min === null || max === null) {
        alert("請輸入完整的預算區間（最低 + 最高）。");
        return;
      }
      if (max < min) {
        alert("最高價格必須大於或等於最低價格。");
        return;
      }

      loading.style.display = "block";
      noResult.style.display = "none";
      listCard.style.display = "none";
      resultCard.style.display = "none";
      listBody.innerHTML = "";

      try {
        const snap = await getDocs(collection(db, "Products"));
        const results = [];

        snap.forEach(docSnap => {
          const d = docSnap.data();

          /* 關鍵字（可空） */
          let matchKeyword = true;
          if (keyword) {
            const model = (d.model || "").toUpperCase();
            const name = (d.name || "").toLowerCase();
            matchKeyword = model.includes(kwUpper) || name.includes(kwLower);
          }
          if (!matchKeyword) return;

          /* 選定欄位 */
          let priceField = qtyVal === 100 ? "quote100"
                         : qtyVal === 300 ? "quote300"
                         : "quote500";
          let price = d[priceField];

          if (typeof price !== "number") return;

          /* 預算比對 */
          if (price < min || price > max) return;

          results.push(d);
        });

        if (results.length === 0) {
          noResult.style.display = "block";
          return;
        }

        results.sort((a, b) => (a.model || "").localeCompare(b.model || "", "en"));

        if (results.length === 1) {
          showDetail(results[0]);
          return;
        }

        listCount.textContent = results.length;

        results.forEach(item => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.model}</td>
            <td>${item.name}</td>
            <td>${item.groupPriceLive}</td>
            <td>${item.minPrice}</td>
            <td>${item.marketPrice}</td>
          `;
          tr.addEventListener("click", () => showDetail(item));
          listBody.appendChild(tr);
        });

        listCard.style.display = "block";
        showDetail(results[0]);

      } finally {
        loading.style.display = "none";
      }
    }

    searchBtn.addEventListener("click", search);
    keywordInput.addEventListener("keydown", e => {
      if (e.key === "Enter") search();
    });
  </script>

</body>
</html>
