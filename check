<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>Kinyo 退貨單號快篩系統</title>
    <style>
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; padding: 20px; background-color: #f0f2f5; }
        .container { max-width: 1000px; margin: 0 auto; display: flex; gap: 20px; }
        .panel { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        
        /* 左側設定區 */
        .left-panel { flex: 1; }
        textarea { width: 100%; height: 300px; padding: 10px; border: 1px solid #ccc; font-size: 14px; }
        
        /* 右側操作區 */
        .right-panel { flex: 2; display: flex; flex-direction: column; align-items: center; }
        
        /* 狀態顯示 */
        #status-box { 
            width: 100%; height: 150px; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 48px; font-weight: bold; color: #fff; 
            background-color: #ccc; border-radius: 8px; margin-bottom: 20px;
            text-align: center;
        }
        
        /* 掃描框 */
        #scan-input { 
            width: 80%; padding: 15px; font-size: 24px; text-align: center; 
            border: 3px solid #007bff; border-radius: 50px; outline: none;
        }
        
        /* 數據統計 */
        .stats { margin-top: 20px; font-size: 20px; color: #555; }
        .log-area { margin-top: 20px; width: 100%; max-height: 200px; overflow-y: auto; font-size: 14px; border-top: 1px solid #eee; }
        .log-item { padding: 5px; border-bottom: 1px solid #eee; }
        .log-success { color: green; }
        .log-error { color: red; font-weight: bold; }
        
        button { background-color: #007bff; color: white; border: none; padding: 10px 20px; cursor: pointer; border-radius: 4px; margin-top: 10px; width: 100%; }
        button:hover { background-color: #0056b3; }
        
        /* 狀態顏色 */
        .bg-neutral { background-color: #6c757d !important; }
        .bg-success { background-color: #28a745 !important; }
        .bg-error { background-color: #dc3545 !important; } /* 紅色警告 */
        .bg-warn { background-color: #ffc107 !important; color: #000 !important; } /* 重複掃描 */

    </style>
</head>
<body>

<div class="container">
    <div class="panel left-panel">
        <h3>1. 貼上預計退貨單號 (一行一個)</h3>
        <textarea id="target-list" placeholder="請將 Excel 中的單號整欄複製貼上到這裡..."></textarea>
        <button onclick="loadList()">鎖定清單並開始</button>
        <div style="margin-top:10px; color:#666; font-size:0.9em;">
            目前清單總數: <span id="total-count">0</span>
        </div>
    </div>

    <div class="panel right-panel">
        <h3>2. 掃描區</h3>
        <div id="status-box" class="bg-neutral">準備就緒</div>
        
        <input type="text" id="scan-input" placeholder="點此開始掃描條碼" autofocus autocomplete="off">
        
        <div class="stats">
            進度：<span id="scanned-count" style="color:green; font-weight:bold;">0</span> / <span id="target-total">0</span>
        </div>

        <div class="log-area" id="log-area"></div>
    </div>
</div>

<script>
    // 資料結構
    let targetSet = new Set(); // 預計要收的
    let scannedSet = new Set(); // 已經收到的
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    // 簡單的音效產生器 (無需外部檔案)
    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        if (type === 'success') {
            // 清脆的高音 (叮!)
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
        } else if (type === 'error') {
            // 低沈的錯誤音 (布布!)
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(100, audioCtx.currentTime + 0.3);
            gain.gain.setValueAtTime(0.5, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
            osc.start();
            osc.stop(audioCtx.currentTime + 0.3);
        }
    }

    // 1. 載入清單
    function loadList() {
        const text = document.getElementById('target-list').value;
        const lines = text.split(/\n/);
        targetSet.clear();
        scannedSet.clear();
        
        lines.forEach(line => {
            const cleanLine = line.trim();
            if (cleanLine) targetSet.add(cleanLine);
        });

        document.getElementById('total-count').innerText = targetSet.size;
        document.getElementById('target-total').innerText = targetSet.size;
        document.getElementById('scanned-count').innerText = 0;
        document.getElementById('log-area').innerHTML = '';
        setStatus('開始作業', 'neutral');
        document.getElementById('scan-input').focus();
        document.getElementById('scan-input').value = '';
    }

    // 2. 監聽掃描 (按下 Enter 觸發)
    document.getElementById('scan-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const inputVal = this.value.trim();
            if (inputVal) processScan(inputVal);
            this.value = ''; // 清空輸入框
        }
    });

    // 3. 處理邏輯
    function processScan(code) {
        const logArea = document.getElementById('log-area');
        const now = new Date().toLocaleTimeString();

        // 狀況 A: 重複掃描
        if (scannedSet.has(code)) {
            setStatus(`重複: ${code}`, 'warn');
            playSound('error');
            logArea.insertAdjacentHTML('afterbegin', `<div class="log-item log-error">[${now}] 重複掃描: ${code}</div>`);
            return;
        }

        // 狀況 B: 成功 (在清單內)
        if (targetSet.has(code)) {
            scannedSet.add(code);
            setStatus(`OK: ${code}`, 'success');
            playSound('success');
            logArea.insertAdjacentHTML('afterbegin', `<div class="log-item log-success">[${now}] 成功核對: ${code}</div>`);
            
            // 更新計數
            document.getElementById('scanned-count').innerText = scannedSet.size;
        } 
        // 狀況 C: 異常 (不在清單內)
        else {
            setStatus(`異常! 非清單內: ${code}`, 'error');
            playSound('error'); // 也可以設計第三種聲音
            logArea.insertAdjacentHTML('afterbegin', `<div class="log-item log-error">[${now}] 異常件: ${code}</div>`);
        }
    }

    function setStatus(msg, type) {
        const box = document.getElementById('status-box');
        box.innerText = msg;
        box.className = ''; // 清除舊 class
        box.classList.add(`bg-${type}`);
    }
</script>

</body>
</html>
