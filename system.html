<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<title>KINYO æŸ¥åƒ¹ç³»çµ±ï¼ˆV7.6 åº«å­˜é è­¦å‡ç´šç‰ˆï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- PptxGenJS for PPT export & XLSX for Excel -->
<script src="https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.bundle.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
/* =========================================
   Root è®Šæ•¸
========================================= */
:root{
  --bg:#f5f6f8;
  --card:#ffffff;
  --primary:#111827;
  --primary-blue:#2563eb;
  --border:#e5e7eb;
  --text:#1f2937;
  --muted:#6b7280;
  --radius:12px;
  --shadow:0 4px 12px rgba(0,0,0,0.06);

  --loading-bg:#e5e7eb;
  --loading-fill:#3b82f6;
}

/* =========================================
   Body
========================================= */
body{
  margin:0;
  padding:24px;
  background:var(--bg);
  font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  color:var(--text);
  max-width:980px;
  margin:0 auto;
}

h1{margin:0 0 4px;}
.subtitle{
  color:var(--muted);
  margin-bottom:18px;
  font-size:14px;
  font-weight: 500;
  letter-spacing: 0.5px;
}

/* =========================================
   Top Bar
========================================= */
.top-bar{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:14px;
}
.user-badge{
  background:#eef0f4;
  padding:6px 14px;
  border-radius:999px;
  font-size:13px;
  transition: all 0.3s ease;
  border: 1px solid transparent;
}
.badge-lv0 { color: #666; border-color: #ddd; background: #f3f4f6; }
.badge-lv1 { background: #dbeafe; color: #1e40af; }
.badge-lv2 { background: #dcfce7; color: #15803d; }
.badge-lv3 { background: #fef3c7; color: #92400e; }
.badge-lv4 { background: #f3e8ff; color: #6b21a8; }
/* VIP Badge */
.badge-vip { background: #fce7f3; color: #be185d; border-color: #fbcfe8; }

.logout-btn{
  padding:6px 14px;
  border-radius:999px;
  border:1px solid var(--border);
  cursor:pointer;
  background:white;
  font-size:12px;
}

/* =========================================
   Toolbar
========================================= */
.toolbar{
  display:flex;
  gap:10px;
  align-items:center;
  margin:10px 0 6px;
  flex-wrap: wrap;
  transition: all 0.3s ease;
}
.toolbar select{ flex:1; min-width: 120px; }

/* å·¥å…·åˆ—æ‡¸æµ®æ¨£å¼ */
.toolbar.fixed-active {
  position: fixed;
  top: 24px;
  left: 50%;
  transform: translateX(-50%);
  bottom: auto;
  
  z-index: 2000;
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(10px);
  padding: 12px 20px;
  
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  border: 1px solid rgba(0,0,0,0.1);
  
  width: calc(100% - 48px);
  max-width: 980px;
  border-radius: 12px;
  
  justify-content: flex-start;
  animation: popDown 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

@keyframes popDown {
  from { transform: translate(-50%, -120%); opacity: 0; }
  to { transform: translate(-50%, 0); opacity: 1; }
}

#toolbarSpacer { height: 70px; display: none; }

.quote-toolbar-btn{
  padding:10px 16px;
  border-radius:999px;
  border:1px solid var(--border);
  background:white;
  cursor:pointer;
  font-size:14px;
  white-space:nowrap;
  display:none;
}

/* =========================================
   æœå°‹å€å¡Š
========================================= */
.search-box{
  background:var(--card);
  padding:18px;
  border-radius:var(--radius);
  box-shadow:0 8px 28px rgba(0,0,0,0.15);
  margin-bottom:12px;
}
.search-row {margin-bottom:14px;}
label{
  font-weight:600;
  margin-bottom:6px;
  display:block;
  font-size:14px;
}
/* è¼¸å…¥æ¡†èšç„¦å…‰æšˆç‰¹æ•ˆ (æ–°) */
input, select {
  width: 100%;
  padding: 12px 14px;        /* ç¨å¾®åŠ å¤§è¼¸å…¥å€åŸŸ */
  border-radius: 8px;
  font-size: 15px;
  box-sizing: border-box;
  border: 1px solid #e2e8f0;
  background: #fff;
  transition: all 0.2s ease; /* åŠ å…¥å‹•ç•«éæ¸¡æ•ˆæœ */
}

/* ç•¶æ»‘é¼ é»æ“Šè¼¸å…¥æ¡†æ™‚çš„æ•ˆæœ */
input:focus, select:focus {
  outline: none;
  border-color: #3b82f6;     /* é‚Šæ¡†è®Šè—è‰² */
  background: #fff;
  /* é—œéµï¼šåŠ å…¥æ“´æ•£çš„è—è‰²å…‰æšˆ */
  box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.15); 
}

/* è¤‡åˆå¼æœå°‹åˆ— (åˆ†é¡ + é—œéµå­—) */
.combo-search {
    display: flex;
    gap: 10px;
}
.combo-search select {
    width: 35%;
    min-width: 130px;
    background-color: #f9fafb;
    border: 1px solid #cbd5e1;
}
.combo-search input {
    flex: 1;
}

/* =========================================
   Buttons
========================================= */
.btn-primary{
  background:var(--primary);
  color:white;
  border:none;
  border-radius:999px;
  padding:12px 20px;
  font-weight:600;
  cursor:pointer;
  width:100%;
}
.btn-secondary{
  background:white;
  border:1px solid var(--border);
  padding:10px 16px;
  border-radius:999px;
  cursor:pointer;
  font-size:14px;
  white-space:nowrap;
}
.btn-secondary:disabled { color: #ccc; cursor: not-allowed; }
.btn-outline-add{
  padding:6px 12px;
  border-radius:6px;
  border:1px solid #2563eb;
  background:#eff6ff;
  color:#2563eb;
  font-size:12px;
  cursor:pointer;
  font-weight:600;
}
.btn-outline-add:hover{background:#dbeafe;}

/* =========================================
   è¡¨æ ¼
========================================= */
table{
  width:100%;
  border-collapse:collapse;
  background:white;
  border-radius:var(--radius);
  box-shadow:0 8px 28px rgba(0,0,0,0.15);
}
/* è¡¨æ ¼å¯¬é¬†åŒ–è¨­å®š (æ–°) */
th, td {
  padding: 16px 12px;        /* å¢åŠ ä¸Šä¸‹é«˜åº¦ï¼Œè®“çœ¼ç›æ›´èˆ’æœ */
  border-bottom: 1px solid #f1f5f9; /* æ”¹ç”¨æ¥µæ·¡çš„ç·šæ¢ */
  font-size: 14px;
  vertical-align: middle;    /* é—œéµï¼šè®“åœ–ç‰‡å’Œæ–‡å­—å‚ç›´ç½®ä¸­ */
}

th {
  background: #f8fafc;       /* æ·ºç°åº•è‰² */
  color: #64748b;            /* æ·±ç°æ–‡å­— */
  font-weight: 700;
  text-align: left;
  letter-spacing: 0.5px;     /* å­—è·ç¨å¾®æ‹‰é–‹ */
}

.product-img{
  width:110px;height:110px;
  object-fit:cover;
  border-radius:14px;
  border:1px solid #e5e7eb;
  cursor: pointer;
}
.model-cell { cursor: pointer; }
.model-cell:hover { color: var(--primary-blue); text-decoration: underline; }

/* åƒ¹æ ¼æ¨™ç±¤ - è—¥ä¸¸åŒ– */
.price-tag {
  padding: 4px 12px;         /* å¢åŠ å·¦å³å¯¬åº¦ï¼Œè®“å®ƒæ›´åƒè—¥ä¸¸ */
  font-size: 12px;
  border-radius: 50px;       /* é—œéµï¼šæ”¹æˆ 50px è®Šæˆæ­£åœ“å¼§ */
  display: inline-block;
  margin-right: 6px;
  margin-bottom: 6px;
  font-weight: 700;          /* å­—é«”åŠ ç²— */
  white-space: nowrap;
  border: none;              /* ç§»é™¤é‚Šæ¡†ï¼Œçœ‹èµ·ä¾†æ›´ä¹¾æ·¨ */
  box-shadow: 0 1px 2px rgba(0,0,0,0.05); /* åŠ ä¸€é»é»é™°å½± */
  transition: transform 0.2s; /* å¾®äº’å‹•ï¼šåŠ å…¥å‹•ç•« */
}
.price-tag:hover {
  transform: scale(1.05);    /* æ»‘é¼ ç§»éå»æœƒç¨å¾®æ”¾å¤§ */
}
.tag50{background:#dbeafe;color:#1e40af;}
.tag100{background:#e0f2fe;color:#0369a1;}
.tag300{background:#dcfce7;color:#15803d;}
.tag500{background:#ffedd5;color:#ea580c;}
.tag1000{background:#fee2e2;color:#b91c1c;}

/* åˆ†é¡æ¨™ç±¤ - è—¥ä¸¸åŒ– */
.category-badge {
  display: inline-block;
  font-size: 11px;
  padding: 3px 10px;         /* ç¨å¾®åŠ å¯¬ */
  background: #f1f5f9;
  color: #64748b;
  border-radius: 50px;       /* è—¥ä¸¸å½¢ç‹€ */
  margin-bottom: 4px;
  border: 1px solid #e2e8f0;
  font-weight: 600;
}

/* åº«å­˜æ–‡å­—æ¨™ç±¤ - è—¥ä¸¸åŒ– */
.stock-tag {
  display: inline-block;
  padding: 2px 8px;          /* åŠ å¯¬ */
  border-radius: 50px;       /* è—¥ä¸¸å½¢ç‹€ */
  font-size: 11px;           /* å­—é«”å¾®ç¸®ï¼Œæ›´ç²¾ç·» */
  font-weight: 700;
  margin-left: 0; 
  vertical-align: middle;
  border: 1px solid transparent; /* ä¿æŒé€æ˜é‚Šæ¡†ä»¥ç¶­æŒæ’ç‰ˆ */
}

/* 1. å°æ–¼ 30 (ç´…è‰² - è­¦æˆ’) */
.st-crit { background: #fee2e2; color: #991b1b; border-color: #fca5a5; }
/* 2. å°æ–¼ 100 (æ©˜ç´… - å°‘é‡) */
.st-low  { background: #ffedd5; color: #9a3412; border-color: #fdba74; }
/* 3. å°æ–¼ 400 (æ©˜é»ƒ - æ™®é€š) */
.st-warn { background: #fff7ed; color: #b45309; border-color: #fed7aa; }
/* 4. å°æ–¼ 800 (è‰ç¶  - å……è¶³) */
.st-mid  { background: #ecfccb; color: #3f6212; border-color: #bef264; }
/* 5. å°æ–¼ 1200 (ç¶ è‰² - è±å¯Œ) */
.st-good { background: #dcfce7; color: #166534; border-color: #86efac; }
/* 6. å¤§æ–¼ 1200 (æ·±ç¶  - æ¥µå¤š) */
.st-high { background: #ccfbf1; color: #0f766e; border-color: #5eead4; }
.st-zero { background: #374151; color: #ffffff; border-color: #1f2937; }


/* =========================================
   Loading
========================================= */
#centerLoadingBox{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.35);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:2000;
}
#centerLoadingCard{
  background:rgba(255,255,255,0.65);backdrop-filter:blur(14px);
  width:280px;
  padding:20px;
  border-radius:12px;
  box-shadow:0 8px 28px rgba(0,0,0,0.15);
}
.loading-title{
  font-size:15px;
  font-weight:700;
  margin-bottom:12px;
}
.loading-bar .fill{
  height:100%;
  width:0%;
  background:var(--loading-fill);
  transition:width .15s linear;
}

/* =========================================
   Detail Card
========================================= */
#detailCard{
  position:fixed;
  right:20px;
  top:120px;
  width:360px;
  max-height:78vh;
  overflow-y:auto;
  background:white;
  padding:18px;
  border-radius:var(--radius);
  box-shadow:0 8px 28px rgba(0,0,0,0.15);
  display:none;
  z-index:999;
}
.card-close-btn {
  position: absolute; 
  top: 12px; 
  right: 12px; 
  width: 32px; 
  height: 32px; 
  border-radius: 50%; 
  background: #f3f4f6; 
  border: 1px solid #e5e7eb; 
  color: #6b7280; 
  font-size: 20px; 
  cursor: pointer; 
  display: flex; 
  align-items: center; 
  justify-content: center;
  z-index: 20;
  transition: all 0.2s;
}
.card-close-btn:hover {
  background: #e5e7eb;
  color: #ef4444;
  transform: scale(1.1);
}

/* =========================================
   ç¶²è·¯åœ– grid
========================================= */
.net-gallery{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:6px;
  margin-top:10px;
}
.net-gallery img{
  width:100%;
  border-radius:6px;
  border:1px solid #e5e7eb;
  object-fit:cover;
  cursor: pointer;
  transition: transform 0.2s;
}
.net-gallery img:hover { transform: scale(1.05); }

/* =========================================
   Mobile Sheet
========================================= */
.sheet-backdrop{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.45);
  z-index:1000;
}
.sheet{
  position:fixed;left:0;right:0;bottom:0;
  height:80vh;background:#fff;
  border-radius:16px 16px 0 0;
  transform:translateY(100%);
  transition:transform .25s ease;
  display:flex;flex-direction:column;
  z-index:1001;
}
.sheet.open{transform:translateY(0);}
.sheet-header{
  padding:12px 16px;
  border-bottom:1px solid var(--border);
  font-weight:700;
  display:flex;justify-content:space-between;align-items:center;
}
.sheet-close{
  background:none;border:none;
  font-size:26px;cursor:pointer;line-height:1;
}
.sheet-content{
  padding:16px;overflow-y:auto;font-size:15px;flex:1;
}
.hidden{display:none!important;}

.quote-item{
  display:flex;justify-content:space-between;align-items:center;
  padding:12px 0;border-bottom:1px solid #eee;
}
.quote-info{font-size:14px;color:#666;}
.quote-price{font-weight:700;color:#2563eb;}
.quote-del{color:#999;cursor:pointer;padding:6px;font-size:16px;}
.quote-del:hover{color:#ef4444;}

/* =========================================
   Login Overlay
========================================= */
#loginOverlay {
  position: fixed;
  inset: 0;
  background: #f5f6f8;
  z-index: 3000;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-direction: column;
}
.login-card {
  background: white;
  padding: 30px;
  border-radius: 16px;
  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
  width: 90%;
  max-width: 400px;
  text-align: center;
}
.login-card h2 { margin-top: 0; color: var(--primary); }
.login-input {
  width: 100%;
  margin-bottom: 12px;
  padding: 12px;
  border: 1px solid #ddd;
  border-radius: 8px;
  box-sizing: border-box;
}
.login-btn {
  width: 100%;
  padding: 12px;
  background: var(--primary-blue);
  color: white;
  border: none;
  border-radius: 8px;
  font-weight: bold;
  cursor: pointer;
  margin-top: 10px;
}
.login-btn:hover { background: #1d4ed8; }
.login-error {
  color: #ef4444;
  margin-top: 10px;
  font-size: 14px;
  display: none;
}

/* =========================================
   RWD
========================================= */
@media (max-width:900px){
  #detailCard{display:none!important;}
}
/* 9. æ‰‹æ©Ÿç‰ˆé©é… (Card View) - 4æ¬„çµæ§‹å°ˆç”¨ç‰ˆ */
@media (max-width: 600px) {
  body { padding: 16px; background: #f8fafc; }
  
  /* éš±è—åŸæœ¬çš„è¡¨é ­ */
  thead { display: none; }
  /* è¡¨æ ¼è½‰å¡Šç‹€ */
  table, tbody, tr, td { display: block; width: 100%; }
  
  tr {
    background: white;
    border-radius: 16px;
    padding: 16px;
    margin-bottom: 16px;
    /* æ‰‹æ©Ÿç‰ˆå¡ç‰‡é™°å½± */
    box-shadow: 0 2px 8px rgba(0,0,0,0.04) !important;
    border: 1px solid rgba(0,0,0,0.03);
    position: relative;
    box-sizing: border-box;
  }
  
  /* ç§»é™¤é›»è…¦ç‰ˆçš„æ‡¸æµ®ä¸Šæµ®ç‰¹æ•ˆï¼Œæ‰‹æ©Ÿä¸éœ€è¦ */
  tbody tr:hover { transform: none; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }

  td { border: none; padding: 4px 0; text-align: left; }
  
  /* --- æ ¼å­å°æ‡‰é‚è¼¯ --- */

  /* æ ¼å­1: å‹¾é¸æ¡† (å®šä½åœ¨å·¦ä¸Šè§’) */
  td:nth-of-type(1) { 
    position: absolute; top: 12px; left: 12px; width: auto; z-index: 10; 
  }
  
  /* æ ¼å­2: å‹è™Ÿ+åœ–ç‰‡ (ç½®ä¸­é¡¯ç¤º) */
  td:nth-of-type(2) { 
    display: flex; flex-direction: column; align-items: center; padding-bottom: 12px; 
  }
  /* æ‰‹æ©Ÿç‰ˆæŠŠåœ–ç‰‡ä¸Šæ–¹çš„å°å‹è™Ÿéš±è—ï¼Œå› ç‚ºä¸‹é¢è³‡è¨Šæ¬„å·²ç¶“æœ‰äº†ï¼Œç‰ˆé¢æœƒæ¯”è¼ƒæ¸…çˆ½ */
  td:nth-of-type(2) .model-cell { display: none; } 
  .product-img { width: 100%; max-width: 200px; height: 180px; }
  
  /* æ ¼å­3: å•†å“è³‡è¨Š (ä¿æŒåŸæ¨£) */
  td:nth-of-type(3) { padding-bottom: 12px; }

  /* æ ¼å­4: åƒ¹æ ¼å€ (æ”¹æˆå·¦å³æ©«æ’ï¼Œæ¯”è¼ƒå¥½è®€) */
  td:nth-of-type(4) {
    background: #f8fafc; 
    padding: 10px 12px; 
    border-radius: 12px; 
    margin-top: 8px;
    display: flex; 
    justify-content: space-between; 
    align-items: center;
  }
  
  /* ç”¨ CSS åœ¨åƒ¹æ ¼å‰é¢è£œä¸Šæ–‡å­—æ¨™ç±¤ */
  td:nth-of-type(4) div:first-child::before { 
    content: "æœ«å”®: "; 
    color: #64748b; font-weight: normal; font-size: 13px; margin-right: 4px; 
  }
  td:nth-of-type(4) div:last-child::before { 
    content: "è³£å ´: "; 
    color: #94a3b8; font-weight: normal; font-size: 12px; margin-right: 4px;
  }
  
  /* ä¿®å¾©èƒ½é‡æ¢åœ¨æ‰‹æ©Ÿç‰ˆçš„å¯¬åº¦ */
  .stock-bar-container { width: 100%; }
}

/* =========================================
   Preview Overlay
========================================= */
#previewOverlay {
    position: fixed; inset: 0; background: rgba(0,0,0,0.5); 
    display: none; align-items: center; justify-content: center; z-index: 4000;
}
.preview-card {
    background: white; width: 90%; max-width: 900px; max-height: 80vh;
    border-radius: 12px; padding: 20px; display: flex; flex-direction: column;
}
.preview-header { font-weight: bold; font-size: 18px; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 10px;}
.preview-body { flex: 1; overflow-y: auto; margin-bottom: 10px; font-size: 13px; }
.preview-footer { display: flex; justify-content: flex-end; gap: 10px; }
.preview-table { width: 100%; border-collapse: collapse; }
.preview-table th, .preview-table td { border: 1px solid #ddd; padding: 6px; text-align: left; }
.preview-table th { background: #f3f4f6; }
.field-badge {
    background: #e0f2fe; color: #0284c7; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-right: 4px;
}

/* =========================================
   æ–°å¢ï¼šåº«å­˜èƒ½é‡æ¢ (Inventory Bar) æ¨£å¼
========================================= */
.stock-bar-container {
  width: 100%;              /* è®“å®ƒå¡«æ»¿å¯¬åº¦ */
  height: 6px;              /* é«˜åº¦ */
  background: #e5e7eb;      /* åº•è‰² (æ·ºç°) */
  border-radius: 3px;       /* åœ“è§’ */
  margin-top: 4px;          /* èˆ‡æ–‡å­—çš„é–“è· */
  overflow: hidden;
  position: relative;
}
.stock-bar-fill {
  height: 100%;
  border-radius: 3px;
  transition: width 0.3s ease; /* å‹•ç•«æ•ˆæœ */
}

/* èƒ½é‡æ¢é¡è‰²å®šç¾© */
.fill-crit { background: #ef4444; } /* ç´…è‰² (å±éšª) */
.fill-low  { background: #f97316; } /* æ©˜è‰² (åä½) */
.fill-mid  { background: #eab308; } /* é»ƒè‰² (æ™®é€š) */
.fill-good { background: #22c55e; } /* ç¶ è‰² (å……è¶³) */
.fill-high { background: #10b981; } /* æ·±ç¶  (æ¥µå¤š) */
.st-zero   { background: #9ca3af; } /* ç°è‰² (ç¼ºè²¨) */

/* =========================================
   LINE æŒ‰éˆ•å°ˆå±¬æ¨£å¼ (å¼·åˆ¶ç¶ è‰²)
========================================= */
.line-share-btn {
  background-color: #06C755 !important; /* LINE å®˜æ–¹ç¶  */
  color: white !important;               /* ç™½å­— */
  border: 1px solid #06C755 !important; /* ç¶ æ¡† */
  box-shadow: 0 2px 6px rgba(6, 199, 85, 0.3) !important; /* ç¶ è‰²å…‰æšˆé™°å½± */
  transition: all 0.2s ease;
}

.line-share-btn:hover {
  background-color: #059640 !important; /* æ»‘é¼ ç§»éå»è®Šæ·±ç¶  */
  transform: translateY(-2px);          /* å¾®å¾®ä¸Šæµ® */
  box-shadow: 0 4px 12px rgba(6, 199, 85, 0.4) !important;
}
    
</style>
</head>
<body>

<!-- Login Overlay -->
<div id="loginOverlay">
  <div class="login-card">
    <h2>KINYO æŸ¥åƒ¹ç³»çµ±</h2>
    <p style="color:#666;margin-bottom:20px;">è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼ç™»å…¥</p>
    <input type="email" id="loginEmail" class="login-input" placeholder="é›»å­ä¿¡ç®±">
    <input type="password" id="loginPassword" class="login-input" placeholder="å¯†ç¢¼">
    <button id="doLoginBtn" class="login-btn">ç™»å…¥</button>
    <div id="loginError" class="login-error"></div>
  </div>
</div>

<!-- Preview Overlay -->
<div id="previewOverlay">
    <div class="preview-card">
        <div class="preview-header" id="previewHeader">
            åŒ¯å…¥é è¦½æª¢æŸ¥
        </div>
        <div class="preview-body" id="previewContent">
            <!-- Table will be injected here -->
        </div>
        <div class="preview-footer">
            <button id="cancelImportBtn" class="btn-secondary">å–æ¶ˆ</button>
            <button id="confirmImportBtn" class="btn-primary">ç¢ºèªå¯«å…¥è³‡æ–™åº«</button>
        </div>
    </div>
</div>

<!-- Loading -->
<div id="centerLoadingBox">
  <div id="centerLoadingCard">
    <div class="loading-title">å•†å“è¼‰å…¥ä¸­...</div>
    <div id="centerLoadingBar" class="loading-bar">
      <div class="fill"></div>
    </div>
  </div>
</div>

<div class="top-bar">
  <span id="userInfo" class="user-badge">æœªç™»å…¥</span>
  <button id="logoutBtn" class="logout-btn" style="display:none;">ç™»å‡º</button>
</div>

<h1>KINYO æŸ¥åƒ¹ç³»çµ±</h1>
<div class="subtitle">
  V7.6 åº«å­˜é è­¦å‡ç´šç‰ˆ --- é‹ç±Œå¸·å¹„ å°ˆå±¬å ±åƒ¹é¡§å•
  <br>
  Designed & Engineered by éƒ­åº­è±ª (0976-966-333)
</div>

<form id="searchForm" class="search-box">
  <div class="search-row">
    <label>é—œéµå­—æœå°‹ï¼ˆåˆ†é¡ / å‹è™Ÿ / åç¨±ï¼‰</label>
    <div class="combo-search">
        <select id="categorySelect">
            <option value="">å…¨éƒ¨åˆ†é¡</option>
        </select>
       <input id="keyword" placeholder="æ”¯æ´å¤šçµ„æœå°‹ (ä¾‹å¦‚: kh9660, kh195 ç”¨ç©ºç™½æˆ–é€—è™Ÿéš”é–‹)" autocomplete="off" />
    </div>
  </div>

  <div class="search-row">
  <label>èµ·è¨‚é‡ / æ§åƒ¹ / åº«å­˜ç¯©é¸</label>
  <div style="display:flex; gap:10px; align-items: stretch;">
    
    <select id="qtySelect" style="flex:5; min-width: 0;">
      </select>

    <div style="flex:2; min-width: 0; display:flex; align-items:center; justify-content:center; gap:4px; background:#eff6ff; padding:0 4px; border-radius:8px; border:1px solid #bfdbfe;">
      <input type="checkbox" id="controlledFilter" style="width:16px; height:16px; cursor:pointer;">
      <label for="controlledFilter" style="margin:0; color:#1e40af; font-weight:bold; cursor:pointer; font-size:13px; user-select:none; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
        ğŸ›¡ï¸ æ§åƒ¹
      </label>
    </div>

    <select id="stockFilter" style="flex:3; min-width: 0; border-color:#22c55e; background-color:#f0fdf4; color:#15803d; font-weight:bold; display:none;">
      <option value="">ğŸ“¦ ä¸é™åº«å­˜</option>
      <option value="ZERO" style="color:#dc2626; font-weight:bold;">âŒ ç¼ºè²¨ (0)</option>
      <option value="1">ğŸ“¦ ç¾è²¨ > 0</option>
      <option value="50">ğŸ“¦ ç¾è²¨ > 50</option>
      <option value="100">ğŸ“¦ ç¾è²¨ > 100</option>
      <option value="300">ğŸ“¦ ç¾è²¨ > 300</option>
      <option value="500">ğŸ“¦ ç¾è²¨ > 500</option>
      <option value="1000">ğŸ“¦ ç¾è²¨ > 1000</option>
    </select>

  </div>
</div>

  <div class="search-row">
    <label>é ç®—å€é–“ï¼ˆèµ·è¨‚é‡å·²é¸æ™‚æ‰ç”Ÿæ•ˆï¼›å¯åªå¡«ä¸€é‚Šï¼‰</label>
    <div style="display:flex; gap:10px;">
      <input id="minPrice" type="number" placeholder="æœ€ä½ (å¯ç©º)">
      <input id="maxPrice" type="number" placeholder="æœ€é«˜ (å¯ç©º)">
    </div>
  </div>

  <button id="searchBtn" type="submit" class="btn-primary">æŸ¥è©¢</button>
  <button id="clearBtn" type="button" class="btn-secondary" style="margin-top:20px;width:100%;">æ¸…é™¤æœå°‹æ¢ä»¶</button>
</form>

<!-- Hidden File Inputs -->
<input type="file" id="productUpload" accept=".csv, .xlsx, .xls" style="display:none" />
<!-- ğŸ†• æ–°å¢ï¼šåº«å­˜åŒ¯å…¥éš±è—æŒ‰éˆ• (V7.6) -->
<input type="file" id="inventoryUpload" accept=".csv, .xlsx, .xls" style="display:none" />

<div class="toolbar">
  <select id="sortSelect" class="btn-secondary">
    <option value="">ä¸æ’åº (éš¨æ©Ÿ)</option>
    <option value="minPriceAsc">æœ«å”®ï¼šä½ â†’ é«˜</option>
    <option value="minPriceDesc">æœ«å”®ï¼šé«˜ â†’ ä½</option>
    <option value="marketAsc">è³£å ´ï¼šä½ â†’ é«˜</option>
    <option value="marketDesc">è³£å ´ï¼šé«˜ â†’ ä½</option>
    <option value="alphaAsc">ä¸»å‹è™Ÿï¼šA â†’ Z</option>
    <option value="alphaDesc">ä¸»å‹è™Ÿï¼šZ â†’ A</option>
  </select>
  
  <!-- é è¨­éš±è—ï¼ŒLevel 4 æ‰é¡¯ç¤º -->
  <button id="importProductBtn" class="btn-secondary" style="color:#2563eb; border-color:#2563eb; background:#eff6ff; font-weight:bold; display:none;">ğŸ“¥ åŒ¯å…¥ç”¢å“ç¸½è¡¨ (åŒæ­¥ä¸Šä¸‹æ¶)</button>
  <!-- ğŸ†• æ–°å¢ï¼šåº«å­˜åŒ¯å…¥æŒ‰éˆ• (V7.6) -->
  <button id="importInventoryBtn" class="btn-secondary" style="color:#7c3aed; border-color:#7c3aed; background:#f5f3ff; font-weight:bold; display:none;">ğŸ“¦ åŒ¯å…¥åº«å­˜ (å« ETA)</button>

  <button id="batchAddQuoteBtn" class="btn-secondary" disabled>åŠ å…¥å€™é¸æ¸…å–®</button>
  <button id="multiLineBtn" class="btn-secondary" disabled>å¤šé¸ LINE åˆ†äº«</button>
 <button id="exportBtn" class="btn-secondary" disabled>åŒ¯å‡º Excel</button>
<button id="setHotBtn" class="btn-secondary" style="display:none; color:#b91c1c; border-color:#b91c1c; font-weight:bold;">ğŸ”¥ è¨­ç‚ºé¦–é ç†±é–€ (L4)</button>
  <button id="quoteToolbarBtn" class="quote-toolbar-btn">å ±åƒ¹å–®</button>
  <button id="pptToolbarBtn" class="btn-secondary" disabled>ç”Ÿæˆ PPTï¼ˆ1â€“20ï¼‰</button>

  <!-- ğŸ“Š æ–°å¢ï¼šå¤§æ•¸æ“šåŒ¯å‡ºæŒ‰éˆ• (åªæœ‰ Level 4 æœƒé¡¯ç¤º) -->
  <button id="exportHistoryBtn" class="btn-secondary" style="display:none; color:#b91c1c; border-color:#b91c1c; font-weight:bold;">ğŸ“Š åŒ¯å‡ºå ±åƒ¹å¤§æ•¸æ“š</button>
</div>
<div id="toolbarSpacer"></div>

<table id="resultTable" style="display:none;">
  <thead>
    <tr>
      <th style="width:32px;"><input type="checkbox" id="checkAll" /></th>
      <th style="width:130px; text-align:center;">å‹è™Ÿ / åœ–ç‰‡</th>
      <th>å•†å“è³‡è¨Š</th>
      <th style="width:110px; text-align:right;">åƒ¹æ ¼ (æœ«/è³£)</th>
    </tr>
  </thead>
  <tbody id="resultBody"></tbody>
</table>

<div id="detailCard"></div>

<div id="sheetBackdrop" class="sheet-backdrop hidden"></div>
<div id="mobileDetailSheet" class="sheet hidden">
  <div class="sheet-header">
    <span>å•†å“è³‡è¨Š</span>
    <button id="sheetCloseBtn" class="sheet-close">Ã—</button>
  </div>
  <div class="sheet-content" id="sheetContent"></div>
</div>

<div id="quoteSheet" class="sheet hidden">
  <div class="sheet-header">
    <span>å ±åƒ¹å–®é è¦½</span>
    <button id="quoteCloseBtn" class="quote-close">Ã—</button>
  </div>

  <div class="sheet-content" style="display:flex;flex-direction:column;">
    <div id="quoteListBody" style="flex:1;overflow-y:auto;"></div>

    <div style="border-top:1px solid #eee; padding-top:12px; margin-top:10px;">
      <button id="pptFromQuoteBtn" class="btn-primary" style="width:100%;">ç”Ÿæˆ PPT (ä¾å ±åƒ¹å–®å…§å®¹)</button>
      <button id="copyQuoteBtn" class="btn-secondary" style="width:100%;margin-top:8px;">è¤‡è£½æ•´å¼µå ±åƒ¹å–® (LINE)</button>
      <button id="downloadQuoteExcelBtn" class="btn-secondary" style="width:100%;margin-top:8px;">ä¸‹è¼‰ Excel å ±åƒ¹å–®</button>
      <button id="clearQuoteBtn" class="btn-secondary" style="width:100%;margin-top:8px;color:#ef4444;border-color:#ef4444;">æ¸…ç©ºå ±åƒ¹å–®</button>
    </div>
  </div>
</div>


<script type="module">
/* =======================================================
   1. è¨­å®šæ‚¨çš„ LOGO ç¶²å€
======================================================= */
const COMPANY_LOGO_URL = "https://drive.google.com/file/d/1JxoU3A5qAYsE39pc2z7IMVwVS8-uTOIn/view?usp=drive_link"; 

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc, doc, getDoc, updateDoc, writeBatch, initializeFirestore } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged, signOut, signInWithEmailAndPassword, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyDtp6rwV7KmIOedLQ9793BnXbBquopP9kM",
  authDomain: "kinyo-price.firebaseapp.com",
  projectId: "kinyo-price",
  storageBucket: "kinyo-price.firebasestorage.app",
  messagingSenderId: "122464645678",
  appId: "1:122464645678:web:c0febbc6297a8ada5ea5bf",
  measurementId: "G-R0PWMZNSJH"
};

const app  = initializeApp(firebaseConfig);
const db = initializeFirestore(app, { experimentalForceLongPolling: true });
const auth = getAuth(app);

const searchForm      = document.getElementById("searchForm");
const categorySelect  = document.getElementById("categorySelect");
const keywordInput    = document.getElementById("keyword");
const qtySelect       = document.getElementById("qtySelect");
const stockFilter     = document.getElementById("stockFilter");
const minPriceInput   = document.getElementById("minPrice");
const maxPriceInput   = document.getElementById("maxPrice");
const sortSelect      = document.getElementById("sortSelect");
const exportBtn       = document.getElementById("exportBtn");
const pptToolbarBtn   = document.getElementById("pptToolbarBtn");
const multiLineBtn    = document.getElementById("multiLineBtn");
const batchAddQuoteBtn = document.getElementById("batchAddQuoteBtn");
const clearBtn        = document.getElementById("clearBtn");
const importProductBtn   = document.getElementById("importProductBtn");
const importInventoryBtn = document.getElementById("importInventoryBtn"); // ğŸ†•
const productUpload   = document.getElementById("productUpload");
const inventoryUpload = document.getElementById("inventoryUpload");       // ğŸ†•

const resultTable     = document.getElementById("resultTable");
const resultBody      = document.getElementById("resultBody");
const checkAllBox     = document.getElementById("checkAll");
const detailCard      = document.getElementById("detailCard");

const userInfoSpan    = document.getElementById("userInfo");
const logoutBtn       = document.getElementById("logoutBtn");

const sheetBackdrop   = document.getElementById("sheetBackdrop");
const mobileSheet     = document.getElementById("mobileDetailSheet");
const sheetContent    = document.getElementById("sheetContent");
const sheetCloseBtn   = document.getElementById("sheetCloseBtn");

const quoteSheet      = document.getElementById("quoteSheet");
const quoteCloseBtn   = document.getElementById("quoteCloseBtn");
const quoteListBody   = document.getElementById("quoteListBody");
const copyQuoteBtn    = document.getElementById("copyQuoteBtn");
const clearQuoteBtn   = document.getElementById("clearQuoteBtn");
const downloadQuoteExcelBtn = document.getElementById("downloadQuoteExcelBtn");
const quoteToolbarBtn = document.getElementById("quoteToolbarBtn");
const pptFromQuoteBtn = document.getElementById("pptFromQuoteBtn");

const centerLoadingBox = document.getElementById("centerLoadingBox");
const centerLoadingBar = document.getElementById("centerLoadingBar");

const loginOverlay = document.getElementById("loginOverlay");
const loginEmail = document.getElementById("loginEmail");
const loginPassword = document.getElementById("loginPassword");
const doLoginBtn = document.getElementById("doLoginBtn");
const loginError = document.getElementById("loginError");

// Preview Elements
const previewOverlay = document.getElementById("previewOverlay");
const previewHeader  = document.getElementById("previewHeader");
const previewContent = document.getElementById("previewContent");
const cancelImportBtn = document.getElementById("cancelImportBtn");
const confirmImportBtn = document.getElementById("confirmImportBtn");

let productCache = [];
let currentResultList = [];
let userLevel = 0; 
let currentUserEmail = "";
let currentUserVipConfig = null; // ğŸš€ VIP Config: { column: 'VIP_A', name: 'å¥½å¸‚å¤š' }
   let isGroupBuyUser = false;
let quoteList = [];
let isProductsLoaded = false;
let isQuotesLoaded = false;
let hasCheckedItems = false;

// Import state
let currentImportMode = ""; // 'inventory' or 'product'
let pendingInventoryMap = new Map(); 
let pendingProductData = []; // Array of objects containing { action, data, id? }

const CACHE_TTL = 1000 * 60 * 60 * 6; 

function getCacheKey() {
  const mail = (currentUserEmail || "guest").toLowerCase();
  return `KINYO_SAFE_CACHE_V580_${mail}`; // Reuse key
}

function loadCache() {
  try {
    const raw = localStorage.getItem(getCacheKey());
    if (!raw) return null;
    const obj = JSON.parse(raw);
    if (!obj || !obj.time || !Array.isArray(obj.data)) return null;
    if (Date.now() - obj.time > CACHE_TTL) return null;
    return obj.data;
  } catch { return null; }
}

function saveCache(data) {
  try {
    localStorage.setItem(getCacheKey(), JSON.stringify({ time: Date.now(), data }));
  } catch {}
}

let driveMap = new Map();
let mainFolderMap = new Map();
let netMap    = new Map();
let netImagesMap = new Map();
let isDriveLoaded = false;

/* ğŸš€ ====================================================
     HELPER FUNCTIONS
   ==================================================== ğŸš€ */

/* ğŸš€ åº«å­˜åˆ¤æ–·é‚è¼¯ (10éšå±¤ç´š + ç¼ºè²¨) */
function getInventoryStatus(qty) {
  if (qty === null || qty === undefined || qty === "") return null;
  const val = parseInt(qty, 10);
  if (isNaN(val)) return null;

  // 1. ç¼ºè²¨ (â‰¤ 0) - ç°è‰²
  if (val <= 0)    return { label: "âŒ ç¼ºè²¨ä¸­",    cls: "st-zero" };
  
  // 2. å±éšªæ°´ä½ (1-29) - ç´…è‰²
  if (val < 30)    return { label: "åº«å­˜ < 30",    cls: "st-crit" };

  // 3. ä½æ°´ä½ (30-99) - æ©˜ç´…
  if (val < 100)   return { label: "åº«å­˜ < 100",   cls: "st-low" };

  // 4. æ™®é€šæ°´ä½ç´°åˆ† (100-399) - æ©˜é»ƒ
  if (val < 200)   return { label: "åº«å­˜ < 200",   cls: "st-warn" };
  if (val < 300)   return { label: "åº«å­˜ < 300",   cls: "st-warn" };
  if (val < 400)   return { label: "åº«å­˜ < 400",   cls: "st-warn" };

  // 5. ä¸­æ°´ä½ (400-699) - è‰ç¶ 
  if (val < 700)   return { label: "åº«å­˜ < 700",   cls: "st-mid" };

  // 6. é«˜æ°´ä½ç´°åˆ† (700-1200) - ç¶ è‰²
  if (val < 900)   return { label: "åº«å­˜ < 900",   cls: "st-good" };
  if (val <= 1200) return { label: "åº«å­˜ < 1200",  cls: "st-good" };
  
  // 7. çˆ†é‡ (> 1200) - æ·±ç¶ 
  return { label: "åº«å­˜ > 1200", cls: "st-high" };
}

function getInventoryRangeLabel(qty, eta) {
    if (qty === null || qty === undefined || qty === "") return null;
    const val = parseInt(qty, 10);
    if (isNaN(val)) return null;
    
    let label = "";
    if (val > 1000) label = "1000å€‹ä»¥ä¸Š";
    else if (val <= 100) label = "100å€‹ä»¥å…§";
    else if (val <= 300) label = "300å€‹ä»¥å…§";
    else if (val <= 500) label = "500å€‹ä»¥å…§";
    else if (val <= 1000) label = "1000å€‹ä»¥å…§";
    
    // ğŸ†• åŒ¯å‡ºæ™‚å¦‚æœç¼ºè²¨ï¼Œè£œä¸Š ETA
    if ((val <= 0 || val < 100) && eta) {
        label += ` (é è¨ˆ ${eta} åˆ°è²¨)`;
    }
    
    return label;
}

/* ğŸš€ ä¿®æ”¹ç‰ˆï¼šåŠ å…¥èƒ½é‡æ¢ (Energy Bar) + ETA é¡¯ç¤º */
function renderStockByVariant(item) {
    // 1. æ¬Šé™æª¢æŸ¥
    if (userLevel < 2 && !currentUserVipConfig) return "";
    
    // 2. è³‡æ–™æª¢æŸ¥
    if (!item.variants || item.variants.length === 0) return "";
    const activeVariants = item.variants.filter(v => v.inventory !== undefined && v.inventory !== null && v.inventory !== "");
    if (activeVariants.length === 0) return "";

    let html = `<div style="display:flex; flex-direction:column; gap:6px; margin-top:6px; border-top:1px dashed #eee; padding-top:6px;">`;

    activeVariants.forEach(v => {
        const status = getInventoryStatus(v.inventory);
        if (status) {
            const qty = parseInt(v.inventory || 0);
            
            // --- ğŸ”‹ èƒ½é‡æ¢è¨ˆç®—æ ¸å¿ƒ ---
            let percent = Math.min((qty / 1200) * 100, 100);
            if (qty > 0 && percent < 5) percent = 5;

            // --- ğŸ¨ é¡è‰²åˆ¤æ–· (10 éšå°æ‡‰ 5 ç¨®é¡è‰²) ---
            let fillClass = "fill-good";
            if (qty <= 0)      fillClass = "st-zero";    // 0
            else if (qty < 30) fillClass = "fill-crit";  // 1-29 (ç´…)
            else if (qty < 100) fillClass = "fill-low";  // 30-99 (æ©˜)
            else if (qty < 400) fillClass = "fill-mid";  // 100-399 (é»ƒ)
            else if (qty < 700) fillClass = "fill-good"; // 400-699 (ç¶ )
            else if (qty <= 1200) fillClass = "fill-high";// 700-1200 (æ·±ç¶ )
            else fillClass = "fill-high";                 // >1200 (æ·±ç¶ )

            // --- ğŸ·ï¸ æ¨™ç±¤é¡¯ç¤ºé‚è¼¯ ---
            let colorLabel = "";
            if (activeVariants.length > 1 || (v.color && v.color !== "å–®ä¸€æ¬¾å¼")) {
               colorLabel = `<span style="color:#666; margin-right:4px; font-size:12px;">${v.color}</span>`;
            }

            // VIP æ¨¡ç³Šé‚è¼¯
            let displayLabel = status.label;
            if (currentUserVipConfig) {
                if (qty >= 100) displayLabel = "åº«å­˜å……è¶³";
                else displayLabel = "åº«å­˜ç·Šå¼µ";
            }

            // ğŸ†• é è¨ˆåˆ°è²¨æ—¥ (ETA) é‚è¼¯
            // åªæœ‰åº«å­˜ < 100 æˆ–æ˜¯ 0 çš„æ™‚å€™æ‰é¡¯ç¤ºæ—¥æœŸï¼Œé¿å…ç‰ˆé¢å¤ªäº‚
            if (v.nextArrival && qty < 100) {
                // é€™è£¡çš„ nextArrival æ˜¯å¾è³‡æ–™åº«å–å‡ºçš„å­—ä¸²ï¼Œå¯èƒ½æ˜¯ "3/20" æˆ– "2025/3/20"
                displayLabel += ` <span style="color:#2563eb; margin-left:4px; font-weight:normal;">(ğŸ“… ${v.nextArrival})</span>`;
            }

            // --- ğŸ–¥ï¸ çµ„åˆ HTML ---
            html += `
            <div style="width:100%;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1px;">
                    ${colorLabel}
                    <span class="stock-tag ${status.cls}" style="font-size:11px; padding:1px 6px; transform:scale(0.9); transform-origin:right center;">${displayLabel}</span>
                </div>
                <div class="stock-bar-container">
                    <div class="stock-bar-fill ${fillClass}" style="width: ${percent}%;"></div>
                </div>
            </div>`;
        }
    });

    html += `</div>`;
    return html;
}

function getGoogleDriveId(url) {
  if (!url) return null;
  const patterns = [
    /\/d\/([a-zA-Z0-9_-]+)/,        
    /id=([a-zA-Z0-9_-]+)/,          
    /open\?id=([a-zA-Z0-9_-]+)/      
  ];
  for (let p of patterns) {
    const m = url.match(p);
    if (m && m[1]) return m[1];
  }
  return null;
}

async function fetchAsDataURL(url) {
  if (!url) return null;
  let targetUrl = url;
  if (url.includes("drive.google.com") || url.includes("googleusercontent.com")) {
    const id = getGoogleDriveId(url);
    if (id) {
       const directLink = `https://drive.google.com/uc?id=${id}`;
       // é™ä½å“è³ªæå‡ä¸‹è¼‰é€Ÿåº¦ (åŸ: w=400&q=70 -> æ”¹: w=300&q=50)
       targetUrl = "https://images.weserv.nl/?url=" + encodeURIComponent(directLink) + "&output=jpg&w=300&q=50";
    } else {
       targetUrl = "https://images.weserv.nl/?url=" + encodeURIComponent(url) + "&output=jpg&w=300&q=50";
    }
  } else {
      if(targetUrl.includes("weserv.nl")) {
          if(!targetUrl.includes("&w=")) targetUrl += "&w=300&q=50";
      } else {
          targetUrl = "https://images.weserv.nl/?url=" + encodeURIComponent(url) + "&output=jpg&w=300&q=50";
      }
  }

  try {
    const res = await fetch(targetUrl, { mode: 'cors', credentials: 'omit' });
    if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
    const blob = await res.blob();
    return new Promise((resolve) => {
      const reader = new FileReader();
      reader.onloadend = () => resolve(reader.result);
      reader.readAsDataURL(blob);
    });
  } catch (e) {
    console.warn("åœ–ç‰‡è®€å–å¤±æ•—:", url);
    return null;
  }
}

function pickRandom(arr, count) {
  if (!Array.isArray(arr)) return [];
  const _arr = [...arr];
  for (let i = _arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [_arr[i], _arr[j]] = [_arr[j], _arr[i]];
  }
  return _arr.slice(0, count);
}

/* ğŸš€ æ–°å¢ï¼šå ±åƒ¹è¡Œç‚ºè¨˜éŒ„å™¨ (Log Quote History) - V7.3 */
async function logQuoteAction(items, sourceMode) {
    try {
        // 1. æº–å‚™åŸºæœ¬è³‡æ–™
        const timestamp = new Date();
        const userEmail = currentUserEmail || "guest";
        const userName = (currentUserVipConfig && currentUserVipConfig.name) ? currentUserVipConfig.name : userEmail; 
        
        let totalAmount = 0;
        let productDetails = [];
        
        // 2. åˆ¤æ–·ä¾†æºä¸¦è¨ˆç®—é‡‘é¡
        if (sourceMode === 'quote') {
            // ä¾†æº A: å¾å ±åƒ¹å–®ç”Ÿæˆ (è³‡è¨Šæœ€å®Œæ•´)
            items.forEach(i => {
                const p = parseFloat(i.customQuoteInfo?.price || i.price || 0);
                const q = parseInt(i.count || 1);
                const subtotal = p * q;
                totalAmount += subtotal;
                
                productDetails.push({
                    model: i.model,
                    name: i.name,
                    price: p,
                    qty: q,
                    qtyLabel: i.customQuoteInfo?.qtyLabel || i.qtyLabel || "è‡ªè¨‚",
                    subtotal: subtotal
                });
            });
        } else {
            // ä¾†æº B: å¾åˆ—è¡¨å‹¾é¸ç”Ÿæˆ (é è¨­æ•¸é‡ 1)
            const currentTier = qtySelect.value || "50"; 
            items.forEach(i => {
                const priceKey = `quote${currentTier}`;
                let finalPrice = i[priceKey] || i.quote50 || 0;
                if(currentUserVipConfig) {
                      finalPrice = i[currentUserVipConfig.column] || 0;
                }
                const p = parseFloat(finalPrice);
                const q = 1;
                const subtotal = p * q;
                totalAmount += subtotal;

                productDetails.push({
                    model: i.model,
                    name: i.name,
                    price: p,
                    qty: q,
                    qtyLabel: `${currentTier}å€‹(é è¨­)`,
                    subtotal: subtotal
                });
            });
        }

        // 3. æ‰“åŒ…è³‡æ–™ç‰©ä»¶
        const logData = {
            action: "generate_ppt",
            source: sourceMode,
            user: userName,
            email: userEmail,
            createdAt: timestamp,
            totalAmount: totalAmount,
            itemCount: productDetails.length,
            items: productDetails
        };

        // 4. å¯«å…¥ Firebase (QuoteHistory)
        const historyRef = collection(db, "QuoteHistory");
        // ä¸ä½¿ç”¨ awaitï¼Œè®“å®ƒåœ¨èƒŒæ™¯è·‘ï¼Œä¸å¡ä½ PPT ç”Ÿæˆ
        addDoc(historyRef, logData).then(() => {
            console.log("âœ… å ±åƒ¹ç´€éŒ„å·²å„²å­˜ (ç¸½é¡: $" + totalAmount + ")");
        });

    } catch (e) {
        console.warn("âš ï¸ å ±åƒ¹ç´€éŒ„å¯«å…¥å¤±æ•—:", e);
    }
}

/* ğŸš€ æ–°å¢ï¼šåŒ¯å‡ºå ±åƒ¹æ­·å²ç´€éŒ„ (Export Big Data) - V7.3 */
async function exportQuoteHistory() {
    // 1. å®‰å…¨ç¢ºèª
    if (!confirm("ç¢ºå®šè¦åŒ¯å‡ºæ‰€æœ‰å ±åƒ¹ç´€éŒ„å—ï¼Ÿé€™å¯èƒ½éœ€è¦ä¸€é»æ™‚é–“ã€‚")) return;
    
    const btn = document.getElementById("exportHistoryBtn");
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = "æ­£åœ¨ä¸‹è¼‰é›²ç«¯æ•¸æ“š...";

    try {
        // 2. æŠ“å–è³‡æ–™ (å¾ Firebase çš„ QuoteHistory é›†åˆ)
        // æ³¨æ„ï¼šå¦‚æœè³‡æ–™é‡éå¤§ï¼ŒFirebase å¯èƒ½æœƒè¦æ±‚å»ºç«‹ç´¢å¼• (Index)ï¼Œè«‹ç•™æ„ Console è¨Šæ¯
        const q = collection(db, "QuoteHistory"); 
        const querySnapshot = await getDocs(q);
        
        let rows = [];
        // 3. è¨­å®š Excel è¡¨é ­ (Header)
        rows.push(["æ—¥æœŸ", "æ™‚é–“", "æ¥­å‹™/å®¢æˆ¶", "æ“ä½œä¾†æº", "æ•´å–®ç¸½é‡‘é¡", "å•†å“å‹è™Ÿ", "å•†å“åç¨±", "æ•¸é‡", "å ±åƒ¹å–®åƒ¹", "å°è¨ˆ"]);

        // 4. è§£ææ¯ä¸€ç­†è³‡æ–™
        querySnapshot.forEach((doc) => {
            const data = doc.data();
            const dateObj = data.createdAt ? data.createdAt.toDate() : new Date();
            const dateStr = dateObj.toLocaleDateString('zh-TW');
            const timeStr = dateObj.toLocaleTimeString('zh-TW');

            // å› ç‚ºä¸€ç­†ç´€éŒ„åŒ…å«å¤šå€‹å•†å“ï¼Œæˆ‘å€‘è¦æŠŠå®ƒã€Œæ”¤å¹³ã€æˆå¤šè¡Œ
            if (data.items && Array.isArray(data.items)) {
                data.items.forEach(item => {
                    rows.push([
                        dateStr,
                        timeStr,
                        data.user || "Guest",
                        data.source === 'quote' ? 'å ±åƒ¹å–®ç”Ÿæˆ' : 'åˆ—è¡¨ç›´æ¥ç”Ÿæˆ',
                        data.totalAmount || 0,
                        item.model,
                        item.name,
                        item.qty,
                        item.price,
                        item.subtotal
                    ]);
                });
            }
        });

        // 5. ç”Ÿæˆä¸¦ä¸‹è¼‰ Excel
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, "å ±åƒ¹å¤§æ•¸æ“š");
        XLSX.writeFile(wb, `KINYO_å ±åƒ¹å¤§æ•¸æ“š_${new Date().toISOString().slice(0,10)}.xlsx`);

        alert(`åŒ¯å‡ºæˆåŠŸï¼å…±ä¸‹è¼‰ ${querySnapshot.size} ç­†æ“ä½œç´€éŒ„ã€‚`);

    } catch (e) {
        console.error("åŒ¯å‡ºå¤±æ•—:", e);
        alert("åŒ¯å‡ºå¤±æ•—ï¼Œè«‹æª¢æŸ¥ Console éŒ¯èª¤è¨Šæ¯ (å¯èƒ½éœ€è¦å»ºç«‹ Firebase ç´¢å¼•)");
    } finally {
        // 6. æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
        btn.disabled = false;
        btn.textContent = originalText;
    }
}
    
/* ğŸš€ ä¿®æ”¹ç‰ˆï¼šè¨˜éŒ„æ‰“å‹¾é—œæ³¨è¡Œç‚º (å¯«å…¥åˆ°å…¬é–‹æ•¸æ“šæ±  ProductClicks) */
async function logCheckboxInterest(item) {
    try {
        const timestamp = new Date();
        
        // âš ï¸ é—œéµå·®ç•°ï¼šé€™è£¡æˆ‘å€‘ã€Œæ•…æ„ä¸å­˜ã€User å’Œ Email
        // åªè¨˜éŒ„å‹è™Ÿè·Ÿå“åï¼Œé€™æ¨£å°±ç®—è³‡æ–™è¢«å…¬é–‹è®€å–ï¼Œä¹Ÿçµ•å°å®‰å…¨
        const logData = {
            model: item.model,
            name: item.name,
            price: item.marketPrice || 0, // å­˜è³£å ´åƒ¹ç•¶åƒè€ƒ (éåº•åƒ¹)
            createdAt: timestamp,
            source: "backend_check" // æ¨™è¨˜ä¾†æºæ˜¯å¾Œå°æ‰“å‹¾
        };

        // âœ… æ”¹å¯«å…¥åˆ° ProductClicks (é€™æ˜¯æˆ‘å€‘è¨­å®šç‚ºå¯å…¬é–‹è®€å–çš„é›†åˆ)
        const historyRef = collection(db, "ProductClicks");
        
        // å°„å¾Œä¸ç†
        addDoc(historyRef, logData).then(() => {
            // console.log("é—œæ³¨ç´€éŒ„å·²å„²å­˜ (å®‰å…¨ç‰ˆ):", item.model);
        });

    } catch (e) {
        console.warn("é—œæ³¨ç´€éŒ„å¯«å…¥å¤±æ•—:", e);
    }
}
    
   function showLoading() {
  centerLoadingBox.style.display = "flex";
  centerLoadingBar.querySelector(".fill").style.width = "0%";
  setTimeout(() => { centerLoadingBar.querySelector(".fill").style.width = "55%"; }, 120);
}
function hideLoading() {
  centerLoadingBar.querySelector(".fill").style.width = "100%";
  setTimeout(() => { centerLoadingBox.style.display = "none"; }, 0);
}

function openSheet() { sheetBackdrop.classList.remove("hidden"); mobileSheet.classList.remove("hidden"); requestAnimationFrame(() => mobileSheet.classList.add("open")); }
function closeSheet() { mobileSheet.classList.remove("open"); setTimeout(() => { mobileSheet.classList.add("hidden"); if (quoteSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden"); }, 220); }

function openQuoteSheet() { sheetBackdrop.classList.remove("hidden"); quoteSheet.classList.remove("hidden"); requestAnimationFrame(() => quoteSheet.classList.add("open")); renderQuoteList(); }
function closeQuoteSheet() { quoteSheet.classList.remove("open"); setTimeout(() => quoteSheet.classList.add("hidden"), 220); if (mobileSheet.classList.contains("hidden")) sheetBackdrop.classList.add("hidden"); }

function updateQuoteToolbarBtn() { 
  if (quoteList.length > 0) { 
    quoteToolbarBtn.style.display = "inline-block"; 
    quoteToolbarBtn.textContent = `å ±åƒ¹å–®ï¼ˆ${quoteList.length}ï¼‰`; 
  } else { 
    quoteToolbarBtn.style.display = "none"; 
  } 
}

function updateToolbarScrollState() {
  const toolbar = document.querySelector('.toolbar');
  const spacer = document.getElementById('toolbarSpacer');
  const searchForm = document.getElementById('searchForm');

  if (!hasCheckedItems) {
    toolbar.classList.remove('fixed-active');
    if(spacer) spacer.style.display = 'none';
    return;
  }
  const triggerPoint = searchForm.offsetTop + searchForm.offsetHeight;
  if (window.scrollY > triggerPoint) {
    if (!toolbar.classList.contains('fixed-active')) {
      toolbar.classList.add('fixed-active');
      if(spacer) spacer.style.display = 'block';
    }
  } else {
    if (toolbar.classList.contains('fixed-active')) {
      toolbar.classList.remove('fixed-active');
      if(spacer) spacer.style.display = 'none';
    }
  }
}

function updateMultiLineBtnState() { 
  const checked = document.querySelectorAll(".row-check:checked");
  hasCheckedItems = checked.length > 0;
  
  if(multiLineBtn) multiLineBtn.disabled = !hasCheckedItems;
  if(exportBtn) exportBtn.disabled = !hasCheckedItems; 
  if(pptToolbarBtn) pptToolbarBtn.disabled = !hasCheckedItems; 
  if(batchAddQuoteBtn) batchAddQuoteBtn.disabled = !hasCheckedItems;
   const setHotBtn = document.getElementById("setHotBtn");
    if(setHotBtn && userLevel >= 4) setHotBtn.disabled = !hasCheckedItems;
  
  updateToolbarScrollState();
}

function renderQuoteList() {
  quoteListBody.innerHTML = ""; if (quoteList.length === 0) { quoteListBody.innerHTML = `<div style="text-align:center;padding:40px;color:#999;">å ±åƒ¹å–®æ˜¯ç©ºçš„</div>`; return; }
  quoteList.forEach((q, idx) => {
    const div = document.createElement("div"); div.className = "quote-item";
    const priceDisplay = `$${q.price}`;
    
    // ğŸ†• å³ä¸‹è§’æ¸…å–®é¡¯ç¤º ETA
    let etaHtml = "";
    // å˜—è©¦å¾ productCache æ‰¾å› ETA è³‡è¨Š
    const fullItem = productCache.find(p => p.model === q.model);
    if(fullItem && fullItem.nextArrival && (parseInt(fullItem.inventory||0) < 100)) {
        etaHtml = `<span style="color:#ef4444; font-size:12px; margin-left:4px;">(ğŸ“… ${fullItem.nextArrival})</span>`;
    }

    div.innerHTML = `<div style="flex:1;"><div style="font-weight:700;">${q.name}</div><div class="quote-info">${q.model} ${etaHtml} | ${q.qtyLabel}</div></div><div style="text-align:right;margin-right:8px;"><div class="quote-price">${priceDisplay}</div><div style="font-size:12px;color:#888;">x ${q.count}</div></div><div class="quote-del" data-idx="${idx}">ğŸ—‘ï¸</div>`;
    quoteListBody.appendChild(div);
  });
  document.querySelectorAll(".quote-del").forEach(btn => { btn.onclick = (e) => { const i = Number(e.target.getAttribute("data-idx")); quoteList.splice(i, 1); renderQuoteList(); updateQuoteToolbarBtn(); }; });
}

function bindCheckAll() {
  const rowChecks = document.querySelectorAll(".row-check");
  checkAllBox.onchange = () => { rowChecks.forEach(c => c.checked = checkAllBox.checked); updateMultiLineBtnState(); };
  rowChecks.forEach(chk => { chk.onchange = () => { const all = document.querySelectorAll(".row-check"); const checked = document.querySelectorAll(".row-check:checked"); checkAllBox.checked = (all.length === checked.length); updateMultiLineBtnState(); }; });
}

function updateUserDisplay(status) {
  if (!userInfoSpan) return;
  if (status === 'searching') {
    userInfoSpan.textContent = "ğŸ” æœå°‹é‹ç®—ä¸­...";
    userInfoSpan.style.background = "#fef9c3";
    userInfoSpan.style.color = "#854d0e";
    userInfoSpan.className = "user-badge";
  } else {
    let badgeClass = "badge-lv0";
    if (userLevel === 1) badgeClass = "badge-lv1";
    else if (userLevel === 2) badgeClass = "badge-lv2";
    else if (userLevel >= 3) badgeClass = "badge-lv3";
    
    // VIP Badge Logic
    if (currentUserVipConfig) {
        badgeClass = "badge-vip";
        userInfoSpan.textContent = `${currentUserVipConfig.name} (VIP)`;
    } else {
        userInfoSpan.textContent = `${currentUserEmail.replace(/@.*/, "")}`;
    }
    
    userInfoSpan.className = `user-badge ${badgeClass}`;
    userInfoSpan.style.background = ""; 
    userInfoSpan.style.color = "";
  }
}

// ğŸš€ Updates UI permissions based on user level
function updatePermissions() {
    const exportHistoryBtn = document.getElementById("exportHistoryBtn");

    // 1. Level 4 Only
    if (userLevel >= 4) {
        if(importProductBtn) importProductBtn.style.display = 'inline-block'; 
        if(importInventoryBtn) importInventoryBtn.style.display = 'inline-block'; // ğŸ†• 
        
        if(exportHistoryBtn) exportHistoryBtn.style.display = 'inline-block';

        const btn = document.getElementById("setHotBtn");
        if(btn) btn.style.display = 'inline-block'; 

    } else {
        if(importProductBtn) importProductBtn.style.display = 'none'; 
        if(importInventoryBtn) importInventoryBtn.style.display = 'none'; // ğŸ†•
        
        if(exportHistoryBtn) exportHistoryBtn.style.display = 'none';

        const btn = document.getElementById("setHotBtn");
        if(btn) btn.style.display = 'none';
    }

    // 2. Level 2+ æˆ– VIP éƒ½èƒ½ä½¿ç”¨åº«å­˜ç¯©é¸
    if (userLevel >= 2 || currentUserVipConfig) {
        if(stockFilter) stockFilter.style.display = 'block'; 
    } else {
        if(stockFilter) stockFilter.style.display = 'none';
    }
}

async function getDocsWithRetry(queryRef, retries = 3, delay = 1000) {
    for (let i = 0; i < retries; i++) {
        try {
            return await getDocs(queryRef);
        } catch (err) {
            console.warn(`Attempt ${i + 1} failed. Retrying in ${delay}ms...`, err);
            if (i === retries - 1) throw err;
            await new Promise(res => setTimeout(res, delay));
        }
    }
}

function normalizeKey(key) {
    if (!key) return "";
    let base = key.split('.')[0].split('_')[0].toUpperCase();
    base = base.replace(/-/g, '');
    let m = base.match(/^([a-zA-Z]+)(\d+)([a-zA-Z]*)$/);
    if (m) { return (m[1] + m[2]); }
    return base;
}

function shuffleArray(arr) {
  const a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

async function preloadDriveModelData() {
  try {
    const res = await fetch(`./modelData.json?v=${Date.now()}`, { cache: "no-store" });
    if (!res.ok) throw new Error("modelData.json è®€å–å¤±æ•—");
    const data = await res.json();

    driveMap.clear(); netMap.clear(); netImagesMap.clear(); mainFolderMap.clear();

    (data.models || []).forEach(m => {
      const rawKey = String(m.mainModel || m.model || "").trim();
      if (!rawKey) return;
      const key = normalizeKey(rawKey);

      if (m.mainImage) driveMap.set(key, m.mainImage);
      if (m.folderUrl) mainFolderMap.set(key, m.folderUrl);
      
      const folderUrl = m.netGalleryUrl || m.netFolderUrl || m.folderUrl || m.folderLink || "";
      if (folderUrl) netMap.set(key, folderUrl);

      let finalImages = [];
      if (Array.isArray(m.netImages) && m.netImages.length > 0) {
          finalImages = m.netImages.filter(Boolean);
      }
      else if (Array.isArray(m.images) && m.images.length > 0) {
          finalImages = m.images.map(x => x.url).filter(Boolean);
      }
      if (finalImages.length > 0) netImagesMap.set(key, finalImages);
    });
    isDriveLoaded = true;
  } catch (e) {
    console.warn("Drive è¼‰å…¥å¤±æ•—", e);
    isDriveLoaded = false;
  }
}

function getDriveMainImage(model, mainModel) {
  const k1 = normalizeKey(model);
  const k2 = normalizeKey(mainModel);
  return driveMap.get(k1) || driveMap.get(k2) || "";
}
function getDriveMainFolder(model, mainModel){
  const k1 = normalizeKey(model);
  const k2 = normalizeKey(mainModel);
  return mainFolderMap.get(k1)||mainFolderMap.get(k2)||"";
}
function getDriveNetGallery(model, mainModel) {
  const k1 = normalizeKey(model);
  const k2 = normalizeKey(mainModel);
  return netMap.get(k1) || netMap.get(k2) || "";
}
function getDriveNetImages(model, mainModel){
  const k1 = normalizeKey(model);
  const k2 = normalizeKey(mainModel);
  return netImagesMap.get(k1) || netImagesMap.get(k2) || [];
}

/* ğŸš€ Updated Logic - æ™ºæ…§ä¸»å‹è™Ÿåˆ¤æ–· (ä¿®æ­£ WV-KHP1230PI åˆä½µå•é¡Œ) */
function getMainModel(model) {
  if (!model) return "";
  const raw = String(model).trim().toUpperCase();
  if (!raw) return "";

  // 1. å„ªå…ˆè™•ç†ï¼šå¦‚æœæœ‰æ©«ç·šä¸”æœ€å¾Œä¸€æ®µæ˜¯ç´”è‹±æ–‡ (ä¾‹å¦‚ CL-123-W)
  // é€™ä»£è¡¨æœ€å¾Œä¸€æ®µè‚¯å®šæ˜¯é¡è‰²æˆ–å¾Œç¶´
  if (raw.includes("-")) {
    const parts = raw.split("-");
    const last = parts[parts.length - 1];
    // å¦‚æœæœ€å¾Œä¸€æ®µæ˜¯ 1~3 å€‹è‹±æ–‡å­—æ¯ (æ’é™¤æ•¸å­—)
    if (/^[A-Z]{1,3}$/.test(last)) {
        // åˆ‡æ‰æœ€å¾Œä¸€æ®µï¼Œä¾‹å¦‚ CL-123-W => CL-123
        return raw.substring(0, raw.lastIndexOf("-"));
    }
  }

  // 2. æ¬¡è¦è™•ç†ï¼šç›´æ¥é»åœ¨å¾Œé¢çš„å¾Œç¶´ (ä¾‹å¦‚ WV-KHP1230PI => WV-KHP1230)
  // é‚è¼¯ï¼šå­—ä¸²çµå°¾æ˜¯ "æ•¸å­—" æ¥ "1~3å€‹è‹±æ–‡å­—"
  const match = raw.match(/(.*[0-9]+)([A-Z]{1,3})$/);
  if (match) {
      return match[1]; // å›å‚³å‰åŠæ®µ (WV-KHP1230)
  }

  // 3. éƒ½æ²’å°ä¸­ï¼Œå°±å›å‚³åŸå§‹å‹è™Ÿ (ä¾‹å¦‚ CL-528)
  return raw;
}

function updateCategoryOptions() {
  const cats = new Set();
  productCache.forEach(p => {
    // Only show category if status is not inactive
    if(p.status !== 'inactive' && p.category) cats.add(p.category.trim());
  });
  
  const sortedCats = Array.from(cats).sort();
  
  const currentVal = categorySelect.value;
  
  categorySelect.innerHTML = `<option value="">å…¨éƒ¨åˆ†é¡</option>`;
  sortedCats.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c;
    opt.textContent = c;
    categorySelect.appendChild(opt);
  });
  
  if(currentVal && sortedCats.includes(currentVal)) {
    categorySelect.value = currentVal;
  }
}

/* ğŸš€ Preload Products - Plan A: Pre-calculation & Merge Logic */
async function preloadProducts() {
  showLoading();
  isProductsLoaded = false;
  isQuotesLoaded = false;

  try {
    const snap = await getDocsWithRetry(collection(db, "Products"));
    const rawList = [];

    // 1. Fetch raw data
    snap.forEach(docSnap => {
      const d = docSnap.data() || {};
      const id = docSnap.id;
      
      const model = (d.model || "").trim();
      const mainModel = getMainModel(model);
      
      let colorList = (d.colorList || "").trim();
      // å¦‚æœ colorList ç©ºç™½ï¼Œå˜—è©¦å¾å‹è™Ÿå–å¾—å¾Œç¶´ (ä¾‹å¦‚ CL-123W -> W)
      if (!colorList) {
        const suffix = model.toUpperCase().replace(mainModel, "").replace("-", "");
        if (suffix && /^[A-Z]{1,3}$/.test(suffix)) colorList = suffix;
      }

      // ä¸åœ¨é€™è£¡çµ„ searchKeyï¼Œå› ç‚ºç­‰ä¸€ä¸‹è¦åˆä½µ
      const category = d.category ? String(d.category).trim() : "";
      const netSalesPermission = d.netSalesPermission ? String(d.netSalesPermission).trim() : "";
      const nextArrival = d.nextArrival || ""; // ğŸ†• è®€å– ETA
      
      rawList.push({ id, ...d, model, mainModel, colorList, category, netSalesPermission, nextArrival });
    });

    // 2. Perform Pre-calculation Merge (æ–¹æ¡ˆ A)
    const mergedMap = {};
    rawList.forEach(item => {
        // Skip inactive items from the merge (optional, but cleaner)
        if(item.status === 'inactive') return;

        const main = item.mainModel;
        
        // å»ºç«‹è®Šé«”ç‰©ä»¶
        const variantObj = {
            model: item.model,
            color: item.colorList || "å–®ä¸€æ¬¾å¼",
            inventory: item.inventory,
            nextArrival: item.nextArrival // ğŸ†• ç¶å®š ETA åˆ°è®Šé«”
        };

        if (!mergedMap[main]) {
            // åˆå§‹åŒ–ä¸»ç‰©ä»¶
            mergedMap[main] = { 
                ...item, 
                models: [item.model], 
                variants: [variantObj],
                // é‡ç½® colorListï¼Œç¨å¾Œç´¯åŠ 
                colorList: item.colorList || "" 
            };
        } else {
            // åˆä½µè®Šé«”
            mergedMap[main].models.push(item.model);
            mergedMap[main].variants.push(variantObj);

            // åˆä½µé¡è‰²å­—ä¸²
            const existColors = mergedMap[main].colorList.split(" / ").filter(Boolean);
            const newColors = (item.colorList || "").split(" / ").filter(Boolean);
            mergedMap[main].colorList = [...new Set([...existColors, ...newColors])].join(" / ");
            
            // è®“ inventory æ¬„ä½ä¿æŒç‚ºæœ€å¤§å€¼ï¼Œæ–¹ä¾¿æ’åº (å¯é¸)
            if(item.inventory && parseInt(item.inventory) > parseInt(mergedMap[main].inventory||0)) {
                mergedMap[main].inventory = item.inventory;
            }
        }
    });

    // 3. Convert map back to array & Add Search Key
    productCache = Object.values(mergedMap).map(p => {
        return {
            ...p,
            // é—œéµå­—æœå°‹è¦åŒ…å«æ‰€æœ‰å­å‹è™Ÿ
            searchKey: `${p.mainModel} ${p.models.join(' ')} ${p.name || ""} ${p.category || ""}`.toLowerCase()
        };
    });

    isProductsLoaded = true;
    isQuotesLoaded = true;
    updateCategoryOptions(); 

  } catch (e) {
    console.error(e);
    alert("å•†å“è³‡æ–™è¼‰å…¥å¤±æ•—");
  }
  
  hideLoading();
}

function setupQtySelectByLevel() {
  qtySelect.innerHTML = "";
  const emptyOpt = document.createElement("option");
  emptyOpt.value = ""; emptyOpt.textContent = "ä¸ä½¿ç”¨èµ·è¨‚é‡";
  qtySelect.appendChild(emptyOpt);
  
  const add = (v,t)=>{
    const o = document.createElement("option"); o.value = v; o.textContent = t; qtySelect.appendChild(o);
  };
  
  if (userLevel >= 1) add("50", "50 å€‹");
  if (userLevel >= 2) { add("100", "100 å€‹"); add("300", "300 å€‹"); }
  if (userLevel >= 3) { add("500", "500 å€‹"); add("1000", "1000 å€‹"); }
   if (userLevel >= 4) { add("3000", "3000 å€‹ (å·¥å» å°ˆæ¡ˆ)");}
}

function applySorting(list) {
  const o = sortSelect.value;
  if (o === "minPriceAsc")  return list.sort((a,b)=> (a.minPrice||0) - (b.minPrice||0));
  if (o === "minPriceDesc") return list.sort((a,b)=> (b.minPrice||0) - (a.minPrice||0));
  if (o === "marketAsc")    return list.sort((a,b)=> (a.marketPrice||0) - (b.marketPrice||0));
  if (o === "marketDesc")   return list.sort((a,b)=> (b.marketPrice||0) - (a.marketPrice||0));
  if (o === "alphaAsc")     return list.sort((a,b)=> (a.mainModel||"").localeCompare(b.mainModel||""));
  if (o === "alphaDesc")    return list.sort((a,b)=> (b.mainModel||"").localeCompare(a.mainModel||""));
  return list;
}

/* ğŸš€ Updated Search Logic - ç§»é™¤ A ç´šå“éæ¿¾ç‰ˆ */
function searchProducts() {
  // 1. åŸºæœ¬è¼‰å…¥æª¢æŸ¥
  if (!isProductsLoaded) { alert("å•†å“è³‡æ–™è¼‰å…¥ä¸­"); return; }
  
  // --- [A] æŠ“å–èˆ‡è™•ç†é—œéµå­— ---
  const rawInput = keywordInput.value.trim().toLowerCase();
  const keys = rawInput.split(/[\s,ï¼Œ\n]+/).filter(k => k.length > 0);
  const hasKey = keys.length > 0;

  // --- [B] æŠ“å–å…¶ä»–æœå°‹æ¢ä»¶ ---
  const qty = qtySelect.value;
  const minPraw = minPriceInput.value.trim();
  const maxPraw = maxPriceInput.value.trim();
  const cat = categorySelect.value; 
  const stockReq = stockFilter.value; 
  
  // æŠ“å–å‹¾é¸æ¡†ç‹€æ…‹ (åªå‰©æ§åƒ¹å“)
  const controlledCheck = document.getElementById("controlledFilter");
  const isControlledOnly = controlledCheck && controlledCheck.checked;
  
  const hasQty = !!qty;
  const hasBudget = !!minPraw || !!maxPraw;
  const hasCat = !!cat; 
  const hasStockReq = !!stockReq;

  // --- [C] é˜²å‘†åˆ¤æ–· ---
  
  if (hasBudget && !hasQty && userLevel >= 1) {
    alert("æœå°‹é ç®—å€é–“æ™‚ï¼Œå¿…é ˆé¸æ“‡ã€Œèµ·è¨‚é‡ã€ï¼");
    return;
  }
  
  // é˜²å‘†é‚è¼¯ï¼šç§»é™¤ isGradeOnly
  if (!hasKey && !hasQty && !hasBudget && !hasCat && !hasStockReq && !isControlledOnly) {
    alert("è«‹è¼¸å…¥æœå°‹æ¢ä»¶ï¼ˆé—œéµå­—ã€åˆ†é¡ã€èµ·è¨‚é‡ã€é ç®—ã€åº«å­˜æˆ–å‹¾é¸ç¯©é¸ï¼‰");
    return;
  }

  const _needsQuote = hasQty && hasBudget;
  if (_needsQuote && !isQuotesLoaded) { alert("å ±åƒ¹è³‡æ–™è¼‰å…¥ä¸­ï¼Œè«‹ç¨å€™"); return; }

  showLoading();
  updateUserDisplay('searching');

  setTimeout(() => {
    let r = productCache;

    // --- [D] è³‡æ–™éæ¿¾æ ¸å¿ƒ (å·²ç§»é™¤ A ç´šå“éæ¿¾) ---

    // 1. å‹¾é¸ç¯©é¸ï¼šåªçœ‹æ§åƒ¹å“
    if (isControlledOnly) {
        r = r.filter(p => p.isControlled === true);
    }

    // 2. åˆ†é¡ç¯©é¸
    if (hasCat) {
        r = r.filter(p => p.category === cat);
    }

    // 3. é—œéµå­—ç¯©é¸
    if (hasKey) {
      r = r.filter(p => {
        const pKey = (p.searchKey || "");
        return keys.some(k => pKey.includes(k));
      });
    }

    // 4. åº«å­˜ç¯©é¸
    if (hasStockReq) {
        if (stockReq === 'ZERO') {
            r = r.filter(p => {
                const inv = parseInt(p.inventory || 0, 10);
                return inv <= 0;
            });
        } else {
            const minStock = parseInt(stockReq, 10);
            r = r.filter(p => {
                const inv = parseInt(p.inventory || 0, 10);
                return inv >= minStock;
            });
        }
    }

    // 5. é ç®—ç¯©é¸
    if (hasBudget) {
      const min = minPraw ? Number(minPraw) : 0;
      const max = maxPraw ? Number(maxPraw) : Number.MAX_SAFE_INTEGER;
      r = r.filter(p => {
        let price = 0;
        if (qty) {
            const k = `quote${qty}`;
            price = Number(p[k]) || 0;
        } else {
            price = Number(p.marketPrice) || 0;
        }
        return price >= min && price <= max;
      });
    }

   // --- [E] æ’åºèˆ‡æ¸²æŸ“ (ä¿®æ”¹ç‰ˆï¼šå¼·åˆ¶ç¼ºè²¨ç½®åº•) ---
    
    // 1. å…ˆå°‡çµæœæ‹†æˆå…©å †
    const activeItems = r.filter(p => (parseInt(p.inventory || 0, 10) > 0));
    const zeroItems   = r.filter(p => (parseInt(p.inventory || 0, 10) <= 0));

    // 2. å…©å †å„è‡ªé€²è¡Œæ’åº (æˆ–éš¨æ©Ÿ)
    let sortedActive = [];
    let sortedZero = [];

    if (!sortSelect.value) {
        // å¦‚æœé¸ã€Œéš¨æ©Ÿã€ï¼Œå…©å †å„è‡ªæ´—ç‰Œ
        sortedActive = shuffleArray(activeItems);
        sortedZero = shuffleArray(zeroItems);
    } else {
        // å¦‚æœé¸ã€Œåƒ¹æ ¼æ’åºã€ï¼Œå…©å †å„è‡ªæ’åº
        sortedActive = applySorting(activeItems);
        sortedZero = applySorting(zeroItems);
    }

    // 3. åˆä½µï¼šæœ‰è²¨çš„åœ¨ä¸Šé¢ï¼Œç¼ºè²¨çš„åœ¨ä¸‹é¢
    currentResultList = [...sortedActive, ...sortedZero];
    
    renderResults(currentResultList);
    hideLoading();
    updateUserDisplay('normal');
  }, 0);
}


/* ğŸš€ Updated Render Logic - åˆ—è¡¨é åœ–ç‰‡ (ä¿®å¾©å‚™ç”¨åœ–ç„¡æ³•é¡¯ç¤ºå•é¡Œ) */
function renderResults(list) {
  resultBody.innerHTML = ""; detailCard.style.display = "none"; checkAllBox.checked = false; updateMultiLineBtnState();
  if (list.length === 0) {
    resultTable.style.display = "none"; exportBtn.disabled = true; pptToolbarBtn.disabled = true; return;
  }
  resultTable.style.display = "table"; exportBtn.disabled = false; pptToolbarBtn.disabled = false;

  // âœ… [æ–°å¢] åœ–ç‰‡é€£çµè½‰æ›å°å·¥å…· (æŠŠ Drive é€£çµè½‰æˆåœ–ç‰‡)
  const wrapUrl = (u) => {
      if(!u) return "https://placehold.co/110x110?text=No+Image";
      if(u.includes("placehold.co")) return u;
      return "https://images.weserv.nl/?url=" + encodeURIComponent(u) + "&output=jpg&w=150";
  };

  list.forEach(item => {
    // --- åœ–ç‰‡æ™ºæ…§éè£œé‚è¼¯ ---
    const netImages = getDriveNetImages(item.model, item.mainModel) || [];
    const driveMainImg = getDriveMainImage(item.model, item.mainModel);
    
    // 1. æº–å‚™ã€Œæ•‘æ´åœ–ç‰‡ã€ (é‡é»ä¿®æ­£ï¼šåŠ ä¸Š wrapUrl åŒ…è£)
    let rawBackup = null;
    if (driveMainImg) rawBackup = driveMainImg;
    else if (netImages.length > 0) rawBackup = netImages[0];

    // é€™è£¡æœƒæŠŠ rawBackup (åŸå§‹é€£çµ) è½‰æˆ ç€è¦½å™¨çœ‹å¾—æ‡‚çš„ weserv é€£çµ
    let backupImg = wrapUrl(rawBackup);

    // 2. æ±ºå®šã€Œé è¨­é¡¯ç¤ºåœ–ç‰‡ã€
    let img = item.imageUrl; 
    
    // å¦‚æœ Excel æ²’å¡«ï¼Œç›´æ¥å…ˆç”¨æ•‘æ´åœ–
    if (!img || !img.startsWith("http")) {
        img = backupImg;
    }
    
    // --- æ¨™ç±¤èˆ‡è®Šæ•¸ ---
    let controlledHtml = "";
    if (item.isControlled) {
        controlledHtml = `<span style="background:#eff6ff; color:#1e40af; border:1px solid #bfdbfe; padding:2px 6px; border-radius:50px;; font-size:12px; font-weight:bold; margin-right:4px;">ğŸ›¡ï¸ æ§åƒ¹å“</span>`;
    }
      
    const tr = document.createElement("tr");
    let priceHtml = ""; 
    const getPrice = (p) => (item[p] ?? "-");

    // --- åƒ¹æ ¼é‚è¼¯ ---
    if (isGroupBuyUser) {
        let htmlStack = [];
        const gbPrice = item.groupBuyPrice; 
        if (gbPrice) {
            htmlStack.push(`<div style="margin-bottom:4px;"><span style="display:inline-block; background:#fee2e2; color:#b91c1c; border:1px solid #f87171; padding:3px 8px; border-radius:6px; font-weight:bold; font-size:15px;">ğŸ”´ ç›´æ’­åœ˜è³¼åƒ¹ï¼š$${gbPrice}</span></div>`);
        } else {
            htmlStack.push(`<div style="margin-bottom:4px;"><span style="color:#9ca3af; font-size:13px;">(æœ¬æª”æœªé–‹æ”¾åœ˜è³¼)</span></div>`);
        }
        const costCol = (currentUserVipConfig && currentUserVipConfig.column) ? currentUserVipConfig.column : 'VIP_C';
        const myCost = item[costCol]; 
        if (myCost) {
            htmlStack.push(`<div><span style="display:inline-block; background:#ecfdf5; color:#047857; border:1px solid #6ee7b7; padding:2px 6px; border-radius:4px; font-weight:bold; font-size:13px;">ğŸ’° æ‚¨çš„é€²åƒ¹ï¼š$${myCost}</span></div>`);
        } else {
             htmlStack.push(`<div><span style="color:#999; font-size:12px;">(ç„¡å°ˆå±¬é€²åƒ¹)</span></div>`);
        }
        priceHtml = htmlStack.join("");
    } else if (currentUserVipConfig) {
        const vipPriceVal = item[currentUserVipConfig.column];
        if (vipPriceVal) {
            priceHtml = `<span style="font-weight:bold; color:#b91c1c; font-size:14px; background:#fce7f3; padding:4px 8px; border-radius:6px;">${currentUserVipConfig.name} å°ˆå±¬åƒ¹ï¼š$${vipPriceVal}</span>`;
        } else {
            priceHtml = `<span style="font-weight:bold; color:#2563eb; font-size:14px;">è«‹æ´½éƒ­åº­è±ª</span>`;
        }
    } else {
        if (userLevel >= 1) priceHtml += `<span class="price-tag tag50">50å€‹ï¼š${getPrice('quote50')}</span>`;
        if (userLevel >= 2) {
            priceHtml += `<span class="price-tag tag100">100å€‹ï¼š${getPrice('quote100')}</span>`;
            priceHtml += `<span class="price-tag tag300">300å€‹ï¼š${getPrice('quote300')}</span>`;
        }
        if (userLevel >= 3) {
            priceHtml += `<span class="price-tag tag500">500å€‹ï¼š${getPrice('quote500')}</span>`;
            priceHtml += `<span class="price-tag tag1000">1000å€‹ï¼š${getPrice('quote1000')}</span>`;
        }
        if (userLevel >= 4) {
            priceHtml += `<span class="price-tag" style="background:#f3e8ff;color:#6b21a8;">3000å€‹ï¼š${getPrice('quote3000')}</span>`;
        }
    }

    const showMinPrice = userLevel >= 1;
    let minPriceDisplay = "";
    let marketPriceDisplay = item.marketPrice ?? "-";

    if (currentUserVipConfig) {
        const vipPriceVal = item[currentUserVipConfig.column];
        if (vipPriceVal) {
            minPriceDisplay = "";
            marketPriceDisplay = "";
        } else {
            minPriceDisplay = item.minPrice ?? "-";
            marketPriceDisplay = item.marketPrice ?? "-";
        }
    } else if (isGroupBuyUser) {
        minPriceDisplay = "-"; 
        marketPriceDisplay = item.marketPrice ?? "-";
    } else {
        minPriceDisplay = showMinPrice ? (item.minPrice ?? "-") : "---";
        marketPriceDisplay = item.marketPrice ?? "-";
    }
    const catBadge = item.category ? `<span class="category-badge">${item.category}</span>` : "";
    const variantStockHtml = renderStockByVariant(item);

    // --- HTML ---
   // --- HTML (V7.2.2 ç·Šæ¹Šç‰ˆ) ---
    tr.innerHTML = `
       <td>
        <input type="checkbox" class="row-check" data-model="${item.model}" 
               onchange="if(this.checked) { logCheckboxInterest({model: '${item.model}', name: '${item.name}'}); }">
      </td>
      
      <td style="text-align:center; vertical-align: top;">
        <div class="model-cell" style="font-weight:700; font-size:14px; margin-bottom:6px; color:#334155; cursor:pointer;" onclick="event.stopPropagation();">${item.mainModel || "-"}</div>
        <img src="${img}" class="product-img" 
             loading="lazy"
             onerror="this.onerror=null; this.src='${backupImg}';">
      </td>

      <td>
        ${controlledHtml} ${catBadge} 
        <div style="font-weight:700; margin-bottom:4px; font-size:15px; line-height:1.4;">${item.name || "-"}</div>
        <div style="font-size:13px; color:#64748b; margin-bottom:6px;">
           ${item.colorList ? `é¡è‰²ï¼š${item.colorList}` : ''}
        </div>
        ${variantStockHtml}
        
        <div class="price-tag-container" style="font-size:13px; margin-bottom:8px; margin-top:8px;">${priceHtml}</div>
        
        ${currentUserVipConfig ? '' : `
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button class="line-share-btn btn-secondary" data-model="${item.model}" style="padding:4px 12px; font-size:12px; border-radius:6px;">LINE</button>
          <button class="btn-outline-add add-quote-btn" data-model="${item.model}">â• å ±åƒ¹</button>
        </div>
        `}
      </td>

      <td style="text-align:right; vertical-align: top;">
        <div style="font-weight:700; color:#ef4444; font-size:16px; margin-bottom:4px;">${minPriceDisplay}</div>
        <div style="color:#94a3b8; font-size:12px; text-decoration:line-through;">${marketPriceDisplay}</div>
      </td>
    `;

    // --- Events ---
    const imgEl = tr.querySelector('.product-img');
    const modelEl = tr.querySelector('.model-cell');
    const openDetail = () => {
      if (window.innerWidth > 900) {
        if (window.hideDetailTimer) clearTimeout(window.hideDetailTimer);
        showDetailDesktop(item);
      } else {
        showDetailMobile(item);
      }
    };
    if (imgEl) {
      imgEl.addEventListener('click', openDetail);
      if (window.innerWidth > 900) {
          imgEl.addEventListener('mouseenter', openDetail);
          imgEl.addEventListener('mouseleave', () => {
              window.hideDetailTimer = setTimeout(() => { detailCard.style.display = "none"; }, 1000); 
          });
      }
    }
    if (modelEl) {
      modelEl.addEventListener('click', openDetail);
       if (window.innerWidth > 900) {
          modelEl.addEventListener('mouseenter', openDetail);
          modelEl.addEventListener('mouseleave', () => {
              window.hideDetailTimer = setTimeout(() => { detailCard.style.display = "none"; }, 1000); 
          });
      }
    }
    resultBody.appendChild(tr);
  });
  bindCheckAll();
}

// ----------------------------------------------------
// PRODUCT IMPORT LOGIC (ç§»é™¤ A ç´šå“åµæ¸¬ç‰ˆ) - RESTORED
// ----------------------------------------------------
if(productUpload) {
    productUpload.onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        currentImportMode = 'product';

        const reader = new FileReader();
        reader.onload = (evt) => {
            try {
                const data = evt.target.result;
                const workbook = XLSX.read(data, { type: 'binary' });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 }); 

                // 1. å®šç¾©æ¬„ä½ (å·²ç§»é™¤ grade)
                let h = {
                    model: -1, name: -1, 
                    market: -1, min: -1, 
                    q50: -1, q100: -1, q300: -1, q500: -1, q1000: -1, q3000: -1,
                    cat: -1, color: -1, barcode: -1, box: -1, controlled: -1,
                    url: -1, perm: -1, bsmi: -1, ncc: -1, groupBuy: -1,
                    cost: -1,      // å» åƒ¹
                    inventory: -1, // å–®ä¸€åº«å­˜
                    finished: -1,  // æˆå“å€‰
                    exclusive: -1,  // å°ˆè³£å€‰
                    status: -1      // ğŸ†• æ–°å¢é€™å€‹ï¼šä¸Šä¸‹æ¶ç‹€æ…‹
                };
                
                let vipHeaders = {}; 

                // 2. æƒæè¡¨é ­
                for(let r=0; r<Math.min(jsonData.length, 10); r++) {
                    const row = jsonData[r];
                    for(let c=0; c<row.length; c++) {
                        const cell = String(row[c] || "").trim();
                        const cellLower = cell.toLowerCase();
                        
                        if(cellLower === 'model' || cellLower === 'å‹è™Ÿ' || cellLower === 'ç”¢å“') h.model = c;
                        if(cellLower === 'name' || cellLower === 'å“å' || cellLower === 'ç”¢å“åç¨±') h.name = c;
                        if(cellLower.includes('è³£å ´') || cellLower.includes('å»ºè­°å”®åƒ¹')) h.market = c;
                        if(cellLower.includes('æœ«å”®') || cellLower.includes('åº•åƒ¹')) h.min = c;
                        if(cellLower.includes('åœ˜è³¼')) h.groupBuy = c; 
                        
                        if (cellLower.includes('50') && !cellLower.includes('500') && (cellLower.includes('å ±åƒ¹') || cellLower === '50')) h.q50 = c;
                        if (cellLower.includes('100') && !cellLower.includes('1000') && (cellLower.includes('å ±åƒ¹') || cellLower === '100')) h.q100 = c;
                        if (cellLower.includes('300') && (cellLower.includes('å ±åƒ¹') || cellLower === '300')) h.q300 = c;
                        if (cellLower.includes('500') && (cellLower.includes('å ±åƒ¹') || cellLower === '500')) h.q500 = c;
                        if (cellLower.includes('1000') && (cellLower.includes('å ±åƒ¹') || cellLower === '1000')) h.q1000 = c;
                        if (cellLower.includes('3000') && (cellLower.includes('å ±åƒ¹') || cellLower === '3000')) h.q3000 = c;
                        
                        // âœ… å·²ç§»é™¤ grade åµæ¸¬
                        if (cellLower.includes('æ§åƒ¹') || cellLower === 'controlled') h.controlled = c;

                        if(cellLower.includes('é¡è‰²')) h.color = c;
                        if(cellLower.includes('åˆ†é¡') || cellLower === 'category') h.cat = c;
                        if(cellLower.includes('æ¢ç¢¼') || cellLower === 'barcode' || cellLower === 'åœ‹éš›æ¢ç¢¼') h.barcode = c;
                        if(cellLower.includes('ç®±å…¥') || cellLower.includes('carton')) h.box = c;

                        if (cellLower.includes('ç¶²ç«™') || cellLower.includes('ç¶²å€') || cellLower.includes('url')) h.url = c;
                        if (cellLower.includes('æ¬Šé™') || cellLower.includes('permission')) h.perm = c;
                        if (cellLower.includes('bsmi')) h.bsmi = c;
                        if (cellLower.includes('ncc')) h.ncc = c;
                        
                        if (cellLower === 'å» åƒ¹' || cellLower === 'cost' || cellLower === 'æˆæœ¬') h.cost = c;
                        
                        if (cellLower.includes('æˆå“å€‰') || cellLower === 'æˆå“') h.finished = c;
                        if (cellLower.includes('å°ˆè³£å€‰') || cellLower === 'å°ˆè³£') h.exclusive = c;
                        if (cellLower === 'åº«å­˜' || cellLower === 'ç¾è²¨' || cellLower === 'inventory') h.inventory = c;
                        // ğŸ†• æ–°å¢ï¼šåµæ¸¬ "ç‹€æ…‹", "ä¸Šä¸‹æ¶", "status"
                        if (cellLower.includes('ç‹€æ…‹') || cellLower.includes('ä¸Šä¸‹æ¶') || cellLower === 'status') h.status = c;

                        if (cell.toUpperCase().startsWith('VIP')) {
                            vipHeaders[cell] = c;
                        }
                    }
                }

                if(h.barcode === -1) {
                    alert("âš ï¸ è­¦å‘Šï¼šæ‰¾ä¸åˆ°ã€Œåœ‹éš›æ¢ç¢¼ã€æ¬„ä½ï¼Œç„¡æ³•é€²è¡Œç²¾æº–æ›´æ–°ã€‚");
                }

                let actions = [];
                const hasVal = (v) => v !== undefined && v !== null && String(v).trim() !== "";

                jsonData.forEach((row) => {
                    const rawModel = row[h.model];
                    if(!rawModel || String(rawModel).includes("å‹è™Ÿ")) return;

                    const modelVal = String(rawModel).trim();
                    let obj = {}; 

                    if(h.name !== -1 && hasVal(row[h.name])) obj.name = row[h.name];
                    if(h.cat !== -1 && hasVal(row[h.cat])) obj.category = row[h.cat];
                    if(h.color !== -1 && hasVal(row[h.color])) obj.colorList = row[h.color];
                    if(h.barcode !== -1 && hasVal(row[h.barcode])) obj.internationalBarcode = row[h.barcode]; 
                    if(h.box !== -1 && hasVal(row[h.box])) obj.cartonQty = row[h.box];
                    if(h.url !== -1 && hasVal(row[h.url])) obj.productUrl = row[h.url];
                    if(h.perm !== -1 && hasVal(row[h.perm])) obj.netSalesPermission = row[h.perm];
                    if(h.bsmi !== -1 && hasVal(row[h.bsmi])) obj.bsmi = row[h.bsmi];
                    if(h.ncc !== -1 && hasVal(row[h.ncc])) obj.ncc = row[h.ncc];

                    if(h.market !== -1 && hasVal(row[h.market])) obj.marketPrice = row[h.market];
                    if(h.min !== -1 && hasVal(row[h.min])) obj.minPrice = row[h.min];
                    if(h.groupBuy !== -1 && hasVal(row[h.groupBuy])) obj.groupBuyPrice = row[h.groupBuy];
                    
                    // åº«å­˜
                    if (h.finished !== -1 && h.exclusive !== -1) {
                        const finQty = parseInt(row[h.finished] || 0, 10);
                        const excQty = parseInt(row[h.exclusive] || 0, 10);
                        obj.inventory = finQty + excQty; 
                    } else if (h.inventory !== -1 && hasVal(row[h.inventory])) {
                        obj.inventory = parseInt(row[h.inventory], 10);
                    }

                    // å» åƒ¹é‹ç®—
                    let tempCost = 0;
                    if (h.cost !== -1 && hasVal(row[h.cost])) {
                        tempCost = parseFloat(row[h.cost]);
                    }

                    if (tempCost > 0) {
                        if (!hasVal(row[h.q50]))   obj.quote50   = Math.ceil((tempCost / 0.76) * 1.05);
                        else obj.quote50 = row[h.q50]; 
                        if (!hasVal(row[h.q100]))  obj.quote100  = Math.ceil((tempCost / 0.79) * 1.05);
                        else obj.quote100 = row[h.q100];
                        if (!hasVal(row[h.q300]))  obj.quote300  = Math.ceil((tempCost / 0.82) * 1.05);
                        else obj.quote300 = row[h.q300];
                        if (!hasVal(row[h.q500]))  obj.quote500  = Math.ceil((tempCost / 0.845) * 1.05);
                        else obj.quote500 = row[h.q500];
                        if (!hasVal(row[h.q1000])) obj.quote1000 = Math.ceil((tempCost / 0.865) * 1.05);
                        else obj.quote1000 = row[h.q1000];
                        if (!hasVal(row[h.q3000])) obj.quote3000 = Math.ceil((tempCost / 0.89) * 1.05);
                        else obj.quote3000 = row[h.q3000];
                    } else {
                        if(hasVal(row[h.q50])) obj.quote50 = row[h.q50];
                        if(hasVal(row[h.q100])) obj.quote100 = row[h.q100];
                        if(hasVal(row[h.q300])) obj.quote300 = row[h.q300];
                        if(hasVal(row[h.q500])) obj.quote500 = row[h.q500];
                        if(hasVal(row[h.q1000])) obj.quote1000 = row[h.q1000];
                        if(hasVal(row[h.q3000])) obj.quote3000 = row[h.q3000];
                    }

                    // âœ… å·²ç§»é™¤ grade è™•ç†
                    if(h.controlled !== -1 && hasVal(row[h.controlled]) && String(row[h.controlled]).toLowerCase() === 'v') obj.isControlled = true;

                    for (const [vKey, vIdx] of Object.entries(vipHeaders)) {
                        if (hasVal(row[vIdx])) {
                            obj[vKey] = row[vIdx];
                        }
                    }

                    // ğŸ†• [é–‹å§‹] æ–°å¢ï¼šè§£æä¸Šä¸‹æ¶ç‹€æ…‹
                    if (h.status !== -1 && hasVal(row[h.status])) {
                        const rawStatus = String(row[h.status]).trim().toLowerCase();
                        // å¦‚æœ Excel å¡«å…¥ ä¸‹æ¶, åœå”®, N, 0, Falseï¼Œç³»çµ±å°±æ¨™è¨˜ç‚º inactive
                        if (['ä¸‹æ¶', 'åœå”®', 'inactive', 'off', 'n', 'false', '0'].includes(rawStatus)) {
                            obj.status = 'inactive';
                        } else {
                            obj.status = 'active';
                        }
                    } else {
                        // æ²’å¡«å¯«é è¨­ç‚ºä¸Šæ¶
                        obj.status = 'active';
                    }
                    // ğŸ†• [çµæŸ]

                    obj.model = modelVal;
                    obj.mainModel = modelVal.split('-')[0]; 

                    actions.push({ data: obj, model: modelVal });
                });

                previewHeader.textContent = "å…¨èƒ½åŒ¯å…¥ç¢ºèª (é›™å€‰åŠ ç¸½ + å» åƒ¹å…¬å¼)";
                previewContent.innerHTML = `
                    <div style="padding:20px; text-align:center;">
                        <h3 style="color:#2563eb;">å·²è§£æ ${actions.length} ç­†è³‡æ–™</h3>
                        <div style="background:#f0fdf4; border:1px solid #bbf7d0; padding:10px; border-radius:8px; display:inline-block; margin-bottom:10px;">
                            âœ… <b>åŠŸèƒ½å·²å•Ÿå‹•</b><br>
                            1. åº«å­˜ = æˆå“å€‰ + å°ˆè³£å€‰<br>
                            2. å ±åƒ¹ = ä¾å» åƒ¹å…¬å¼è‡ªå‹•è¨ˆç®—
                        </div>
                        <ul style="text-align:left; display:inline-block; font-size:14px; color:#444; margin-top:10px;">
                            <li>ğŸ“¦ <b>é›™å€‰åµæ¸¬</b>ï¼š${(h.finished !== -1 && h.exclusive !== -1) ? 'âœ… æˆåŠŸæŠ“åˆ°å…©å€‰' : 'âš ï¸ åªæŠ“åˆ°å–®ä¸€åº«å­˜æˆ–æœªæŠ“åˆ°'}</li>
                            <li>ğŸ’° <b>å» åƒ¹é‹ç®—</b>ï¼š${h.cost !== -1 ? 'âœ… åŸ·è¡Œä¸­' : 'âŒ æœªå•Ÿç”¨'}</li>
                            <li>ğŸ·ï¸ <b>ç”¢å“è³‡è¨Š</b>ï¼šåœ‹éš›æ¢ç¢¼æ¯”å°ä¸­...</li>
                        </ul>
                    </div>
                `;
                pendingProductData = actions;
                previewOverlay.style.display = "flex";

            } catch(e) {
                console.error(e);
                alert("æª”æ¡ˆè®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Excel æ ¼å¼");
            }
        };
        reader.readAsBinaryString(file);
    };
}

// ----------------------------------------------------
// ğŸ†• æ–°å¢ï¼šINVENTORY IMPORT LOGIC (åº«å­˜+ETA ç¨ç«‹åŒ¯å…¥)
// ----------------------------------------------------
if(importInventoryBtn) {
    importInventoryBtn.onclick = () => {
        if(inventoryUpload) {
            inventoryUpload.value = ''; // Reset
            inventoryUpload.click();
        }
    };
}

if(inventoryUpload) {
    inventoryUpload.onchange = (e) => {
        const file = e.target.files[0];
        if(!file) return;
        currentImportMode = 'inventory';

        const reader = new FileReader();
        reader.onload = (evt) => {
            try {
                const data = evt.target.result;
                // âš ï¸ ä½¿ç”¨ cellDates: false èˆ‡ raw: false ä¾†ç¢ºä¿ "3/20" è¢«è®€ç‚ºå­—ä¸²ï¼Œè€Œä¸æ˜¯æ•¸å­—
                const workbook = XLSX.read(data, { type: 'binary', cellDates: false });
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1, raw: false });

                // 1. åµæ¸¬æ¬„ä½ä½ç½®
                let h = { barcode: -1, inventory: -1, eta: -1 }; 
                
                // æƒæç¬¬ä¸€åˆ— (è¡¨é ­)
                const headerRow = jsonData[0] || [];
                headerRow.forEach((cell, idx) => {
                    const c = String(cell).trim().toLowerCase();
                    if(c.includes('æ¢ç¢¼') || c === 'barcode') h.barcode = idx;
                    if(c.includes('åº«å­˜') || c.includes('ç¾è²¨') || c === 'inventory') h.inventory = idx;
                    // ğŸ†• åµæ¸¬åˆ°è²¨æ—¥
                    if(c.includes('åˆ°è²¨') || c.includes('eta') || c.includes('äº¤æœŸ')) h.eta = idx;
                });

                if(h.barcode === -1 || h.inventory === -1) {
                    alert("âŒ æ‰¾ä¸åˆ°ã€Œåœ‹éš›æ¢ç¢¼ã€æˆ–ã€Œåº«å­˜ã€æ¬„ä½ï¼Œè«‹æª¢æŸ¥ Excel è¡¨é ­ã€‚");
                    return;
                }

                // 2. å»ºç«‹è³‡æ–™ Map (Barcode -> {qty, eta})
                const invMap = new Map();
                
                // å¾ç¬¬äºŒåˆ—é–‹å§‹è®€
                for(let i=1; i<jsonData.length; i++) {
                    const row = jsonData[i];
                    const bc = String(row[h.barcode] || "").trim();
                    
                    if(bc) {
                        const qty = parseInt(row[h.inventory] || 0, 10);
                        const etaVal = (h.eta !== -1) ? String(row[h.eta] || "").trim() : "";
                        
                        // ğŸ“¦ å°‡ æ•¸é‡ èˆ‡ ETA æ‰“åŒ…å­˜å…¥
                        invMap.set(bc, { qty: qty, eta: etaVal });
                    }
                }

                pendingInventoryMap = invMap;
                
                // é¡¯ç¤ºé è¦½
                previewHeader.textContent = `åº«å­˜åŒ¯å…¥ç¢ºèª (å« ETA)`;
                previewContent.innerHTML = `
                    <div style="padding:20px; text-align:center;">
                        <h3>ğŸ“¦ å·²è®€å– ${invMap.size} ç­†åº«å­˜è³‡æ–™</h3>
                        ${h.eta !== -1 ? '<span style="color:green; font-weight:bold;">âœ… å·²åµæ¸¬åˆ°ã€ŒETAã€æ¬„ä½</span>' : '<span style="color:gray;">(æœªåµæ¸¬åˆ°åˆ°è²¨æ—¥æ¬„ä½ï¼Œåƒ…æ›´æ–°æ•¸é‡)</span>'}
                        <div style="font-size:12px; color:#666; margin-top:8px;">
                           ç¢ºèªç„¡èª¤å¾Œï¼Œè«‹æŒ‰ä¸‹æ–¹ã€Œç¢ºèªå¯«å…¥è³‡æ–™åº«ã€
                        </div>
                    </div>`;
                previewOverlay.style.display = "flex";

            } catch(e) {
                console.error(e);
                alert("æª”æ¡ˆè®€å–å¤±æ•—");
            }
        };
        reader.readAsBinaryString(file);
    };
}

// ğŸš€ V6.4 é‡å¯«çš„ä¿å­˜é‚è¼¯ï¼šå³æ™‚æŠ“å–åŸå§‹è³‡æ–™é€²è¡Œç²¾æº–å¯«å…¥ (RESTORED)
async function saveProductDataToFirestore(actions) {
    importProductBtn.disabled = true;
    importProductBtn.textContent = "æ­£åœ¨æŠ“å–åŸå§‹è³‡æ–™...";

    let batch = writeBatch(db);
    let opCount = 0;
    const BATCH_LIMIT = 400; 
    let successCount = 0;

    try {
        // 1. Fetch RAW docs to build Map<Barcode, ID>
        const snap = await getDocsWithRetry(collection(db, "Products"));
        const rawMap = new Map(); // Barcode -> DocID

        snap.forEach(docSnap => {
            const d = docSnap.data();
            // é€™è£¡ä¹ŸåŠ å¼·é˜²å‘†ï¼šç¢ºä¿è³‡æ–™åº«åŸæœ¬çš„æ¢ç¢¼ä¹Ÿè½‰æˆå­—ä¸²
            const bc = String(d.internationalBarcode || d.barcode || "").trim();
            if(bc) rawMap.set(bc, docSnap.id);
        });

        importProductBtn.textContent = "æ­£åœ¨å¯«å…¥è³‡æ–™åº«...";

        // 2. Process Actions using Barcode Mapping
        for(const item of actions) {
            // item.data contains the new data from Excel
            // Key logic: item.data.internationalBarcode
            
            // ğŸ‘‡ğŸ‘‡ğŸ‘‡ã€ä¿®æ­£é‡é»åœ¨é€™è£¡ã€‘åŠ ä¸Š String() åŒ…èµ·ä¾† ğŸ‘‡ğŸ‘‡ğŸ‘‡
            const excelBc = String(item.data.internationalBarcode || "").trim();
            // ğŸ‘†ğŸ‘†ğŸ‘†ã€ä¿®æ­£çµæŸã€‘ğŸ‘†ğŸ‘†ğŸ‘†

            if(!excelBc) {
                console.warn("Skipping item without barcode:", item.model);
                continue; 
            }

            // ç¢ºä¿è¦å¯«å…¥è³‡æ–™åº«çš„ barcode ä¹Ÿæ˜¯ä¹¾æ·¨çš„å­—ä¸²
            item.data.internationalBarcode = excelBc;

            // ğŸ†• æ±ºå®šç‹€æ…‹ï¼šå¦‚æœ Excel æœ‰è®€åˆ°å°±ç”¨è®€åˆ°çš„ï¼Œæ²’æœ‰å°±é è¨­ active
            const finalStatus = item.data.status || 'active';

            if(rawMap.has(excelBc)) {
                // Update existing doc (æ›´æ–°èˆŠå•†å“)
                const docId = rawMap.get(excelBc);
                const docRef = doc(db, "Products", docId);

                // âš ï¸ ä¿®æ”¹é‡é»ï¼šé€™è£¡ä½¿ç”¨ finalStatusï¼Œä¸å†å¼·åˆ¶ 'active'
                batch.update(docRef, { ...item.data, status: finalStatus });

            } else {
                // Create new doc (å»ºç«‹æ–°å•†å“)
                const newDocRef = doc(collection(db, "Products"));

                // âš ï¸ ä¿®æ”¹é‡é»ï¼šé€™è£¡ä¹Ÿä½¿ç”¨ finalStatus
                batch.set(newDocRef, { ...item.data, status: finalStatus, inventory: 0 });
            }
            
            opCount++;
            successCount++;

            if(opCount >= BATCH_LIMIT) {
                await batch.commit();
                batch = writeBatch(db);
                opCount = 0;
            }
        }

        if(opCount > 0) {
            await batch.commit();
        }

        alert(`ç”¢å“ç¸½è¡¨åŒæ­¥å®Œæˆï¼\nä»¥åœ‹éš›æ¢ç¢¼ç‚ºåŸºæº–ï¼Œå…±è™•ç†äº† ${successCount} ç­†è³‡æ–™ã€‚\nç³»çµ±å°‡è‡ªå‹•é‡æ–°æ•´ç†ã€‚`);
        window.location.reload();

    } catch(e) {
        console.error(e);
        alert("å¯«å…¥è³‡æ–™åº«æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ Consoleã€‚");
    } finally {
        importProductBtn.disabled = false;
        importProductBtn.textContent = "ğŸ“¥ åŒ¯å…¥ç”¢å“ç¸½è¡¨ (åŒæ­¥ä¸Šä¸‹æ¶)";
    }
}

// ğŸš€ V7.6 ä¿®æ”¹ç‰ˆï¼šåŒæ™‚æ›´æ–°åº«å­˜èˆ‡åˆ°è²¨æ—¥ (Inventory + ETA)
async function saveInventoryToFirestore(invMap) {
    const btn = document.getElementById("confirmImportBtn");
    if(btn) {
        btn.disabled = true;
        btn.textContent = "æ­£åœ¨å¯«å…¥è³‡æ–™åº«...";
    }
    
    let batch = writeBatch(db);
    let opCount = 0;
    let updatedCount = 0;
    const BATCH_LIMIT = 400;

    try {
        const snap = await getDocsWithRetry(collection(db, "Products"));
        
        // éæ­·è³‡æ–™åº«ä¸­çš„æ‰€æœ‰å•†å“
        for(const docSnap of snap.docs) {
             const product = docSnap.data();
             const bc = String(product.internationalBarcode || product.barcode || "").trim();
             
             // å¦‚æœé€™å€‹å•†å“çš„æ¢ç¢¼ï¼Œåœ¨åº«å­˜è¡¨(invMap)è£¡é¢æ‰¾å¾—åˆ°
             if(bc && invMap.has(bc)) {
                const data = invMap.get(bc); // é€™è£¡å–å‡ºä¾†çš„æ˜¯ { qty, eta } ç‰©ä»¶
                const docRef = doc(db, "Products", docSnap.id);
                
                // æº–å‚™è¦æ›´æ–°çš„æ¬„ä½
                let updateData = { inventory: data.qty };
                
                // ğŸ†• å¦‚æœ Excel æœ‰å¡« ETAï¼Œå°±ä¸€èµ·æ›´æ–°ï¼›æ²’å¡«å°±æ›´æ–°ç‚ºç©ºå­—ä¸² (æ¸…é™¤èˆŠæ—¥æœŸ)
                updateData.nextArrival = data.eta || ""; 

                batch.update(docRef, updateData);
                
                opCount++;
                updatedCount++;
                
                if(opCount >= BATCH_LIMIT) {
                    await batch.commit();
                    batch = writeBatch(db);
                    opCount = 0;
                }
             }
        }
        
        if(opCount > 0) await batch.commit();

        alert(`åº«å­˜åŒæ­¥å®Œæˆï¼\nå…±æ›´æ–°äº† ${updatedCount} ç­†å•†å“ã€‚\n(åŒ…å«åº«å­˜æ•¸é‡èˆ‡é è¨ˆåˆ°è²¨æ—¥)`);
        window.location.reload();

    } catch(e) {
        console.error(e);
        alert("å¯«å…¥è³‡æ–™åº«å¤±æ•—ï¼Œè«‹æª¢æŸ¥ Consoleã€‚");
    } finally {
        if(btn) {
            btn.disabled = false;
            btn.textContent = "ç¢ºèªå¯«å…¥è³‡æ–™åº«";
        }
    }
}
</script>
</body>
</html>
