<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KINYO æ¥­å‹™é æ’è¨‚å–®ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { opacity: 0; transition: opacity 0.5s; }
        input[type="date"]::-webkit-calendar-picker-indicator { cursor: pointer; opacity: 0.6; }
        .spinner { border: 3px solid #f3f3f3; border-radius: 50%; border-top: 3px solid #3b82f6; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .fade-in-up { animation: fadeInUp 0.5s ease-out forwards; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Toast Animation */
        .toast-enter { transform: translateX(100%); opacity: 0; }
        .toast-enter-active { transform: translateX(0); opacity: 1; transition: all 300ms ease-out; }
        .toast-exit { transform: translateX(0); opacity: 1; }
        .toast-exit-active { transform: translateX(100%); opacity: 0; transition: all 300ms ease-in; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">
    <div id="root"></div>
    <script type="text/babel">
        const { useState, useEffect } = React;

        // --- è¨­å®šå€ï¼šè«‹å¡«å…¥æ‚¨çš„ Web App URL ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwCS7Gq03PeeYpymCVYM02bhST_OP_zcnEyrs41aVmLSprs2tlOCIafM9liEGR4MmIcuw/exec"; 

        // Icons
        const IconBase = ({children, size=24, className=""}) => (<svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>);
        const ShoppingCart = (p) => <IconBase {...p}><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.12"/></IconBase>;
        const Calendar = (p) => <IconBase {...p}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const Building2 = (p) => <IconBase {...p}><path d="M6 22V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v18Z"/><path d="M6 12H4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h2"/><path d="M18 9h2a2 2 0 0 1 2 2v9a2 2 0 0 1-2 2h-2"/><path d="M10 6h4"/><path d="M10 10h4"/><path d="M10 14h4"/><path d="M10 18h4"/></IconBase>;
        const User = (p) => <IconBase {...p}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Plus = (p) => <IconBase {...p}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Trash2 = (p) => <IconBase {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const Box = (p) => <IconBase {...p}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></IconBase>;
        const CheckCircle2 = (p) => <IconBase {...p}><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></IconBase>;
        const Flame = (p) => <IconBase {...p}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/></IconBase>;
        const UploadCloud = (p) => <IconBase {...p}><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v9"/><path d="m16 16-4-4-4 4"/></IconBase>;
        const FileText = (p) => <IconBase {...p}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>;
        const X = (p) => <IconBase {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></IconBase>;
        const Search = (p) => <IconBase {...p}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const AlertTriangle = (p) => <IconBase {...p}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></IconBase>;
        const MapPin = (p) => <IconBase {...p}><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const RotateCcw = (p) => <IconBase {...p}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></IconBase>;
        const ClipboardList = (p) => <IconBase {...p}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconBase>;
        const Send = (p) => <IconBase {...p}><line x1="22" x2="11" y1="2" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></IconBase>;

        // â˜…â˜…â˜… ä¿®æ­£ InputFieldï¼šç¢ºä¿ required å±¬æ€§æœ‰æ­£ç¢ºå‚³éçµ¦ input â˜…â˜…â˜…
        const InputField = ({ label, required, ...props }) => (
            <div className="space-y-1.5">
                <label className="block text-sm font-semibold text-slate-700">{label} {required && <span className="text-red-500">*</span>}</label>
                <input {...props} required={required} className="w-full px-4 py-2.5 bg-white border border-slate-300 rounded-lg text-slate-800 text-sm focus:ring-2 focus:ring-slate-800 focus:border-transparent outline-none transition-all placeholder:text-slate-400" />
            </div>
        );

        // --- Toast å…ƒä»¶ (å³ä¸‹è§’é€šçŸ¥) ---
        const Toast = ({ message, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className="fixed bottom-6 right-6 z-[80] bg-slate-800 text-white px-6 py-4 rounded-lg shadow-2xl flex items-center gap-3 animate-[slideIn_0.3s_ease-out]">
                    <CheckCircle2 className="text-green-400" size={24} />
                    <div>
                        <h4 className="font-bold text-sm">è¨‚å–®å»ºç«‹æˆåŠŸ</h4>
                        <p className="text-xs text-slate-300">{message}</p>
                    </div>
                </div>
            );
        };

        // --- æŸ¥è©¢ Modal ---
        const TrackingModal = ({ onClose }) => {
            const [searchId, setSearchId] = useState('');
            const [searchPhone, setSearchPhone] = useState('');
            const [result, setResult] = useState(null);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState('');

            const handleSearch = async (e) => {
                e.preventDefault();
                if (!searchId || !searchPhone) {
                    setError("è«‹è¼¸å…¥è¨‚å–®ç·¨è™Ÿèˆ‡é›»è©±");
                    return;
                }
                setLoading(true);
                setError('');
                setResult(null);

                try {
                    const res = await fetch(`${GOOGLE_SCRIPT_URL}?action=track&id=${encodeURIComponent(searchId.trim())}&phone=${encodeURIComponent(searchPhone.trim())}`);
                    const data = await res.json();
                    
                    if (data.found) setResult(data);
                    else setError("æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªå–®è™Ÿèˆ‡é›»è©±æ˜¯å¦æ­£ç¢ºã€‚");
                } catch (err) {
                    setError("é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                } finally {
                    setLoading(false);
                }
            };

            const getStatusColor = (status) => {
                if (status.includes("å¾…å¯©æ ¸")) return "bg-gray-100 text-gray-600 border-gray-200";
                if (status.includes("å·²æ”¶ä»¶") || status.includes("åº«å­˜")) return "bg-blue-100 text-blue-700 border-blue-200";
                if (status.includes("è™•ç†ä¸­") || status.includes("ç¼ºè²¨")) return "bg-orange-100 text-orange-700 border-orange-200";
                if (status.includes("çµæ¡ˆ") || status.includes("å·²å‡ºè²¨")) return "bg-green-100 text-green-700 border-green-200";
                if (status.includes("é€€ä»¶") || status.includes("å–æ¶ˆ")) return "bg-red-100 text-red-700 border-red-200";
                return "bg-gray-100 text-gray-600";
            };

            return (
                <div className="fixed inset-0 z-[70] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm transition-opacity" onClick={onClose}>
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-md overflow-hidden" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-slate-50">
                            <h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Search size={20}/> è¨‚å–®é€²åº¦æŸ¥è©¢</h3>
                            <button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition-colors text-slate-500"><X size={20} /></button>
                        </div>
                        <div className="p-6 space-y-4">
                            {!result ? (
                                <>
                                    <p className="text-sm text-slate-500 mb-4">è«‹è¼¸å…¥è¨‚å–®ç·¨è™Ÿ (ORD No.) èˆ‡è¯çµ¡äººé›»è©±é€²è¡Œé©—è­‰ã€‚</p>
                                    <InputField label="è¨‚å–®ç·¨è™Ÿ" placeholder="ä¾‹å¦‚ï¼šORD-2025..." value={searchId} onChange={e => setSearchId(e.target.value)} />
                                    <InputField label="è¯çµ¡äººé›»è©±" placeholder="ä¾‹å¦‚ï¼š0912345678" value={searchPhone} onChange={e => setSearchPhone(e.target.value)} />
                                    {error && <div className="p-3 bg-red-50 text-red-600 text-sm rounded-lg border border-red-100 flex items-center gap-2"><AlertTriangle size={16} /> {error}</div>}
                                    <button onClick={handleSearch} disabled={loading} className="w-full py-3 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition-colors flex justify-center">
                                        {loading ? <div className="spinner"></div> : "ç«‹å³æŸ¥è©¢"}
                                    </button>
                                </>
                            ) : (
                                <div className="space-y-4 animate-in fade-in zoom-in">
                                    <div className="bg-green-50 border border-green-200 rounded-xl p-5 text-center">
                                        <div className={`inline-block px-4 py-1.5 rounded-full text-sm font-bold border mb-3 ${getStatusColor(result.status)}`}>
                                            {result.status}
                                        </div>
                                        <div className="text-sm text-gray-600 mb-4">å»ºç«‹æ—¥æœŸï¼š{result.date}</div>
                                        {result.shipDate && (
                                            <div className="bg-white p-3 rounded border border-green-100 text-left text-sm text-gray-700 mb-2">
                                                <span className="font-bold block mb-1">ğŸ“… é è¨ˆå‡ºè²¨æ—¥ï¼š</span>{result.shipDate}
                                            </div>
                                        )}
                                        {result.note && (
                                            <div className="bg-white p-3 rounded border border-green-100 text-left text-sm text-gray-700">
                                                <span className="font-bold block mb-1">ğŸ“ å‚™è¨»/ç‰©æµï¼š</span>{result.note}
                                            </div>
                                        )}
                                        <button onClick={() => setResult(null)} className="mt-4 text-sm text-green-700 underline">æŸ¥è©¢å…¶ä»–</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        function App() {
            const [isSubmitting, setIsSubmitting] = useState(false);
            const [submittedId, setSubmittedId] = useState('');
            const [step, setStep] = useState(1);
            const [showTracking, setShowTracking] = useState(false);
            const [sessionHistory, setSessionHistory] = useState([]);
            const [toast, setToast] = useState(null);

            const [formData, setFormData] = useState({
                type: 'new_order', 
                companyName: '', contactName: '', contactPhone: '', contactEmail: '', 
                shippingAddress: '', receiverName: '', receiverPhone: '', // æ–°å¢æ¬„ä½
                shipDate: '', 
                urgency: 'normal', 
                orderType: 'stock', 
                internalNote: '',
                files: [],
                products: [{ id: Date.now(), model: '', price: '', quantity: "1", note: '' }]
            });

            const handleInputChange = (e) => { const { name, value } = e.target; setFormData(prev => ({ ...prev, [name]: value })); };

            const handleProductChange = (id, field, value) => {
                const val = (field === 'quantity' || field === 'price') ? value.replace(/[^0-9.]/g, '') : value;
                setFormData(prev => ({ ...prev, products: prev.products.map(p => p.id === id ? { ...p, [field]: val } : p) }));
            };
            const addProduct = () => { setFormData(prev => ({ ...prev, products: [...prev.products, { id: Date.now() + Math.random(), model: '', price: '', quantity: "1", note: '' }] })); };
            const removeProduct = (id) => { if (formData.products.length > 1) { setFormData(prev => ({ ...prev, products: prev.products.filter(p => p.id !== id) })); } };

            const handleFileUpload = (e) => {
                if (e.target.files) {
                    const newFiles = Array.from(e.target.files).map(file => ({ 
                        name: file.name, 
                        size: (file.size / 1024 / 1024).toFixed(2) + ' MB',
                        file: file
                    }));
                    setFormData(prev => ({ ...prev, files: [...prev.files, ...newFiles] }));
                }
            };
            const removeFile = (index) => { setFormData(prev => ({ ...prev, files: prev.files.filter((_, i) => i !== index) })); };

            const getBase64 = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result.split(',')[1]); 
                    reader.onerror = error => reject(error);
                });
            };

            const calculateTotal = () => {
                return formData.products.reduce((acc, curr) => {
                    const price = parseFloat(curr.price) || 0;
                    const qty = parseFloat(curr.quantity) || 0;
                    return acc + (price * qty);
                }, 0);
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                
                // â˜…â˜…â˜… é›™é‡æª¢æŸ¥å¿…å¡«æ¬„ä½ â˜…â˜…â˜…
                if (!formData.companyName || !formData.contactName || !formData.contactPhone || !formData.contactEmail || !formData.shipDate) {
                    alert("è«‹æª¢æŸ¥å¿…å¡«æ¬„ä½ (å…¬å¸åç¨±ã€è¯çµ¡äººã€é›»è©±ã€Emailã€å‡ºè²¨æ—¥) æ˜¯å¦å·²å¡«å¯«");
                    return;
                }

                setIsSubmitting(true);

                // åˆ¤æ–·æ˜¯å“ªå€‹æŒ‰éˆ•é€å‡ºçš„ (quick æˆ– finish)
                // ä½¿ç”¨ nativeEvent.submitter ä¾†ç²å–è§¸ç™¼ submit çš„æŒ‰éˆ•
                const submitterValue = e.nativeEvent.submitter?.value;

                let fileData = [];
                if (formData.files.length > 0) {
                    try {
                        const filePromises = formData.files.map(async (fileObj) => {
                            const base64 = await getBase64(fileObj.file);
                            return { name: fileObj.name, mimeType: fileObj.file.type, base64: base64 };
                        });
                        fileData = await Promise.all(filePromises);
                    } catch (error) {
                        alert("æª”æ¡ˆè™•ç†å¤±æ•—");
                        setIsSubmitting(false);
                        return;
                    }
                }

                const orderId = `ORD-${new Date().toISOString().slice(0,10).replace(/-/g,'')}-${Math.floor(Math.random()*1000)}`;
                const totalAmt = calculateTotal();
                
                const payload = {
                    ...formData,
                    rmaId: orderId, 
                    typeTitle: 'æ¥­å‹™é æ’è¨‚å–®',
                    totalAmount: totalAmt,
                    files: fileData
                };

                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        redirect: "follow",
                        method: "POST",
                        body: JSON.stringify(payload),
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                    });
                    
                    // æ–°å¢ï¼šåŠ å…¥æ­·å²æ¸…å–®
                    setSessionHistory(prev => [{
                        id: orderId,
                        receiver: formData.receiverName || formData.contactName,
                        amount: totalAmt,
                        address: formData.shippingAddress || '-'
                    }, ...prev]);

                    if (submitterValue === 'quick') {
                        // å¿«é€ŸçºŒå–®æ¨¡å¼ï¼šé¡¯ç¤º Toastï¼Œæ»¾å‹•åˆ°ä¸­é–“ï¼Œä¸¦åŸ·è¡Œä¿ç•™/æ¸…ç©ºé‚è¼¯
                        setToast(`å–®è™Ÿ ${orderId} å·²å»ºç«‹ï¼Œè«‹ç¹¼çºŒè¼¸å…¥`);
                        handleSameClientNext();
                        // æ»¾å‹•åˆ°è¡¨å–®ä¸­é–“ (å‡ºè²¨è³‡è¨Šå€)
                        setTimeout(() => {
                            const shipSection = document.getElementById('ship-section');
                            if(shipSection) shipSection.scrollIntoView({ behavior: 'smooth' });
                        }, 100);
                    } else {
                        // æ­£å¸¸çµæŸæ¨¡å¼ (é€å‡ºä¸¦å®Œæˆ)
                        setSubmittedId(orderId);
                        setStep(2);
                    }

                } catch (error) {
                    console.error(error);
                    alert("é€£ç·šç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æˆªåœ–è¯ç¹«ç®¡ç†å“¡ã€‚");
                } finally {
                    setIsSubmitting(false);
                }
            };

            // åŒå®¢æˆ¶çºŒå–®åŠŸèƒ½ (ä¿ç•™åŸºæœ¬è³‡æ–™ï¼Œæ¸…ç©ºå‡ºè²¨èˆ‡ç”¢å“)
            const handleSameClientNext = () => {
                setStep(1);
                setFormData(prev => ({
                    ...prev,
                    // ä¿ç•™ (æ ¹æ“šè¦æ±‚): shipDate, companyName, contactName, contactPhone, contactEmail, urgency, orderType
                    
                    // æ¸…ç©º: ç”¢å“ã€åœ°å€ã€æ”¶ä»¶äººã€å‚™è¨»ã€æª”æ¡ˆ
                    shippingAddress: '', 
                    receiverName: '', 
                    receiverPhone: '',
                    internalNote: '',
                    files: [],
                    products: [{ id: Date.now(), model: '', price: '', quantity: "1", note: '' }]
                }));
            };

            // å®Œå…¨é‡ç½®åŠŸèƒ½
            const handleFullReset = () => {
                setStep(1);
                setFormData({ 
                    type: 'new_order', 
                    companyName: '', contactName: '', contactPhone: '', contactEmail: '', 
                    shippingAddress: '', receiverName: '', receiverPhone: '', 
                    shipDate: '', urgency: 'normal', orderType: 'stock', 
                    internalNote: '', files: [], 
                    products: [{id: Date.now(), model: '', price: '', quantity: "1", note: ''}] 
                });
            };

            const renderProductList = () => (
                <div className="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden">
                    <div className="px-6 py-4 bg-slate-50 border-b border-slate-200 flex justify-between items-center">
                        <h3 className="font-semibold text-slate-800 flex items-center gap-2"><Box size={18} /> è¨‚è³¼ç”¢å“æ˜ç´°</h3>
                        <span className="text-xs font-medium px-2.5 py-1 bg-white border border-slate-200 rounded-full text-slate-600">å…± {formData.products.length} ç­†</span>
                    </div>
                    <div className="p-4 space-y-4">
                        {formData.products.map((product, index) => (
                            <div key={product.id} className="relative p-4 rounded-lg border border-slate-200 bg-white hover:border-slate-400 transition-colors group">
                                <div className="grid grid-cols-1 md:grid-cols-12 gap-4 items-start">
                                    <div className="md:col-span-1 flex items-center gap-2 md:block md:pt-3">
                                        <span className="text-xs font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded">#{index + 1}</span>
                                        {formData.products.length > 1 && (<button type="button" onClick={() => removeProduct(product.id)} className="md:hidden text-red-500 p-1"><Trash2 size={16} /></button>)}
                                    </div>
                                    <div className="md:col-span-4">
                                        <label className="block text-xs text-slate-500 mb-1 md:hidden">ç”¢å“å‹è™Ÿ</label>
                                        <input type="text" placeholder="ç”¢å“å‹è™Ÿ / æ–™è™Ÿ" value={product.model} onChange={(e) => handleProductChange(product.id, 'model', e.target.value)} required className="w-full px-3 py-2 border border-slate-300 rounded focus:ring-2 focus:ring-slate-800 outline-none text-sm" />
                                    </div>
                                    <div className="md:col-span-3">
                                        <label className="block text-xs text-slate-500 mb-1 md:hidden">å–®åƒ¹(å«ç¨…)</label>
                                        <div className="relative">
                                            <span className="absolute left-3 top-2 text-slate-400">$</span>
                                            <input type="text" inputMode="numeric" placeholder="å–®åƒ¹" value={product.price} onChange={(e) => handleProductChange(product.id, 'price', e.target.value)} className="w-full pl-6 pr-3 py-2 border border-slate-300 rounded focus:ring-2 focus:ring-slate-800 outline-none text-sm text-right" />
                                        </div>
                                    </div>
                                    <div className="md:col-span-2">
                                        <label className="block text-xs text-slate-500 mb-1 md:hidden">æ•¸é‡</label>
                                        <input type="text" inputMode="numeric" placeholder="æ•¸é‡" value={product.quantity} onChange={(e) => handleProductChange(product.id, 'quantity', e.target.value)} required className="w-full px-3 py-2 border border-slate-300 rounded focus:ring-2 focus:ring-slate-800 outline-none text-sm text-center" />
                                    </div>
                                    <div className="md:col-span-2 pt-2 md:pt-0 text-right md:text-right">
                                        <label className="inline-block text-xs text-slate-500 mr-2 md:hidden">å°è¨ˆ</label>
                                        <span className="font-bold text-slate-700 text-sm">
                                            ${((parseFloat(product.price) || 0) * (parseFloat(product.quantity) || 0)).toLocaleString()}
                                        </span>
                                    </div>
                                    <div className="hidden md:flex md:col-span-1 justify-center pt-2">
                                        {formData.products.length > 1 && (<button type="button" onClick={() => removeProduct(product.id)} className="text-slate-400 hover:text-red-500 transition-colors" title="ç§»é™¤"><Trash2 size={18} /></button>)}
                                    </div>
                                </div>
                            </div>
                        ))}
                        
                        <div className="flex flex-col md:flex-row justify-between items-center pt-4 border-t border-slate-100 gap-4">
                            <button type="button" onClick={addProduct} className="px-4 py-2 border border-dashed border-slate-300 rounded-lg text-slate-500 hover:border-slate-500 hover:text-slate-700 hover:bg-slate-50 transition-all flex items-center gap-2 text-sm font-medium"><Plus size={16} /> æ–°å¢å“é …</button>
                            <div className="text-right w-full md:w-auto">
                                <span className="text-sm text-slate-500 mr-3">è¨‚å–®ç¸½é‡‘é¡ (å«ç¨…)</span>
                                <span className="text-2xl font-bold text-blue-600">${calculateTotal().toLocaleString()}</span>
                            </div>
                        </div>

                        {/* âœ¨ æ–°å¢æŒ‰éˆ•ï¼šæ–°å¢å¦å¤–ä¸€ç­†è¨‚å–® (é¡¯ç¤ºåœ¨è¨‚è³¼å…§å®¹æœ€ä¸‹æ–¹) */}
                        <div className="mt-4 pt-2 border-t border-slate-100 flex justify-center md:justify-end">
                            <button 
                                type="submit" 
                                name="action" 
                                value="quick"
                                className="w-full md:w-auto px-6 py-2.5 bg-blue-100 text-blue-700 border border-blue-200 hover:bg-blue-200 rounded-lg font-bold transition-all flex items-center justify-center gap-2 text-sm"
                            >
                                <Plus size={18} /> æ–°å¢å¦å¤–ä¸€ç­†è¨‚å–®
                            </button>
                        </div>
                    </div>
                </div>
            );

            // Session History Table Component
            const SessionHistoryTable = () => (
                <div className="mt-12 border-t border-slate-200 pt-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
                    <h4 className="text-sm font-bold text-slate-500 uppercase tracking-wider mb-4 flex items-center gap-2">
                        <ClipboardList size={16}/> ğŸ“Š æœ¬æ¬¡ä½œæ¥­å·²å»ºç«‹æ¸…å–® ({sessionHistory.length})
                    </h4>
                    <div className="bg-white rounded-lg border border-slate-200 overflow-hidden shadow-sm">
                        <table className="w-full text-sm text-left">
                            <thead className="bg-slate-50 text-slate-600 font-semibold border-b border-slate-200">
                                <tr>
                                    <th className="px-4 py-3">è¨‚å–®ç·¨è™Ÿ</th>
                                    <th className="px-4 py-3">æ”¶ä»¶äºº / åœ°é»</th>
                                    <th className="px-4 py-3 text-right">é‡‘é¡</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {sessionHistory.map((item, idx) => (
                                    <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                        <td className="px-4 py-3 font-mono text-blue-600 font-medium">{item.id}</td>
                                        <td className="px-4 py-3 text-slate-700">
                                            <div className="font-medium">{item.receiver}</div>
                                            <div className="text-xs text-slate-400 truncate max-w-[200px]">{item.address}</div>
                                        </td>
                                        <td className="px-4 py-3 text-right font-bold text-slate-800">${item.amount.toLocaleString()}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen bg-slate-100 font-sans text-slate-800 flex flex-col">
                    <nav className="bg-slate-900 text-white shadow-md sticky top-0 z-50">
                        <div className="max-w-5xl mx-auto px-4 md:px-8 h-16 flex items-center justify-between">
                            <div className="flex items-center gap-3 cursor-pointer" onClick={() => window.location.href='https://www.kinyo-gift.com/'}>
                                <img src="https://www.kinyo.tw/assets/images/logo.png" alt="KINYO" className="h-8" onError={(e) => {e.target.style.display='none';e.target.nextSibling.style.display='inline-block';}} />
                                <span className="hidden text-xl font-bold tracking-wide">KINYO</span>
                                <span className="text-slate-400 font-normal text-sm ml-1 border-l border-slate-600 pl-3">æ¥­å‹™è¨‚å–®é æ’ç³»çµ±</span>
                            </div>
                            <div className="flex items-center gap-6 text-sm text-gray-300">
                                <span onClick={() => setShowTracking(true)} className="hover:text-white cursor-pointer transition-colors bg-blue-700 px-3 py-1 rounded text-xs flex items-center gap-1"><Search size={14}/> è¨‚å–®æŸ¥è©¢</span>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-grow py-12 px-4 md:px-8">
                        <div className="max-w-4xl mx-auto">
                            {step === 1 ? (
                                <div className="bg-white rounded-2xl shadow-xl shadow-slate-200/50 overflow-hidden border border-slate-100 animate-in fade-in zoom-in duration-300">
                                    <div className="bg-slate-50 border-b border-slate-100 px-8 py-6">
                                        <h2 className="text-xl font-bold text-slate-800 flex items-center gap-2">
                                            <ShoppingCart size={24} className="text-blue-600"/>
                                            å»ºç«‹æ–°è¨‚å–®
                                        </h2>
                                        <p className="text-sm text-slate-500 mt-1">æ­¤è¡¨å–®åƒ…ä¾›å…§éƒ¨æ¥­å‹™ä½¿ç”¨ï¼Œè«‹å¡«å¯«è©³ç´°å‡ºè²¨éœ€æ±‚ã€‚</p>
                                    </div>
                                    <div className="p-8 md:p-12">
                                        <form onSubmit={handleSubmit} className="space-y-10">
                                            <section className="grid grid-cols-1 md:grid-cols-3 gap-6 bg-blue-50/50 p-6 rounded-xl border border-blue-100">
                                                <div className="md:col-span-1">
                                                    <label className="block text-sm font-bold text-slate-700 mb-1.5 flex items-center gap-1"><Calendar size={16}/> é è¨ˆå‡ºè²¨æ—¥ <span className="text-red-500">*</span></label>
                                                    <input type="date" name="shipDate" required value={formData.shipDate} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-white border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm cursor-pointer" />
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold text-slate-700 mb-1.5 flex items-center gap-1"><Flame size={16} className={formData.urgency === 'top_urgent' ? 'text-red-500 fill-red-500' : ''}/> æ€¥è¿«æ€§</label>
                                                    <select name="urgency" value={formData.urgency} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-white border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"><option value="normal">ğŸŸ¢ æ­£å¸¸æ’ç¨‹</option><option value="urgent">ğŸŸ  æ€¥ä»¶ (éœ€æ’å–®)</option><option value="top_urgent">ğŸ”´ ç‰¹æ€¥ (ç•¶æ—¥/éš”æ—¥å‡º)</option></select>
                                                </div>
                                                <div>
                                                    <label className="block text-sm font-bold text-slate-700 mb-1.5">è¨‚å–®é¡å‹</label>
                                                    <select name="orderType" value={formData.orderType} onChange={handleInputChange} className="w-full px-4 py-2.5 bg-white border border-blue-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-sm"><option value="stock">ğŸ“¦ ç¾è²¨å‡ºè²¨</option><option value="preorder">â³ å®¢è¨‚ / é è³¼ (éœ€æ¡è³¼)</option></select>
                                                </div>
                                            </section>

                                            <section>
                                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2"><Building2 size={16} /> å®¢æˆ¶åŸºæœ¬è³‡æ–™</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    <div className="md:col-span-2"><InputField label="å®¢æˆ¶å…¬å¸åç¨±" required name="companyName" value={formData.companyName} onChange={handleInputChange} placeholder="è«‹è¼¸å…¥å®Œæ•´æŠ¬é ­" /></div>
                                                    <InputField label="è¯çµ¡çª—å£å§“å" required name="contactName" value={formData.contactName} onChange={handleInputChange} placeholder="æ¡è³¼æˆ–å°å£äººå“¡" />
                                                    <InputField label="è¯çµ¡é›»è©±" required name="contactPhone" value={formData.contactPhone} onChange={handleInputChange} placeholder="åˆ†æ©Ÿæˆ–æ‰‹æ©Ÿ" />
                                                    <div className="md:col-span-2"><InputField label="è¯çµ¡ Email (è‡ªå‹•é€šçŸ¥ç”¨)" required name="contactEmail" value={formData.contactEmail} onChange={handleInputChange} placeholder="è«‹è¼¸å…¥ Email" type="email" /></div>
                                                </div>
                                            </section>

                                            {/* æŒ‡å®šå‡ºè²¨è³‡è¨Šå€å¡Š (åŠ ä¸Š ID æ–¹ä¾¿æ»¾å‹•å®šä½) */}
                                            <section id="ship-section">
                                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2"><MapPin size={16} /> æŒ‡å®šå‡ºè²¨è³‡è¨Š</h3>
                                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                                    <div className="md:col-span-2">
                                                        <InputField label="æŒ‡å®šå‡ºè²¨åœ°å€" name="shippingAddress" value={formData.shippingAddress} onChange={handleInputChange} placeholder="è«‹è¼¸å…¥å®Œæ•´æ”¶ä»¶åœ°å€" />
                                                    </div>
                                                    <InputField label="æ”¶ä»¶äººå§“å" name="receiverName" value={formData.receiverName} onChange={handleInputChange} placeholder="ç¾å ´æ”¶ä»¶äºº" />
                                                    <InputField label="æ”¶ä»¶äººé›»è©±" name="receiverPhone" value={formData.receiverPhone} onChange={handleInputChange} placeholder="æ”¶ä»¶è¯çµ¡é›»è©±" />
                                                </div>
                                            </section>

                                            <section>
                                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2"><Box size={16} /> è¨‚è³¼å…§å®¹</h3>
                                                {renderProductList()}
                                            </section>

                                            <section>
                                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-4 flex items-center gap-2"><FileText size={16} /> è¨‚å–®/å¤šé»å¯„é€æª”æ¡ˆ (é¸å¡«)</h3>
                                                <div className="border-2 border-dashed border-slate-300 rounded-xl p-8 text-center bg-slate-50 hover:bg-white hover:border-blue-400 transition-all cursor-pointer relative group">
                                                    <input type="file" multiple accept=".xls,.xlsx,.pdf,.doc,.docx,.jpg,.png" onChange={handleFileUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                                    <div className="flex flex-col items-center justify-center text-slate-400 group-hover:text-blue-600"><UploadCloud size={32} className="mb-2" /><p className="font-medium text-slate-600">é»æ“Šæˆ–æ‹–æ›³æª”æ¡ˆè‡³æ­¤</p><p className="text-xs mt-1 text-slate-400">æ”¯æ´ Excel, PDF, Word, åœ–ç‰‡æ ¼å¼</p></div>
                                                </div>
                                                {formData.files.length > 0 && (<div className="space-y-2 mt-3">{formData.files.map((file, index) => (<div key={index} className="flex items-center justify-between p-3 bg-white border border-slate-200 rounded-lg text-sm shadow-sm"><div className="flex items-center gap-2 text-slate-600"><FileText size={16} className="text-blue-500" /><span className="truncate max-w-[200px]">{file.name}</span><span className="text-slate-400 text-xs">({file.size})</span></div><button type="button" onClick={() => removeFile(index)} className="text-slate-400 hover:text-red-500"><X size={16} /></button></div>))}</div>)}
                                            </section>

                                            <section>
                                                <h3 className="text-sm font-bold text-slate-400 uppercase tracking-wider mb-2">çµ¦æ¡è³¼/åŠ©ç†çš„å‚™è¨» (é¸å¡«)</h3>
                                                <textarea name="internalNote" value={formData.internalNote} onChange={handleInputChange} rows="2" className="w-full px-4 py-2.5 bg-white border border-slate-300 rounded-lg text-slate-800 text-sm focus:ring-2 focus:ring-slate-800 outline-none" placeholder="ä¾‹å¦‚ï¼šæ­¤å–®éœ€é…åˆè¡ŒéŠ·æ´»å‹•ã€éœ€ç‰¹æ®ŠåŒ…è£..."></textarea>
                                            </section>

                                            <div className="flex justify-end pt-6 border-t border-slate-100">
                                                <button type="submit" name="action" value="finish" disabled={isSubmitting} className={`flex items-center gap-2 px-8 py-3 bg-slate-800 text-white rounded-lg font-bold shadow-lg hover:bg-slate-900 hover:-translate-y-0.5 transition-all ${isSubmitting ? 'opacity-70 cursor-not-allowed' : ''}`}>{isSubmitting ? <><div className="spinner mr-2"></div> è™•ç†ä¸­...</> : "ç¢ºèªé€å‡º (å®Œæˆ)"}</button>
                                            </div>
                                        </form>
                                        
                                        {/* æ–°å¢ï¼šåœ¨å¡«å¯«é é¢ä¸‹æ–¹é¡¯ç¤ºå·²å»ºç«‹æ¸…å–® */}
                                        {sessionHistory.length > 0 && <SessionHistoryTable />}
                                    </div>
                                </div>
                            ) : (
                                <div className="bg-white rounded-2xl shadow-xl p-12 text-center animate-in zoom-in duration-500">
                                    <div className="w-20 h-20 rounded-full bg-green-100 text-green-600 flex items-center justify-center mb-6 shadow-sm mx-auto"><CheckCircle2 size={40} /></div>
                                    <h2 className="text-3xl font-bold text-slate-900 mb-2">è¨‚å–®å·²å»ºç«‹</h2>
                                    <p className="text-slate-500 mb-8">ç³»çµ±å·²æ’ç¨‹ï¼Œå°‡è‡ªå‹•æª¢æŸ¥åº«å­˜ä¸¦é€šçŸ¥æ¡è³¼äººå“¡ã€‚</p>
                                    
                                    <div className="bg-slate-50 p-6 rounded-xl w-full max-w-md text-left border border-slate-200 mb-8 shadow-sm mx-auto">
                                        <div className="flex justify-between items-center mb-4 pb-4 border-b border-slate-200"><span className="text-sm text-slate-500">è¨‚å–®ç·¨è™Ÿ</span><span className="font-mono font-bold text-slate-800">{submittedId}</span></div>
                                        <div className="space-y-2 text-sm">
                                            <div className="flex justify-between"><span className="text-slate-500">å®¢æˆ¶åç¨±</span><span className="font-medium text-slate-800">{formData.companyName}</span></div>
                                            <div className="flex justify-between"><span className="text-slate-500">é è¨ˆå‡ºè²¨</span><span className="font-medium text-blue-600 font-bold">{formData.shipDate}</span></div>
                                            <div className="flex justify-between"><span className="text-slate-500">æ”¶ä»¶äºº</span><span className="font-medium text-slate-800">{formData.receiverName || formData.contactName}</span></div>
                                            <div className="flex justify-between border-t border-slate-200 pt-2 mt-2"><span className="text-slate-500">è¨‚å–®ç¸½é¡</span><span className="font-bold text-blue-600">${calculateTotal().toLocaleString()}</span></div>
                                        </div>
                                    </div>

                                    {/* æŒ‰éˆ•ç¾¤çµ„ */}
                                    <div className="flex flex-col md:flex-row gap-4 justify-center mb-10">
                                        <button onClick={handleSameClientNext} className="px-8 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 transition-all shadow-md flex items-center justify-center gap-2">
                                            <RotateCcw size={18} /> åŒå®¢æˆ¶çºŒå–® (ä¿ç•™åŸºæœ¬è³‡æ–™)
                                        </button>
                                        <button onClick={handleFullReset} className="px-8 py-3 bg-slate-800 text-slate-200 rounded-lg font-semibold hover:bg-slate-900 transition-all flex items-center justify-center gap-2">
                                            <Plus size={18} /> å»ºç«‹å…¨æ–°è¨‚å–®
                                        </button>
                                    </div>

                                    {/* æˆåŠŸé é¢çš„æ­·å²ç´€éŒ„ */}
                                    {sessionHistory.length > 0 && <SessionHistoryTable />}
                                </div>
                            )}
                        </div>
                    </main>

                    {showTracking && <TrackingModal onClose={() => setShowTracking(false)} />}
                    {toast && <Toast message={toast} onClose={() => setToast(null)} />}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
        window.onload = () => document.body.style.opacity = '1';
    </script>
</body>
</html>
