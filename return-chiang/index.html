<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kinyo 退貨點收系統 | Chiang專用</title>
    <style>
        /* 基礎設定 */
        body { font-family: "Microsoft JhengHei", Arial, sans-serif; padding: 20px; background-color: #f0f2f5; margin: 0; }
        .container { max-width: 1200px; margin: 0 auto; display: flex; gap: 20px; height: 90vh; }
        
        /* 響應式設計：手機版會自動變成上下排列 */
        @media (max-width: 768px) {
            .container { flex-direction: column; height: auto; }
            .panel { height: auto; }
            textarea { height: 150px; }
        }

        .panel { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        
        /* 左側設定區 */
        .left-panel { flex: 1; }
        h3 { margin-top: 0; color: #333; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        textarea { width: 100%; flex-grow: 1; padding: 15px; border: 1px solid #ccc; font-size: 16px; border-radius: 8px; resize: none; box-sizing: border-box; }
        
        /* 右側操作區 */
        .right-panel { flex: 2; align-items: center; }
        
        /* 狀態顯示大框框 */
        #status-box { 
            width: 100%; height: 180px; 
            display: flex; justify-content: center; align-items: center; 
            font-size: 56px; font-weight: bold; color: #fff; 
            background-color: #6c757d; border-radius: 12px; margin-bottom: 20px;
            text-align: center; box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            transition: all 0.2s;
        }
        
        /* 掃描框 */
        #scan-input { 
            width: 80%; padding: 15px; font-size: 28px; text-align: center; 
            border: 3px solid #007bff; border-radius: 50px; outline: none; margin-bottom: 10px;
        }
        #scan-input:focus { box-shadow: 0 0 15px rgba(0,123,255,0.3); }
        
        /* 數據與按鈕 */
        .stats { margin: 10px 0; font-size: 22px; color: #555; font-weight: bold; }
        .log-area { margin-top: 20px; width: 100%; flex-grow: 1; overflow-y: auto; font-size: 15px; border-top: 1px solid #eee; padding-top: 10px; }
        .log-item { padding: 8px; border-bottom: 1px solid #f9f9f9; display: flex; justify-content: space-between; }
        
        /* 按鈕樣式 */
        .btn-primary { background-color: #007bff; color: white; border: none; padding: 12px; font-size: 16px; cursor: pointer; border-radius: 6px; width: 100%; margin-top: 10px; font-weight: bold; }
        .btn-primary:hover { background-color: #0056b3; }

        /* 顏色狀態 */
        .bg-neutral { background-color: #6c757d !important; }
        .bg-success { background-color: #28a745 !important; } /* 綠色 */
        .bg-error { background-color: #dc3545 !important; }   /* 紅色 */
        .bg-warn { background-color: #ffc107 !important; color: #333 !important; } /* 黃色 */

        .text-success { color: #28a745; font-weight: bold; }
        .text-error { color: #dc3545; font-weight: bold; }
        .text-warn { color: #d39e00; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="panel left-panel">
        <h3>1. 每日清單設定</h3>
        <p style="margin:0 0 10px 0; color:#666; font-size:14px;">請貼上 Excel 中的單號 (一行一個)</p>
        <textarea id="target-list" placeholder="在此貼上單號..."></textarea>
        <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center;">
            <span>清單總數: <strong id="total-count" style="color:#007bff">0</strong></span>
        </div>
        <button class="btn-primary" onclick="loadList()">鎖定清單並開始作業</button>
    </div>

    <div class="panel right-panel">
        <h3>2. 掃描核對區</h3>
        <div id="status-box">待命</div>
        
        <input type="text" id="scan-input" placeholder="點此掃描條碼" autofocus autocomplete="off">
        <div style="font-size:14px; color:#999;">(掃描後自動清除)</div>
        
        <div class="stats">
            已收：<span id="scanned-count" style="color:#28a745;">0</span> / <span id="target-total">0</span>
        </div>

        <div class="log-area" id="log-area">
            </div>
    </div>
</div>

<script>
    let targetSet = new Set(); 
    let scannedSet = new Set(); 
    let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

    function playSound(type) {
        if (audioCtx.state === 'suspended') audioCtx.resume();
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        const now = audioCtx.currentTime;
        if (type === 'success') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(800, now);
            osc.frequency.exponentialRampToValueAtTime(1200, now + 0.1);
            gain.gain.setValueAtTime(0.3, now);
            gain.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
            osc.start(now);
            osc.stop(now + 0.1);
        } else if (type === 'error') {
            osc.type = 'sawtooth';
            osc.frequency.setValueAtTime(150, now);
            osc.frequency.linearRampToValueAtTime(100, now + 0.3);
            gain.gain.setValueAtTime(0.5, now);
            gain.gain.linearRampToValueAtTime(0.01, now + 0.3);
            osc.start(now);
            osc.stop(now + 0.3);
        }
    }

    function loadList() {
        const text = document.getElementById('target-list').value;
        const lines = text.split(/\n/);
        targetSet.clear();
        scannedSet.clear();
        
        lines.forEach(line => {
            const cleanLine = line.trim();
            if (cleanLine) targetSet.add(cleanLine);
        });

        document.getElementById('total-count').innerText = targetSet.size;
        document.getElementById('target-total').innerText = targetSet.size;
        document.getElementById('scanned-count').innerText = 0;
        document.getElementById('log-area').innerHTML = '';
        setStatus('開始作業', 'neutral');
        
        const input = document.getElementById('scan-input');
        input.value = '';
        input.focus();
    }

    document.getElementById('scan-input').addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
            const inputVal = this.value.trim();
            if (inputVal) processScan(inputVal);
            this.value = ''; 
        }
    });

    function processScan(code) {
        const logArea = document.getElementById('log-area');
        const now = new Date().toLocaleTimeString('zh-TW', { hour12: false });

        if (scannedSet.has(code)) {
            setStatus('重複掃描', 'warn');
            playSound('error');
            addLog(now, code, '重複', 'text-warn');
            return;
        }

        if (targetSet.has(code)) {
            scannedSet.add(code);
            setStatus('OK', 'success');
            playSound('success');
            addLog(now, code, '核對成功', 'text-success');
            document.getElementById('scanned-count').innerText = scannedSet.size;
        } else {
            setStatus('異常退貨', 'error');
            playSound('error');
            addLog(now, code, '不在清單內', 'text-error');
        }
    }

    function setStatus(msg, type) {
        const box = document.getElementById('status-box');
        box.innerText = msg;
        box.className = ''; 
        box.classList.add(`bg-${type}`);
    }

    function addLog(time, code, status, cssClass) {
        const logArea = document.getElementById('log-area');
        const html = `
            <div class="log-item">
                <span style="color:#999; font-size:12px;">${time}</span>
                <span style="font-family:monospace; font-size:16px;">${code}</span>
                <span class="${cssClass}">${status}</span>
            </div>`;
        logArea.insertAdjacentHTML('afterbegin', html);
    }
</script>

</body>
</html>
