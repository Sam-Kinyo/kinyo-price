// --- 0. å…¨åŸŸè¨­å®šå€ ---
var CONFIG = {
  // ç®¡ç†å“¡æ”¶ä»¶ (æœ‰å¤šäººè«‹ç”¨é€—è™Ÿåˆ†éš”)
  adminEmails: "sam.kuo@kinyo.tw,iris.chen@nakay.com.tw", 
  senderName: "KINYO B2B ç³»çµ±",
  folderName: "KINYO_RMA_Images"
};

// --- 1. æŸ¥è©¢åŠŸèƒ½ (å‰ç«¯ç¶²é å‘¼å«æ­¤è™•ä¾†æŸ¥é€²åº¦) ---
function doGet(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000);
  
  try {
    // åˆ¤æ–·æ˜¯å¦ç‚ºæŸ¥è©¢è«‹æ±‚
    if (e.parameter.action === 'track') {
      var rmaId = e.parameter.id;
      var phone = e.parameter.phone;
      
      if (!rmaId || !phone) throw new Error("è«‹è¼¸å…¥å–®è™Ÿèˆ‡é›»è©±");

      var doc = SpreadsheetApp.getActiveSpreadsheet();
      var sheets = doc.getSheets();
      var result = null;

      // éæ­·æ‰€æœ‰åˆ†é å°‹æ‰¾å–®è™Ÿ
      for (var i = 0; i < sheets.length; i++) {
        var sheet = sheets[i];
        var lastRow = sheet.getLastRow();
        if (lastRow <= 1) continue;

        // è®€å–æ•´å¼µè¡¨è³‡æ–™ (ç‚ºäº†æ•ˆèƒ½ä¸€æ¬¡è®€å–)
        // å‡è¨­å–®è™Ÿåœ¨ Bæ¬„(index 1), é›»è©±åœ¨ Fæ¬„(index 5), ç‹€æ…‹åœ¨ Næ¬„(index 13), å‚™è¨»åœ¨ Oæ¬„(index 14)
        // æ¬„ä½çµæ§‹è«‹å°ç…§ doPost çš„ rowData
        var data = sheet.getRange(2, 1, lastRow - 1, 15).getValues(); // è®€åˆ° O æ¬„

        for (var j = 0; j < data.length; j++) {
          var row = data[j];
          // æ¯”å°å–®è™Ÿ (å¿½ç•¥å¤§å°å¯«) èˆ‡ é›»è©± (åŒ…å«)
          if (String(row[1]).toUpperCase() === rmaId.toUpperCase() && String(row[5]).includes(phone)) {
            result = {
              found: true,
              rmaId: row[1],
              type: sheet.getName(),
              date: Utilities.formatDate(new Date(row[0]), Session.getScriptTimeZone(), "yyyy/MM/dd"),
              status: row[13] || "å¾…å¯©æ ¸", // Næ¬„
              note: row[14] || ""        // Oæ¬„
            };
            break;
          }
        }
        if (result) break;
      }

      if (result) {
        return ContentService.createTextOutput(JSON.stringify(result)).setMimeType(ContentService.MimeType.JSON);
      } else {
        return ContentService.createTextOutput(JSON.stringify({ found: false, message: "æŸ¥ç„¡è³‡æ–™ï¼Œè«‹ç¢ºèªå–®è™Ÿèˆ‡é›»è©±æ˜¯å¦æ­£ç¢ºã€‚" })).setMimeType(ContentService.MimeType.JSON);
      }
    }
    
    return ContentService.createTextOutput("ç³»çµ±æ­£å¸¸é‹ä½œä¸­ (GET)");
  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({ error: e.toString() })).setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

// --- 2. æ¥æ”¶è¡¨å–®è³‡æ–™ (å‰ç«¯é€å‡ºç”³è«‹) ---
function doPost(e) {
  var lock = LockService.getScriptLock();
  lock.tryLock(10000);

  try {
    var doc = SpreadsheetApp.getActiveSpreadsheet();
    var data = JSON.parse(e.postData.contents);
    
    // æ±ºå®šåˆ†é 
    var sheetName = "";
    if (data.type === 'sales_return') sheetName = "éŠ·è²¨é€€è²¨";
    else if (data.type === 'sample_return') sheetName = "æ¨£å“æ­¸é‚„";
    else if (data.type === 'new_defective') sheetName = "æ–°å“ä¸è‰¯";
    else if (data.type === 'repair_service') sheetName = "æ•…éšœç¶­ä¿®";

    var sheet = doc.getSheetByName(sheetName);
    if (!sheet) {
      sheet = doc.insertSheet(sheetName);
      setupHeaders(sheet, data.type);
    }

    // æª”æ¡ˆè™•ç†
    var fileLinks = [];
    if (data.files && data.files.length > 0) {
      var folders = DriveApp.getFoldersByName(CONFIG.folderName);
      var folder = folders.hasNext() ? folders.next() : DriveApp.createFolder(CONFIG.folderName);
      data.files.forEach(function(fileObj) {
        var blob = Utilities.newBlob(Utilities.base64Decode(fileObj.base64), fileObj.mimeType, fileObj.name);
        var file = folder.createFile(blob);
        file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
        fileLinks.push(file.getUrl());
      });
    }
    var strFileLinks = fileLinks.join("\n");

    // æº–å‚™è³‡æ–™
    var timestamp = new Date();
    var contactPhone = data.contactPhone ? "'" + data.contactPhone : ""; 
    var allModels = [], allQtys = [], allReasons = [];

    if (data.products) {
      data.products.forEach(function(p) {
        var detail = [];
        if (p.reason) detail.push(p.reason);
        if (p.serialNumber) detail.push("S/N:" + p.serialNumber);
        if (p.purchaseDate) detail.push("è³¼:" + p.purchaseDate);
        if (p.note) detail.push(p.note);
        var strReason = detail.join(" / ") || "-";

        allModels.push(p.model);
        allQtys.push(p.quantity);
        allReasons.push(strReason);

        // æ¬„ä½å¯«å…¥ (ç‚ºäº†ç›¸å®¹èˆŠè³‡æ–™ï¼Œæ–°æ¬„ä½ Email/Status å»ºè­°å¾€å¾ŒåŠ )
        // ç›®å‰çµæ§‹: [0-11] åŸæœ¬æ¬„ä½ | [12] Email | [13] Status | [14] Note
        var rowData = [];
        
        // æ ¸å¿ƒè³‡æ–™å€å¡Š (A-L)
        if (data.type === 'sales_return') {
          rowData = [timestamp, data.rmaId, data.companyName, data.contactName, contactPhone, data.orderNumber || "", p.model, p.quantity, strReason, strFileLinks];
        } else if (data.type === 'sample_return') {
          var tracking = data.trackingNumber ? "'" + data.trackingNumber : "";
          rowData = [timestamp, data.rmaId, data.companyName, data.contactName, contactPhone, data.projectName || "", data.shippingCarrier || "", tracking, p.model, p.quantity, strReason, strFileLinks];
        } else { // new_defective & repair
          var consPhone = data.consumerPhone ? "'" + data.consumerPhone : "";
          rowData = [timestamp, data.rmaId, data.companyName, data.contactName, contactPhone, data.consumerName || "", consPhone, data.consumerAddress || "", p.model, p.quantity, strReason, data.defectiveDesc || "", strFileLinks];
        }

        // è£œé½Šå‰é¢çš„ç©ºæ¬„ä½ç›´åˆ° L æ¬„ (index 11)ï¼Œç¢ºä¿ Email/Status åœ¨å›ºå®šä½ç½®
        // éŠ·è²¨é€€è²¨(10æ¬„), æ¨£å“(12æ¬„), ç¶­ä¿®(13æ¬„)ã€‚ç‚ºäº†çµ±ä¸€ï¼Œæˆ‘å€‘è®“ Email å›ºå®šåœ¨ç¬¬ 13 æ¬„ (Col M)
        // é€™è£¡åšä¸€å€‹ç°¡å–®çš„å¡«å……é‚è¼¯ï¼š
        // å¯¦éš›ä¸Š Google Sheet appendRow æœƒä¾åºå¡«å…¥ã€‚ç‚ºäº†æŸ¥è©¢æ–¹ä¾¿ï¼Œå»ºè­° Email æ”¾åœ¨æœ€å¾Œä¸€å€‹ã€Œè³‡æ–™æ¬„ã€ä¹‹å¾Œ
        // ä½†ç‚ºäº† onEdit è§¸ç™¼ç°¡å–®ï¼Œå›ºå®šä½ç½®æœ€å¥½ã€‚
        // è®“æˆ‘å€‘æ¡ç”¨ã€Œé™„åŠ åœ¨æœ€å¾Œã€ç­–ç•¥ï¼š
        
        // æ–°å¢æ¬„ä½ï¼šè¯çµ¡äºº Email (M), ç›®å‰ç‹€æ…‹ (N), è™•ç†å‚™è¨» (O)
        // æ³¨æ„ï¼šä¸åŒè¡¨å–®é•·åº¦ä¸åŒï¼Œé€™è£¡æˆ‘å€‘è®“ Email ç·Šæ¥åœ¨é™„ä»¶ä¹‹å¾Œï¼Œä½†ç‚ºäº†æŸ¥è©¢æ–¹ä¾¿ï¼Œæˆ‘å€‘çµ±ä¸€ Email å¯«åœ¨ rowData ä¹‹å¾Œ
        
        rowData.push(data.contactEmail || ""); // Email
        rowData.push("å¾…å¯©æ ¸");                // Status (é è¨­)
        rowData.push("");                      // Internal Note (é è¨­ç©º)

        sheet.appendRow(rowData);
      });
    }

    // å¯„é€é€šçŸ¥ä¿¡çµ¦ç®¡ç†å“¡
    sendAdminNotification(data, fileLinks, allModels, allQtys, allReasons);

    return ContentService.createTextOutput(JSON.stringify({ result: "success", row: sheet.getLastRow() })).setMimeType(ContentService.MimeType.JSON);

  } catch (e) {
    return ContentService.createTextOutput(JSON.stringify({ result: "error", error: e.toString() })).setMimeType(ContentService.MimeType.JSON);
  } finally {
    lock.releaseLock();
  }
}

// --- 3. ç‹€æ…‹è®Šæ›´è§¸ç™¼ (éœ€æ‰‹å‹•è¨­å®šè§¸ç™¼ç¨‹åº) ---
function onStatusChange(e) {
  // æª¢æŸ¥æ˜¯å¦ç·¨è¼¯äº†å„²å­˜æ ¼
  if (!e || !e.range) return;
  
  var sheet = e.range.getSheet();
  var sheetName = sheet.getName();
  // åªç›£è½é€™ä¸‰å€‹åˆ†é 
  if (['éŠ·è²¨é€€è²¨', 'æ¨£å“æ­¸é‚„', 'æ–°å“ä¸è‰¯', 'æ•…éšœç¶­ä¿®'].indexOf(sheetName) === -1) return;

  var col = e.range.getColumn();
  var row = e.range.getRow();
  var val = e.value; // æ–°çš„ç‹€æ…‹å€¼

  // å‡è¨­ "ç‹€æ…‹" åœ¨ç¬¬ 14 æ¬„ (N) æˆ–é™„è¿‘? 
  // ç”±æ–¼ä¸åŒè¡¨å–®é•·åº¦ä¸åŒï¼š
  // éŠ·è²¨é€€è²¨: é™„ä»¶åœ¨ J(10), Email K(11), Status L(12) -> ä¿®æ­£ï¼šä¸Šæ–¹ doPost æˆ‘æ˜¯ç”¨ pushï¼Œæ‰€ä»¥ä½ç½®æ˜¯æµ®å‹•çš„
  // ç‚ºäº†ç²¾æº–ï¼Œæˆ‘å€‘æ”¹ç”¨ã€Œåˆ¤æ–·æ¨™é¡Œåˆ—ã€ä¾†æ‰¾ Status åœ¨ç¬¬å¹¾æ¬„
  
  var headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  var statusColIndex = headers.indexOf("ç›®å‰ç‹€æ…‹") + 1; // Google Sheet column index starts at 1
  var emailColIndex = headers.indexOf("è¯çµ¡äººEmail") + 1;
  var rmaColIndex = headers.indexOf("ç”³è«‹å–®è™Ÿ") + 1;
  var noteColIndex = headers.indexOf("è™•ç†å‚™è¨»") + 1;

  // å¦‚æœç·¨è¼¯çš„ä¸æ˜¯ç‹€æ…‹æ¬„ï¼Œæˆ–æ˜¯æ¨™é¡Œæ²’è¨­å°ï¼Œå°±è·³é
  if (col !== statusColIndex || statusColIndex === 0) return;
  if (row <= 1) return; // æ¨™é¡Œåˆ—ä¸è™•ç†

  // å–å¾—è©²åˆ—è³‡æ–™å¯„ä¿¡
  var email = sheet.getRange(row, emailColIndex).getValue();
  var rmaId = sheet.getRange(row, rmaColIndex).getValue();
  var note = (noteColIndex > 0) ? sheet.getRange(row, noteColIndex).getValue() : "";

  if (email && email.includes("@")) {
    sendCustomerStatusEmail(email, rmaId, val, note);
  }
}

// --- è¼”åŠ©å‡½æ•¸å€ ---

function setupHeaders(sheet, type) {
  var headers = [];
  // åŸºç¤æ¬„ä½
  if (type === 'sales_return') {
    headers = ["æ™‚é–“æˆ³è¨˜", "ç”³è«‹å–®è™Ÿ", "å…¬å¸åç¨±", "è¯çµ¡äººå§“å", "è¯çµ¡äººé›»è©±", "åŸè¨‚å–®ç·¨è™Ÿ", "ç”¢å“å‹è™Ÿ", "ç”¢å“æ•¸é‡", "åŸå› /å‚™è¨»", "é™„ä»¶é€£çµ"];
  } else if (type === 'sample_return') {
    headers = ["æ™‚é–“æˆ³è¨˜", "ç”³è«‹å–®è™Ÿ", "å…¬å¸åç¨±", "è¯çµ¡äººå§“å", "è¯çµ¡äººé›»è©±", "å€Ÿå‡ºæ¡ˆå", "è²¨é‹å…¬å¸", "è²¨é‹å–®è™Ÿ", "ç”¢å“å‹è™Ÿ", "ç”¢å“æ•¸é‡", "åŸå› /å‚™è¨»", "é™„ä»¶é€£çµ"];
  } else {
    headers = ["æ™‚é–“æˆ³è¨˜", "ç”³è«‹å–®è™Ÿ", "ç¶“éŠ·å•†åç¨±", "è¯çµ¡äººå§“å", "è¯çµ¡äººé›»è©±", "æ¶ˆè²»è€…å§“å", "æ¶ˆè²»è€…é›»è©±", "æ¶ˆè²»è€…åœ°å€", "ç”¢å“å‹è™Ÿ", "ç”¢å“æ•¸é‡", "åŸå› /å‚™è¨»", "æ•…éšœæè¿°", "é™„ä»¶é€£çµ"];
  }
  // åŠ ä¸Šæ–°æ¬„ä½
  headers.push("è¯çµ¡äººEmail", "ç›®å‰ç‹€æ…‹", "è™•ç†å‚™è¨»");
  
  sheet.appendRow(headers);
  sheet.setFrozenRows(1);
  sheet.getRange(1, 1, 1, headers.length).setFontWeight("bold").setBackground("#f3f4f6");
  
  // è¨­å®šç‹€æ…‹æ¬„ä½çš„ä¸‹æ‹‰é¸å–® (Data Validation)
  var statusColIndex = headers.indexOf("ç›®å‰ç‹€æ…‹") + 1;
  var rule = SpreadsheetApp.newDataValidation()
    .requireValueInList(['å¾…å¯©æ ¸', 'å·²æ”¶ä»¶', 'è™•ç†ä¸­', 'å·²çµæ¡ˆ/å¯„å›', 'é€€ä»¶'], true)
    .setAllowInvalid(false)
    .build();
  // è¨­å®šæ•´æ¬„ (å¾ç¬¬2åˆ—é–‹å§‹)
  sheet.getRange(2, statusColIndex, 999).setDataValidation(rule);
}

function sendAdminNotification(data, fileLinks, models, qtys, reasons) {
  // å¯„çµ¦ç®¡ç†å“¡ (ä¿æŒä¸è®Š)
  var subject = "ã€æ–°æ¡ˆä»¶é€šçŸ¥ã€‘" + data.typeTitle + " - " + data.companyName;
  var body = "æ–°æ¡ˆä»¶é€šçŸ¥...\nå–®è™Ÿï¼š" + data.rmaId + "\né¡åˆ¥ï¼š" + data.typeTitle + "\nå…¬å¸ï¼š" + data.companyName + "\nè¯çµ¡äººï¼š" + data.contactName + "\nEmailï¼š" + data.contactEmail + "\n\nç”¢å“æ˜ç´°è«‹è¦‹è©¦ç®—è¡¨ã€‚";
  MailApp.sendEmail({ to: CONFIG.adminEmails, subject: subject, body: body, name: CONFIG.senderName });
}

function sendCustomerStatusEmail(email, rmaId, status, note) {
  var subject = "ã€æ¡ˆä»¶é€²åº¦æ›´æ–°ã€‘å–®è™Ÿ " + rmaId + " ç‹€æ…‹è®Šæ›´ç‚ºï¼š" + status;
  var body = "è¦ªæ„›çš„åˆä½œå¤¥ä¼´ æ‚¨å¥½ï¼š\n\n" +
             "æ‚¨çš„å”®å¾Œæœå‹™ç”³è«‹å–® (" + rmaId + ") é€²åº¦å·²æ›´æ–°ã€‚\n\n" +
             "ğŸ”´ ç›®å‰ç‹€æ…‹ï¼š" + status + "\n";
  
  if (note) {
    body += "ğŸ“ è™•ç†å‚™è¨»/å–®è™Ÿï¼š" + note + "\n";
  }
  
  body += "\nè‹¥æœ‰ä»»ä½•ç–‘å•ï¼Œæ­¡è¿è¯ç¹« KINYO å”®å¾Œæœå‹™ä¸­å¿ƒã€‚\n\n(æ­¤ç‚ºç³»çµ±è‡ªå‹•ç™¼é€ï¼Œè«‹å‹¿å›è¦†)";
  
  try {
    MailApp.sendEmail({ to: email, subject: subject, body: body, name: CONFIG.senderName });
  } catch(e) {
    Logger.log("å®¢æˆ¶ä¿¡å¯„é€å¤±æ•—: " + e.toString());
  }
}
